/*! For license information please see sdk.js.LICENSE.txt */
(()=>{var e={33:(e,t,i)=>{var n,a,r=i(814),o=i(471),s=0,l=0;e.exports=function(e,t,i){var d=t&&i||0,c=t||[],u=(e=e||{}).node||n,g=(i=void 0!==e.clockseq?e.clockseq:a,null!=u&&null!=i||(g=r(),null==u&&(u=n=[1|g[0],g[1],g[2],g[3],g[4],g[5]]),null==i&&(i=a=16383&(g[6]<<8|g[7]))),void 0!==e.msecs?e.msecs:(new Date).getTime()),p=void 0!==e.nsecs?e.nsecs:l+1,m=g-s+(p-l)/1e4;if(m<0&&void 0===e.clockseq&&(i=i+1&16383),1e4<=(p=(m<0||s<g)&&void 0===e.nsecs?0:p))throw new Error("uuid.v1(): Can't create more than 10M uuids/sec");s=g,a=i,m=(1e4*(268435455&(g+=122192928e5))+(l=p))%4294967296,c[d++]=m>>>24&255,c[d++]=m>>>16&255,c[d++]=m>>>8&255,c[d++]=255&m,c[d++]=(e=g/4294967296*1e4&268435455)>>>8&255,c[d++]=255&e,c[d++]=e>>>24&15|16,c[d++]=e>>>16&255,c[d++]=i>>>8|128,c[d++]=255&i;for(var h=0;h<6;++h)c[d+h]=u[h];return t||o(c)}},372:(e,t,i)=>{e.exports=function(e,t,i){if("number"!=typeof t)throw new Error("second argument must be a Number");let a,r,o,s,l,d,c=!0;function u(e){function t(){i&&i(e,a),i=null}c?n(t):t()}function g(t,i,n){if(a[t]=n,i&&(l=!0),0==--o||i)u(i);else if(!l&&d<r){let t;s?(t=s[d],d+=1,e[t](function(e,i){g(t,e,i)})):(t=d,d+=1,e[t](function(e,i){g(t,e,i)}))}}o=r=(Array.isArray(e)?(a=[],e):(s=Object.keys(e),a={},s)).length,d=t,o?s?s.some(function(i,n){return e[i](function(e,t){g(i,e,t)}),n===t-1}):e.some(function(e,i){return e(function(e,t){g(i,e,t)}),i===t-1}):u(null),c=!1};let n=i(596)},414:(e,t,i)=>{var n=i(33),a=i=i(550);a.v1=n,a.v4=i,e.exports=a},471:e=>{for(var t=[],i=0;i<256;++i)t[i]=(i+256).toString(16).substr(1);e.exports=function(e,i){i=i||0;var n=t;return[n[e[i++]],n[e[i++]],n[e[i++]],n[e[i++]],"-",n[e[i++]],n[e[i++]],"-",n[e[i++]],n[e[i++]],"-",n[e[i++]],n[e[i++]],"-",n[e[i++]],n[e[i++]],n[e[i++]],n[e[i++]],n[e[i++]],n[e[+i]]].join("")}},550:(e,t,i)=>{var n=i(814),a=i(471);e.exports=function(e,t,i){var r=t&&i||0,o=("string"==typeof e&&(t="binary"===e?new Array(16):null,e=null),(e=e||{}).random||(e.rng||n)());if(o[6]=15&o[6]|64,o[8]=63&o[8]|128,t)for(var s=0;s<16;++s)t[r+s]=o[s];return t||a(o)}},596:(e,t,i)=>{let n;e.exports="function"==typeof queueMicrotask?queueMicrotask.bind("undefined"!=typeof window?window:i.g):e=>(n=n||Promise.resolve()).then(e).catch(e=>setTimeout(()=>{throw e},0))},790:(e,t,i)=>{e.exports=function e(t,i,n){function a(o,s){if(!i[o]){if(!t[o]){if(r)return r(o,!0);var l=new Error("Cannot find module '"+o+"'");throw l.code="MODULE_NOT_FOUND",l}l=i[o]={exports:{}},t[o][0].call(l.exports,function(e){return a(t[o][1][e]||e)},l,l.exports,e,t,i,n)}return i[o].exports}for(var r=void 0,o=0;o<n.length;o++)a(n[o]);return a}({1:[function(e,t,n){(function(e){var i,n,a,r,o=e.MutationObserver||e.WebKitMutationObserver,s=o?(i=0,o=new o(d),n=e.document.createTextNode(""),o.observe(n,{characterData:!0}),function(){n.data=i=++i%2}):e.setImmediate||void 0===e.MessageChannel?"document"in e&&"onreadystatechange"in e.document.createElement("script")?function(){var t=e.document.createElement("script");t.onreadystatechange=function(){d(),t.onreadystatechange=null,t.parentNode.removeChild(t),t=null},e.document.documentElement.appendChild(t)}:function(){setTimeout(d,0)}:((a=new e.MessageChannel).port1.onmessage=d,function(){a.port2.postMessage(0)}),l=[];function d(){r=!0;for(var e,t,i=l.length;i;){for(t=l,l=[],e=-1;++e<i;)t[e]();i=l.length}r=!1}t.exports=function(e){1!==l.push(e)||r||s()}}).call(this,void 0!==i.g?i.g:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],2:[function(e,t,i){var n=e(1);function a(){}var r={},o=["REJECTED"],s=["FULFILLED"],l=["PENDING"];function d(e){if("function"!=typeof e)throw new TypeError("resolver must be a function");this.state=l,this.queue=[],this.outcome=void 0,e!==a&&p(this,e)}function c(e,t,i){this.promise=e,"function"==typeof t&&(this.onFulfilled=t,this.callFulfilled=this.otherCallFulfilled),"function"==typeof i&&(this.onRejected=i,this.callRejected=this.otherCallRejected)}function u(e,t,i){n(function(){var n;try{n=t(i)}catch(n){return r.reject(e,n)}n===e?r.reject(e,new TypeError("Cannot resolve promise with itself")):r.resolve(e,n)})}function g(e){var t=e&&e.then;if(e&&("object"==typeof e||"function"==typeof e)&&"function"==typeof t)return function(){t.apply(e,arguments)}}function p(e,t){var i=!1;function n(t){i||(i=!0,r.reject(e,t))}function a(t){i||(i=!0,r.resolve(e,t))}var o=m(function(){t(a,n)});"error"===o.status&&n(o.value)}function m(e,t){var i={};try{i.value=e(t),i.status="success"}catch(e){i.status="error",i.value=e}return i}(t.exports=d).prototype.catch=function(e){return this.then(null,e)},d.prototype.then=function(e,t){var i;return"function"!=typeof e&&this.state===s||"function"!=typeof t&&this.state===o?this:(i=new this.constructor(a),this.state!==l?u(i,this.state===s?e:t,this.outcome):this.queue.push(new c(i,e,t)),i)},c.prototype.callFulfilled=function(e){r.resolve(this.promise,e)},c.prototype.otherCallFulfilled=function(e){u(this.promise,this.onFulfilled,e)},c.prototype.callRejected=function(e){r.reject(this.promise,e)},c.prototype.otherCallRejected=function(e){u(this.promise,this.onRejected,e)},r.resolve=function(e,t){var i=m(g,t);if("error"===i.status)return r.reject(e,i.value);if(i=i.value)p(e,i);else{e.state=s,e.outcome=t;for(var n=-1,a=e.queue.length;++n<a;)e.queue[n].callFulfilled(t)}return e},r.reject=function(e,t){e.state=o,e.outcome=t;for(var i=-1,n=e.queue.length;++i<n;)e.queue[i].callRejected(t);return e},d.resolve=function(e){return e instanceof this?e:r.resolve(new this(a),e)},d.reject=function(e){var t=new this(a);return r.reject(t,e)},d.all=function(e){var t=this;if("[object Array]"!==Object.prototype.toString.call(e))return this.reject(new TypeError("must be an array"));var i=e.length,n=!1;if(!i)return this.resolve([]);for(var o=new Array(i),s=0,l=-1,d=new this(a);++l<i;)((e,a)=>{t.resolve(e).then(function(e){o[a]=e,++s!==i||n||(n=!0,r.resolve(d,o))},function(e){n||(n=!0,r.reject(d,e))})})(e[l],l);return d},d.race=function(e){var t=this;if("[object Array]"!==Object.prototype.toString.call(e))return this.reject(new TypeError("must be an array"));var i=e.length,n=!1;if(!i)return this.resolve([]);for(var o=-1,s=new this(a);++o<i;)(e=>{t.resolve(e).then(function(e){n||(n=!0,r.resolve(s,e))},function(e){n||(n=!0,r.reject(s,e))})})(e[o]);return s}},{1:1}],3:[function(e,t,n){(function(t){"function"!=typeof t.Promise&&(t.Promise=e(2))}).call(this,void 0!==i.g?i.g:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{2:2}],4:[function(e,t,i){var n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},a=(()=>{try{return"undefined"!=typeof indexedDB?indexedDB:"undefined"!=typeof webkitIndexedDB?webkitIndexedDB:"undefined"!=typeof mozIndexedDB?mozIndexedDB:"undefined"!=typeof OIndexedDB?OIndexedDB:"undefined"!=typeof msIndexedDB?msIndexedDB:void 0}catch(e){}})();function r(e,t){e=e||[],t=t||{};try{return new Blob(e,t)}catch(a){if("TypeError"!==a.name)throw a;for(var i=new("undefined"!=typeof BlobBuilder?BlobBuilder:"undefined"!=typeof MSBlobBuilder?MSBlobBuilder:"undefined"!=typeof MozBlobBuilder?MozBlobBuilder:WebKitBlobBuilder),n=0;n<e.length;n+=1)i.append(e[n]);return i.getBlob(t.type)}}"undefined"==typeof Promise&&e(3);var o=Promise;function s(e,t){t&&e.then(function(e){t(null,e)},function(e){t(e)})}function l(e,t,i){"function"==typeof t&&e.then(t),"function"==typeof i&&e.catch(i)}function d(e){return"string"!=typeof e&&(console.warn(e+" used as a key, but it is not a string."),e=String(e)),e}function c(){if(arguments.length&&"function"==typeof arguments[arguments.length-1])return arguments[arguments.length-1]}var u="local-forage-detect-blob-support",g=void 0,p={},m=Object.prototype.toString,h="readonly",E="readwrite";function v(e){return"boolean"==typeof g?o.resolve(g):(t=e,new o(function(e){var i=t.transaction(u,E),n=r([""]);i.objectStore(u).put(n,"key"),i.onabort=function(t){t.preventDefault(),t.stopPropagation(),e(!1)},i.oncomplete=function(){var t=navigator.userAgent.match(/Chrome\/(\d+)/),i=navigator.userAgent.match(/Edge\//);e(i||!t||43<=parseInt(t[1],10))}}).catch(function(){return!1}).then(function(e){return g=e}));var t}function f(e){e=p[e.name];var t={};t.promise=new o(function(e,i){t.resolve=e,t.reject=i}),e.deferredOperations.push(t),e.dbReady?e.dbReady=e.dbReady.then(function(){return t.promise}):e.dbReady=t.promise}function S(e){(e=p[e.name].deferredOperations.pop())&&(e.resolve(),e.promise)}function _(e,t){if(e=p[e.name].deferredOperations.pop())return e.reject(t),e.promise}function I(e,t){return new o(function(i,n){if(p[e.name]=p[e.name]||{forages:[],db:null,dbReady:null,deferredOperations:[]},e.db){if(!t)return i(e.db);f(e),e.db.close()}var r=[e.name],o=(t&&r.push(e.version),a.open.apply(a,r));t&&(o.onupgradeneeded=function(t){var i=o.result;try{i.createObjectStore(e.storeName),t.oldVersion<=1&&i.createObjectStore(u)}catch(i){if("ConstraintError"!==i.name)throw i;console.warn('The database "'+e.name+'" has been upgraded from version '+t.oldVersion+" to version "+t.newVersion+', but the storage "'+e.storeName+'" already exists.')}}),o.onerror=function(e){e.preventDefault(),n(o.error)},o.onsuccess=function(){var t=o.result;t.onversionchange=function(e){e.target.close()},i(t),S(e)}})}function T(e){return I(e,!1)}function y(e){return I(e,!0)}function b(e,t){var i,n,a;return!e.db||(i=!e.db.objectStoreNames.contains(e.storeName),a=e.version<e.db.version,n=e.version>e.db.version,a&&(e.version!==t&&console.warn('The database "'+e.name+"\" can't be downgraded from version "+e.db.version+" to version "+e.version+"."),e.version=e.db.version),(n||i)&&(i&&(a=e.db.version+1,e.version<a)&&(e.version=a),1))}function A(e){return r([(e=>{for(var t=e.length,i=new ArrayBuffer(t),n=new Uint8Array(i),a=0;a<t;a++)n[a]=e.charCodeAt(a);return i})(atob(e.data))],{type:e.type})}function O(e){return e&&e.__local_forage_encoded_blob}function w(e){var t=this,i=t._initReady().then(function(){var e=p[t._dbInfo.name];if(e&&e.dbReady)return e.dbReady});return l(i,e,e),i}function D(e,t,i,n){void 0===n&&(n=1);try{var a=e.db.transaction(e.storeName,t);i(null,a)}catch(a){if(0<n&&(!e.db||"InvalidStateError"===a.name||"NotFoundError"===a.name))return o.resolve().then(function(){if(!e.db||"NotFoundError"===a.name&&!e.db.objectStoreNames.contains(e.storeName)&&e.version<=e.db.version)return e.db&&(e.version=e.db.version+1),y(e)}).then(function(){return(e=>{f(e);for(var t=p[e.name],i=t.forages,n=0;n<i.length;n++){var a=i[n];a._dbInfo.db&&(a._dbInfo.db.close(),a._dbInfo.db=null)}return e.db=null,T(e).then(function(t){return e.db=t,b(e)?y(e):t}).then(function(n){e.db=t.db=n;for(var a=0;a<i.length;a++)i[a]._dbInfo.db=n}).catch(function(t){throw _(e,t),t})})(e).then(function(){D(e,t,i,n-1)})}).catch(i);i(a)}}e={_driver:"asyncStorage",_initStorage:function(e){var t=this,i={db:null};if(e)for(var n in e)i[n]=e[n];var a=p[i.name],r=(a||(a={forages:[],db:null,dbReady:null,deferredOperations:[]},p[i.name]=a),a.forages.push(t),t._initReady||(t._initReady=t.ready,t.ready=w),[]);function s(){return o.resolve()}for(var l=0;l<a.forages.length;l++){var d=a.forages[l];d!==t&&r.push(d._initReady().catch(s))}var c=a.forages.slice(0);return o.all(r).then(function(){return i.db=a.db,T(i)}).then(function(e){return i.db=e,b(i,t._defaultConfig.version)?y(i):e}).then(function(e){i.db=a.db=e,t._dbInfo=i;for(var n=0;n<c.length;n++){var r=c[n];r!==t&&(r._dbInfo.db=i.db,r._dbInfo.version=i.version)}})},_support:(()=>{try{var e,t;return!(!a||!a.open)&&(e="undefined"!=typeof openDatabase&&/(Safari|iPhone|iPad|iPod)/.test(navigator.userAgent)&&!/Chrome/.test(navigator.userAgent)&&!/BlackBerry/.test(navigator.platform),t="function"==typeof fetch&&-1!==fetch.toString().indexOf("[native code"),(!e||t)&&"undefined"!=typeof indexedDB&&"undefined"!=typeof IDBKeyRange)}catch(e){return!1}})(),iterate:function(e,t){var i=this,n=new o(function(t,n){i.ready().then(function(){D(i._dbInfo,h,function(a,r){if(a)return n(a);try{var o=r.objectStore(i._dbInfo.storeName).openCursor(),s=1;o.onsuccess=function(){var i,n=o.result;n?(O(i=n.value)&&(i=A(i)),void 0!==(i=e(i,n.key,s++))?t(i):n.continue()):t()},o.onerror=function(){n(o.error)}}catch(a){n(a)}})}).catch(n)});return s(n,t),n},getItem:function(e,t){var i=this,n=(e=d(e),new o(function(t,n){i.ready().then(function(){D(i._dbInfo,h,function(a,r){if(a)return n(a);try{var o=r.objectStore(i._dbInfo.storeName).get(e);o.onsuccess=function(){var e=o.result;O(e=void 0===e?null:e)&&(e=A(e)),t(e)},o.onerror=function(){n(o.error)}}catch(a){n(a)}})}).catch(n)}));return s(n,t),n},setItem:function(e,t,i){var n=this,a=(e=d(e),new o(function(i,a){var r;n.ready().then(function(){return r=n._dbInfo,"[object Blob]"===m.call(t)?v(r.db).then(function(e){return e?t:(i=t,new o(function(e,t){var n=new FileReader;n.onerror=t,n.onloadend=function(t){t=btoa(t.target.result||""),e({__local_forage_encoded_blob:!0,data:t,type:i.type})},n.readAsBinaryString(i)}));var i}):t}).then(function(t){D(n._dbInfo,E,function(r,o){if(r)return a(r);try{var s=o.objectStore(n._dbInfo.storeName),l=(null===t&&(t=void 0),s.put(t,e));o.oncomplete=function(){i(t=void 0===t?null:t)},o.onabort=o.onerror=function(){var e=l.error||l.transaction.error;a(e)}}catch(r){a(r)}})}).catch(a)}));return s(a,i),a},removeItem:function(e,t){var i=this,n=(e=d(e),new o(function(t,n){i.ready().then(function(){D(i._dbInfo,E,function(a,r){if(a)return n(a);try{var o=r.objectStore(i._dbInfo.storeName).delete(e);r.oncomplete=function(){t()},r.onerror=function(){n(o.error)},r.onabort=function(){var e=o.error||o.transaction.error;n(e)}}catch(a){n(a)}})}).catch(n)}));return s(n,t),n},clear:function(e){var t=this,i=new o(function(e,i){t.ready().then(function(){D(t._dbInfo,E,function(n,a){if(n)return i(n);try{var r=a.objectStore(t._dbInfo.storeName).clear();a.oncomplete=function(){e()},a.onabort=a.onerror=function(){var e=r.error||r.transaction.error;i(e)}}catch(n){i(n)}})}).catch(i)});return s(i,e),i},length:function(e){var t=this,i=new o(function(e,i){t.ready().then(function(){D(t._dbInfo,h,function(n,a){if(n)return i(n);try{var r=a.objectStore(t._dbInfo.storeName).count();r.onsuccess=function(){e(r.result)},r.onerror=function(){i(r.error)}}catch(n){i(n)}})}).catch(i)});return s(i,e),i},key:function(e,t){var i=this,n=new o(function(t,n){e<0?t(null):i.ready().then(function(){D(i._dbInfo,h,function(a,r){if(a)return n(a);try{var o=r.objectStore(i._dbInfo.storeName),s=!1,l=o.openKeyCursor();l.onsuccess=function(){var i=l.result;i?0===e||s?t(i.key):(s=!0,i.advance(e)):t(null)},l.onerror=function(){n(l.error)}}catch(a){n(a)}})}).catch(n)});return s(n,t),n},keys:function(e){var t=this,i=new o(function(e,i){t.ready().then(function(){D(t._dbInfo,h,function(n,a){if(n)return i(n);try{var r=a.objectStore(t._dbInfo.storeName).openKeyCursor(),o=[];r.onsuccess=function(){var t=r.result;t?(o.push(t.key),t.continue()):e(o)},r.onerror=function(){i(r.error)}}catch(n){i(n)}})}).catch(i)});return s(i,e),i},dropInstance:function(e,t){t=c.apply(this,arguments);var i=this.config();return(e="function"!=typeof e&&e||{}).name||(e.name=e.name||i.name,e.storeName=e.storeName||i.storeName),s(i=e.name?(i=e.name===i.name&&this._dbInfo.db?o.resolve(this._dbInfo.db):T(e).then(function(t){var i=p[e.name],n=i.forages;i.db=t;for(var a=0;a<n.length;a++)n[a]._dbInfo.db=t;return t}),e.storeName?i.then(function(t){if(t.objectStoreNames.contains(e.storeName)){var i=t.version+1,n=(f(e),p[e.name]),r=n.forages;t.close();for(var s=0;s<r.length;s++){var l=r[s];l._dbInfo.db=null,l._dbInfo.version=i}return new o(function(t,n){var r=a.open(e.name,i);r.onerror=function(e){r.result.close(),n(e)},r.onupgradeneeded=function(){r.result.deleteObjectStore(e.storeName)},r.onsuccess=function(){var e=r.result;e.close(),t(e)}}).then(function(e){n.db=e;for(var t=0;t<r.length;t++){var i=r[t];i._dbInfo.db=e,S(i._dbInfo)}}).catch(function(t){throw(_(e,t)||o.resolve()).catch(function(){}),t})}}):i.then(function(t){f(e);var i=p[e.name],n=i.forages;t.close();for(var r=0;r<n.length;r++)n[r]._dbInfo.db=null;return new o(function(t,i){var n=a.deleteDatabase(e.name);n.onerror=function(){var e=n.result;e&&e.close(),i(n.error)},n.onblocked=function(){console.warn('dropInstance blocked for database "'+e.name+'" until all open connections are closed')},n.onsuccess=function(){var e=n.result;e&&e.close(),t(e)}}).then(function(e){i.db=e;for(var t=0;t<n.length;t++)S(n[t]._dbInfo)}).catch(function(t){throw(_(e,t)||o.resolve()).catch(function(){}),t})})):o.reject("Invalid arguments"),t),i}};var N="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",C=/^~~local_forage_type~([^~]+)~/,L="__lfsc__:",P="arbf",R="blob",M=Object.prototype.toString;function k(e){for(var t,i,n,a,r=.75*e.length,o=e.length,s=0,l=("="===e[e.length-1]&&(r--,"="===e[e.length-2])&&r--,r=new ArrayBuffer(r),new Uint8Array(r)),d=0;d<o;d+=4)t=N.indexOf(e[d]),i=N.indexOf(e[d+1]),n=N.indexOf(e[d+2]),a=N.indexOf(e[d+3]),l[s++]=t<<2|i>>4,l[s++]=(15&i)<<4|n>>2,l[s++]=(3&n)<<6|63&a;return r}function x(e){for(var t=new Uint8Array(e),i="",n=0;n<t.length;n+=3)i=(i=(i=(i+=N[t[n]>>2])+N[(3&t[n])<<4|t[n+1]>>4])+N[(15&t[n+1])<<2|t[n+2]>>6])+N[63&t[n+2]];return t.length%3==2?i=i.substring(0,i.length-1)+"=":t.length%3==1&&(i=i.substring(0,i.length-2)+"=="),i}var B={serialize:function(e,t){var i="";if(e&&(i=M.call(e)),e&&("[object ArrayBuffer]"===i||e.buffer&&"[object ArrayBuffer]"===M.call(e.buffer))){var n,a=L;e instanceof ArrayBuffer?(n=e,a+=P):(n=e.buffer,"[object Int8Array]"===i?a+="si08":"[object Uint8Array]"===i?a+="ui08":"[object Uint8ClampedArray]"===i?a+="uic8":"[object Int16Array]"===i?a+="si16":"[object Uint16Array]"===i?a+="ur16":"[object Int32Array]"===i?a+="si32":"[object Uint32Array]"===i?a+="ui32":"[object Float32Array]"===i?a+="fl32":"[object Float64Array]"===i?a+="fl64":t(new Error("Failed to get type for BinaryArray"))),t(a+x(n))}else if("[object Blob]"===i)(a=new FileReader).onload=function(){var i="~~local_forage_type~"+e.type+"~"+x(this.result);t(L+R+i)},a.readAsArrayBuffer(e);else try{t(JSON.stringify(e))}catch(i){console.error("Couldn't convert value into a JSON string: ",e),t(null,i)}},deserialize:function(e){if(e.substring(0,9)!==L)return JSON.parse(e);var t,i=e.substring(13),n=e.substring(9,13),a=(n===R&&C.test(i)&&(t=(e=i.match(C))[1],i=i.substring(e[0].length)),k(i));switch(n){case P:return a;case R:return r([a],{type:t});case"si08":return new Int8Array(a);case"ui08":return new Uint8Array(a);case"uic8":return new Uint8ClampedArray(a);case"si16":return new Int16Array(a);case"ur16":return new Uint16Array(a);case"si32":return new Int32Array(a);case"ui32":return new Uint32Array(a);case"fl32":return new Float32Array(a);case"fl64":return new Float64Array(a);default:throw new Error("Unkown type: "+n)}},stringToBuffer:k,bufferToString:x};function U(e,t,i,n){e.executeSql("CREATE TABLE IF NOT EXISTS "+t.storeName+" (id INTEGER PRIMARY KEY, key unique, value)",[],i,n)}function F(e,t,i,n,a,r){e.executeSql(i,n,a,function(e,o){o.code===o.SYNTAX_ERR?e.executeSql("SELECT name FROM sqlite_master WHERE type='table' AND name = ?",[t.storeName],function(e,s){s.rows.length?r(e,o):U(e,t,function(){e.executeSql(i,n,a,r)},r)},r):r(e,o)},r)}function W(e,t,i,n){var a=this,r=(e=d(e),new o(function(r,o){a.ready().then(function(){var s=t=void 0===t?null:t,l=a._dbInfo;l.serializer.serialize(t,function(t,d){d?o(d):l.db.transaction(function(i){F(i,l,"INSERT OR REPLACE INTO "+l.storeName+" (key, value) VALUES (?, ?)",[e,t],function(){r(s)},function(e,t){o(t)})},function(t){t.code===t.QUOTA_ERR&&(0<n?r(W.apply(a,[e,s,i,n-1])):o(t))})})}).catch(o)}));return s(r,i),r}var H={_driver:"webSQLStorage",_initStorage:function(e){var t=this,i={db:null};if(e)for(var n in e)i[n]="string"!=typeof e[n]?e[n].toString():e[n];var a=new o(function(e,n){try{i.db=openDatabase(i.name,String(i.version),i.description,i.size)}catch(e){return n(e)}i.db.transaction(function(a){U(a,i,function(){t._dbInfo=i,e()},function(e,t){n(t)})},n)});return i.serializer=B,a},_support:"function"==typeof openDatabase,iterate:function(e,t){var i=this,n=new o(function(t,n){i.ready().then(function(){var a=i._dbInfo;a.db.transaction(function(i){F(i,a,"SELECT * FROM "+a.storeName,[],function(i,n){for(var r=n.rows,o=r.length,s=0;s<o;s++){var l=r.item(s),d=(d=l.value)&&a.serializer.deserialize(d);if(void 0!==(d=e(d,l.key,s+1)))return void t(d)}t()},function(e,t){n(t)})})}).catch(n)});return s(n,t),n},getItem:function(e,t){var i=this,n=(e=d(e),new o(function(t,n){i.ready().then(function(){var a=i._dbInfo;a.db.transaction(function(i){F(i,a,"SELECT * FROM "+a.storeName+" WHERE key = ? LIMIT 1",[e],function(e,i){i=(i=i.rows.length?i.rows.item(0).value:null)&&a.serializer.deserialize(i),t(i)},function(e,t){n(t)})})}).catch(n)}));return s(n,t),n},setItem:function(e,t,i){return W.apply(this,[e,t,i,1])},removeItem:function(e,t){var i=this,n=(e=d(e),new o(function(t,n){i.ready().then(function(){var a=i._dbInfo;a.db.transaction(function(i){F(i,a,"DELETE FROM "+a.storeName+" WHERE key = ?",[e],function(){t()},function(e,t){n(t)})})}).catch(n)}));return s(n,t),n},clear:function(e){var t=this,i=new o(function(e,i){t.ready().then(function(){var n=t._dbInfo;n.db.transaction(function(t){F(t,n,"DELETE FROM "+n.storeName,[],function(){e()},function(e,t){i(t)})})}).catch(i)});return s(i,e),i},length:function(e){var t=this,i=new o(function(e,i){t.ready().then(function(){var n=t._dbInfo;n.db.transaction(function(t){F(t,n,"SELECT COUNT(key) as c FROM "+n.storeName,[],function(t,i){i=i.rows.item(0).c,e(i)},function(e,t){i(t)})})}).catch(i)});return s(i,e),i},key:function(e,t){var i=this,n=new o(function(t,n){i.ready().then(function(){var a=i._dbInfo;a.db.transaction(function(i){F(i,a,"SELECT key FROM "+a.storeName+" WHERE id = ? LIMIT 1",[e+1],function(e,i){i=i.rows.length?i.rows.item(0).key:null,t(i)},function(e,t){n(t)})})}).catch(n)});return s(n,t),n},keys:function(e){var t=this,i=new o(function(e,i){t.ready().then(function(){var n=t._dbInfo;n.db.transaction(function(t){F(t,n,"SELECT key FROM "+n.storeName,[],function(t,i){for(var n=[],a=0;a<i.rows.length;a++)n.push(i.rows.item(a).key);e(n)},function(e,t){i(t)})})}).catch(i)});return s(i,e),i},dropInstance:function(e,t){t=c.apply(this,arguments);var i=this.config(),n=((e="function"!=typeof e&&e||{}).name||(e.name=e.name||i.name,e.storeName=e.storeName||i.storeName),this),a=e.name?new o(function(t){var a,r=e.name===i.name?n._dbInfo.db:openDatabase(e.name,"","",0);e.storeName?t({db:r,storeNames:[e.storeName]}):t((a=r,new o(function(e,t){a.transaction(function(i){i.executeSql("SELECT name FROM sqlite_master WHERE type='table' AND name <> '__WebKitDatabaseInfoTable__'",[],function(t,i){for(var n=[],r=0;r<i.rows.length;r++)n.push(i.rows.item(r).name);e({db:a,storeNames:n})},function(e,i){t(i)})},function(e){t(e)})})))}).then(function(e){return new o(function(t,i){e.db.transaction(function(n){for(var a=[],r=0,s=e.storeNames.length;r<s;r++)a.push((e=>new o(function(t,i){n.executeSql("DROP TABLE IF EXISTS "+e,[],function(){t()},function(e,t){i(t)})}))(e.storeNames[r]));o.all(a).then(function(){t()}).catch(function(e){i(e)})},function(e){i(e)})})}):o.reject("Invalid arguments");return s(a,t),a}};function V(e,t){var i=e.name+"/";return e.storeName!==t.storeName&&(i+=e.storeName+"/"),i}function G(e,t){for(var i,n,a=e.length,r=0;r<a;){if((i=e[r])===(n=t)||"number"==typeof i&&"number"==typeof n&&isNaN(i)&&isNaN(n))return 1;r++}}var K={_driver:"localStorageWrapper",_initStorage:function(e){var t={};if(e)for(var i in e)t[i]=e[i];return t.keyPrefix=V(e,this._defaultConfig),!(()=>{var e="_localforage_support_test";try{localStorage.setItem(e,!0),localStorage.removeItem(e)}catch(e){return 1}})()||0<localStorage.length?((this._dbInfo=t).serializer=B,o.resolve()):o.reject()},_support:(()=>{try{return"undefined"!=typeof localStorage&&"setItem"in localStorage&&!!localStorage.setItem}catch(e){return!1}})(),iterate:function(e,t){var i=this,n=i.ready().then(function(){for(var t=i._dbInfo,n=t.keyPrefix,a=n.length,r=localStorage.length,o=1,s=0;s<r;s++){var l=localStorage.key(s);if(0===l.indexOf(n)){var d=(d=localStorage.getItem(l))&&t.serializer.deserialize(d);if(void 0!==(d=e(d,l.substring(a),o++)))return d}}});return s(n,t),n},getItem:function(e,t){var i=this,n=(e=d(e),i.ready().then(function(){var t=i._dbInfo,n=localStorage.getItem(t.keyPrefix+e);return n&&t.serializer.deserialize(n)}));return s(n,t),n},setItem:function(e,t,i){var n=this,a=(e=d(e),n.ready().then(function(){var i=t=void 0===t?null:t;return new o(function(a,r){var o=n._dbInfo;o.serializer.serialize(t,function(t,n){if(n)r(n);else try{localStorage.setItem(o.keyPrefix+e,t),a(i)}catch(t){"QuotaExceededError"!==t.name&&"NS_ERROR_DOM_QUOTA_REACHED"!==t.name||r(t),r(t)}})})}));return s(a,i),a},removeItem:function(e,t){var i=this,n=(e=d(e),i.ready().then(function(){var t=i._dbInfo;localStorage.removeItem(t.keyPrefix+e)}));return s(n,t),n},clear:function(e){var t=this,i=t.ready().then(function(){for(var e=t._dbInfo.keyPrefix,i=localStorage.length-1;0<=i;i--){var n=localStorage.key(i);0===n.indexOf(e)&&localStorage.removeItem(n)}});return s(i,e),i},length:function(e){var t=this.keys().then(function(e){return e.length});return s(t,e),t},key:function(e,t){var i=this,n=i.ready().then(function(){var t,n=i._dbInfo;try{t=localStorage.key(e)}catch(n){t=null}return t&&t.substring(n.keyPrefix.length)});return s(n,t),n},keys:function(e){var t=this,i=t.ready().then(function(){for(var e=t._dbInfo,i=localStorage.length,n=[],a=0;a<i;a++){var r=localStorage.key(a);0===r.indexOf(e.keyPrefix)&&n.push(r.substring(e.keyPrefix.length))}return n});return s(i,e),i},dropInstance:function(e,t){t=c.apply(this,arguments),(e="function"!=typeof e&&e||{}).name||(n=this.config(),e.name=e.name||n.name,e.storeName=e.storeName||n.storeName);var i=this,n=e.name?new o(function(t){e.storeName?t(V(e,i._defaultConfig)):t(e.name+"/")}).then(function(e){for(var t=localStorage.length-1;0<=t;t--){var i=localStorage.key(t);0===i.indexOf(e)&&localStorage.removeItem(i)}}):o.reject("Invalid arguments");return s(n,t),n}},j=Array.isArray||function(e){return"[object Array]"===Object.prototype.toString.call(e)},Y={},q={},z={INDEXEDDB:e,WEBSQL:H,LOCALSTORAGE:K},$=(e=[z.INDEXEDDB._driver,z.WEBSQL._driver,z.LOCALSTORAGE._driver],["dropInstance"]),J=["clear","getItem","iterate","key","keys","length","removeItem","setItem"].concat($),X={description:"",driver:e.slice(),name:"localforage",size:4980736,storeName:"keyvaluepairs",version:1};function Q(e){for(var t=1;t<arguments.length;t++){var i=arguments[t];if(i)for(var n in i)i.hasOwnProperty(n)&&(j(i[n])?e[n]=i[n].slice():e[n]=i[n])}return e}function Z(e){var t,i,n;if(!(this instanceof Z))throw new TypeError("Cannot call a class as a function");for(t in z)z.hasOwnProperty(t)&&(n=(i=z[t])._driver,this[t]=n,Y[n]||this.defineDriver(i));this._defaultConfig=Q({},X),this._config=Q({},this._defaultConfig,e),this._driverSet=null,this._initDriver=null,this._ready=!1,this._dbInfo=null,this._wrapLibraryMethodsWithReady(),this.setDriver(this._config.driver).catch(function(){})}Z.prototype.config=function(e){if("object"!==(void 0===e?"undefined":n(e)))return"string"==typeof e?this._config[e]:this._config;if(this._ready)return new Error("Can't call config() after localforage has been used.");for(var t in e){if("storeName"===t&&(e[t]=e[t].replace(/\W/g,"_")),"version"===t&&"number"!=typeof e[t])return new Error("Database version must be a number.");this._config[t]=e[t]}return!("driver"in e&&e.driver)||this.setDriver(this._config.driver)},Z.prototype.defineDriver=function(e,t,i){var n=new o(function(t,i){try{var n=e._driver,a=new Error("Custom driver not compliant; see https://mozilla.github.io/localForage/#definedriver");if(e._driver){for(var r=J.concat("_initStorage"),l=0,d=r.length;l<d;l++){var c=r[l];if((!G($,c)||e[c])&&"function"!=typeof e[c])return void i(a)}for(var u=0,g=$.length;u<g;u++){var p=$[u];e[p]||(e[p]=(e=>function(){var t=new Error("Method "+e+" is not implemented by the current driver");return s(t=o.reject(t),arguments[arguments.length-1]),t})(p))}var m=function(i){Y[n]&&console.info("Redefining LocalForage driver: "+n),Y[n]=e,q[n]=i,t()};"_support"in e?e._support&&"function"==typeof e._support?e._support().then(m,i):m(!!e._support):m(!0)}else i(a)}catch(a){i(a)}});return l(n,t,i),n},Z.prototype.driver=function(){return this._driver||null},Z.prototype.getDriver=function(e,t,i){return l(e=Y[e]?o.resolve(Y[e]):o.reject(new Error("Driver not found.")),t,i),e},Z.prototype.getSerializer=function(e){var t=o.resolve(B);return l(t,e),t},Z.prototype.ready=function(e){var t=this,i=t._driverSet.then(function(){return null===t._ready&&(t._ready=t._initDriver()),t._ready});return l(i,e,e),i},Z.prototype.setDriver=function(e,t,i){var n=this,a=(j(e)||(e=[e]),this._getSupportedDrivers(e));function r(){n._config.driver=n.driver()}function s(e){return n._extend(e),r(),n._ready=n._initStorage(n._config),n._ready}return e=null!==this._driverSet?this._driverSet.catch(function(){return o.resolve()}):o.resolve(),this._driverSet=e.then(function(){var e=a[0];return n._dbInfo=null,n._ready=null,n.getDriver(e).then(function(e){n._driver=e._driver,r(),n._wrapLibraryMethodsWithReady(),n._initDriver=function(e){return function(){var t=0;return function i(){for(;t<e.length;){var a=e[t];return t++,n._dbInfo=null,n._ready=null,n.getDriver(a).then(s).catch(i)}r();var l=new Error("No available storage method found.");return n._driverSet=o.reject(l),n._driverSet}()}}(a)})}).catch(function(){r();var e=new Error("No available storage method found.");return n._driverSet=o.reject(e),n._driverSet}),l(this._driverSet,t,i),this._driverSet},Z.prototype.supports=function(e){return!!q[e]},Z.prototype._extend=function(e){Q(this,e)},Z.prototype._getSupportedDrivers=function(e){for(var t=[],i=0,n=e.length;i<n;i++){var a=e[i];this.supports(a)&&t.push(a)}return t},Z.prototype._wrapLibraryMethodsWithReady=function(){for(var e=0,t=J.length;e<t;e++)((e,t)=>{e[t]=function(){var i=arguments;return e.ready().then(function(){return e[t].apply(e,i)})}})(this,J[e])},Z.prototype.createInstance=function(e){return new Z(e)},H=new Z,t.exports=H},{3:3}]},{},[4])(4)},814:e=>{var t,i,n="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto)||"undefined"!=typeof msCrypto&&"function"==typeof window.msCrypto.getRandomValues&&msCrypto.getRandomValues.bind(msCrypto);n?(t=new Uint8Array(16),e.exports=function(){return n(t),t}):(i=new Array(16),e.exports=function(){for(var e,t=0;t<16;t++)!(3&t)&&(e=4294967296*Math.random()),i[t]=e>>>((3&t)<<3)&255;return i})}},t={};function i(n){var a=t[n];return void 0!==a||(a=t[n]={exports:{}},e[n](a,a.exports,i)),a.exports}i.d=(e,t)=>{for(var n in t)i.o(t,n)&&!i.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},i.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),i.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),i.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var n,a={};{i.r(a),i.d(a,{exportForTesting:()=>Er,handleLogout:()=>cr,initializeLaunchSequence:()=>gr});var r=i(790);let Tt={INIT_DATA:"initData",BROWSER_DETAILS:"browserDetails",UNIFIED_LOGS:"unifiedLogs",HAS_USER_LOGGED_OUT:"hasUserLoggedOut",LANDING_PAGE_TRACKING:"landingPageTracking"},yt={USER_DATA:"USER_DATA",PUSH_TOKEN:"PUSH_TOKEN",SUBSCRIPTION_DETAILS:"SUBSCRIPTION_DETAILS",SETUP_TIME:"SETUP_TIME",OPT_IN_SHOWN_TIME:"OPT_IN_SHOWN_TIME",OPTED_STATUS_TRACK_TIME:"OPTED_STATUS_TRACK_TIME",SOFT_ASK_STATUS:"SOFT_ASK_STATUS",HARD_ASK_STATUS:"HARD_ASK_STATUS",WEB_SETTINGS:"WEB_SETTINGS",GRACEFUL_DATA:"GRACEFUL_DATA",Q:{PREFIX:"Q",REPORT:"REPORT",DEVICE:"DEVICE"},INIT_DATA:"INIT_DATA",OLD_SDK:{USER_DATA:"moengage_data",SUBSCRIPTION_DETAILS:"MOE_PUSH_ENDPOINT",PUSH_TOKEN:"MOE_PUSH_TOKEN"},BROWSER_DETAILS:"browserDetails",SESSION:"SESSION",DEVICE_DATA:"DEVICE_DATA",IDENTITY_MAP:"IDENTITY_MAP",SDK_VERSION:"SDK_VERSION",SDK_DISABLED:"SDK_DISABLED"},bt={SESSION_COOKIE:{EXPIRY_YEARS:2}},At="COOKIE_SHARING",Ot={COOKIE_NAME_MAPPING:{[yt.USER_DATA]:"moe_u_d",[yt.SUBSCRIPTION_DETAILS]:"moe_s_d",[yt.PUSH_TOKEN]:"moe_p_t",[yt.OPT_IN_SHOWN_TIME]:"moe_o_s_t",[yt.SOFT_ASK_STATUS]:"moe_s_a_s",[yt.HARD_ASK_STATUS]:"moe_h_a_s",[yt.SESSION]:"moe_s_n",[yt.DEVICE_DATA]:"moe_d_d",[yt.IDENTITY_MAP]:"moe_i_m",[yt.SDK_DISABLED]:"moe_dis",COOKIE_SHARING:"moe_c_s"},PERMISSION_STATE_MAPPING:{prompt:2,granted:1,dismissed:3,denied:0,shown:4,"not shown":5,allowed:6},SUBSCRIPTION_DETAILS_KEYS:{domain:"d",token:"t",endpoint:"e",keys:"k",p256dh:"p",auth:"a"},USER_DATA_KEYS:{attributes:"a",subscribedToOldSdk:"s_old",deviceUuid:"d_id",deviceAdded:"d_added"},ATTRIBUTE_KEYS:{key:"k",value:"v",updated_at:"u_at",level:"l"},IDENTITY_MAP_KEYS:{userIdentities:"u_i",previousIdentities:"p_i",previousIdentitiesUpdatedTime:"p_i_u_t"},SESSION_KEYS:{sessionKey:"s_k",sessionStartTime:"s_s_t",sessionMaxTime:"s_m_t",customIdentifiersToTrack:"c_i_t_t",sessionExpiryTime:"s_e_t",numberOfSessions:"n_o_s",currentSource:"c_s"},SOURCE_KEYS:{source:"s",medium:"m",source_url:"s_u",term:"t",campaign_name:"c_n",campaign_id:"c_id",content:"c",extra:"e"},DEVICE_DATA_KEYS:{deviceUniqueId:"d_uid"},ENDPOINT_URL_MAPPING:{"https://fcm.googleapis.com/fcm/send/":"f","https://wns2-pn1p.notify.windows.com/w/":"w","https://wns2-sin1p.notify.windows.com/":"w1","https://wns2-bay1p.notify.windows.com/":"w2","https://updates.push.services.mozilla.com/wpush/v2/":"m","https://web.push.apple.com/":"a"}},wt={USER_ATTRIBUTE:"EVENT_ACTION_USER_ATTRIBUTE",UNSUBSCRIBED:"MOE_WEB_UNSUBSCRIBED",WEB_SESSION_START:"EVENT_ACTION_WEB_SESSION_START",PAGE_VIEWED:"MOE_PAGE_VIEWED",WEB_OPTIN_BANNER_LOAD:"MOE_WEB_OPTIN_BANNER_LOAD",WEB_OPTIN_CLOSED:"MOE_WEB_OPTIN_CLOSED",WEB_OPTIN_ACCEPTED:"MOE_WEB_OPTIN_ACCEPTED",USER_SUBSCRIBED:"MOE_USER_SUBSCRIBED",OPT_IN_SHOWN:"MOE_OPT_IN_SHOWN",OPT_IN_ALLOWED:"MOE_OPT_IN_ALLOWED",OPT_IN_DISMISSED:"MOE_OPT_IN_DISMISSED",OPT_IN_BLOCKED:"MOE_OPT_IN_BLOCKED",OPT_IN_ATTEMPT:"MOE_OPT_IN_ATTEMPT",LOGOUT:"MOE_LOGOUT",DEVICE_ATTRIBUTE:"EVENT_ACTION_DEVICE_ATTRIBUTE",PERMISSION_ALLOWED:"MOE_PUSH_PERMISSION_STATE_ALLOWED",PERMISSION_BLOCKED:"MOE_PUSH_PERMISSION_STATE_BLOCKED",MOE_PAGE_EXIT:"MOE_PAGE_EXIT",MOE_PAGE_SCROLL:"MOE_PAGE_SCROLL",MOE_PAGE_URL_EVENT:"MOE_PAGE_URL_EVENT",MOE_EXIT:"MOE_EXIT"},Dt={URL:"URL",LOGGED_IN_STATUS:"moe_logged_in_status",FIRST_VISIT:"moe_first_visit"},Nt={ID:"USER_ATTRIBUTE_UNIQUE_ID",EMAIL:"USER_ATTRIBUTE_USER_EMAIL",NAME:"USER_ATTRIBUTE_USER_NAME",FIRST_NAME:"USER_ATTRIBUTE_USER_FIRST_NAME",LAST_NAME:"USER_ATTRIBUTE_USER_LAST_NAME",MOBILE:"USER_ATTRIBUTE_USER_MOBILE",GENDER:"USER_ATTRIBUTE_USER_GENDER",BDAY:"USER_ATTRIBUTE_USER_BDAY",ID_MODIFIED:"USER_ID_MODIFIED_FROM"},Ct=["id","first_name","last_name","email","mobile","name","gender","birthday"],Lt=[Nt.ID,Nt.ID_MODIFIED],Pt={MOE_LIFECYCLE:{TOPIC_NAME:"MOE_LIFECYCLE",EVENT_NAMES:{MOE_INIT:"SDK_INITIALIZED",SETTINGS_FETCHED:"SETTINGS_FETCHED",EVENT_TRACKED:"EVENT_TRACKED",DEVICE_UUID:"DEVICE_UUID",MOE_INIT_COMPLETED:"SDK_INITIALIZATION_COMPLETED",CARDS_INIT:"CARDS_INITIALIZED",SDK_DISABLED:"SDK_DISABLED",SDK_ENABLED:"SDK_ENABLED",OSM_INIT:"OSM_INITIALIZED",WEBP_INIT:"WEBP_INITIALIZED",LANDING_PAGE_DEVICE_ADD:"LANDING_PAGE_DEVICE_ADD"}},OPT_IN_LIFECYCLE:{TOPIC_NAME:"MOE_OPT_IN",EVENT_NAMES:{HARD_ASK_SHOWN:"HARD_ASK_SHOWN",HARD_ASK_DISMISSED:"HARD_ASK_DISMISSED",HARD_ASK_ATTEMPTED:"HARD_ASK_ATTEMPTED",HARD_ASK_ALLOWED:"HARD_ASK_ALLOWED",HARD_ASK_DENIED:"HARD_ASK_DENIED",SOFT_ASK_SHOWN:"SOFT_ASK_SHOWN",SOFT_ASK_DISMISSED:"SOFT_ASK_DISMISSED",SOFT_ASK_ALLOWED:"SOFT_ASK_ALLOWED"}},INAPP_LIFECYCLE:{TOPIC_NAME:"INAPP_LIFECYCLE",EVENT_NAMES:{MODULE_LOADED:"MODULE_LOADED",OSM_RENDERED:"OSM_RENDERED"}},USER_LIFECYCLE:{TOPIC_NAME:"USER_LIFECYCLE",EVENT_NAMES:{USER_IDENTITY_UPDATE:"USER_IDENTITY_UPDATE",LOGOUT:"LOGOUT"}},SPA_LIFECYCLE:{TOPIC_NAME:"SPA",EVENT_NAMES:{PAGE_CHANGED:"PAGE_CHANGED"}}},Rt={WEB_PUSH_NOT_SUPPORTED:{code:1e3,reason:"Web push not supported in current browser environment"},SERVICE_WORKER_REGISTRATION_FAILED:{code:1001,reason:"Registering the service worker failed"},WEB_PUSH_NOT_CONFIGURED:{code:1002,reason:"Web push settings not configured"},NOTIFICATION_MANAGER_NOT_CONFIGURED:{code:1003,reason:"Could not configure a notification manager for the current browser and settings"},PERMISSION_DISMISSED_TOO_MANY_TIMES:{code:1004,reason:"Hard ask was dismissed to many times"},SERVICE_WORKER_NOT_IN_CORRECT_SCOPE:{code:1005,reason:"Service worker can not be registered on this page due to scope issues"}},Mt={AMAZED:"https://media.giphy.com/media/90F8aUepslB84/giphy.gif",SAD:"https://media.giphy.com/media/KDRv3QggAjyo/giphy.gif"},kt={DC_1:"sdk-01.moengage.com",DC_2:"sdk-02.moengage.com",DC_3:"sdk-03.moengage.com",DC_4:"sdk-04.moengage.com",DC_5:"sdk-05.moengage.com",DC_6:"sdk-06.moengage.com",DC_100:"sdk-100.moengage.com",DC_101:"sdk-101.moengage.com",EU:"sdk-02.moengage.com",IN:"sdk-03.moengage.com"},xt={MOE_DASHBOARD:"https://dashboard.moengage.com",WEBSDK_DOCS:"https://developers.moengage.com/hc/en-us/articles/360060713252-Web-SDK-Integration",SELF_HANDLED_DOCS:"https://developers.moengage.com/hc/en-us/articles/360061219351-Configure-Self-Handled-Opt-In"},Bt="Dashboard --\x3e Settings --\x3e Channel --\x3e Push",Ut={SESSION:"SESSION",SESSION_KEY:"sessionKey",SESSION_START_TIME:"sessionStartTime",SESSION_EXPIRY_TIME:"sessionExpiryTime",SESSION_MAX_TIME:"sessionMaxTime",SESSION_ENABLED:"sessionEnabled",CUSTOM_IDENTIFIERS_TO_TRACK:"customIdentifiersToTrack",CURRENT_SOURCE:"currentSource",NUMBER_OF_SESSIONS:"numberOfSessions"},Ft={DATABASE_NAME:"moe_tracking",STORE_NAME:"events"},Wt={DATABASE_NAME:"moe_tracking",STORE_NAME:"batched_events"},Ht={DATABASE_NAME:"moe_database",STORE_NAME:"moe_data"},Vt={UUID:"moe_uuid"},Gt={CLUSTER:"moe_segment_cluster",SW_PATH:"moe_segment_sw_path",SW_SCOPE:"moe_segment_sw_scope",ENABLE_SPA:"moe_segment_enable_spa",CARDS:"moe_segment_cards",DISABLE_COOKIES:"moe_segment_disable_cookies",DISABLE_ONSITE:"moe_segment_disable_onsite"},Kt={PageEventHistoryManager:"MoengagePageEventHistoryManager"},jt={HOST_1:"https://sdk-01.moengage.com/",HOST_2:"https://sdk-02.moengage.com/",HOST_3:"https://sdk-03.moengage.com/",HOST_4:"https://sdk-04.moengage.com/",HOST_5:"https://sdk-05.moengage.com/",HOST_6:"https://sdk-06.moengage.com/",HOST_100:"https://sdk-100.moengage.com/",API:{META:"v3/campaigns/inapp/live",CAMPAIGN_PAYLOAD:"v3/campaigns/inapp/live/",DRAFT_CAMPAIGN_PAYLOAD:"v3/campaigns/inapp/test/",STATS:"v3/campaigns/inapp/live/v2/stats",CAMPAIGNS_PAYLOAD:"v3/campaigns/inapp/live/campaigns"},DRAFT_CAMPAIGN_TPYES:{WEB_PERSONALIZATON:"web_personalization",ONSITE_MESSAGING:"onsite_messaging"},META_REFRESH_TIME:9e5,DATABASE_NAME:"moe_onsite",OSM_MODULE:"moeOnsite",DELIVERY_FUNNEL:{ATTEMPTED:{CAMPAIGN_ATTEMPTED:"ATM"},PRIORITIZED:{CAMPAIGN_PRIORITY_HIGH_PRIORITY_CAMPAIGN_AVAILABLE:"PRT_HIGH_PRT_CMP_AVL",CAMPAIGN_PRIORITY_MAX_TIMES_SHOWN:"PRT_MAX_TIM_SWN",CAMPAIGN_PRIORITY_MIN_DELAY:"PRT_MIN_DEL",CAMPAIGN_PRIORITY_GLOBAL_DELAY:"PRT_GBL_DEL",CAMPAIGN_PRIORITY_EXPIRED:"PRT_EXP"},DELIVERED:{CAMPAIGN_DELIVERED_API_FAILURE:"DLV_API_FLR",CAMPAIGN_DELIVERED_MANDATORY_PARAMS_MISSING:"DLV_MAND_PARM_MIS"},IMPRESSION:{CAMPAIGN_IMPRESSION_URL_CHANGED:"IMP_URL_CHG",CAMPAIGN_IMPRESSION_GLOBAL_DELAY:"IMP_GBL_DEL",CAMPAIGN_IMPRESSION_MAX_TIMES_SHOWN:"IMP_MAX_TIM_SHW",CAMPAIGN_IMPRESSION_ANOTHER_CAMPAIGN_VISIBLE:"IMP_ANTR_CMP_VISB",CAMPAIGN_IMPRESSION_CANCEL_BEFORE_DELAY:"IMP_CNCL_BFR_DEL"},EVALUATION:{CAMPAIGN_EVALUATION_PATH_TIME_EXPIRED:"EVL_PATH_TIME_EXP",CAMPAIGN_EVALUATION_USER_NOT_ON_APP:"EVL_USER_NOT_ON_APP"}},STORES:{CAMPAIGNS_META:{NAME:"campaigns_meta"},CAMPAIGNS_TAGS:{NAME:"campaigns_tags"},CAMPAIGNS_STATS:{NAME:"campaigns_stats"},EXIT_INTENT_CAMPAIGN_STORE:{NAME:"exit_intent"},SERVICE_META:{NAME:"service_meta",KEYS:{LAST_META_CALL_TIME:"last_meta_call_time",GLOBAL_DELAY:"global_delay_between_inapps",LAST_INAPP_SHOWN_TIME:"last_inapp_shown",LAST_FETCH_SDK_VERSION:"last_fetch_sdk_version",UNIQUE_ID:"unique_id"}},PENDING_SECONDARY_EVENTS:{NAME:"pending_secondary_events"},PENDING_TIMER_CAMPAIGNS:{NAME:"pending_timer_campaigns"},TRIGGERING_PRIMARY_EVENTS:{NAME:"triggering_primary_events"}},EVENT_NAMES:{OSM:{CLICK:"MOE_ONSITE_MESSAGE_CLICKED",IMPRESSION:"MOE_ONSITE_MESSAGE_SHOWN",DISMISS:"MOE_ONSITE_MESSAGE_DISMISSED",AUTO_DISMISS:"MOE_ONSITE_MESSAGE_AUTO_DISMISS",DELIVERED:"MOE_ONSITE_MESSAGE_DELIVERED",TYPE:"onsite"},WP:{CLICK:"MOE_WEBP_MESSAGE_CLICKED",IMPRESSION:"MOE_WEBP_MESSAGE_SHOWN",DISMISS:"MOE_WEBP_MESSAGE_DISMISSED",DELIVERED:"MOE_WEBP_MESSAGE_DELIVERED",TYPE:"webp"}},WEB_HELPER_IFRAME_URL:"https://cdn.moengage.com/webpush/beta/webpushhelper.html",IFRAME_CHANNEL:"inapp_helper",IFRAME_TOPICS:{COOKIE_STORAGE:"COOKIE_STORAGE"},COOKIE_STORAGE:{TEST_DRAFT_TYPE:"moe_inapp_draft_type",TEST_DRAFT_ID:"moe_inapp_draft_id",TEST_DRAFT_TAG:"moe_inapp_draft_tag",TEST_CAMPAIGN_META:"test_campaign_meta",TEST_TEMPLATE_TYPE:"test_template_type",TEST_VARIATION:"moe_inapp_draft_variation",TEST_LOCALE:"moe_inapp_draft_locale"},CSS_SELECTORS:{CLICK_INAPP:"moe-inapp-click",DISMISS_INAPP:"moe-inapp-close"},EXIT_INTENT:{CONFIG:{SCROLL_DOWN_THRESHOLD:50,SCROLL_UP_THRESHOLD:5,SCROLL_INTERVAL:1e3}},POSITIONED_TEMPLATE:'data-editor-type="MOE_EDITOR"',SIDE_BANNER:'data-template-type="SIDE_BANNER"',PUSH_BANNER:"moe-osm-pusher",GCG_ERROR_CODE:"E001",SCROLL_CAMPAIGN_THROTTLING_TIME:1500,MAX_SELF_HANDLE_OSM_CAMPAIGNS:5},Yt={CARDS:{name:"CARDS",src:"https://cdn.moengage.com/webpush/moe_webSdk_cards.min.latest.js",windowLocation:"moeCards"}},qt={DATABASE_NAME:"moe_database",OFFLINE_SYNC_EVENT:"moe_offline_data_sync",STORES:{OFFLINE_DATA:{NAME:"offline_data"}}},zt={API:{REPORT_ADD:"v2/sdk/report/"},CONFIG:{TIME_BETWEEN_BATCHES:15e3}},$t={NUMBER:"number"},Jt={FIRST_SEEN_SESSIONS:1},Xt={TOPIC:"MOE_AUTOMATED_EVENTS",NAMES:[wt.UNSUBSCRIBED,wt.WEB_SESSION_START,wt.PAGE_VIEWED,wt.WEB_OPTIN_BANNER_LOAD,wt.WEB_OPTIN_CLOSED,wt.WEB_OPTIN_ACCEPTED,wt.USER_SUBSCRIBED,wt.OPT_IN_ATTEMPT,wt.OPT_IN_SHOWN,wt.OPT_IN_ALLOWED,wt.OPT_IN_DISMISSED,wt.OPT_IN_BLOCKED,wt.PERMISSION_ALLOWED,wt.PERMISSION_BLOCKED,wt.LOGOUT,jt.EVENT_NAMES.OSM.CLICK,jt.EVENT_NAMES.OSM.IMPRESSION,jt.EVENT_NAMES.OSM.DISMISS,jt.EVENT_NAMES.OSM.AUTO_DISMISS]},Qt=[wt.OPT_IN_ATTEMPT],Zt={DEFAULT:"default",PROMPT:"prompt",DENIED:"denied"},ei="IOS_PERMISSION_DENIED",ti={MOE_PUSH_OPTED:"moe_push_opted"},ii={END_POINT:"v1/sdk_logging/"},ni={IMPRESSION:"MOE_WEBP_MESSAGE_SHOWN",CLICK:"MOE_WEBP_MESSAGE_CLICKED",OFFERING_CLICKED:"MOE_OFFERING_CLICKED",OFFERING_SHOWN:"MOE_OFFERING_SHOWN"},ai={IMPRESSION:"MOE_LANDING_PAGE_SHOWN",CLICK:"MOE_LANDING_PAGE_CLICKED",FORM_SUBMIT:"MOE_RESPONSE_SUBMITTED"},ri={API:{DEVICE_ADD:"v2/device/add",DEVICE_TOKEN_CHECK:"v2/device/token-check",REPORT_ADD:"v2/report/add"},MAX_PAYLOAD_SIZE:195},oi={TV:"tv",TABLET:"tablet",MOBILE:"mobile",WEB:"web"},si={TIZEN:"Tizen",WEB_OS:"WebOS",XBOX:"Xbox",VIZIO:"viziotv",DEFAULT:"SmartTV"},li="User is offline.",di=[{moeName:"uid",attributeName:"USER_ATTRIBUTE_UNIQUE_ID",programName:"id"},{moeName:"u_em",attributeName:"USER_ATTRIBUTE_USER_EMAIL",programName:"email"},{moeName:"u_gd",attributeName:"USER_ATTRIBUTE_USER_GENDER",programName:"gender"},{moeName:"u_bd",attributeName:"USER_ATTRIBUTE_USER_BDAY",programName:"birthday"},{moeName:"u_n",attributeName:"USER_ATTRIBUTE_USER_NAME",programName:"name"},{moeName:"u_fn",attributeName:"USER_ATTRIBUTE_USER_FIRST_NAME",programName:"first_name"},{moeName:"u_ln",attributeName:"USER_ATTRIBUTE_USER_LAST_NAME",programName:"last_name"},{moeName:"u_mb",attributeName:"USER_ATTRIBUTE_USER_MOBILE",programName:"mobile"}],ci=["Google Chrome","Mozilla Firefox","Opera","Apple Safari","Edge"],ui="identifiers",gi=["moe-card=1"],pi=[yt.DEVICE_DATA],mi="A pop-up has appeared on screen",hi={FLOATING_ICON_IFRAME:"moe-floating-icon-iframe",FLOATING_ICON_ID:"moe-floating-icon"};function o(e,t,i){return null!=e&&t?(e=e[(t=Array.isArray(t)?t:t.split("."))[0]])&&1<t.length?o(e,t.slice(1),i):void 0===e?i||null:e:null}class Ei{static set(e,t){Ei.baseLogTag,window&&(window.moeInternals?window.moeInternals.ephemeral||(window.moeInternals.ephemeral={}):(window.moeInternals={},window.moeInternals.ephemeral={}),window.moeInternals.ephemeral[e]=t)}static get(e){return o(window,"moeInternals.ephemeral."+e,null)}static clear(){window&&(window.moeInternals={},window.moeInternals.ephemeral={})}}function s(){return window[window.moengage_object||"Moengage"]}Ei.baseLogTag="EphemeralStorage";class vi{static logData(e,t){return{log_type:e,sent_time:(new Date).toISOString(),lake_fields:t}}static setRemoteLogging(e,t){return this.isTrackingEnabled||(this.logLevel=e,this.isTrackingEnabled=t),this.isTrackingEnabled}static log(e,t,i,n,...a){!this.isTrackingEnabled||e!==this.logLevel&&"verbose"!==this.logLevel||s().remoteLogs.addRemoteLogs(this.logData(e,{msg:i+[...a].toString(),file_name:t,trace:n}))}}let fi="color: white; background: #41AE55; border-radius: 5px;";class Si{static setLogLevel(e,t){var i=Si.baseLogTag+".setLogLevel";null==Ei.get(Tt.UNIFIED_LOGS)&&Ei.set(Tt.UNIFIED_LOGS,[]),null==e?Si.logLevel=0:e in[0,1,2]?0<(Si.logLevel=e)&&t&&Si.releaseAllLogs():Si.warn(0,i,"Value",e,"not supported for setDebugLevel(). Current log level is",Si.logLevel,". Debug level can only be [0, 1, 2]")}static setLogTabStyle(e){Si.tagLogStyle=Si.tagLogStyle.replace("#48beab",e)}static log(e,t,i,...n){e<=Si.logLevel?console.log("%c "+Si.logBrand+" %c %c info %c %c "+t+" ",fi,"","color: white; background: #18a0bf; border-radius: 5px;","",Si.tagLogStyle,i,...n):Si.cacheLog(()=>{Si.log(e,t,i,...n)})}static remoteLogTracking(e,t,i,n,...a){vi.log(t,i,n,...a),this.log(e,i,n,...a)}static error(e,t,i,...n){var a;null!=(a=n[n.length-1])&&a.isCached||vi.log("error",t,i,...n),e<=Si.logLevel?console.error("%c "+Si.logBrand+" %c %c error %c %c "+t+" ",fi,"","color: white; background: #cc0a0a; border-radius: 5px;","",Si.tagLogStyle,i,...n.slice(0,-1)):Si.cacheLog(()=>{Si.error(e,t,i,...n,{isCached:!0})})}static warn(e,t,i,...n){var a;null!=(a=n[n.length-1])&&a.isCached||vi.log("warning",t,i,...n),e<=Si.logLevel?console.warn("%c "+Si.logBrand+" %c %c warn %c %c "+t+" ",fi,"","color: white; background: #e8ab51; border-radius: 5px;","",Si.tagLogStyle,i,...n.slice(0,-1)):Si.cacheLog(()=>{Si.warn(e,t,i,...n,{isCached:!0})})}static customLabel(e,t,i,...n){e<=Si.logLevel?console.log("%c "+Si.logBrand+" %c %c "+t+" %c %c "+i+" %c ",fi,"",Si.tagLogStyle,"","color: white; background: #a400ff; border-radius: 5px;","",...n):Si.cacheLog(()=>{Si.customLabel(e,t,i,...n)})}static image(e,t){e<=Si.logLevel?console.log("%c+","font-size: 1px; padding: 20px 80px; line-height: 45px; background: url("+t+"); background-size: 160px 90px; color: transparent;"):Si.cacheLog(()=>{Si.image(e,t)})}static releaseAllLogs(){var e=Ei.get(Tt.UNIFIED_LOGS),t=e.length,i=e;if(Ei.set(Tt.UNIFIED_LOGS,[]),0<t){Si.log(0,"Logger.releaseAllLogs","<---- HISTORICAL LOGS BEGIN ----\x3e");for(let e=0;e<t;e++)i[e]();Si.log(0,"Logger.releaseAllLogs","<---- HISTORICAL LOGS END ----\x3e")}}static setLogBrand(e){Si.logBrand=e}static setBrandColor(e){fi="color: white; background: "+e+"; border-radius: 5px;"}static cacheLog(e){let t=Ei.get(Tt.UNIFIED_LOGS);(t=null==t?[]:t).push(e),Ei.set(Tt.UNIFIED_LOGS,t)}}Si.baseLogTag="Logger",Si.logBrand="MoEngage",Si.logLevel=0,Si.tagLogStyle="color: white; background: #48beab; border-radius: 5px;";class _i{constructor(e){this.debugLevel=0,this.cluster=null,this.environment=null,this.baseDomainName="https://sdk-01.moengage.com/",this.inapp=null,this.customSoftAsk=null;var t=_i.baseLogTag+".constructor";null!=o(e,"app_id",null)?(this.appId=o(e,"app_id",null),this.integrationType=n.OLD_SDK):null!=o(e,"appId",null)?(this.appId=o(e,"appId",null),this.integrationType=n.NEW_SDK):(Si.error(1,t,"App Id not specified. Please check docs page to complete the integration - ",xt.WEBSDK_DOCS),this.integrationType=null),null!=o(e,"debug_logs",null)?this.debugLevel=o(e,"debug_logs",0):null!=o(e,"debugLevel",null)?this.debugLevel=o(e,"debugLevel",0):(Si.log(2,t,"No log level config found. Using default value of",0),this.debugLevel=0),this.appId&&(this.baseDomainName="https://sdk-01.moengage.com/",this.forceSwUpdate=o(e,"forceSwUpdate",!1),this.cluster=o(e,"cluster",this.cluster),this.cluster&&null!=kt[this.cluster.toUpperCase()]&&(this.environment=kt[this.cluster.toUpperCase()]),o(e,"environment",null)&&(this.environment=e.environment),this.environment&&(this.baseDomainName="https://"+this.environment+"/"),0<this.debugLevel&&this.appId.indexOf("_DEBUG")<0?this.appId=this.appId+"_DEBUG":0===this.debugLevel&&0<=this.appId.indexOf("_DEBUG")&&(this.appId=this.appId.substr(0,this.appId.indexOf("_DEBUG"))),this.swPath=o(e,"swPath",null),null!=e.customSoftAsk?this.customSoftAsk={mainClass:o(e,"customSoftAsk.mainClass",null),allowClass:o(e,"customSoftAsk.allowClass",null),dismissClass:o(e,"customSoftAsk.dismissClass",null)}:this.customSoftAsk={mainClass:o(e,"main_class",null),allowClass:o(e,"allow_class",null),dismissClass:o(e,"block_class",null)},null!=o(e,"inapp.host",null)&&(this.inapp={host:o(e,"inapp.host",null)}),null!=o(e,"swScope",null)&&(this.swScope=o(e,"swScope",null)),null!=o(e,"disable_onsite",null)&&(this.disableOnsite=o(e,"disable_onsite",!1)),null!=o(e,"enableSPA",null)&&(this.enableSPA=o(e,"enableSPA",!1)),null!=o(e,"cards",null)&&(this.cards=o(e,"cards",{})),null!=o(e,"proxyDomains",null)&&(this.proxyDomains=o(e,"proxyDomains",null),this.proxyDomains.api)&&(this.baseDomainName="https://"+this.proxyDomains.api+"/",this.environment=this.proxyDomains.api),null!=o(e,"disable_web_push",null)&&(this.disableWebPush=o(e,"disable_web_push",!1)),null!=o(e,"disableCookies",null)&&(this.disableCookies=o(e,"disableCookies",!1)),null!=o(e,"disableSdk",null)&&(this.disableSdk=o(e,"disableSdk",!1)),null!=o(e,"project_id",null))&&(this.projectId=o(e,"project_id",null))}static save(e){Ei.set(Tt.INIT_DATA,new _i(e)),Li.set(yt.INIT_DATA,new _i(e))}static get(){return Ei.get(Tt.INIT_DATA)}}function l(e,t){return!_i.get().disableWebPush&&e.isWebPushEnabled&&0<=ci.indexOf(t.name)&&navigator.serviceWorker&&"PushManager"in window&&"Notification"in window}function d(e,t){var i;return t.isChrome()||t.isOpera()||t.isEdge()||t.isSafari()?"vapid"===(null==(i=null==e?void 0:e.chrome)?void 0:i.subscriptionMode)&&null!=(i=null==e?void 0:e.chrome)&&i.vapidPublicKey:t.isFirefox()&&"vapid"===(null==(i=null==e?void 0:e.firefox)?void 0:i.subscriptionMode)&&null!=(t=null==e?void 0:e.firefox)&&t.vapidPublicKey}function c(){var e=null==(e=_i.get())?void 0:e.swPath;return!(!e||!e.includes("tools/moengage"))}function u(e,t){return!(e!==Nt.EMAIL&&e!==Nt.MOBILE&&!t.includes(e))}function g(e,t){var i;return t.isChrome()||t.isOpera()||t.isEdge()||t.isSafari()?(null==(i=null==e?void 0:e.chrome)?void 0:i.vapidPublicKey)||"":t.isFirefox()&&(null==(i=null==e?void 0:e.firefox)?void 0:i.vapidPublicKey)||""}_i.baseLogTag="InitData",(a=n=n||{}).OLD_SDK="OLD_SDK",a.NEW_SDK="NEW_SDK";var p=Uint8Array,m=Uint16Array,h=Int32Array,E=new p([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),v=new p([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),f=new p([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),S=(a=function(e,t){for(var i=new m(31),n=0;n<31;++n)i[n]=t+=1<<e[n-1];var a=new h(i[30]);for(n=1;n<30;++n)for(var r=i[n];r<i[n+1];++r)a[r]=r-i[n]<<5|n;return{b:i,r:a}})(E,2),_=S.b,I=S.r;_[28]=258,I[258]=28;for(var T=(S=a(v,0)).b,y=S.r,b=new m(32768),A=0;A<32768;++A){var O=(43690&A)>>1|(21845&A)<<1;b[A]=((65280&(O=(61680&(O=(52428&O)>>2|(13107&O)<<2))>>4|(3855&O)<<4))>>8|(255&O)<<8)>>1}var w=function(e,t,i){for(var n=e.length,a=0,r=new m(t);a<n;++a)e[a]&&++r[e[a]-1];var o=new m(t);for(a=1;a<t;++a)o[a]=o[a-1]+r[a-1]<<1;if(i){var s=new m(1<<t),l=15-t;for(a=0;a<n;++a)if(e[a])for(var d=a<<4|e[a],c=t-e[a],u=o[e[a]-1]++<<c,g=u|(1<<c)-1;u<=g;++u)s[b[u]>>l]=d}else for(s=new m(n),a=0;a<n;++a)e[a]&&(s[a]=b[o[e[a]-1]++]>>15-e[a]);return s},D=new p(288);for(A=0;A<144;++A)D[A]=8;for(A=144;A<256;++A)D[A]=9;for(A=256;A<280;++A)D[A]=7;for(A=280;A<288;++A)D[A]=8;var N=new p(32);for(A=0;A<32;++A)N[A]=5;var C=w(D,9,0),L=w(D,9,1),P=w(N,5,0),R=w(N,5,1),M=function(e){for(var t=e[0],i=1;i<e.length;++i)t<e[i]&&(t=e[i]);return t},k=function(e,t,i){var n=t/8|0;return(e[n]|e[1+n]<<8)>>(7&t)&i},x=function(e,t){var i=t/8|0;return(e[i]|e[1+i]<<8|e[2+i]<<16)>>(7&t)},B=function(e){return(e+7)/8|0},U=function(e,t,i){return(null==i||i>e.length)&&(i=e.length),new p(e.subarray(t=null==t||t<0?0:t,i))},F=["unexpected EOF","invalid block type","invalid length/literal","invalid distance","stream finished","no stream handler",,"no callback","invalid UTF-8 data","extra field too long","date not in range 1980-2099","filename too long","stream finishing","invalid zip data"],W=function(e,t,i){if((t=new Error(t||F[e])).code=e,Error.captureStackTrace&&Error.captureStackTrace(t,W),i)return t;throw t},H=function(e,t,i){var n=t/8|0;e[n]|=i<<=7&t,e[1+n]|=i>>8},V=function(e,t,i){var n=t/8|0;e[n]|=i<<=7&t,e[1+n]|=i>>8,e[2+n]|=i>>16},G=function(e,t){for(var i=[],n=0;n<e.length;++n)e[n]&&i.push({s:n,f:e[n]});var a=i.length,r=i.slice();if(!a)return{t:J,l:0};if(1==a)return(v=new p(i[0].s+1))[i[0].s]=1,{t:v,l:1};i.sort(function(e,t){return e.f-t.f}),i.push({s:-1,f:25001});var o=i[0],s=i[1],l=0,d=1,c=2;for(i[0]={s:-1,f:o.f+s.f,l:o,r:s};d!=a-1;)o=i[i[l].f<i[c].f?l++:c++],s=i[l!=d&&i[l].f<i[c].f?l++:c++],i[d++]={s:-1,f:o.f+s.f,l:o,r:s};var u=r[0].s;for(n=1;n<a;++n)r[n].s>u&&(u=r[n].s);var g=new m(u+1),h=K(i[d-1],g,0);if(t<h){n=0;var E=0,v=h-t,f=1<<v;for(r.sort(function(e,t){return g[t.s]-g[e.s]||e.f-t.f});n<a;++n){var S=r[n].s;if(!(g[S]>t))break;E+=f-(1<<h-g[S]),g[S]=t}for(E>>=v;0<E;){var _=r[n].s;g[_]<t?E-=1<<t-g[_]++-1:++n}for(;0<=n&&E;--n){var I=r[n].s;g[I]==t&&(--g[I],++E)}h=t}return{t:new p(g),l:h}},K=function(e,t,i){return-1==e.s?Math.max(K(e.l,t,i+1),K(e.r,t,i+1)):t[e.s]=i},j=function(e){for(var t=e.length;t&&!e[--t];);for(var i=new m(++t),n=0,a=e[0],r=1,o=function(e){i[n++]=e},s=1;s<=t;++s)if(e[s]==a&&s!=t)++r;else{if(!a&&2<r){for(;138<r;r-=138)o(32754);2<r&&(o(10<r?r-11<<5|28690:r-3<<5|12305),r=0)}else if(3<r){for(o(a),--r;6<r;r-=6)o(8304);2<r&&(o(r-3<<5|8208),r=0)}for(;r--;)o(a);r=1,a=e[s]}return{c:i.subarray(0,n),n:t}},Y=function(e,t){for(var i=0,n=0;n<t.length;++n)i+=e[n]*t[n];return i},q=function(e,t,i){var n=i.length,a=B(t+2);e[a]=255&n,e[a+1]=n>>8,e[a+2]=255^e[a],e[a+3]=255^e[a+1];for(var r=0;r<n;++r)e[a+r+4]=i[r];return 8*(a+4+n)},z=function(e,t,i,n,a,r,o,s,l,d,c){H(t,c++,i),++a[256];for(var u=(i=G(a,15)).t,g=(i=i.l,(p=G(r,15)).t),p=p.l,h=(S=j(u)).c,S=S.n,_=(I=j(g)).c,I=I.n,T=new m(19),y=0;y<h.length;++y)++T[31&h[y]];for(y=0;y<_.length;++y)++T[31&_[y]];for(var b=(A=G(T,7)).t,A=A.l,O=19;4<O&&!b[f[O-1]];--O);var L=d+5<<3,R=Y(a,D)+Y(r,N)+o;if(a=Y(a,u)+Y(r,g)+o+14+3*O+Y(T,b)+2*T[16]+3*T[17]+7*T[18],0<=l&&L<=R&&L<=a)return q(t,c,e.subarray(l,l+d));if(H(t,c,1+(a<R)),c+=2,a<R){var M=w(u,i,0),k=u,x=w(g,p,0),B=g,U=w(b,A,0);for(H(t,c,S-257),H(t,c+5,I-1),H(t,c+10,O-4),c+=14,y=0;y<O;++y)H(t,c+3*y,b[f[y]]);c+=3*O;for(var F=[h,_],W=0;W<2;++W){var K=F[W];for(y=0;y<K.length;++y){var z=31&K[y];H(t,c,U[z]),c+=b[z],15<z&&(H(t,c,K[y]>>5&127),c+=K[y]>>12)}}}else M=C,k=D,x=P,B=N;for(y=0;y<s;++y){var $,J=n[y];255<J?(V(t,c,M[257+(z=J>>18&31)]),c+=k[z+257],7<z&&(H(t,c,J>>23&31),c+=E[z]),V(t,c,x[$=31&J]),c+=B[$],3<$&&(V(t,c,J>>5&8191),c+=v[$])):(V(t,c,M[J]),c+=k[J])}return V(t,c,M[256]),c+k[256]},$=new h([65540,131080,131088,131104,262176,1048704,1048832,2114560,2117632]),J=new p(0);var X="undefined"!=typeof TextEncoder&&new TextEncoder,Q="undefined"!=typeof TextDecoder&&new TextDecoder;try{Q.decode(J,{stream:!0})}catch(vr){}function Z(e){try{let n=e.replace(/-/g,"+").replace(/_/g,"/");for(;n.length%4;)n+="=";var t=atob(n),i=new Uint8Array(t.length);for(let e=0;e<t.length;e++)i[e]=t.charCodeAt(e);return function(e,t){var i;if(t){for(var n="",a=0;a<e.length;a+=16384)n+=String.fromCharCode.apply(null,e.subarray(a,a+16384));return n}return Q?Q.decode(e):(i=(t=function(e){for(var t="",i=0;;){var n=e[i++],a=(127<n)+(223<n)+(239<n);if(e.length<i+a)return{s:t,r:U(e,i-1)};a?3==a?(n=((15&n)<<18|(63&e[i++])<<12|(63&e[i++])<<6|63&e[i++])-65536,t+=String.fromCharCode(55296|n>>10,56320|1023&n)):t+=1&a?String.fromCharCode((31&n)<<6|63&e[i++]):String.fromCharCode((15&n)<<12|(63&e[i++])<<6|63&e[i++]):t+=String.fromCharCode(n)}}(e)).s,(n=t.r).length&&W(8),i)}(function(e,t){return function(e,t,i,n){var a=e.length,r=n?n.length:0;if(!a||t.f&&!t.l)return i||new p(0);function o(e){var t=i.length;t<e&&((t=new p(Math.max(2*t,e))).set(i),i=t)}var s=!i,l=s||2!=t.i,d=t.i,c=(s&&(i=new p(3*a)),t.f||0),u=t.p||0,g=t.b||0,m=t.l,h=t.d,S=t.m,I=t.n,y=8*a;do{if(!m){c=k(e,u,1);var b=k(e,u+1,3);if(u+=3,!b){var A=e[(G=B(u)+4)-4]|e[G-3]<<8;if(a<(F=G+A)){d&&W(0);break}l&&o(g+A),i.set(e.subarray(G,F),g),t.b=g+=A,t.p=u=8*F,t.f=c;continue}if(1==b)m=L,h=R,S=9,I=5;else if(2==b){A=k(e,u,31)+257;for(var O=k(e,u+10,15)+4,D=A+k(e,u+5,31)+1,N=(u+=14,new p(D)),C=new p(19),P=0;P<O;++P)C[f[P]]=k(e,u+3*P,7);u+=3*O;var F,H=(1<<(F=M(C)))-1,V=w(C,F,1);for(P=0;P<D;){var G,K=V[k(e,u,H)];if(u+=15&K,(G=K>>4)<16)N[P++]=G;else{var j=0,Y=0;for(16==G?(Y=3+k(e,u,3),u+=2,j=N[P-1]):17==G?(Y=3+k(e,u,7),u+=3):18==G&&(Y=11+k(e,u,127),u+=7);Y--;)N[P++]=j}}var q=N.subarray(0,A),z=N.subarray(A);S=M(q),I=M(z),m=w(q,S,1),h=w(z,I,1)}else W(1);if(y<u){d&&W(0);break}}l&&o(g+131072);for(var $=(1<<S)-1,J=(1<<I)-1,X=u;;X=u){var Q=(j=m[x(e,u)&$])>>4;if(y<(u+=15&j)){d&&W(0);break}if(j||W(2),Q<256)i[g++]=Q;else{if(256==Q){X=u,m=null;break}var Z,ee=Q-254,te=(264<Q&&(Z=E[P=Q-257],ee=k(e,u,(1<<Z)-1)+_[P],u+=Z),(Q=h[x(e,u)&J])>>4);if(Q||W(3),u+=15&Q,z=T[te],3<te&&(Z=v[te],z+=x(e,u)&(1<<Z)-1,u+=Z),y<u){d&&W(0);break}l&&o(g+131072);var ie=g+ee;if(g<z){var ne=r-z,ae=Math.min(z,ie);for(ne+g<0&&W(3);g<ae;++g)i[g]=n[ne+g]}for(;g<ie;++g)i[g]=i[g-z]}}t.l=m,t.p=X,t.b=g,t.f=c,m&&(c=1,t.m=S,t.d=h,t.n=I)}while(!c);return g!=i.length&&s?U(i,0,g):i.subarray(0,g)}(e,{i:2},t&&t.out,t&&t.dictionary)}(i))}catch(e){return null}}function ee(e){if("undefined"!=typeof document){var t=e+"=",i=document.cookie.split(";");for(let a=0;a<i.length;a++){var n=i[a].trim();if(0===n.indexOf(t)){n=n.substring(t.length);try{return decodeURIComponent(n)}catch(e){return n}}}}return null}let{SUBSCRIPTION_DETAILS_KEYS:Ii,USER_DATA_KEYS:Ti,ATTRIBUTE_KEYS:yi,IDENTITY_MAP_KEYS:bi,SESSION_KEYS:Ai,SOURCE_KEYS:Oi,DEVICE_DATA_KEYS:wi}=Ot;function te(e){var t,i,n,a,r,o,s;return e&&(({domain:t,token:i,endpoint:n,keys:a,p256dh:r,auth:o}=Ii),s={},e[t]&&(s.domain=e[t]),e[i]&&(s.token=e[i]),e[n]&&("string"==typeof e[n]&&e[n].startsWith("h://")?s.endpoint=e[n].replace("h://","https://"):s.endpoint=e[n]),e[a]&&(s.keys={},e[a][r]&&(s.keys.p256dh=e[a][r]),e[a][o])&&(s.keys.auth=e[a][o]),s)}function ie(e){if(!e)return e;var{attributes:t,subscribedToOldSdk:i,deviceUuid:n,deviceAdded:a}=Ti;let{key:r,value:o,updated_at:s,level:l}=yi;var d={};return e[t]&&(d.attributes=e[t].map(e=>{var t,i,n={};return e[r]&&(n.key=(t=e[r],(i=di.find(e=>e.moeName===t))?i.attributeName:t)),void 0!==e[o]&&(n.value=e[o]),void 0!==e[s]&&(n.updated_at=e[s]),void 0!==e[l]&&(n.level=e[l]),n})),void 0!==e[i]&&(d.subscribedToOldSdk=e[i]),e[n]&&(d.deviceUuid=e[n]),void 0!==e[a]&&(d.deviceAdded=e[a]),d}function ne(e){var t,i,n,a;return e&&(({userIdentities:t,previousIdentities:i,previousIdentitiesUpdatedTime:n}=bi),a={},e[t]&&(a.userIdentities=e[t]),e[i]&&(a.previousIdentities=e[i]),void 0!==e[n]&&(a.previousIdentitiesUpdatedTime=e[n]),a)}function ae(e){var t,i,n,a,r,o,s,l;return e&&(({sessionKey:t,sessionStartTime:i,sessionMaxTime:n,customIdentifiersToTrack:a,sessionExpiryTime:r,numberOfSessions:o,currentSource:s}=Ai),l={},e[t]&&(l.sessionKey=e[t]),e[i]&&(l.sessionStartTime=e[i]),void 0!==e[n]&&(l.sessionMaxTime=e[n]),e[a]&&(l.customIdentifiersToTrack=e[a]),void 0!==e[r]&&(l.sessionExpiryTime=e[r]),void 0!==e[o]&&(l.numberOfSessions=e[o]),e[s]&&(l.currentSource=(e=>{var t,i,n,a,r,o,s,l,d;return e&&(({source:t,medium:i,source_url:n,term:a,campaign_name:r,campaign_id:o,content:s,extra:l}=Oi),d={},e[t]&&(d.source=e[t]),e[i]&&(d.medium=e[i]),e[n]&&(d.source_url=e[n]),e[a]&&(d.term=e[a]),e[r]&&(d.campaign_name=e[r]),e[o]&&(d.campaign_id=e[o]),e[s]&&(d.content=e[s]),e[l]&&(d.extra=e[l]),d)})(e[s])),l)}class Di{static getCompressedKeyName(e){return Ot.COOKIE_NAME_MAPPING[e]||e}static getOriginalName(e){return Di.REVERSE_COOKIE_NAME_MAPPING[e]||e}static getCookieVersion(e,t){if([Ot.COOKIE_NAME_MAPPING[At],Ot.COOKIE_NAME_MAPPING[yt.HARD_ASK_STATUS],Ot.COOKIE_NAME_MAPPING[yt.SOFT_ASK_STATUS],Vt.UUID,Ot.COOKIE_NAME_MAPPING[yt.OPT_IN_SHOWN_TIME],Ot.COOKIE_NAME_MAPPING[yt.SDK_DISABLED]].includes(e))return 3;if(!Object.keys(Ot.COOKIE_NAME_MAPPING).includes(e)&&Object.values(Ot.COOKIE_NAME_MAPPING).includes(e))try{let a;try{if(a=JSON.parse(t),Di.hasV3Structure(a,e))return 3;if("string"==typeof a){var i=Z(a);if(null!==i)try{return JSON.parse(i),3}catch(e){}}return 2}catch(e){var n=Z(t);if(null!==n)try{return a=JSON.parse(n),3}catch(e){}return 2}}catch(e){return 2}return 1}static hasV3Structure(e,t){if(!e||"object"!=typeof e)return!1;switch(Di.getOriginalName(t)){case yt.SUBSCRIPTION_DETAILS:return e.e&&"string"==typeof e.e&&e.e.length<=2;case yt.USER_DATA:return e.d_uid||e.a&&!Array.isArray(e.a)||!e.hasOwnProperty("a");case yt.IDENTITY_MAP:return!e.hasOwnProperty("p_i")||!e.hasOwnProperty("p_i_u_t");case yt.SESSION:return e.s_s_t&&"number"==typeof e.s_s_t;default:return!1}}static getAllCookieNames(e){var t=[e],i=Ot.COOKIE_NAME_MAPPING[e];return i&&i!==e&&t.push(i),t}static compressValue(e,t){if(null==e)return e;if("object"!=typeof e||Array.isArray(e))return"boolean"!=typeof e||t!==yt.SDK_DISABLED&&t!==At?"string"==typeof e&&Object.keys(Ot.PERMISSION_STATE_MAPPING).includes(e)?Ot.PERMISSION_STATE_MAPPING[e]:e:e?1:0;if(null===(e=Di.compressObjectV3(e,t)))return null;var i=(e=>{try{var t=function(e){return function(e,t,i,n,a){var r,o;return a||(a={l:1},t.dictionary&&(r=t.dictionary.subarray(-32768),(o=new p(r.length+e.length)).set(r),o.set(e,r.length),e=o,a.w=r.length)),function(e,t,i,n,a,r){var o=r.z||e.length,s=new p(n+o+5*(1+Math.ceil(o/7e3))+a),l=s.subarray(n,s.length-a),d=r.l,c=7&(r.r||0);if(t){c&&(l[0]=r.r>>3);for(var u=(t=$[t-1])>>13,g=8191&t,f=(1<<i)-1,S=r.p||new m(32768),_=r.h||new m(1+f),T=Math.ceil(i/3),b=2*T,A=function(t){return(e[t]^e[t+1]<<T^e[t+2]<<b)&f},O=new h(25e3),w=new m(288),D=new m(32),N=0,C=0,L=r.i||0,P=0,R=r.w||0,M=0;L+2<o;++L){var k=A(L),x=32767&L,F=_[k];if(S[x]=F,_[k]=x,R<=L){var W=o-L;if((7e3<N||24576<P)&&(423<W||!d)){c=z(e,l,0,O,w,D,C,P,M,L-M,c),P=N=C=0,M=L;for(var H=0;H<286;++H)w[H]=0;for(H=0;H<30;++H)D[H]=0}var V=2,G=0,K=g,j=x-F&32767;if(2<W&&k==A(L-j))for(var Y=Math.min(u,W)-1,J=Math.min(32767,L),X=Math.min(258,W);j<=J&&--K&&x!=F;){if(e[L+V]==e[L+V-j]){for(var Q=0;Q<X&&e[L+Q]==e[L+Q-j];++Q);if(V<Q){if(G=j,Y<(V=Q))break;var Z=Math.min(j,Q-2),ee=0;for(H=0;H<Z;++H){var te=L-j+H&32767,ie=te-S[te]&32767;ee<ie&&(ee=ie,F=te)}}}j+=(x=F)-(F=S[x])&32767}G?(O[P++]=268435456|I[V]<<18|y[G],k=31&I[V],W=31&y[G],C+=E[k]+v[W],++w[257+k],++D[W],R=L+V,++N):(O[P++]=e[L],++w[e[L]])}}for(L=Math.max(L,R);L<o;++L)O[P++]=e[L],++w[e[L]];c=z(e,l,d,O,w,D,C,P,M,L-M,c),d||(r.r=7&c|l[c/8|0]<<3,c-=7,r.h=_,r.p=S,r.i=L,r.w=R)}else{for(L=r.w||0;L<o+d;L+=65535){var ne=L+65535;o<=ne&&(l[c/8|0]=d,ne=o),c=q(l,c+1,e.subarray(L,ne))}r.i=o}return U(s,0,n+B(c)+a)}(e,null==t.level?6:t.level,null==t.mem?a.l?Math.ceil(1.5*Math.max(8,Math.min(13,Math.log(e.length)))):20:12+t.mem,i,n,a)}(e,{},0,0)}(function(e){var t;if(X)return X.encode(e);var i=e.length,n=new p(e.length+(e.length>>1)),a=0,r=function(e){n[a++]=e};for(t=0;t<i;++t){a+5>n.length&&((o=new p(a+8+(i-t<<1))).set(n),n=o);var o=e.charCodeAt(t);o<128?r(o):(o<2048?r(192|o>>6):(55295<o&&o<57344?(r(240|(o=65536+(1047552&o)|1023&e.charCodeAt(++t))>>18),r(128|o>>12&63)):r(224|o>>12),r(128|o>>6&63)),r(128|63&o))}return U(n,0,a)}(e));let i="";for(let e=0;e<t.length;e++)i+=String.fromCharCode(t[e]);return btoa(i).replace(/\+/g,"-").replace(/\//g,"_").replace(/=/g,"")}catch(e){return null}})(t=JSON.stringify(e));if(null!==i){var n=encodeURIComponent(t).length;if(i.length<n&&Z(i)===t)return i}return e}static decompressValue(e,t,i){if(null==e)return e;if(void 0===i&&(n=Di.getCompressedKeyName(t),i="string"==typeof e?Di.getCookieVersion(n,e):2),(3===i||void 0===i)&&"string"==typeof e){var n=Z(e);if(null!==n)try{var a=JSON.parse(n);return Di.decompressObjectV3(a,t)}catch(t){i=2}}return 1===i&&Di.isLegacyValue(e)?"string"===e.MOE_DATA_TYPE?e.actualValue?String(e.actualValue):null:(e.MOE_DATA_TYPE,e.actualValue):"number"!=typeof e||0!==e&&1!==e||t!==yt.SDK_DISABLED&&t!==At?"number"==typeof e&&0<=e&&e<=6&&(t===yt.SOFT_ASK_STATUS||t===yt.HARD_ASK_STATUS)?Object.keys(Ot.PERMISSION_STATE_MAPPING).find(t=>Ot.PERMISSION_STATE_MAPPING[t]===e):"object"!=typeof e||Array.isArray(e)?e:void 0!==i&&2!==i||(n=Di.getCompressedKeyName(t),!Di.hasV3Structure(e,n))?3===i?Di.decompressObjectV3(e,t):Di.decompressObject(e,t):Di.decompressObjectV3(e,t):1===e}static compressObjectV3(e,t){if(!e)return e;switch(t){case yt.SUBSCRIPTION_DETAILS:return Di.compressSubscriptionDetailsV3(e);case yt.USER_DATA:return Di.compressUserDataV3(e);case yt.IDENTITY_MAP:return Di.compressIdentityMapV3(e);case yt.SESSION:return Di.compressSessionV3(e);case yt.DEVICE_DATA:return null;default:return e}}static compressSubscriptionDetailsV3(e){var t,i,n,a,r,o,s=e&&(({domain:s,token:o,endpoint:t,keys:i,p256dh:n,auth:a}=Ii),r={},e.domain&&(r[s]=e.domain),e.token&&(r[o]=e.token),e.endpoint&&(r[t]=e.endpoint),e.keys&&(r[i]={},e.keys.p256dh&&(r[i][n]=e.keys.p256dh),e.keys.auth)&&(r[i][a]=e.keys.auth),r);return s.e&&"string"==typeof s.e&&(o=Ot.ENDPOINT_URL_MAPPING[s.e])&&(s.e=o),s}static compressUserDataV3(e){var t;if(e=function(e){if(!e)return e;var{attributes:t,subscribedToOldSdk:i,deviceUuid:n,deviceAdded:a}=Ti;let{key:r,value:o,updated_at:s,level:l}=yi;var d={};return e.attributes&&(d[t]=e.attributes.map(e=>{var t,i,n={};return e.key&&(n[r]=(t=e.key,(i=di.find(e=>e.attributeName===t))?i.moeName:t)),void 0!==e.value&&(n[o]=e.value),void 0!==e.updated_at&&(n[s]=e.updated_at),void 0!==e.level&&(n[l]=e.level),n})),void 0!==e.subscribedToOldSdk&&(d[i]=e.subscribedToOldSdk),e.deviceUuid&&(d[n]=e.deviceUuid),void 0!==e.deviceAdded&&(d[a]=e.deviceAdded),d}(e),e.d_uid||(t=Di.getDeviceDataForMigration())&&t.deviceUniqueId&&(e.d_uid=t.deviceUniqueId),e.d_id&&delete e.d_id,e.a&&Array.isArray(e.a)&&0===e.a.length&&delete e.a,e.a&&Array.isArray(e.a)&&0<e.a.length){let t={};e.a.forEach(e=>{var i;e.k&&void 0!==e.v&&(i=e.l?e.k+"_p_attr":e.k,t[i]={v:e.v,u_at:e.u_at,l:e.l||void 0})}),e.a=t}return e}static compressIdentityMapV3(e){var t,i,n,a=e&&(({userIdentities:a,previousIdentities:t,previousIdentitiesUpdatedTime:i}=bi),n={},e.userIdentities&&(n[a]=e.userIdentities),e.previousIdentities&&(n[t]=e.previousIdentities),void 0!==e.previousIdentitiesUpdatedTime&&(n[i]=e.previousIdentitiesUpdatedTime),n);return a.p_i&&0!==Object.keys(a.p_i).length||0!==a.p_i_u_t||(delete a.p_i,delete a.p_i_u_t),a}static compressSessionV3(e){var t;return e=function(e){var t,i,n,a,r,o,s,l;return e&&(({sessionKey:t,sessionStartTime:i,sessionMaxTime:n,customIdentifiersToTrack:a,sessionExpiryTime:r,numberOfSessions:o,currentSource:s}=Ai),l={},e.sessionKey&&(l[t]=e.sessionKey),e.sessionStartTime&&(l[i]=e.sessionStartTime),void 0!==e.sessionMaxTime&&(l[n]=e.sessionMaxTime),e.customIdentifiersToTrack&&(l[a]=e.customIdentifiersToTrack),void 0!==e.sessionExpiryTime&&(l[r]=e.sessionExpiryTime),void 0!==e.numberOfSessions&&(l[o]=e.numberOfSessions),e.currentSource&&(l[s]=(e=>{var t,i,n,a,r,o,s,l,d;return e&&(({source:t,medium:i,source_url:n,term:a,campaign_name:r,campaign_id:o,content:s,extra:l}=Oi),d={},e.source&&(d[t]=e.source),e.medium&&(d[i]=e.medium),e.source_url&&(d[n]=e.source_url),e.term&&(d[a]=e.term),e.campaign_name&&(d[r]=e.campaign_name),e.campaign_id&&(d[o]=e.campaign_id),e.content&&(d[s]=e.content),e.extra&&(d[l]=e.extra),d)})(e.currentSource)),l)}(e),e.s_s_t&&"string"==typeof e.s_s_t&&(t=new Date(e.s_s_t).getTime(),e.s_s_t=t),e}static decompressObject(e,t){if(!e)return e;switch(t){case yt.SUBSCRIPTION_DETAILS:return te(e);case yt.USER_DATA:return ie(e);case yt.IDENTITY_MAP:return ne(e);case yt.SESSION:return ae(e);case yt.DEVICE_DATA:return(i=e)&&(a={},i[n=wi.deviceUniqueId]&&(a.deviceUniqueId=i[n]),a);default:return e}var i,n,a}static decompressObjectV3(e,t){if(!e)return e;switch(t){case yt.SUBSCRIPTION_DETAILS:return Di.decompressSubscriptionDetailsV3(e);case yt.USER_DATA:return Di.decompressUserDataV3(e);case yt.IDENTITY_MAP:return Di.decompressIdentityMapV3(e);case yt.SESSION:return Di.decompressSessionV3(e);case yt.DEVICE_DATA:return Di.getDeviceDataFromUserData();default:return e}}static decompressSubscriptionDetailsV3(e){var t;return(e=Object.assign({},e)).e&&"string"==typeof e.e&&(t=Di.REVERSE_ENDPOINT_URL_MAPPING[e.e])&&(e.e=t),te(e)}static decompressUserDataV3(e,t){var i=!(e=Object.assign({},e)).hasOwnProperty("a"),n=(e.a&&"object"==typeof e.a&&!Array.isArray(e.a)&&(n=Object.entries(e.a).map(([e,t])=>{var i=void 0!==t.l,n=e.endsWith("_p_attr");return{k:i&&n?e.slice(0,-7):e,v:t.v,u_at:t.u_at||(new Date).getTime(),l:t.l||void 0}}),e.a=n),i&&(e.a=[]),ie(e));return n.deviceUuid||(i=ee("moe_uuid"))&&(n.deviceUuid=i),n}static decompressIdentityMapV3(e){return(e=Object.assign({},e)).hasOwnProperty("p_i")||(e.p_i={}),e.hasOwnProperty("p_i_u_t")||(e.p_i_u_t=0),ne(e)}static decompressSessionV3(e){return(e=Object.assign({},e)).s_s_t&&"number"==typeof e.s_s_t&&(e.s_s_t=new Date(e.s_s_t).toISOString()),ae(e)}static getDeviceDataForMigration(){if("undefined"!=typeof localStorage)try{var e=localStorage.getItem("MOE_DATA");if(e){var t=JSON.parse(e);if(t&&t.DEVICE_DATA&&t.DEVICE_DATA.deviceUniqueId)return t.DEVICE_DATA}}catch(e){}return null}static getDeviceDataFromUserData(){var e;for(e of Di.getAllCookieNames(yt.USER_DATA)){var t,i=ee(e);if(null!==i)try{let e=JSON.parse(i);if((e="string"==typeof e&&null!==(t=Z(e))?JSON.parse(t):e).d_uid)return{deviceUniqueId:e.d_uid};var n=Di.decompressUserDataV3(e);if(n.deviceUuid)return{deviceUniqueId:n.deviceUuid}}catch(e){continue}}return null}static isCompressedCookie(e){return e.startsWith("moe_")&&Object.values(Ot.COOKIE_NAME_MAPPING).includes(e)}static isLegacyValue(e){return"object"==typeof e&&null!==e&&e.hasOwnProperty("MOE_DATA_TYPE")&&e.hasOwnProperty("actualValue")}}Di.REVERSE_ENDPOINT_URL_MAPPING=Object.fromEntries(Object.entries(Ot.ENDPOINT_URL_MAPPING).map(([e,t])=>[t,e])),Di.REVERSE_COOKIE_NAME_MAPPING=Object.fromEntries(Object.entries(Ot.COOKIE_NAME_MAPPING).map(([e,t])=>[t,e]));class Ni{static set(e,t){if(null==(i=_i.get())||!i.disableCookies){var i=Ni.baseTag+".set";if(null==t)Ni.remove(e);else if(e===yt.PUSH_TOKEN)Si.log(2,i,"Skipping PUSH_TOKEN as it is redundant with SUBSCRIPTION_DETAILS");else if(e!==yt.DEVICE_DATA){let n;i=Di.compressValue(t,e),t=Di.getCompressedKeyName(e),Ni.cleanupOldVersions(e,t),n="string"==typeof i?i:"object"==typeof i&&null!==i?JSON.stringify(i):String(i),e=Date.now(),i=";expires="+new Date(e+31536e6*bt.SESSION_COOKIE.EXPIRY_YEARS).toUTCString(),document.cookie=t+"="+encodeURIComponent(n)+i+";domain="+Ni.getOrigin()+";path=/;SameSite=None; Secure"}}}static get(e){var t,i;if(null==(i=_i.get())||!i.disableCookies){let n=null,a=null,r=1;for(t of Di.getAllCookieNames(e))if(null!==(n=Ni.getCookieValue(t))){a=t,r=Di.getCookieVersion(t,n);break}return null===n?null:(i=Ni.processParseValue(n,e,1<r,r),a&&r<3&&Ni.migrateToV3(e,i,a),i)}}static migrateToV3(e,t,i){var n=Ni.baseTag+".migrateToV3";try{Ni.set(e,t),Ni.removeSpecificCookie(i)}catch(e){Si.error(2,n,`Failed to migrate cookie ${i} to V3:`,e)}}static cleanupOldVersions(e,t){Di.getAllCookieNames(e).forEach(e=>{var t=Ni.getCookieValue(e);null!==t&&Di.getCookieVersion(e,t)<3&&Ni.removeSpecificCookie(e)})}static removeSpecificCookie(e){document.cookie=e+"=;domain="+Ni.getOrigin()+";path=/;expires=Thu, 01 Jan 1970 00:00:01 GMT;"}static getCookieValue(e){var t=e+"=",i=Ni.getDecodedCookies();for(let e=i.length-1;0<=e;e--){let n=i[e];for(;" "===n.charAt(0);)n=n.substring(1);if(0===n.indexOf(t))return n.substring(t.length,n.length)}return null}static processParseValue(e,t,i,n){var a="MOE_DATA_TYPE",r="actualValue";try{let s;try{s=JSON.parse(e)}catch(t){s=e}Di.isLegacyValue(s)?"string"===o(s,a,null)?e=(e=o(s,r,null))?String(e):null:"boolean"===o(s,a,null)&&(e=o(s,r,null)):e=i?Di.decompressValue(s,t,n):s}catch(t){}return e}static remove(e){var t;null!=(t=_i.get())&&t.disableCookies||Di.getAllCookieNames(e).forEach(e=>{Ni.removeSpecificCookie(e)})}static setRaw(e,t,i){var n;if(null==(n=_i.get())||!n.disableCookies)if(Ni.baseTag,null==t)Ni.remove(e);else{let n="";null!=i&&(n=";expires="+i.toISOString()),document.cookie=e+"="+encodeURIComponent(t)+n+";domain="+Ni.getOrigin()+";path=/;"}}static getOrigin(){if(null==(e=_i.get())||!e.disableCookies){var e=Ni.baseTag+".getOrigin";let t=window.location.origin;return t=t.indexOf(".")!==t.lastIndexOf(".")?t.substring(t.indexOf(".")):"."+t.substring(t.lastIndexOf("/")+1),"localhost"===window.location.hostname&&(Si.warn(1,e,"Cross domain user persitence will not work with localhost. \n\nWe will save the key-value pairs in the localhost cookie store for reference. You'll be able to test this functionality in a hosted staging/test environment."),t=""),t}}static getDecodedCookies(){let e=Ni.baseTag+".getDecodedCookies";return document.cookie.split(";").map(t=>{let i=t.trim();"%"===i.slice(-1)&&(i+="25");try{return decodeURIComponent(i)}catch(t){return Si.error(2,e,"Error decoding cookie:",i,t),i}})}}Ni.baseTag="CookieStorage";let Ci="MOE_DATA";class Li{static setPrefix(e){Li.prefix=e+"_"}static set(e,t){Li.baseLogTag,e=Li.prefix+e,localStorage&&((n=Li.getMoeData())[e]=t,localStorage.setItem(Ci,JSON.stringify(n)));var i,n=Li.KEYS_SHARED_WITH_COOKIE.indexOf(e);Li.isSharedWithCookie&&0<=n&&(i="object"!=typeof t||Array.isArray(t)?t:Object.assign({},t),0===n&&Array.isArray(i.attributes)&&(i.attributes=i.attributes.filter(e=>!!this.isPushBillingOrIdentityAttribute(e.key))),e===yt.SUBSCRIPTION_DETAILS&&(i.domain=t.domain,i.token=t.token,i.endpoint=t.endpoint,i.keys=t.keys),Ni.set(e,i))}static get(e){return Li.baseLogTag,e=Li.prefix+e,localStorage?o(Li.getMoeData(),e,null):null}static remove(e){var t,i=Li.baseLogTag+".remove",n=Li.prefix+e;localStorage&&null!=Li.get(e)&&(delete(t=Li.getMoeData())[n],localStorage.setItem(Ci,JSON.stringify(t)),Si.log(2,i,"Key",e,"removed.")),Li.isSharedWithCookie&&0<=Li.KEYS_SHARED_WITH_COOKIE.indexOf(e)&&Ni.remove(e)}static logout(){var e,t,i=["INIT_DATA","Q","WEB_SETTINGS","SUBSCRIPTION_DETAILS","PUSH_TOKEN","GRACEFUL_DATA","DEVICE_DATA","SDK_VERSION","SDK_DISABLED"];for(e in yt)i.indexOf(e)<0&&Li.remove(yt[e]);for(t in yt.Q)Pi.purge(t)}static getString(e){if(e=Li.prefix+e,localStorage)return"string"==typeof(e=Li.get(e))||e instanceof String?e:JSON.stringify(e)}static removePrefix(){Li.prefix=""}static copyKeysFromCookie(){let e=null;for(let n=0;n<Li.KEYS_SHARED_WITH_COOKIE.length;n++){var t=Li.KEYS_SHARED_WITH_COOKIE[n],i=Ni.get(t);if(null!=i){let n="object"!=typeof i||Array.isArray(i)?i:Object.assign({},i);if(t===yt.USER_DATA){if(i=Li.get(t)&&Li.get(t).attributes,Array.isArray(n.attributes)&&Array.isArray(i)&&0<i.length){let e=[...i];n.attributes.forEach(t=>{var i=e.findIndex(e=>e.key===t.key&&e.level===t.level);0<=i?e[i]=t:e.push(t)}),e=e.filter(e=>!(this.isPushBillingOrIdentityAttribute(e.key)&&n.attributes.findIndex(t=>t.key===e.key&&t.level===e.level)<0)),n.attributes=e}n.d_uid&&(e={deviceUniqueId:n.d_uid},delete n.d_uid)}else t===yt.DEVICE_DATA&&(e=n);Li.set(t,n)}}e&&Li.set(yt.DEVICE_DATA,e),Ni.get(yt.PUSH_TOKEN)&&Ni.remove(yt.PUSH_TOKEN),Li.removeStaleKeysFromLS(),Li.copyIdentitiesFromCookiesToIDB()}static isPushBillingOrIdentityAttribute(e){var t=Li.get(yt.WEB_SETTINGS),i=(null==(i=null==t?void 0:t.configs)?void 0:i.identityAttributes)||[],n=(null==(n=null==t?void 0:t.configs)?void 0:n.subscriberBasedBillingAttributes)||[];return!!(null!=t&&t.isPushSubBilling&&u(e,n)||Lt.includes(e)||i.includes((null==(t=di.find(t=>t.attributeName===e))?void 0:t.moeName)||e))}static copyIdentitiesFromCookiesToIDB(){var e,t,i=this.baseLogTag+".copyIdentitiesFromCookiesToIDB",n=Ni.get(yt.IDENTITY_MAP),a=Ni.get(yt.USER_DATA),o={};null!=n&&n.userIdentities&&(({userIdentities:n,previousIdentities:e,previousIdentitiesUpdatedTime:t}=n),o.userIdentities=n,o.previousIdentities=e,o.previousIdentitiesUpdatedTime=t),null!=(n=null==a?void 0:a.attributes)&&n.length&&a.attributes.find(e=>e.key===Nt.ID)&&(o.moe_user_id=a.attributes.find(e=>e.key===Nt.ID).value),null!=(e=this.moeDataStore)&&e.getItem||(this.moeDataStore=r.createInstance({driver:[r.INDEXEDDB],name:"moe_database",storeName:"moe_data"}),this.moeDataStore&&(this.moeDataStore.setItem(ui,o),Si.log(2,i,"Copied identities from cookie to IndexedDB")))}static removeStaleKeysFromLS(){var e=Li.baseLogTag+".removeStaleKeysFromLS";try{Object.keys(Li.getMoeData()).forEach(e=>{var t=Ni.get(e);!this.KEYS_SHARED_WITH_COOKIE.includes(e)||pi.includes(e)||t||!1===t||Li.remove(e)})}catch(t){Si.error(1,e,t)}}static getMoeData(){var e=Li.baseLogTag+".getMoeData",t=localStorage.getItem(Ci);if(null==t)return{};try{return JSON.parse(t)}catch(t){return Si.error(1,e,t),{}}}}Li.baseLogTag="PersistentStorage",Li.prefix="",Li.isSharedWithCookie=!1,Li.KEYS_SHARED_WITH_COOKIE=[yt.USER_DATA,yt.SUBSCRIPTION_DETAILS,yt.SOFT_ASK_STATUS,yt.OPT_IN_SHOWN_TIME,yt.HARD_ASK_STATUS,yt.SESSION,yt.DEVICE_DATA,yt.IDENTITY_MAP,yt.SDK_DISABLED];class Pi{constructor(){this.items=[]}static enqueue(e,t){e=Pi.getLocalStorageQName(e);let i=new Pi;(i=Li.get(e)?Li.get(e):i).items.push(t),i.items=i.items.slice(Math.max(i.items.length-50,0)),Li.set(e,i)}static dequeue(e){e=Pi.getLocalStorageQName(e);var t=Li.get(e);let i=null;return t&&0<t.items.length&&(i=t.items[0],t.items.splice(0,1),Li.set(e,t)),i}static isEmpty(e){return e=Pi.getLocalStorageQName(e),!(Li.get(e)&&0<Li.get(e).items.length)}static purge(e){var t=this.baseLogTag+".purge",i=Pi.getLocalStorageQName(e);Pi.isEmpty(e)||Li.remove(i),Si.log(2,t,`Queue "${e}" has been cleared.`)}static getLocalStorageQName(e){return yt.Q.PREFIX+"_"+e}}Pi.baseLogTag="LocalQ";var re,oe=i(414);let Ri=e=>{if(e){var t=e.indexOf("?");if(t<0)return{};t=(e=e.slice(t+1)).replace("?","").split("&");let i={};return t.forEach(e=>{var t=(e=e.split("="))[0];e=decodeURIComponent(e[1]||""),i[t]?"[object Array]"===Object.prototype.toString.call(i[t])?i[t].push(e):i[t]=[i[t],e]:i[t]=e}),JSON.parse(JSON.stringify(i))}return{}},Mi=(e,t)=>{if(t){for(var i in"?"!==e[e.length-1]&&(e+="?"),t)t.hasOwnProperty(i)&&null!=t[i]&&(e+=i+"="+encodeURIComponent(t[i])+"&");"&"===e[e.length-1]&&(e=e.slice(0,-1))}return e};class ki{static get(e,t){return ki.makeNetworkCall(re.METHODS.GET,e,t)}static post(e,t){return ki.makeNetworkCall(re.METHODS.POST,e,t)}static makeNetworkCall(e,t,i={}){return new Promise((n,a)=>{var r=JSON.stringify(o(i,"postData",null));t=Mi(t,o(i,"queryParams",null));let s=new XMLHttpRequest;s.open(e,t,!0),ki.addRequestHeaders(s,o(i,"headers",{})),s.onreadystatechange=()=>{4===s.readyState&&200===s.status||4===s.readyState&&410===s.status?n({status:s.status,responseText:s.responseText}):4===s.readyState&&200!==s.status&&a({code:s.status,reason:s.responseText})},s.send(r)})}static addRequestHeaders(e,t){for(var i in t)t.hasOwnProperty(i)&&e.setRequestHeader(i,t[i]);return e}}function se(){var e=navigator.userAgent;return!(!/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|ipad|iris|kindle|Android|Silk|lge |maemo|midp|mmp|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows (ce|phone)|xda|xiino/i.test(e)&&!/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(e.substr(0,4)))}function le(){var e=navigator.userAgent.toLowerCase(),t=/(ipad|tablet|(android(?!.*mobile))|(windows(?!.*phone)(.*touch))|kindle|playbook|silk|(puffin(?!.*(IP|AP|WP))))/.test(e);return/nexus player|neo-x5|adt-2|tsbnettv|roku|tizen|smart-tv.+(samsung)|hbbtv.+maple;(\d+)|(nux; netcast.+smarttv|lg (netcast\.tv-201\d|android tv))|(apple) ?tv|crkey|droid.+aft(\w)( bui|\))|\(dtv[\);].+(aquos)|(aquos-tv[\w ]+)\)|(bravia[\w ]+)( bui|\))|(mitv-\w{5}) bui|Hbbtv.*(technisat) (.*);|\b(roku)[\dx]*[\)\/]((?:dvp-)?[\d\.]*)|hbbtv\/\d+\.\d+\.\d+ +\([\w\+ ]*; *([\w\d][^;]*);([^;]*)|\b(android tv|smart[- ]?tv|opera tv|tv; rv:)\b/i.test(e)?oi.TV:t?oi.TABLET:se()?oi.MOBILE:oi.WEB}function de(e,t){var i=t&&new RegExp("^("+t.join("|")+")$");return le()===oi.TV&&(null!=i&&i.test(e)||!t)?{moe_os_type:(()=>{var e=navigator.userAgent.toLowerCase();return/tizen/i.test(e)?si.TIZEN:/web0s/i.test(e)?si.WEB_OS:/xbox/i.test(e)?si.XBOX:/vizio/i.test(e)?si.VIZIO:si.DEFAULT})(),os:oi.TV.toUpperCase()}:{}}(a=(a=re=re||{}).METHODS||(a.METHODS={})).GET="GET",a.POST="POST";class xi{constructor(){this.p=null,this.res=null,this.rej=null;try{this.p=new Promise((e,t)=>{this.res=e,this.rej=t})}catch(e){Si.error(1,"Utils.PromiseObject","Promises not supported")}}}var ce=function(e,t,i,n){return new(i=i||Promise)(function(a,r){function o(e){try{l(n.next(e))}catch(e){r(e)}}function s(e){try{l(n.throw(e))}catch(e){r(e)}}function l(e){var t;e.done?a(e.value):((t=e.value)instanceof i?t:new i(function(e){e(t)})).then(o,s)}l((n=n.apply(e,t||[])).next())})};class Bi{static getIdentityMap(){var e=Li.get(yt.WEB_SETTINGS);return null!=e&&e.isDomainLevelStorage?this.getIdentitiesFromCookies():this.getIdentitiesFromLocalStorage()}static getIdentitiesFromLocalStorage(){var e=Li.get(yt.IDENTITY_MAP);return null!=e&&e.userIdentities?e:null}static getIdentitiesFromCookies(){var e,t=Ni.get(yt.IDENTITY_MAP);return t&&"object"==typeof t&&t.userIdentities?(e={userIdentities:t.userIdentities},t.previousIdentities&&(e.previousIdentities=t.previousIdentities,e.previousIdentitiesUpdatedTime=t.previousIdentitiesUpdatedTime),e):null}static getUserIdentities(){var e=this.getIdentityMap();return null!=e&&e.userIdentities?e.userIdentities:null}static updateCurrentUserIdentities(e){return ce(this,void 0,void 0,function*(){let t;var i=this.getIdentityMap();t=null!=i&&i.userIdentities?Object.assign(Object.assign({},i),{userIdentities:Object.assign(Object.assign({},i.userIdentities),e)}):(this.createIdentityMap(),Object.assign(Object.assign({},this.getIdentityMap()),{userIdentities:e})),Li.set(yt.IDENTITY_MAP,t),yield this.updateIdentifiersIDB(t)})}static broadcastUserIdentityUpdate(){var e=this.baseLogTag+".broadcastUserIdentityUpdate";Si.log(1,e,"User Identities Updated."),qi.broadcastToWindow({topic:Pt.USER_LIFECYCLE.TOPIC_NAME,name:Pt.USER_LIFECYCLE.EVENT_NAMES.USER_IDENTITY_UPDATE})}static broadcastLogout(){qi.broadcastToWindow({topic:Pt.USER_LIFECYCLE.TOPIC_NAME,name:Pt.USER_LIFECYCLE.EVENT_NAMES.LOGOUT})}static updatePreviousUserIdentities(e,t){return ce(this,void 0,void 0,function*(){let i;var n,a=this.getIdentityMap();i=null!=a&&a.userIdentities?(n=(null==a?void 0:a.previousIdentities)||{},Object.assign(Object.assign({},a),{previousIdentities:Object.assign(Object.assign({},n),e),previousIdentitiesUpdatedTime:t||(new Date).getTime()})):(this.createIdentityMap(),Object.assign(Object.assign({},this.getIdentityMap()),{previousIdentities:e,previousIdentitiesUpdatedTime:t||(new Date).getTime()})),Li.set(yt.IDENTITY_MAP,i),yield this.updateIdentifiersIDB(i)})}static updateIdentifiersIDB(e){var t;return ce(this,void 0,void 0,function*(){var i;null!=(t=this.moeDataStore)&&t.getItem||(this.moeDataStore=r.createInstance({driver:[r.INDEXEDDB],name:Ht.DATABASE_NAME,storeName:Ht.STORE_NAME})),this.moeDataStore&&(Object.keys(e).length?(i=(yield this.moeDataStore.getItem(ui))||{},yield this.moeDataStore.setItem(ui,Object.assign(Object.assign({},i),e))):yield this.moeDataStore.setItem(ui,e))})}static copyUidIntoIdentityMap(e){var t=this.baseLogTag+".copyUidIntoIdentityMap";(e=e.getAttribute("id"))&&(this.updateCurrentUserIdentities({uid:e}),Si.log(1,t,"UID copied into IdentityMap."))}static getIdentifiersFromIdentities(){var{userIdentities:e,previousIdentities:t,previousIdentitiesUpdatedTime:i}=this.getIdentityMap()||{},n={};return e&&Object.keys(e).length&&(n.userIdentities=e),0<i&&(216e5<(new Date).getTime()-i?this.removePreviousUserIdentities():n.previousIdentities=t),n}static removePreviousUserIdentities(){return ce(this,void 0,void 0,function*(){var e=this.baseLogTag+".removePreviousUserIdentities",t=Object.assign(Object.assign({},this.getIdentityMap()),{previousIdentities:{},previousIdentitiesUpdatedTime:0});Li.set(yt.IDENTITY_MAP,t),yield this.updateIdentifiersIDB(t),Si.log(1,e,"previousIdentities removed from IdentityMap.")})}static createIdentityMap(){Li.set(yt.IDENTITY_MAP,{userIdentities:{},previousIdentities:{},previousIdentitiesUpdatedTime:0})}}function ue(e,t){if(null==e||null==t)return e===t;if(e instanceof Function)return e===t;if(e instanceof RegExp)return e===t;if(e===t||e.valueOf()===t.valueOf())return!0;if(Array.isArray(e)&&e.length!==t.length)return!1;if(e instanceof Date)return!1;if(!(e instanceof Object))return!1;if(!(t instanceof Object))return!1;let i=Object.keys(e);return Object.keys(t).every(e=>-1!==i.indexOf(e))&&i.every(i=>ue(e[i],t[i]))}Bi.baseLogTag="IdentityMethods";class Ui{constructor(e,t,i){this.os="web",this.osPlatform=e.userAgent,this.isMobile=se(),this.os=se()?"mweb":"web",this.name=Ui.getBrowserName(e.userAgent,t),this.isIncognito=i}static getInstance(){return function(e,t,i,n){return new(i=i||Promise)(function(t,a){function r(e){try{s(n.next(e))}catch(e){a(e)}}function o(e){try{s(n.throw(e))}catch(e){a(e)}}function s(e){var n;e.done?t(e.value):((n=e.value)instanceof i?n:new i(function(e){e(n)})).then(r,o)}s((n=n.apply(e,[])).next())})}(this,0,void 0,function*(){var e,t;return null==Ei.get(Tt.BROWSER_DETAILS)?(e=yield Ui.isIncognito(window),e=new Ui(navigator,document,e),Ei.set(Tt.BROWSER_DETAILS,e),(t=Li.get(yt.BROWSER_DETAILS))&&Ui.isBrowserUpdated(t,e)||Li.set(Tt.BROWSER_DETAILS,e),e):Ei.get(Tt.BROWSER_DETAILS)})}static isIncognito(e){let t=e.RequestFileSystem||e.webkitRequestFileSystem;return new Promise(i=>{t?t(e.TEMPORARY,100,()=>{i(!1)},()=>{i(!0)}):i(!1)})}static getBrowserName(e,t){return-1!==e.indexOf("MSIE")||1==t.documentMode?Ui.BROWSER_NAMES.INTERNET_EXPLORER:-1<e.indexOf("Edg")?Ui.BROWSER_NAMES.EDGE:-1<e.indexOf("OPR")||-1<e.indexOf("Opera")?Ui.BROWSER_NAMES.OPERA:-1<e.indexOf("Chrome")||e.match(/\b(?:crmo|crios)\/([\w\.]+)/i)?-1<e.indexOf("MMS")?Ui.BROWSER_NAMES.OPERA_NEON:Ui.BROWSER_NAMES.CHROME:-1<e.indexOf("Safari")?Ui.BROWSER_NAMES.SAFARI:-1<e.indexOf("Firefox")?Ui.BROWSER_NAMES.FIREFOX:Ui.BROWSER_NAMES.OTHERS}static isBrowserUpdated(e,t){return ue(e,t)}isWebPushCompatible(){return this.isChrome()||this.isFirefox()||this.isOpera()||this.isSafari()||this.isEdge()}isChrome(){return this.name===Ui.BROWSER_NAMES.CHROME}isFirefox(){return this.name===Ui.BROWSER_NAMES.FIREFOX}isOpera(){return this.name===Ui.BROWSER_NAMES.OPERA||this.name===Ui.BROWSER_NAMES.OPERA_NEON}isSafari(){return this.name===Ui.BROWSER_NAMES.SAFARI}isEdge(){return this.name===Ui.BROWSER_NAMES.EDGE}static isIOS(){return!(!navigator.userAgent.match(/iPad/i)&&!navigator.userAgent.match(/iPhone/i))}}(S=(S=Ui=Ui||{}).BROWSER_NAMES||(S.BROWSER_NAMES={})).CHROME="Google Chrome",S.FIREFOX="Mozilla Firefox",S.OPERA="Opera",S.OPERA_NEON="Opera Neon",S.SAFARI="Apple Safari",S.INTERNET_EXPLORER="Internet Explorer",S.EDGE="Edge",S.OTHERS="Others";let Fi=Ui,Wi=()=>new Promise((e,t)=>{try{var i=JSON.parse(localStorage.getItem("MOE_DATA"));i&&i.WEB_SETTINGS&&i.WEB_SETTINGS.configs&&e(i.WEB_SETTINGS),t("Error in getting sdk settings from localstorage - no data found")}catch(e){Si.error(1,"getSDKSettings","Error in getting sdk settings from localstorage ",e),t(e)}}),Hi=()=>new Promise((e,t)=>{try{var i=JSON.parse(localStorage.getItem("MOE_DATA"));return i&&i.INIT_DATA&&e(i.INIT_DATA),{}}catch(e){Si.error(1,"getSDKSettings","Error in getting init data from localstorage ",e),t(e)}});class Vi{constructor(e,t,i){this.key=e,this.value=t,this.updated_at=(new Date).getTime(),i===Vi.USER_ATTRIBUTE_LEVEL.PORTFOLIO&&(this.level=i)}static equal(e,t){return e.key===t.key&&JSON.stringify(e.value)===JSON.stringify(t.value)}}(a=(a=Vi=Vi||{}).USER_ATTRIBUTE_LEVEL||(a.USER_ATTRIBUTE_LEVEL={})).PORTFOLIO="PORTFOLIO",a.PROJECT="PROJECT";let Gi=Vi;function ge(){var e;return(null==(e=Li.get(yt.SUBSCRIPTION_DETAILS))?void 0:e.token)||null}function pe(e,t){var{web:e,mobile:i}=e;return e=ye(`\n  <div id="desktopBannerWrapped" aria-labelledby="optInTitle" data-rapid_height="50"\n  style="width: 422px; top: 1px; left: calc(50% - 211px); margin: 0px; padding: 0px; box-shadow: rgb(136, 136, 136) 0px 0px 4px; font-size: 11px; font-weight: 400; position: fixed; z-index: 2147483647; background: ${e.banner.backgroundColor};">\n    <div style="margin: 0;padding: 0 20px 10px;word-spacing: normal!important;letter-spacing: normal!important;font-family: Open Sans,sans-serif!important;">\n      <div\n        style="float: left;position: relative;display: inline-block;margin: 15px 15px 0 0!important;padding: 0!important;word-spacing: normal!important;letter-spacing: normal!important;font-family: Open Sans,sans-serif!important;">\n        <img style="word-spacing: normal!important;letter-spacing: normal!important;font-family: Open Sans,sans-serif!important;height: 65px!important;width: 65px!important;" src="${e.banner.icon}" alt="${e.banner.altText||""}"/>\n      </div>\n      <div style="word-spacing: normal!important;letter-spacing: normal!important;font-family: Open Sans,sans-serif!important;position: relative!important;padding: 10px 0 0!important;color: #000!important;text-align: left!important;margin: 0!important;line-height: 1.4em!important;display: inline-block!important;width: calc(100% - 80px)!important;">\n        <h2 id="optInTitle" style="margin-bottom: 5px; text-align: left; font-size: 14px; font-weight: 700; overflow: hidden; height: 2.8em; line-height: 1.4em; display: block; font-family: Open Sans, sans-serif !important; word-spacing: normal !important; letter-spacing: normal !important; color: ${e.banner.title.textColor+" !important"};">\n          ${e.banner.title.text}\n        </h2>\n        <p aria-describedby="optInTitle" style="overflow: hidden; height: 2.8em; word-spacing: normal !important; letter-spacing: normal !important; font-family: Open Sans, sans-serif !important; font-size: 12px !important; line-height: 1.4em !important; margin: 10px 0px !important; padding: 0px !important; text-align: left !important; color: ${e.banner.body.textColor+" !important"};">\n          ${e.banner.body.text}\n        </p>\n      </div>\n      <div\n        style="display: flex;justify-content: space-between;word-spacing: normal!important;letter-spacing: normal!important;font-family: Open Sans,sans-serif!important;">${t?"":`<div style="margin-top: 0.5em;">\n          <a aria-label="${e.logo.altText||""}" href="https://moengage.com/?utm_source=Journey&amp;utm_medium=soft_ask" target="_blank" style="word-spacing: normal !important; letter-spacing: normal !important; font-family: Open Sans, sans-serif !important; text-decoration: none !important; font-size: 10px !important; line-height: 1.2em !important; font-weight: 400 !important; color: ${e.logo.logoColor+" !important"};">\n            Powered by <span style="text-decoration: none;word-spacing: normal!important;letter-spacing: normal!important;font-family: Open Sans,sans-serif!important;vertical-align: bottom;"><img alt="" id="moeBannerLogoweb" src="https://app-cdn.moengage.com/images/brand/logo-blue.png" style="width: 6.5em;"></span>\n          </a>\n        </div>`}\n        <div style="word-spacing: normal!important;letter-spacing: normal!important;font-family: Open Sans,sans-serif!important;margin: 0!important;padding: 0!important;margin-left: auto !important;">\n          <button id="moe-dontallow_button" style="overflow: hidden; word-spacing: normal !important; letter-spacing: normal !important; width: 100px !important; height: 26px !important; font-size: 14px !important; cursor: pointer !important; line-height: 1.1em !important; border-radius: 4px !important; border: 1px solid rgba(0, 0, 0, 0.1) !important; display: inline-block !important; font-weight: 400 !important; margin: 0px 20px 0px 0px !important; padding: 5px !important; text-transform: none !important; box-sizing: border-box !important; text-shadow: none !important; box-shadow: none !important; white-space: nowrap !important; color: ${e.dismissButton.textColor}; background: ${e.dismissButton.backgroundColor};">\n            ${e.dismissButton.text}\n          </button>\n          <button\n            style="overflow: hidden; word-spacing: normal !important; letter-spacing: normal !important; width: 90px !important; height: 26px !important; font-size: 14px !important; cursor: pointer !important; line-height: 1.1em !important; border-radius: 4px !important; border: 1px solid rgba(0, 0, 0, 0.1) !important; display: inline-block !important; font-weight: 400 !important; margin: 0px !important; padding: 5px !important; text-transform: none !important; box-sizing: border-box !important; text-shadow: none !important; box-shadow: none !important; white-space: nowrap !important; color: ${e.allowButton.textColor}; background: ${e.allowButton.backgroundColor};" id="optInText">\n            ${e.allowButton.text}\n          </button>\n        </div>\n      </div>\n    </div>\n  </div>\n  `),{mobileUI:ye(`\n  <div id="mobileBannerWrapped" aria-labelledby="optInTitle" class="moe-mobile-box" style="position: fixed; top: 0px; left: 0px; width: 100%; box-shadow: rgb(51, 51, 51) 0px 5px 10px -5px; z-index: 2147483647; font-family: Helvetica Neue, Helvetica, Arial, Roboto, sans-serif, sans-serif; background: ${i.nudge.backgroundColor};">\n    <div class="moe-logo-text" style="box-sizing: border-box;padding: 10px !important;float: left !important;width: 100% !important">\n      <img height="40px" width="40px" style="box-sizing: border-box;width: 40px !important;height: 40px !important;float: left !important" alt="${i.nudge.altText||""}" src="${i.nudge.icon}">\n      <h2 aria-labelledby="optInTitle" style="box-sizing: border-box; width: calc(100% - 40px); overflow: hidden; height: 2.4em; float: left !important; word-break: break-word !important; font-weight: 400 !important; line-height: 1.2em !important; font-size: 17px !important; text-align: left !important; padding: 0px 0px 0px 10px !important; font-family: Helvetica Neue, Helvetica, Arial, Roboto, sans-serif, sans-serif !important; color:${i.nudge.title.textColor+" !important"}">\n        ${i.nudge.title.text}\n      </h2>\n    </div>\n    <div class="moe-buttons-panel" style="box-sizing: border-box;text-align: right;padding: 0 10px !important;float: left;width: 100% !important;margin-top: 5px;margin-bottom: 3px">\n      <div style="width: 100%;box-sizing: border-box">\n        <button id="moe-dontallow_button" class="moe-mobile-button-outline" style="box-sizing: border-box; font-size: 14px !important; display: inline-block !important; text-transform: none !important; height: 34px !important; font-weight: 400 !important; line-height: 1.2em !important; font-family: Helvetica Neue, Helvetica, Arial, Roboto, sans-serif, sans-serif !important; padding: 0px 5px !important; width: 120px !important; border-radius: 2px !important; border: 1px solid rgba(0, 0, 0, 0.1) !important; margin: 0px 5px 0px 0px !important; color: ${i.dismissButton.textColor}; background: ${i.dismissButton.backgroundColor};">\n          <div style="height: 1.2em; line-height: 1.2em; overflow: hidden; color: ${i.dismissButton.textColor}; background: ${i.dismissButton.backgroundColor};">\n            ${i.dismissButton.text}\n          </div>\n        </button>\n        <button class="moe-mobile-button-fill" style="box-sizing: border-box; font-size: 14px !important; display: inline-block !important; text-transform: none !important; height: 34px !important; font-weight: 400 !important; line-height: 1.2em !important; font-family: Helvetica Neue, Helvetica, Arial, Roboto, sans-serif, sans-serif !important; padding: 0px 5px !important; width: 120px !important; border-radius: 2px !important; border: 1px solid rgba(0, 0, 0, 0.1) !important; margin: 0px !important; color: ${i.allowButton.textColor}; background: ${i.allowButton.backgroundColor};" id="optInText">\n          <div style="height: 1.2em; line-height: 1.2em; overflow: hidden; color: ${i.allowButton.textColor}; background: ${i.allowButton.backgroundColor};">\n            ${i.allowButton.text}\n          </div>\n        </button>\n      </div>\n    </div>${t?"":`<div style="float: left;margin-top: -2.25em;">\n    <a aria-label="${i.logo.altText||""}" href="https://moengage.com/?utm_source=Journey&amp;utm_medium=soft_ask" target="_blank" style="word-spacing: normal !important; letter-spacing: normal !important; font-family: Open Sans, sans-serif !important; text-decoration: none !important; font-size: 10px !important; line-height: 1.2em !important; font-weight: 400 !important; color: ${i.logo.logoColor+" !important"};">\n    Powered by <span style="text-decoration: none;word-spacing: normal!important;letter-spacing: normal!important;font-family: Open Sans,sans-serif!important;">\n        <img alt="" id="moeBannerLogomobile" src="https://app-cdn.moengage.com/images/brand/logo-blue.png" style="width: 6.5em;">\n      </span>\n    </a>\n    </div>`}\n  </div>\n  `),webUI:e}}function me(e,t){return function(e,t,i,n){return new(i=i||Promise)(function(t,a){function r(e){try{s(n.next(e))}catch(e){a(e)}}function o(e){try{s(n.throw(e))}catch(e){a(e)}}function s(e){var n;e.done?t(e.value):((n=e.value)instanceof i?n:new i(function(e){e(n)})).then(r,o)}s((n=n.apply(e,[])).next())})}(this,0,void 0,function*(){let i="",n="";var a=yield Fi.getInstance();return{mobileUI:i=a.isFirefox()?(n=he((e=>ye(`\n  <div class="moe_firefox" style="display:none;">\n    <div style='position:relative;top: 200px;left: 400px;height: 100px;width: 180px;color: white;font-size: larger;'>\n      ${e=(null==(e=null==e?void 0:e.desktop)?void 0:e.text)||""}\n    </div>\n    <div\n    style="position:relative;top: 45px;left: 300px;width: 80px;height: 80px;color: white;background-size: contain;transform: rotate(180deg);background-image: url('https://cdn.moengage.com/images/pointdown.png');background-repeat: no-repeat;">\n    </div>\n  </div>\n  `))(e.firefox),t),Ee((e=>ye(`\n  <div class='moe_firefox' style="display:none;height:100%;">\n    <div style='position:relative;top: 15%;left: 23%;height: 100px;width: 150px;color: white;font-size: larger;'>\n      ${e=(null==(e=null==e?void 0:e.mobile)?void 0:e.text)||""}\n    </div>\n    <div\n      style="position:relative;top: 5%;left: 240px;width: 80px;height: 80px;color: white;background-size: contain;background-image: url('https://cdn.moengage.com/images/pointdown.png');background-repeat: no-repeat;">\n    </div>\n  </div>\n  `))(e.firefox),t)):a.isOpera()?(n=he((e=>ye(`\n  <div class="moe_opera" style="display:none;">\n    <div style='position:relative;top: 240px;left: 40%;height: 100px;width: 180px;color: white;font-size: larger;'>\n      ${e=(null==(e=null==e?void 0:e.desktop)?void 0:e.text)||""}\n    </div>\n    <div\n      style="position:relative;top: 45px;left: 55%;width: 80px;height: 80px;color: white;background-size: contain;transform: rotate(180deg) scaleX(-1);background-image: url('https://cdn.moengage.com/images/pointdown.png');background-repeat: no-repeat;">\n    </div>\n  </div>\n  `))(e.opera),t),Ee((e=>ye(`\n  <div class='moe_opera' style="display:none;height:100%;">\n    <div style='position:relative;top: 15%;left: 23%;height: 100px;width: 150px;color: white;font-size: larger;'>\n      ${e=(null==(e=null==e?void 0:e.mobile)?void 0:e.text)||""}\n    </div>\n    <div\n      style="position:relative;top: 5%;left: 240px;width: 80px;height: 80px;color: white;background-size: contain;background-image: url('https://cdn.moengage.com/images/pointdown.png');background-repeat: no-repeat;">\n    </div>\n  </div>\n  `))(e.opera),t)):(n=he(ye(`\n  <div class="moe_chrome" style="display:none;">\n    <div style='position:relative;top: 200px;left: 400px;height: 100px;width: 180px;color: white;font-size: larger;'>\n      ${e.chrome.desktop.text}\n    </div>\n    <div\n      style="position:relative;top: 30px;left: 300px;width: 80px;height: 80px;color: white;background-size: contain;transform: rotate(180deg);background-image: url('https://cdn.moengage.com/images/pointdown.png');background-repeat: no-repeat;">\n    </div>\n  </div>\n  `),t),Ee((e=>ye(`\n  <div class='moe_chrome' style="display:none;height:100%;">\n    <div style='position:relative;top: 15%;left: 23%;height: 100px;width: 150px;color: white;font-size: larger;'>\n      ${e=(null==(e=null==e?void 0:e.mobile)?void 0:e.text)||""}\n    </div>\n    <div\n      style="position:relative;top: 5%;left: 240px;width: 80px;height: 80px;color: white;background-size: contain;background-image: url('https://cdn.moengage.com/images/pointdown.png');background-repeat: no-repeat;">\n    </div>\n  </div>\n  `))(e.chrome),t)),webUI:n}})}function he(e,t){return`\n  <div id='chrome_desktop_backend' style='z-index: 999999999;position: fixed;height: 100%;top: 0px;left: 0px;width: 100%;background: rgba(0, 0, 0, 0.89);'>\n    ${e}\n    ${t?"":ye('\n    <a href="#" target="_blank"\n    style="text-decoration: none !important;cursor: pointer !important;color:#A5A0A0 !important;font-size: 11px !important;bottom: 0px;left: 10px;position: absolute;"\n    onclick="window.open(\'https://moengage.com/web-push/?utm_source=moengage_branding&utm_medium=webpush\',\'_blank\');event.cancelBubble = true; if (event.stopPropagation) event.stopPropagation();return false;">\n    Powered by <img src="https://app-cdn.moengage.com/images/brand/logo_full_white.png"\n      style="max-width: 100% !important; height: 20px !important;vertical-align: middle !important; padding-right: 3px !important;"></a>\n      ')}\n  </div>\n  `}function Ee(e,t){return`\n  <div id='chrome_mobile_backend' style='z-index: 999999999;position: fixed;height: 100%;top: 0px;left: 0px;width: 100%;background: rgba(0, 0, 0, 0.798039);'>\n    ${e}\n    ${t?"":ye('\n    <a href="#" target="_blank"\n      style="text-decoration: none !important;cursor: pointer !important;color:#A5A0A0 !important;font-size: 11px !important;left: 0px;bottom: 23%;position: absolute;"\n      onclick="window.open(\'https://moengage.com/web-push/?utm_source=moengage_branding&utm_medium=webpush\',\'_blank\');event.cancelBubble = true; if (event.stopPropagation) event.stopPropagation();return false;">\n      Powered by <img src="https://app-cdn.moengage.com/images/brand/logo_full_white.png"\n        style="max-width: 100% !important; height: 20px !important;vertical-align: middle !important; padding-right: 3px !important;"></a>\n      ')}\n  </div>\n  `}var ve=function(e,t,i,n){return new(i=i||Promise)(function(a,r){function o(e){try{l(n.next(e))}catch(e){r(e)}}function s(e){try{l(n.throw(e))}catch(e){r(e)}}function l(e){var t;e.done?a(e.value):((t=e.value)instanceof i?t:new i(function(e){e(t)})).then(o,s)}l((n=n.apply(e,t||[])).next())})};let Ki=null;class ji{constructor(e){this.attributes=[],this.subscribedToOldSdk=!1,null==e?(this.deviceUuid=(0,oe.v4)(),this.attributes=[],this.deviceAdded=!1):(this.deviceUuid=o(e,"deviceUuid",(0,oe.v4)()),this.attributes=o(e,"attributes",[]),this.deviceAdded=o(e,"deviceAdded",!1))}addAttribute(e){let t=ji.baseLogTag+".addAttribute";return new Promise(i=>ve(this,void 0,void 0,function*(){let n=!0,a=(e.key=ji.getMorphedKey(e.key),-1);for(let t=this.attributes.length-1;0<=t;t--)e.key===this.attributes[t].key&&e.level===this.attributes[t].level&&(a=t);0<=a?(ue(this.attributes[a].value,e.value)&&(Si.log(2,t,"Duplicate attribute found: ",e),n=yield this.isAttibuteTrackingRequired(this.attributes[a].updated_at,this.attributes[a].level)),n&&(this.attributes[a].value=e.value,this.attributes[a].updated_at=(new Date).getTime())):(Si.log(2,t,"Adding attribute:",e),this.attributes.push(e)),this.save().then(()=>{i(n)})}))}isAttibuteTrackingRequired(e,t=Gi.USER_ATTRIBUTE_LEVEL.PROJECT){return ve(this,void 0,void 0,function*(){var i=yield Wi();return t===Gi.USER_ATTRIBUTE_LEVEL.PORTFOLIO&&null!==i.configs.portfolioUserAttributeCacheTime?De(e)>i.configs.portfolioUserAttributeCacheTime:null===i.configs.userAttributeCacheTime||De(e)>i.configs.userAttributeCacheTime})}static getLocalUser(){let e=ji.baseLogTag+".getLocalUser";return new Promise(t=>{var i;Li.get(yt.USER_DATA)?(Si.log(2,e,"Found user in localstorage"),i=Li.get(yt.USER_DATA),t(new ji(i))):t(null)})}static getCookieUser(){return new Promise(e=>{var t=ji.baseLogTag+".getLocalUser";Ni.get(yt.USER_DATA)?(Si.log(2,t,"Found user in cookie"),t=Ni.get(yt.USER_DATA),e(new ji(t))):e(null)})}static getMigrationUser(){let e=ji.baseLogTag+".getLocalUser";return new Promise(t=>{var i=localStorage.getItem(yt.OLD_SDK.USER_DATA);if(i)try{var n=JSON.parse(i);if(n.is_new_sdk_migrated)t(null);else{var a,r=new ji({deviceAdded:o(n,"device_add",!1),deviceUuid:o(n,"uuid",(0,oe.v4)())}),s=o(n,"user_attrs",{});for(a in s)s.hasOwnProperty(a)&&r.attributes.push(new Gi(a,s[a]));var l=localStorage.getItem(yt.OLD_SDK.PUSH_TOKEN);null!=l&&"NA"!==l&&"null"!==l&&(r.subscribedToOldSdk=!0),t(r)}}catch(i){Si.error(1,e,"Error getting the migration user. Resolving as a new user."),Si.error(1,e,i),t(null)}else t(null)})}static getSync(){return ji.instance}static get(){let e=ji.baseLogTag+".get";return null!=Ki?Ki:Ki=new Promise((t,i)=>{Fi.getInstance().then(e=>Wi()).then(t=>{var i=ji.getLocalUser(),n=t.isDomainLevelStorage?ji.getCookieUser():"resolved",a=ji.getMigrationUser();return Promise.all([i,n,a]).then(i=>{let n=i[0],a=i[1];return(i=i[2])?i.save().then(t=>{var i=localStorage.getItem(yt.OLD_SDK.USER_DATA);if(i)try{var n=JSON.parse(i);n.is_new_sdk_migrated=!0,localStorage.setItem(yt.OLD_SDK.USER_DATA,JSON.stringify(n))}catch(t){Si.error(1,e,"Error parsing migration user JSON",t)}return Si.log(1,e,"User resolved from older SDK: ",t),t}):(()=>{var i;return(a&&"resolved"!==a?(Si.log(1,e,"User resolved from cookie: ",a),a):(Si.log(1,e,"Local user: ",n),i=new ji(n),t.isPushSubBilling&&(ge()||((e,t)=>{let i=[Nt.EMAIL,Nt.MOBILE,...t];return 0<e.filter(e=>i.includes(e.key)).length||be()})(i.attributes,null==t?void 0:t.configs.subscriberBasedBillingAttributes)?(i.deviceAdded=!0,pn.trackDeviceAttributes()):i.deviceAdded=!1),i)).save()})()})}).then(e=>{ji.isResolved=!0,t(e)}).catch(t=>{Si.error(1,e,"Error in fetching/creating user",t),Ki=null,i(t)})})}static logout(){return new Promise(e=>{Ki=null,this.instance=null,window.MoeWebP&&(window.MoeWebP.deviceUuid=null),e(!0)})}save(){ji.baseLogTag,ji.isAmpEnabled()&&(this.deviceUuid=Ni.get("moe_uuid")),Li.get("WEB_SETTINGS");var e=Li.get(yt.WEB_SETTINGS);return null!=e&&e.configs.isWebPersonalizationModuleEnabled&&null!=(e=window.MoeWebP)&&e.deviceUuid&&this.deviceUuid!==window.MoeWebP.deviceUuid&&(this.deviceUuid=window.MoeWebP.deviceUuid),ji.instance=this,new Promise(e=>{Li.set(yt.USER_DATA,this),Ni.setRaw(Vt.UUID,ji.instance.deviceUuid),e(this)})}static isAmpEnabled(){var e=Ni.get(Vt.UUID);return e&&e.includes("amp")}getAttribute(e){let t=null;return e=ji.getMorphedKey(e),this.attributes.map(i=>{i.key===e&&(t=i.value)}),t}indexOfAttribute(e){let t=-1;return e=ji.getMorphedKey(e),this.attributes.map((i,n)=>{i.key===e&&(t=n)}),t}static getMorphedKey(e){switch(e){case"id":e=Nt.ID;break;case"email":e=Nt.EMAIL;break;case"name":e=Nt.NAME;break;case"first_name":e=Nt.FIRST_NAME;break;case"last_name":e=Nt.LAST_NAME;break;case"mobile":e=Nt.MOBILE;break;case"gender":e=Nt.GENDER;break;case"birthday":e=Nt.BDAY}return e}}ji.baseLogTag="UserModel",ji.isResolved=!1,ji.instance=null;var fe=function(e,t,i,n){return new(i=i||Promise)(function(a,r){function o(e){try{l(n.next(e))}catch(e){r(e)}}function s(e){try{l(n.throw(e))}catch(e){r(e)}}function l(e){var t;e.done?a(e.value):((t=e.value)instanceof i?t:new i(function(e){e(t)})).then(o,s)}l((n=n.apply(e,t||[])).next())})};function Se(e){e=(e+"=".repeat((4-e.length%4)%4)).replace(/\-/g,"+").replace(/_/g,"/");var t=atob(e),i=new Uint8Array(t.length);for(let e=0;e<t.length;++e)i[e]=t.charCodeAt(e);return i}function _e(e){let t="";var i="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",n=new Uint8Array(e),a=(e=n.byteLength)%3,r=e-a;let o,s,l,d,c;for(let e=0;e<r;e+=3)c=n[e]<<16|n[e+1]<<8|n[e+2],o=(16515072&c)>>18,s=(258048&c)>>12,l=(4032&c)>>6,d=63&c,t+=i[o]+i[s]+i[l]+i[d];return 1==a?(c=n[r],o=(252&c)>>2,s=(3&c)<<4,t+=i[o]+i[s]+"=="):2==a&&(c=n[r]<<8|n[1+r],o=(64512&c)>>10,s=(1008&c)>>4,l=(15&c)<<2,t+=i[o]+i[s]+i[l]+"="),t}function Ie(e){return e.replace(/[\uff0e]/g,".")}function Te(e){return new Date(Date.parse(e))}function ye(e){let t,i=e;return e=_i.get(),"string"==typeof i&&i.length&&null!=(t=null==e?void 0:e.proxyDomains)&&t.api&&(e.proxyDomains.cdnApp&&(i=i.replace(/app-cdn\.moengage\.com/gi,e.proxyDomains.cdnApp)),e.proxyDomains.cdnScript&&(i=i.replace(/cdn\.moengage\.com/gi,e.proxyDomains.cdnScript)),e.proxyDomains.cdnImage)?i.replace(/image\.moengage\.com/gi,e.proxyDomains.cdnImage):i}function be(){var e;return Ei.get(Tt.HAS_USER_LOGGED_OUT)||!(e=Ri(window.location.href)).moe_aid||e.moe_aid.includes("{{")?void 0:e.moe_aid}function Ae(){var e=!!(e=_i.get())&&!!e.disableSdk;let t=!1;return!((t=(Oe()?Ni:Li).get(yt.SDK_DISABLED))||e&&!1!==t)}function Oe(){var e=Li.get(yt.WEB_SETTINGS);return null!=e&&e.isDomainLevelStorage}function we(e){return null!=e&&"NA"!==e&&""!==e&&"null"!==e}function De(e){return e=(new Date).getTime()-e,Math.round(e/1e3)}class Yi{static getListeners(){return this.listeners}static getTopicListeners(e){return o(Yi.topicListeners,e,[])}static addListener(e){Yi.listeners.push(e)}static addTopicListener(e,t){Yi.topicListeners[e]=Yi.getTopicListeners(e),Yi.topicListeners[e].push(t)}static broadcast(e){Yi.listeners.map(t=>{t(e)}),o(Yi.topicListeners,e.topic,[]).map(t=>{t(e)})}static broadcastToWindow(e,t=!1){window&&(t||Ae())&&window.dispatchEvent(new CustomEvent(e.topic,{detail:{name:e.name,data:e.data||null}}))}static deprecatedSdkCallback(e){window.dispatchEvent(new CustomEvent("MOE_OPT_IN",{detail:e}))}static resetAllListeners(){Yi.listeners=[],Yi.topicListeners={}}static resetListeners(){Yi.listeners=[]}}Yi.listeners=[],Yi.topicListeners={};let qi=Yi,zi=e=>e===wt.UNSUBSCRIBED||e===wt.PERMISSION_BLOCKED;function Ne(){qi.broadcastToWindow({topic:Pt.MOE_LIFECYCLE.TOPIC_NAME,name:Pt.MOE_LIFECYCLE.EVENT_NAMES.MOE_INIT_COMPLETED})}let $i=e=>{let t;try{t=JSON.stringify(e)}catch(e){return!1}return new Blob([t]).size/1024>ri.MAX_PAYLOAD_SIZE};function Ce(e){return`Event "${e}" can't get tracked as its size is more than ${ri.MAX_PAYLOAD_SIZE} KB. Max permissible event size is ${ri.MAX_PAYLOAD_SIZE} KB.`}let Ji={isBoolean:e=>"boolean"==typeof e,isNumber:e=>"number"==typeof e,isString:e=>"string"==typeof e,isNumeric:e=>"number"==typeof e||"string"==typeof e&&Number(e).toString()===e,isDate:e=>"[object Date]"===Object.prototype.toString.call(e),isArray:e=>Array.isArray(e)};class Xi{initiateSessionAndSource(e){return new Promise((t,i)=>{this.isSessionRunning()&&this.isCurrentSourceSameAsPreviousSource()||this.startNewSession(e),t(!0)})}clearSessionAndSource(){Li.remove(Ut.SESSION)}isSessionRunning(){return this.getSessionKey()&&!this.isSessionExpired()}isSessionExpired(){var e=this.getSessionExpiryTime(),t=Ei.get("wasBrowserInactive");return!(!t&&null!==t)&&(this.isWindowActive()&&Ei.set("wasBrowserInactive",!1),(new Date).getTime()>e)}isNonEventInteractive(e){return Xi.NON_INTERACTIVE_EVENTS.includes(e.name)||0<e.attributes.filter(e=>"moe_non_interactive"===e.key&&1===e.value).length}getCurrentSource(){let e=Ri(window.location.href),t="",i={};var n;if(Object.keys(e).includes("utm_source"))return t="utm_",this.geCustomIdentifiersToTrack().forEach(t=>{e[t]&&(i[t]=e[t])}),n={source_url:window.location.href},e[t+"source"]&&(n.source=e[t+"source"]),e[t+"medium"]&&(n.medium=e[t+"medium"]),e[t+"term"]&&(n.term=e[t+"term"]),e[t+"campaign"]&&(n.campaign_name=e[t+"campaign"]),e[t+"content"]&&(n.content=e[t+"content"]),e.utm_id&&(n.campaign_id=e.utm_id),Object.keys(i).length&&(n.extra=i),n}getActiveSource(){return this.getSavedSource()||this.getCurrentSource()}isSourceOrganic(){let e=Ri(window.location.href);var t=Object.keys(e);let i=!1;return this.geCustomIdentifiersToTrack().forEach(t=>{e[t]&&(i=!0)}),!t.includes("utm_source")&&!t.includes("source")&&!i}setCurrentSource(e){var t=this.getSession()||{};t.currentSource=e,Li.set(Ut.SESSION,t)}removeCurrentSource(){var e=this.getSession();e&&(e.currentSource=void 0,Li.set(Ut.SESSION,e))}getSavedSource(){var e=o(this.getSession(),Ut.CURRENT_SOURCE,void 0);if(e)return e}isCurrentSourceSameAsPreviousSource(){var e,t;return!!this.isSourceOrganic()||(delete(e=Object.assign({},this.getCurrentSource())).source_url,delete(t=Object.assign({},this.getSavedSource())).source_url,ue(e,t))}getSessionKey(){return o(this.getSession(),Ut.SESSION_KEY,null)}getSessionStartTime(){return o(this.getSession(),Ut.SESSION_START_TIME,null)}getSessionExpiryTime(){return o(this.getSession(),Ut.SESSION_EXPIRY_TIME,null)}getSessionMaxTime(){return o(this.getSession(),Ut.SESSION_MAX_TIME,null)}getSession(){return Li.get(Ut.SESSION)}geCustomIdentifiersToTrack(){return o(this.getSession(),Ut.CUSTOM_IDENTIFIERS_TO_TRACK,[])||[]}generateSessionKey(){return(0,oe.v4)()}startNewSession(e){this.removeCurrentSource();var t=this.getNumberOfSessions();e={sessionKey:this.generateSessionKey(),sessionStartTime:(new Date).toISOString(),sessionMaxTime:e.configs.sessionInactiveDuration,customIdentifiersToTrack:e.configs.sourceExtraParams,sessionExpiryTime:(new Date).getTime()+1e3*e.configs.sessionInactiveDuration,numberOfSessions:++t},Li.set(Ut.SESSION,e)}extendSession(){var e=this.getSession();e&&(e.sessionExpiryTime=(new Date).getTime()+1e3*e.sessionMaxTime,Li.set(Ut.SESSION,e))}handleBrowserInactivity(e){"hidden"===e&&Ei.set("wasBrowserInactive",!0)}isWindowActive(){return!!Ei.get("isWindowActive")}getNumberOfSessions(){return o(Li.get(Ut.SESSION),Ut.NUMBER_OF_SESSIONS)||0}}function Le(e){return`${(e=e?new Date(e):new Date).getDate()}:${e.getMonth()+1}:${e.getFullYear()}:${e.getHours()}:${e.getMinutes()}:`+e.getSeconds()}function Pe(e){return"object"==typeof e&&!Ji.isDate(e)}Xi.NON_INTERACTIVE_EVENTS=[wt.WEB_OPTIN_BANNER_LOAD,wt.OPT_IN_SHOWN,wt.WEB_OPTIN_BANNER_LOAD,wt.LOGOUT];class Qi{constructor(e){this.EVENT_ACTION=e.event.name,this.EVENT_ATTRS=e.event.attributes&&Zi(e.event.attributes),this.EVENT_G_TIME=(new Date).getTime().toString(),this.EVENT_L_TIME=Le(e.event.timestamp),this.EVENT_ATTRS_CUST=e.postData.c,this.N_I_E=e.postData.nie,e.isPortfolioAttribute&&(this.IS_PORTFOLIO=e.isPortfolioAttribute)}}Qi.baseLogTag="ReportAddViewEvent";let Zi=e=>{let t={};return e.forEach(e=>{t[e.key]=e.value}),t};class en{static visibilityChange(){"hidden"!==document.visibilityState||en.windowClosed||on.reactToTriggerEvents()}static removeEventListeners(){document.removeEventListener("visibilitychange",en.visibilityChange,!1)}static addListeners(){document.addEventListener("visibilitychange",en.visibilityChange,!1)}}en.windowClosed=!1;let tn=en;class nn{static initialize(){return function(e,t,i,n){return new(i=i||Promise)(function(t,a){function r(e){try{s(n.next(e))}catch(e){a(e)}}function o(e){try{s(n.throw(e))}catch(e){a(e)}}function s(e){var n;e.done?t(e.value):((n=e.value)instanceof i?n:new i(function(e){e(n)})).then(r,o)}s((n=n.apply(e,[])).next())})}(this,0,void 0,function*(){var e,t;return null==nn.ready&&(nn.offlineDataStore=r.createInstance({driver:[r.INDEXEDDB],name:qt.DATABASE_NAME,storeName:qt.STORES.OFFLINE_DATA.NAME}),t=r.createInstance({driver:[r.INDEXEDDB],name:qt.DATABASE_NAME,storeName:"moe_data"}),e=r.createInstance({driver:[r.INDEXEDDB],name:qt.DATABASE_NAME,storeName:"moe_backup"}),t=[nn.offlineDataStore.ready(),t.ready(),e.ready()],nn.ready=Promise.all(t)),yield nn.ready})}}class an{static getRemoteLogsBatchRequestOptions(e){return new Promise(t=>{pn.collectGetParams().then(i=>{i={query_params:Object.assign(Object.assign({},i),{unique_id:i.unique_id,os:"web"===i.os?"Web":"mWeb"}),logs:[...e]},t(i)})})}static sendBatchOfLogs(e){let t=pn.baseLogTag+".sendBatchOfLogs";return new Promise((i,n)=>{an.getRemoteLogsBatchRequestOptions(e).then(n=>{var a=(a=Hi()).baseDomainName+ii.END_POINT+n.query_params.os.toLowerCase()+"/"+a.appId;ki.post(a,{postData:n}).then(()=>{Si.log(1,t,"[sendBatchOfLogs] batch payload: "+JSON.stringify(e)),Si.log(1,t,"Batch Remote Logs sent to MoEngage successfully"),an.batchRemoteLogsApiRetries=1,i(!0)}).catch(i=>{Si.log(1,t,"Batch Remote Logs API failed",i),this.handleRemoteLogsFailure(e)})})})}static handleRemoteLogsFailure(e){var t=pn.baseLogTag+".handleRemoteLogsFailure";Si.log(1,t,"Retry Batch Logs Failed API",an.batchRemoteLogsApiRetries),an.batchRemoteLogsApiRetries<3&&setTimeout(()=>{an.batchRemoteLogsApiRetries++,an.sendBatchOfLogs(e)},3e3*an.batchRemoteLogsApiRetries)}static sendBeacon(e){an.getRemoteLogsBatchRequestOptions(e).then(e=>{var t=(t=Hi()).baseDomainName+ii.END_POINT+e.query_params.os.toLowerCase()+"/"+t.appId+"?"+(new Date).getTime();Si.log(1,"RemoteLogsApi.sendBeacon","[sendBeacon] Remote Logs batch payload: "+JSON.stringify(e)),navigator.sendBeacon(t,JSON.stringify(e))})}}an.batchRemoteLogsApiRetries=1;var Re=function(e,t,i,n){return new(i=i||Promise)(function(a,r){function o(e){try{l(n.next(e))}catch(e){r(e)}}function s(e){try{l(n.throw(e))}catch(e){r(e)}}function l(e){var t;e.done?a(e.value):((t=e.value)instanceof i?t:new i(function(e){e(t)})).then(o,s)}l((n=n.apply(e,t||[])).next())})};class rn{static updateEventStore(){le()!==oi.TV&&r.createInstance({driver:[r.INDEXEDDB,r.WEBSQL,r.LOCALSTORAGE],name:Wt.DATABASE_NAME,storeName:Wt.STORE_NAME}).setItem(Wt.STORE_NAME,rn.reports)}static spliceReports(e=rn.reports.length){return e=rn.reports.splice(0,e),rn.updateEventStore(),e}static spliceRemoteLogs(e=rn.remoteLogs.length){return rn.remoteLogs.splice(0,e)}static suspendBatching(){var e=rn.baseLogTag+".suspendBatching";this.spliceReports(),this.spliceRemoteLogs(),rn.periodicSyncInterval&&rn.clearInterval(),tn.removeEventListeners(),Si.log(2,e,"Batching has stopped.")}static shouldCreateNewBatch(){return!rn.lastbatchCreatedAt||(new Date).getTime()-rn.lastbatchCreatedAt>=zt.CONFIG.TIME_BETWEEN_BATCHES}static shouldCreateNewBatchForRemoteLogs(){return!rn.lastRemoteLogsbatchCreatedAt||(new Date).getTime()-rn.lastRemoteLogsbatchCreatedAt>=zt.CONFIG.TIME_BETWEEN_BATCHES}static reactToTriggerEvents(){var e=rn.baseLogTag+".reactToTriggerEvents";0<rn.reports.length?(Si.log(1,e,`Trigger Events: Created Batch of ${rn.reports.length} reports`,Le()),rn.createBatch()):Si.log(2,e,Le()+": No report's to sync for this event."),0<rn.remoteLogs.length?(Si.log(1,e,`Trigger Events: Created Batch of remote logs ${rn.remoteLogs.length} reports`,Le()),rn.createRemoteLogsBatch()):Si.log(2,e,Le()+": No logs's to sync for remote logs.")}static periodicSync(e){var t=rn.baseLogTag+".periodicSync";0<rn.reports.length&&rn.shouldCreateNewBatch()?(Si.log(1,t,`Periodic sync: Created Batch of ${rn.reports.length} reports`,Le()),rn.createBatch()):Si.log(2,t,Le()+`: No report's to sync at this interval. The next sync will attempt in ${e} seconds`),0<rn.remoteLogs.length&&rn.shouldCreateNewBatchForRemoteLogs()?(Si.log(1,t,`Periodic sync: Created Batch of remote logs ${rn.reports.length} reports`,Le()),rn.createRemoteLogsBatch()):Si.log(2,t,Le()+`: No report's to sync at this interval for remote logs. The next sync will attempt in ${e} seconds`)}static clearInterval(){clearInterval(rn.periodicSyncInterval),rn.lastbatchCreatedAt=null}static init(e){Fi.getInstance().then(t=>Re(this,void 0,void 0,function*(){(rn.isOfflineBatchingSupported(t,e)||e.configs.remoteLogTracking)&&(yield nn.initialize(),rn.periodicSyncInterval&&rn.clearInterval(),rn.periodicSyncInterval=window.setInterval(rn.periodicSync.bind(this,e.configs.periodicFlushTime),1e3*e.configs.periodicFlushTime),tn.addListeners())}))}static sendBatch(e){let t=rn.baseLogTag+".sendBatch";return new Promise(i=>{try{pn.sendBatchOfReports(e).then(()=>{rn.lastbatchCreatedAt=(new Date).getTime(),i(!0)})}catch(e){Si.error(1,t,"Error in sending batch",e),i(!1)}})}static sendRemoteLogs(e){let t=rn.baseLogTag+".sendRemoteLogs";return new Promise(i=>{try{an.sendBatchOfLogs(e).then(()=>{rn.lastRemoteLogsbatchCreatedAt=(new Date).getTime(),i(!0)})}catch(e){Si.error(1,t,"Error in sending batch of remote logs",e),i(!1)}})}static createBatch(e){0<rn.reports.length&&(e=rn.spliceReports(e),rn.sendBatch(e))}static createRemoteLogsBatch(e){0<rn.remoteLogs.length&&(e=rn.spliceRemoteLogs(e),rn.sendRemoteLogs(e))}static addReport(e,t){var i=rn.baseLogTag+".addReport";return e=new Qi(e),$i(e)?(Si.error(1,i,Ce(e.EVENT_ACTION)),!1):(rn.reports.push(e),$i(rn.reports)?(rn.reports.pop(),Si.log(1,i,`Created Batch of ${rn.reports.length} reports as payload size would have breached after adding new event to this batch: "${e.EVENT_ACTION}"`,Le()),rn.createBatch(),rn.reports.push(e),rn.updateEventStore()):(rn.updateEventStore(),rn.reports.length===t&&(Si.log(1,i,`Created Batch of ${t} reports`,Le()),rn.createBatch(t))),!0)}static sendBeacon(){var e=rn.baseLogTag+".sendBeacon";0<rn.reports.length&&(Si.log(1,e,`Window Unload: Created batch of ${rn.reports.length} reports`,Le()),pn.sendBeacon(rn.spliceReports())),0<rn.remoteLogs.length&&(Si.log(1,e,`Window Unload: Created Remote Logs batch of ${rn.remoteLogs.length} reports`,Le()),an.sendBeacon(rn.spliceRemoteLogs()),rn.lastRemoteLogsbatchCreatedAt=(new Date).getTime())}static flushReports(e=!1){return Re(this,void 0,void 0,function*(){var t=rn.baseLogTag+".flushReports";try{e&&tn.removeEventListeners(),0<rn.reports.length&&(Si.log(1,t,`Flushed ${rn.reports.length} reports`,Le()),yield rn.sendBatch(rn.spliceReports())),0<rn.remoteLogs.length&&(Si.log(1,t,`Flushed ${rn.remoteLogs.length} remote logs`,Le()),yield rn.sendRemoteLogs(rn.spliceRemoteLogs()))}catch(e){Si.error(1,t,"Error in flushing reports",e)}})}static isOfflineBatchingSupported(e,t){return t=t||Li.get(yt.WEB_SETTINGS),rn.isBatchingSupported(t,e)}static addRemoteLogs(e,t=15){var i=rn.baseLogTag+".addRemoteLogs";rn.remoteLogs.push(e),rn.remoteLogs.length===t&&(Si.log(1,i,`Created Batch of ${t} reports`,Le()),rn.createRemoteLogsBatch(t))}static isBatchingSupported(e,t){try{var i=le();return!(null==e||!e.configs.isBatchingEnabled||("web"!==i||t.name!==Fi.BROWSER_NAMES.CHROME&&t.name!==Fi.BROWSER_NAMES.EDGE&&t.name!==Fi.BROWSER_NAMES.OPERA)&&("mobile"!==i||Fi.isIOS()||t.name!==Fi.BROWSER_NAMES.CHROME&&t.name!==Fi.BROWSER_NAMES.OPERA)||!navigator.sendBeacon)}catch(e){Si.error(1,"BatchManager.isBatchingSupported",e)}}}rn.baseLogTag="BatchManager",rn.reports=[],rn.remoteLogs=[],rn.lastbatchCreatedAt=null,rn.lastRemoteLogsbatchCreatedAt=null;let on=rn;class sn{constructor(){var e=sn.baseLogTag+".constructor";let t=ji.getSync().getAttribute("id");t=t?t.toString():void 0;var i=window.analytics;let n,a;if(i){a=i._VERSIONS;try{n=i.user().anonymousId()}catch(t){Si.error(1,e,"Error getting anonymous id from segment api",t)}}this.c=void 0,this.h="",e=Bi.getIdentityMap(),(t||n||null!=e&&e.userIdentities)&&(this.identifiers={moe_user_id:t,segment_id:n,user_identities:(null==e?void 0:e.userIdentities)||void 0,previous_identities:(null==e?void 0:e.previousIdentities)||void 0}),this.meta={bid:(0,oe.v4)(),segmentSdkData:i?a:void 0}}}sn.baseLogTag="ReportPostData";class ln{constructor(e,t,i,n=Gi.USER_ATTRIBUTE_LEVEL.PROJECT){ln.baseLogTag,this.type=e,this.getParams=t,this.event=i,this.isPortfolioAttribute=n===Gi.USER_ATTRIBUTE_LEVEL.PORTFOLIO,this.postData=new sn;var a,r,o={},s={};for(a of i.attributes)a&&null!=a.key&&(this.status=ln.STATUS.VALID,null!=a.value)&&("function"==typeof a.value.getMonth?((r={})[a.key]=Math.round(a.value.getTime()-6e4*a.value.getTimezoneOffset()),null==s.timestamp&&(s.timestamp=[]),s.timestamp.push(r)):o[a.key]=a.value);this.postData.e=i.name,this.postData.a=o,this.postData.c=(e=s,0===Object.keys(e).length&&e.constructor===Object?void 0:s),window&&window.location&&null!=window.location.href&&(this.postData.url=window.location.href)}}ln.baseLogTag="ReportClass",(a=(S=ln=ln||{}).STATUS||(S.STATUS={}))[a.INVALID=0]="INVALID",a[a.VALID=1]="VALID",(a=S.REPORT_ADD_TYPE||(S.REPORT_ADD_TYPE={}))[a.USER_ATTRIBUTE=0]="USER_ATTRIBUTE",a[a.EVENT=1]="EVENT";let dn=ln;class cn{constructor(e,t,i=!0){this.name=e,this.attributes=t,this.timestamp=(new Date).getTime(),i&&this.attributes.push(new Gi(Dt.URL,location.href))}static createUserAttributeEvent(e){return new Promise((t,i)=>{var n=[],a=e.key;switch(e.key){case"id":e.key=Nt.ID;break;case"email":e.key=Nt.EMAIL;break;case"name":e.key=Nt.NAME;break;case"first_name":e.key=Nt.FIRST_NAME;break;case"last_name":e.key=Nt.LAST_NAME;break;case"mobile":e.key=Nt.MOBILE;break;case"gender":e.key=Nt.GENDER;break;case"birthday":e.key=Nt.BDAY}n.push(e),e.key!==a&&Si.log(2,"Event.createUserAttributeEvent","Key changed to MoE reserved keyname: ",e.key),t(new cn(wt.USER_ATTRIBUTE,n,!1))})}static createEvent(e,t,i){return new Promise((n,a)=>{ji.get().then(a=>function(e,t,i,n){return new(i=i||Promise)(function(t,a){function r(e){try{s(n.next(e))}catch(e){a(e)}}function o(e){try{s(n.throw(e))}catch(e){a(e)}}function s(e){var n;e.done?t(e.value):((n=e.value)instanceof i?n:new i(function(e){e(n)})).then(r,o)}s((n=n.apply(e,[])).next())})}(this,0,void 0,function*(){try{var r=new Gi(Dt.LOGGED_IN_STATUS,!!a.getAttribute("id")),o=new Xi,s=new Gi(Dt.FIRST_VISIT,o.getNumberOfSessions()<=Jt.FIRST_SEEN_SESSIONS);t.push(r,s),n(new cn(e,t,i))}catch(r){Si.error(1,"Event.createEvent","Error occurred in create events ",r)}}))})}}class un{static addEvent(e){un.history.push(e),un.listeners.forEach(t=>{t(e)})}static getHistory(){return un.history}static addEventListener(e){un.listeners.push(e)}static clear(){un.history=[]}static clearAll(){un.history=[],un.listeners=[]}}var Me;un.history=[],un.listeners=[];class gn{static track(e,t,i){let n="MoEngage.event.trackEvent";return new Promise((a,r)=>function(e,t,i,n){return new(i=i||Promise)(function(t,a){function r(e){try{s(n.next(e))}catch(e){a(e)}}function o(e){try{s(n.throw(e))}catch(e){a(e)}}function s(e){var n;e.done?t(e.value):((n=e.value)instanceof i?n:new i(function(e){e(n)})).then(r,o)}s((n=n.apply(e,[])).next())})}(this,0,void 0,function*(){var r,o;if(Ae()){let d;i=!!i;try{d=yield Wi()}catch(i){return Si.warn(1,n,"SDK not yet initialized. Caching event and will track when SDK is initialized.",i),null!=(r=window.moengage_q)&&r.push({f:"track_event",a:[e,t]}),void a(!1)}if("string"==typeof e&&e)if(d.configs.blacklistedEvents&&d.configs.blacklistedEvents.includes(e))Si.error(1,n,`This event "${e}" is blacklisted. Please contact Moengage team to whitelist it.`),a({error:5001,message:`Event "${e}" is blacklisted.`});else if(!Qt.includes(e)||d.configs.whitelistedEvents&&d.configs.whitelistedEvents.includes(e))try{var s=[];if(null==t||null!==t&&t===Object(t)&&"[object Object]"===Object.prototype.toString.call(t)){for(var l in t=null==t?{}:t)t.hasOwnProperty(l)&&s.push(new Gi(l,t[l]));let n=new Xi,r=(yield n.initiateSessionAndSource(d),yield cn.createEvent(e,s));un.addEvent(r),null!=d&&d.configs.isWebPersonalizationModuleEnabled&&null!=(o=window.MoeWebP)&&o.handleInSessionEvent(r),pn.collectGetParams().then(t=>{zi(e)&&delete t.push_id,t=new dn(dn.REPORT_ADD_TYPE.EVENT,t,r);var o={session_id:n.getSessionKey(),start_time:n.getSessionStartTime(),background_initiated:0},s=[],l=n.getActiveSource();l&&(n.setCurrentSource(l),s.push(l)),t.postData.meta.session=o,s.length&&(t.postData.meta.source=s),n.isNonEventInteractive(r)&&(t.postData.nie=1),pn.reportAdd(t,i).then(()=>{n.isNonEventInteractive(r)||n.extendSession(),a(!0)})})}else Si.error(1,n,"Event attributes were not passed a key-value pair object for event: "+e),a({error:5002,message:"Event value needs to be a key-value pair object"})}catch(e){Si.error(1,n,"Error occurred in tracking events ",e)}else Si.log(2,n,`This event "${e}" has not been whitelisted. Please contact Moengage team to whitelist it.`),a({error:5001,message:`Event "${e}" is not whitelisted.`});else Si.error(1,n,"Event name not a string or null or empty string:",e),a({error:5001,message:"Event name can not be null"})}else Si.warn(2,n,`Not tracking the event "${e}" as Web SDK has been disabled.`),a(!1)}))}}(S=Me=Me||{}).PROMPT="prompt",S.GRANTED="granted",S.DENIED="denied",S.DISMISSED="dismissed";var ke,xe=function(e,t,i,n){return new(i=i||Promise)(function(a,r){function o(e){try{l(n.next(e))}catch(e){r(e)}}function s(e){try{l(n.throw(e))}catch(e){r(e)}}function l(e){var t;e.done?a(e.value):((t=e.value)instanceof i?t:new i(function(e){e(t)})).then(o,s)}l((n=n.apply(e,t||[])).next())})};class pn{static deviceAdd(e=!0){var t=pn.baseLogTag+".deviceAdd";return pn.isExecutingDeviceAdd?(Si.warn(2,t,"Device add is already in progress. Skipping this call."),Promise.resolve(!1)):(pn.isExecutingDeviceAdd=!0,new Promise((t,i)=>xe(this,void 0,void 0,function*(){if(Ae()){let n=_i.get();return pn.collectGetParams(ri.API.DEVICE_ADD).then(a=>{a={queryParams:a=Object.assign(Object.assign({},a),{url:window.location.href})},ki.post(n.baseDomainName+ri.API.DEVICE_ADD,a).then(()=>{e?ji.get().then(e=>{e.deviceAdded=!0,e.save().then(()=>{En.startPeriodicClear(yt.Q.REPORT),pn.onDeviceAdd.res()})}).then(()=>{this.trackDeviceAttributes(),pn.isExecutingDeviceAdd=!1,t(!0)}):(pn.isExecutingDeviceAdd=!1,t(!0))}).catch(e=>{Pi.enqueue(yt.Q.DEVICE,!0),pn.isExecutingDeviceAdd=!1,i(!1)})})}t(!1)})))}static trackDeviceAttributes(){let e=pn.baseLogTag+".trackDeviceAttributes";return new Promise((t,i)=>xe(this,void 0,void 0,function*(){try{var i="WEB"===(i=le().toUpperCase())?"DESKTOP":i;gn.track(wt.DEVICE_ATTRIBUTE,{deviceType:i});let t=!1;Fi.getInstance().then(i=>{Wi().then(n=>xe(this,void 0,void 0,function*(){if(l(n,i)){let i=ge();if(!i)try{var a=s()||{};let e="";(e="function"==typeof a.getPermissionState?yield a.getPermissionState():e)===Me.GRANTED&&(i=!0)}catch(t){Si.error(2,e,"Failed to get push notification permission state.",t)}t=i}})).then(()=>{gn.track(wt.DEVICE_ATTRIBUTE,{[ti.MOE_PUSH_OPTED]:!!t,source:"deviceAdd"}),Li.set(yt.OPTED_STATUS_TRACK_TIME,Date.now())})})}catch(i){Si.error(2,e,"Failed to track device attributes.",i)}t(null)}))}static reportAdd(e,t){let i=pn.baseLogTag+".reportAdd";return new Promise((n,a)=>{t=!!t,Wi().then(r=>{var o,s,l,d=Ei.get(Tt.LANDING_PAGE_TRACKING)&&(null==(d=null==r?void 0:r.configs)?void 0:d.landingPageTracking);try{if(d&&!u(null==(s=null==(o=e.event.attributes)?void 0:o[0])?void 0:s.key,null==(l=null==r?void 0:r.configs)?void 0:l.subscriberBasedBillingAttributes))return Si.log(2,i,"Landing page tracking enabled (both flag and config), processing report immediately:",e.event.name),Pi.isEmpty(yt.Q.REPORT)||(Si.log(2,i,"Flushing queued reports as landing page tracking is enabled"),En.clear(yt.Q.REPORT)),pn.executeReportAdd(e,t,n,a)}catch(r){Si.error(2,i,"Error checking push subscription attribute acceptance for landing page tracking:",r)}return r.isPushSubBilling?pn.handlePushSubBilling(e,t,r,n,a):pn.executeReportAdd(e,t,n,a)}).catch(e=>{Si.error(1,i,"Error in getting Web SDK Settings. This might indicate that the App is blocked."),a(!1)})})}static executeReportAdd(e,t,i,n){pn.reportAddInternal(e,t).then(()=>{this.sendBroadcast(e),i(!0)}).catch(()=>{n(!1)})}static handlePushSubBilling(e,t,i,n,a){let r=pn.baseLogTag+".handlePushSubBilling";ji.get().then(r=>{r.deviceAdded?pn.executeReportAdd(e,t,n,a):(pn.queueReportForDeviceAdd(e,i),n(!0))}).catch(i=>{Si.error(1,r,"Error getting user data for push subscriber billing:",i),pn.executeReportAdd(e,t,n,a)})}static queueReportForDeviceAdd(e,t){var i=pn.baseLogTag+".queueReportForDeviceAdd";Pi.enqueue(yt.Q.REPORT,e),Si.log(2,i,"Report added to queue as device not added yet:",e.event.name),e.type===dn.REPORT_ADD_TYPE.USER_ATTRIBUTE&&pn.handleUserAttributeForPushSubBilling(e,t)}static handleUserAttributeForPushSubBilling(e,t){var i=pn.baseLogTag+".handleUserAttributeForPushSubBilling";e.event.attributes&&0!==e.event.attributes.length&&(u(e.event.attributes[0].key,null==(e=null==t?void 0:t.configs)?void 0:e.subscriberBasedBillingAttributes)?(Si.log(2,i,"Attribute accepted for push sub billing."),pn.deviceAdd()):Si.log(2,i,"Attribute NOT accepted for push sub billing."))}static sendBroadcast(e){Xt.NAMES.includes(e.event.name)&&qi.broadcastToWindow({topic:Xt.TOPIC,name:e.event.name,data:e.event.attributes})}static getSegmentId(){var e=window.analytics;if(e&&e.user)return e.user().anonymousId()}static getBatchRequestOptions(e){return new Promise(t=>{pn.collectGetParams(zt.API.REPORT_ADD).then(i=>xe(this,void 0,void 0,function*(){var n,a=pn.getSegmentId()||"",r=ji.getSync(),o=_i.get(),s={session_id:(n=new Xi).getSessionKey(),start_time:n.getSessionStartTime(),background_initiated:0},l=[],d=n.getActiveSource(),{userIdentities:n,previousIdentities:d}=(d&&(n.setCurrentSource(d),l.push(d)),yield Bi.getIdentifiersFromIdentities()),c=(d={user_identities:n||void 0,previous_identities:d||void 0},yield this.getParamsFromCookie());let u=null;var g=Object.assign({},i);null!==c&&"object"==typeof c&&(u=c.moe_user_id,null!==c.push_id&&(g.push_id=c.push_id),null!==c.unique_id)&&(g.unique_id=c.unique_id),r={query_params:g,identifiers:Object.assign(Object.assign({moe_user_id:null!==u?u:r.getAttribute("id")||(null==n?void 0:n.uid)||void 0,segment_id:a||void 0},d),{moe_aid:be()}),meta:{bid:(0,oe.v4)(),request_time:(new Date).toISOString(),session:s,source:l.length?l:void 0,initiator:null!=(g=null==(c=null==o?void 0:o.proxyDomains)?void 0:c.api)&&g.length?"proxy_server":void 0},viewsCount:e.length,viewsInfo:[...e]},t(r)}))})}static getParamsFromCookie(){let e=this.baseLogTag+".getMoeUserIdFromCookies",t={moe_user_id:null,unique_id:null,push_id:null};return new Promise(i=>{Wi().then(e=>{var n,a;null!=e&&e.isDomainLevelStorage&&(e=Ni.get(yt.USER_DATA),a=null==(a=Ni.get(yt.SUBSCRIPTION_DETAILS))?void 0:a.token,e&&(null!=(n=e.attributes)&&n.length&&e.attributes.find(e=>e.key===Nt.ID)?t.moe_user_id=e.attributes.find(e=>e.key===Nt.ID).value:t.moe_user_id=void 0,null!=(n=e.deviceUuid))&&n.length&&(t.unique_id=e.deviceUuid),null!=a&&a.length&&we(a)?t.push_id=a:t.push_id=void 0),i(t)}).catch(n=>{Si.error(2,e,"Error occurred while trying to fetch SDK Settings: ",n),i(t)})})}static addReportsToOfflineDB(e,t){return xe(this,void 0,void 0,function*(){let i=pn.baseLogTag+".addReportsToOfflineDB";var n=yield pn.getBatchRequestOptions([]);yield nn.offlineDataStore.setItem(t||"report_add_"+(new Date).getTime(),e),yield nn.offlineDataStore.setItem("requestMetaData",n),yield nn.offlineDataStore.setItem(t||"batch_"+(new Date).getTime(),Object.assign(Object.assign({},n),{viewsCount:e.length,viewsInfo:e})),navigator.serviceWorker&&navigator.serviceWorker.ready.then(e=>{e.sync?e.sync.register(qt.OFFLINE_SYNC_EVENT).then(()=>{Si.log(2,i,"offline sync event registered")}).catch(e=>{Si.error(1,i,"Service worker sync error",e)}):Si.log(2,i,"Service worker sync unavailable")})})}static sendReportBeacon(e,t,i){var n=pn.baseLogTag+".sendReportBeacon";try{if(!e&&navigator.sendBeacon&&navigator.sendBeacon(t,new Blob([JSON.stringify(i)],{type:"text/plain;charset=UTF-8"})))return!0}catch(e){Si.error(2,n,"Failed to send Report call with Beacon:",e)}return!1}static sendBatchOfReports(e){let t=pn.baseLogTag+".sendBatchOfReports";return new Promise((i,n)=>{pn.getBatchRequestOptions(e).then(a=>{var r=_i.get();let o=r.baseDomainName+zt.API.REPORT_ADD+r.appId;Wi().then(n=>{if(!window.navigator.onLine)return this.sendToOfflineTracking(e,li,n);pn.sendReportBeacon(n.configs.isBeaconDisabled,o,a)?(Si.log(1,t,"[sendBatchOfReports] batch payload: "+JSON.stringify(e)),Si.log(1,t,"Batch sent to MoEngage successfully through beacon"),i(!0)):ki.post(o,{postData:a}).then(()=>{Si.log(1,t,"[sendBatchOfReports] batch payload: "+JSON.stringify(e)),Si.log(1,t,"Batch sent to MoEngage successfully"),i(!0)}).catch(a=>{Si.error(1,t,"Batch Report add API failed",a),i(this.sendToOfflineTracking(e,a,n))})}).catch(e=>{e!==li&&Si.error(1,t,"Error in getting Web SDK Settings. This might indicate that the App is blocked."),n(e)})})})}static sendToOfflineTracking(e,t,i){let n=pn.baseLogTag+".sendToOfflineTracking";return new Promise((a,r)=>{Ae()?Fi.getInstance().then(o=>{on.isOfflineBatchingSupported(o,i)?(Si.error(1,n,"Add Report API failed, adding reports to offline db. ",t),pn.addReportsToOfflineDB(e).then(()=>{Si.log(2,n,"Network offline: Batch added to offline db")}),a(!0)):(Si.warn(1,n,"Report not added to offline db. Offline tracking is supported only if batching is enabled. It is supported only on Chrome, Edge and Opera browsers on desktop web and Chrome and Opera browsers on Android web."),r(t))}).catch(()=>{r(t)}):(Si.warn(2,n,"Not adding report(s) to offline db as SDK has been disabled."),r(t))})}static reportAddInternal(e,t){let i=pn.baseLogTag+".reportAddInternal";return new Promise((n,a)=>{Wi().then(a=>{Fi.getInstance().then(r=>{if(t){var o,s=pn.getUpdatedPushDetails();for(o in s)!s.hasOwnProperty(o)||zi(e.event.name)&&"push_id"===o||(e.getParams[o]=s[o]);var l=de(),d=(l={queryParams:Object.assign(Object.assign({},e.getParams),l)},e.postData.nie?(delete(d=Object.assign({},e)).postData.meta.source,delete d.postData.meta.session,l.postData=d.postData):l.postData=e.postData,_i.get().baseDomainName);d+=ri.API.DEVICE_ADD,ki.post(d,l).then(()=>{var t="WEB"===(t=le().toUpperCase())?"DESKTOP":t;gn.track(wt.DEVICE_ATTRIBUTE,{deviceType:t}),n(pn.handleReportAddSuccess(e))}).catch(t=>{on.isBatchingSupported(a,r)?Pi.enqueue(yt.Q.DEVICE,e):pn.handleReportAddFailure(e,t)})}else on.isBatchingSupported(a,r)?(on.addReport(e,a.configs.eventBatchCount)&&(Si.log(1,i,"Event batched successfully:",e.event),this.addEventsToIDB(e.event)),n(!0)):(d=new Qi(e),$i(d)?(Si.error(1,i,Ce(d.EVENT_ACTION)),n(!1)):pn.sendBatchOfReports([d]).then(()=>{n(pn.handleReportAddSuccess(e))}).catch(t=>{pn.handleReportAddFailure(e,t)}))})}).catch(e=>{Si.error(1,i,"Error in getting Web SDK Settings. This might indicate that the App is blocked."),a(!1)})})}static handleReportAddSuccess(e){var t=pn.baseLogTag+".handleReportAddSuccess";return e.type===dn.REPORT_ADD_TYPE.EVENT?(Si.log(1,t,"Event tracked successfully:",e.event),this.addEventsToIDB(e.event)):e.type===dn.REPORT_ADD_TYPE.USER_ATTRIBUTE&&Si.log(1,t,"User attribute added successfully:",e.event.attributes),pn.addReportApiRetries=1,!0}static handleReportAddFailure(e,t){var i=pn.baseLogTag+".handleReportAddFailure";Si.error(1,i,"Add Report API failed",t),e.type===dn.REPORT_ADD_TYPE.EVENT?Si.log(1,i,"Queueing unsuccessful event tracking:",e.event):e.type===dn.REPORT_ADD_TYPE.USER_ATTRIBUTE&&Si.log(1,i,"Queueing unsuccessful user attribute add:",e.event.attributes),pn.addReportApiRetries<3&&setTimeout(()=>{pn.addReportApiRetries++,Pi.enqueue(yt.Q.REPORT,e),En.startPeriodicClear(yt.Q.REPORT)},3e3*pn.addReportApiRetries)}static checkIfTokenValid(e){let t=_i.get().baseDomainName+ri.API.DEVICE_TOKEN_CHECK,i=_i.get();return new Promise(n=>{e?ji.get().then(a=>{a={queryParams:{app_id:i.appId,unique_id:a.deviceUuid,push_id:e}},ki.post(t,a).then(e=>{200===e.status?n(!0):n(!1)}).catch(e=>{n(!1)})}):n(!1)})}static collectGetParams(e){return new Promise((t,i)=>{ji.get().then(i=>xe(this,void 0,void 0,function*(){let n=_i.get(),a=(null!=n&&null!=n.appId||(n=new _i(Li.get(yt.INIT_DATA))),yield Wi());var r=new Date;let o=Date.UTC(r.getUTCFullYear(),r.getUTCMonth(),r.getUTCDate(),r.getUTCHours(),r.getUTCMinutes(),r.getUTCSeconds(),r.getUTCMilliseconds());Fi.getInstance().then(r=>{var s=this.getDeviceUniqueId(),l=de(e,[ri.API.REPORT_ADD,ri.API.DEVICE_ADD,zt.API.REPORT_ADD]),u=Object.assign({os:r.os,os_platform:r.osPlatform,is_incognito:r.isIncognito,app_id:n.appId,os_ver:r.name,sdk_ver:"2.61.01",model:r.name,app_ver:"1.0",device_ts:Number(o),device_tz_offset:(-6e4*(new Date).getTimezoneOffset()).toString(),unique_id:i.deviceUuid,device_tz:(new Date).getTimezoneOffset().toString(),device_unique_id:s},l),p=(n.projectId&&(u.project_code=n.projectId),s=i.getAttribute("cart_token"),we((c()&&s&&null!=a&&a.configs.isMultiIdEnabled&&e!==ri.API.DEVICE_ADD&&(u.cart_token=s),l=ge()))&&(u.push_id=l),r.isWebPushCompatible()&&(d(a.webPushPlatformData,r)?(u.subscription_type="vapid",u.vapid_public=g(a.webPushPlatformData,r)):u.subscription_type="normal"),null!=n.environment&&(u.environment=n.environment),Li.get(yt.SUBSCRIPTION_DETAILS));if(null!=p&&null!=p.keys){for(var m in p.keys)u["keys_"+m]=encodeURI(p.keys[m]);null!=p.endpoint&&(u.endpoint=encodeURI(p.endpoint)),u.expirationTime=p.expirationTime}t(u)})}))})}static getDeviceUniqueId(){var e;return(null==(e=Li.get(yt.DEVICE_DATA))?void 0:e.deviceUniqueId)||void 0}static getUpdatedPushDetails(){var e={},t=Li.get(yt.SUBSCRIPTION_DETAILS);if(null!=t){var i=t.token;if(null!=i&&"NA"!==i&&""!==i&&"null"!==i&&(e.push_id=i),t.keys){for(var n in t.keys)e["keys_"+n]=encodeURI(t.keys[n]);null!=t.endpoint&&(e.endpoint=encodeURI(t.endpoint)),e.expirationTime=t.expirationTime}}return e}static sendBeacon(e){if(!window.navigator.onLine)return this.sendToOfflineTracking(e,li);pn.getBatchRequestOptions(e).then(e=>{var t=(t=_i.get()).baseDomainName+zt.API.REPORT_ADD+t.appId+"?"+(new Date).getTime();Si.log(1,"MoeApi.sendBeacon","[sendBeacon] batch payload: "+JSON.stringify(e)),navigator.sendBeacon(t,JSON.stringify(e))})}static addEventsToIDB(e){var t;le()!==oi.TV&&null!=(t=r.createInstance({driver:[r.INDEXEDDB,r.WEBSQL,r.LOCALSTORAGE],name:Ft.DATABASE_NAME,storeName:Ft.STORE_NAME}))&&t.setItem(e.name,e)}}pn.baseLogTag="MoeApi",pn.onDeviceAdd=new xi,pn.webSdkApiRetries=1,pn.offlineEvents=[],pn.addReportApiRetries=1,pn.isExecutingDeviceAdd=!1;let mn=i(372),hn=yt.Q;class En{static clear(e){var t=En.baseLogTag+".clear";if(Ae()){let i=[];for(;!Pi.isEmpty(e);)switch(e){case hn.REPORT:let n=Pi.dequeue(hn.REPORT);i.push(e=>{pn.reportAdd(n).then(()=>{e()})});break;case hn.DEVICE:Pi.dequeue(hn.DEVICE)&&i.push(e=>{pn.deviceAdd().then(()=>{e()})});break;default:Si.error(1,t,"Do not know how to handle queue with name:",e)}setTimeout(()=>{En.processing[e]=!0,mn(i,5,(t,i)=>{En.processing[e]=!1})},0)}}static startPeriodicClear(e){let t=En.baseLogTag+".startPeriodicCleanQ";En.clearInterval(e);var i=()=>{Pi.isEmpty(e)?(Si.log(1,t,"If you see multiple event tracks with same, they were captured over multiple visits or page refreshes."),o(En.processing,e,!1)||En.clearInterval(e)):(En.clear(e),Si.log(1,t,"Starting periodic queue clear for",e))};i(),En.intervals[e]=setInterval(i,6e3)}static clearInterval(e){null!=En.intervals[e]&&(clearInterval(En.intervals[e]),En.intervals[e]=null)}}En.baseLogTag="QManager",En.intervals={},En.processing={};let vn=class{constructor(e){this.isBeaconDisabled=this.parseSentryBooleanFlag(o(e,"b_d",!1)),this.isCardsModuleEnabled=this.parseSentryBooleanFlag(o(e,"c_s",!1)),this.isWebPersonalizationModuleEnabled=this.parseSentryBooleanFlag(o(e,"c_w_p_e",!1)),this.eventBatchCount=o(e,"e_b_c",15),this.logLevel=o(e,"log_level"),this.periodicFlushTime=o(e,"p_f_t",30),this.isBatchingEnabled=this.parseSentryBooleanFlag(o(e,"s_e_b_e",!1)),this.sessionInactiveDuration=o(e,"s_i_d",1800),this.isRemoteLoggingEnabled=this.parseSentryBooleanFlag(o(e,"s_log",!1)),this.sourceExtraParams=o(e,"src_ext",[]),this.whitelistedEvents=o(e,"w_e",[]),this.blacklistedEvents=o(e,"b_e",[]),this.blacklistedPortfolioUserAttributes=o(e,"p_b_ua",[]),this.isAppActive=this.parseSentryBooleanFlag(o(e,"a_s",!0)),this.remoteLogTracking=this.isRemoteLoggingEnabled&&!!this.logLevel,this.subscriberBasedBillingAttributes=o(e,"s_b_a",[]),this.isMultiIdEnabled=this.parseSentryBooleanFlag(o(e,"m_i_e",!1)),this.userAttributeCacheTime=o(e,"u_a_c_t",43200),this.portfolioUserAttributeCacheTime=o(e,"p_u_a_c_t",43200),this.identityAttributes=o(e,"u_i_s",[]),this.landingPageTracking=this.parseSentryBooleanFlag(o(e,"lp_t",!1))}parseSentryBooleanFlag(e="blocked"){return"allowed"===e||!0===e||"true"===e}};class fn{constructor(e){this.mobile=new Sn(o(e,"mobile",{})),this.web=new Sn(o(e,"web",{}))}}class Sn{constructor(e){this.nudge=e.nudge?new _n(e.nudge):void 0,this.banner=e.banner?new _n(e.banner):void 0,this.allowButton=e.allow_button?new In(e.allow_button):void 0,this.dismissButton=e.dismiss_button?new In(e.dismiss_button):void 0,this.logo=e.logo?new yn(e.logo):void 0}}class _n{constructor(e){this.title=new Tn(o(e,"title",{})),this.body=null!=e&&e.body?new Tn(o(e,"body",{})):void 0,this.backgroundColor=null==e?void 0:e.background_color,this.icon=null==e?void 0:e.icon,this.altText=(null==e?void 0:e.alt_text)||""}}class In{constructor(e){this.textColor=null==e?void 0:e.text_color,this.text=o(e,"text",""),this.backgroundColor=null==e?void 0:e.background_color}}class Tn{constructor(e){this.textColor=null==e?void 0:e.text_color,this.text=o(e,"text","")}}class yn{constructor(e){this.logoUrl=(null==e?void 0:e.logo_url)||"",this.logoColor=(null==e?void 0:e.logo_color)||"",this.altText=(null==e?void 0:e.alt_text)||""}}(a=ke=ke||{}).ONE_STEP="1-step",a.TWO_STEP="2-step",a.SELF_HANDLED="self-handled";class bn{constructor(e){this.subscriptionMode=o(e,"subscription_mode","vapid"),this.vapidPublicKey=o(e,"vapid_public_key",null)}}class An{constructor(e){this.chrome=new bn(null==e?void 0:e.chrome),this.firefox=new bn(null==e?void 0:e.firefox)}}let On=class{constructor(e){this.isDomainLevelStorage=!1,this.configs=new vn({}),this.settingsVersion="V2",this.isDomainLevelStorage=o(e,"domain_level_storage",!1),le()===oi.TV&&(this.isDomainLevelStorage=!1),this.toShowOverlay=o(e,"show_overlay",!1),this.loadTime=o(e,"load_time",0),this.promptAgain=o(e,"prompt_again",24),this.optInType=o(e,"opt_in_type",ke.TWO_STEP),this.isWebPushEnabled=o(e,"is_enabled",!1),this.optInPreview=new fn(o(e,"opt_in_preview",{})),this.overlay=o(e,"overlay",null),this.webPushPlatformData=new An(e.web_push_platform_data),this.isPushSubBilling=o(e,"sub_billing",!1),this.isBrandingHidden=o(e,"hide_moe_branding",!1),this.configs=new vn(e)}};class wn{static getWebSDKSettings(){return wn.BASE_LOG_TAG,new Promise((e,t)=>{let i=wn.getInitData();var n,a,r,o=i=>{wn.isAppBlocked(i)?t(!1):(null!=i&&i.isDomainLevelStorage&&Ni.set(At,i.isDomainLevelStorage),e(i))};wn.sdkSettings?o(wn.sdkSettings):Ae()?(a=(new Date).getTime(),n=()=>wn.getAndPersistWebSettings(i).then(t=>e(t)).catch(e=>t(!1)),null==(r=Li.get(yt.SETUP_TIME))||0<i.debugLevel||Li.get(yt.SDK_VERSION)!==s().getSdkVersion()||a-r>60*wn.RESET_DURATION_IN_HOURS*60*1e3||!(a=Li.get(yt.WEB_SETTINGS))?n():(wn.sdkSettings=a,o(wn.sdkSettings))):(r=Li.get(yt.WEB_SETTINGS))&&(wn.sdkSettings=r,o(wn.sdkSettings))})}static getAndPersistWebSettings(e){let t=wn.BASE_LOG_TAG+".getAndPersistWebSettings";return new Promise((i,n)=>function(e,t,i,n){return new(i=i||Promise)(function(t,a){function r(e){try{s(n.next(e))}catch(e){a(e)}}function o(e){try{s(n.throw(e))}catch(e){a(e)}}function s(e){var n;e.done?t(e.value):((n=e.value)instanceof i?n:new i(function(e){e(n)})).then(r,o)}s((n=n.apply(e,[])).next())})}(this,0,void 0,function*(){try{Si.log(1,t,"Fetching latest settings for workspace id: "+e.appId+(e.projectId?" and project id: "+e.projectId:""));var a={queryParams:{app_id:e.appId}},r={postData:{query_params:{unique_id:(l=Li.get(yt.USER_DATA))&&l.deviceUuid}}},o=(e.projectId&&(a.queryParams.project_code=e.projectId,r.postData.query_params.project_code=e.projectId),ki.get(wn.API_URLS.SETTINGS(e.baseDomainName),a)),s=ki.post(wn.API_URLS.CONFIG(e.baseDomainName,se()?"mweb":"web",e.appId),r);Promise.all([o,s]).then(e=>{let t,a=e[0].responseText,r=("string"==typeof a&&(a=JSON.parse(a)),e[1].responseText);200===e[1].status&&"string"==typeof r&&(r=JSON.parse(r)),e=new On(Object.assign(Object.assign({},a.webData),r)),wn.updateLocalStorage(e),wn.isAppBlocked(e)?n(!1):(wn.sdkSettings=e,null!=(t=wn.sdkSettings)&&t.isDomainLevelStorage&&Ni.set(At,wn.sdkSettings.isDomainLevelStorage),i(e))}).catch(e=>{Si.error(1,t,"Config API failed",e)})}catch(a){Si.error(1,t,"Settings APi Failed: ",a),wn.webSdkApiRetries<wn.WEB_SDK_API_MAX_RETRIES?setTimeout(()=>{wn.webSdkApiRetries++,i(wn.getAndPersistWebSettings(e))},3e3*wn.webSdkApiRetries):n(!1)}var l}))}static isAppBlocked(e){return!(!e||!e.configs||!1!==e.configs.isAppActive)}static getInitData(){let e=_i.get();return null!=e&&null!=e.appId?e:new _i(Li.get(yt.INIT_DATA))}static updateLocalStorage(e){var t=(new Date).getTime();Li.set(yt.WEB_SETTINGS,e),Li.set(yt.SETUP_TIME,t),Li.set(yt.SDK_VERSION,s().getSdkVersion())}}wn.BASE_LOG_TAG="CoreApi",wn.RESET_DURATION_IN_HOURS=24,wn.API_URLS={SETTINGS:e=>e+"v2/websdksettings",CONFIG:(e,t,i)=>e+`v3/sdkconfig/${t}/`+i},wn.webSdkApiRetries=1,wn.WEB_SDK_API_MAX_RETRIES=3;class Dn{addURLChangeObserver(e){let t=Dn.baseLogTag+".addURLChangeObserver",i=document.location.href;Dn.isObserverRunning=!0,Si.log(2,t,"Start listening to URL changes for SPA");var n=document.querySelector("body");Dn.observer=new MutationObserver(n=>{n.forEach(n=>{i===window.location.href||gi.some(e=>window.location.href.includes(e))||(i=window.location.href,Si.log(1,t,"URL Change detected",i),Dn.pageChangeHandler(e))})}),Dn.observer.observe(n,{childList:!0,subtree:!0})}static pageChangeHandler(e){qi.broadcastToWindow({topic:Pt.SPA_LIFECYCLE.TOPIC_NAME,name:Pt.SPA_LIFECYCLE.EVENT_NAMES.PAGE_CHANGED}),un.clearAll(),s().track_page_view(),e&&Li.copyKeysFromCookie()}static removeURLChangeObserver(){var e,t=this.baseLogTag+".removeURLChangeObserver";this.isObserverRunning=!1,null!=(e=this.observer)&&e.disconnect(),Si.log(2,t,"SPA URL Change Observer removed.")}}Dn.baseLogTag="SPAManager";class Nn{constructor(){Nn.handlePublicFunctions()}trackClick(e,t){return Nn.track(ai.CLICK,e,{widget_id:t})}trackImpression(e){return Nn.triggerDeviceAddForLandingPageTracking(),Nn.track(ai.IMPRESSION,e)}trackFormSubmit(e,t){return Nn.track(ai.FORM_SUBMIT,e,t)}trackEvent(e,t,i){return Nn.track(e,t,i)}static track(e,t,i){Ei.get(Tt.LANDING_PAGE_TRACKING)||Ei.set(Tt.LANDING_PAGE_TRACKING,!0);let n=Nn.baseLogTag+".track";if("string"==typeof t)try{t=JSON.parse(t)}catch(i){return void Si.error(2,n,"Error parsing JSON string:",i)}if(i){if("string"==typeof i)try{i=JSON.parse(i)}catch(i){return void Si.error(2,n,"Error parsing attributes JSON string:",i)}t=Object.assign(Object.assign({},i),t)}try{return s()?(Si.log(1,n,e+": Event Tracked"),s().track_event(e,Object.assign({},t))):(window.addEventListener(Pt.MOE_LIFECYCLE.TOPIC_NAME,i=>{if(i.detail.name===Pt.MOE_LIFECYCLE.EVENT_NAMES.MOE_INIT)return Si.log(1,n,e+": Event Tracked"),s().track_event(e,Object.assign({},t))}),Promise.resolve())}catch(i){Si.error(2,n,"Failed Tracking expression",i)}}static triggerDeviceAddForLandingPageTracking(){var e=Nn.baseLogTag+".triggerDeviceAddForLandingPageTracking";Si.log(2,e,"Landing page tracking flag set, broadcasting device add request"),qi.broadcastToWindow({topic:Pt.MOE_LIFECYCLE.TOPIC_NAME,name:Pt.MOE_LIFECYCLE.EVENT_NAMES.LANDING_PAGE_DEVICE_ADD,data:{reason:"landing_page_tracking_enabled",source:"landing_pages_module"}})}static handlePublicFunctions(){(s()||{}).landingPages=Nn}}Nn.baseLogTag="Landing Pages Tracking";class Cn{}Cn.baseLogTag="MoEngage",Cn.landingPages=new Nn,Cn.getSdkVersion=()=>"2.61.01",Cn.setDebugLevel=e=>function(e,t,i,n){return new(i=i||Promise)(function(e,t){function a(e){try{o(n.next(e))}catch(e){t(e)}}function r(e){try{o(n.throw(e))}catch(e){t(e)}}function o(t){var n;t.done?e(t.value):((n=t.value)instanceof i?n:new i(function(e){e(n)})).then(a,r)}o((n=n.apply(undefined,[])).next())})}(0,0,void 0,function*(){let t,i=Cn.baseLogTag+".setDebugLevel",n=s();try{"number"==typeof e&&(Si.setLogLevel(e,!0),!_i.get().disableOnsite&&null!=(t=null==n?void 0:n.onsite)&&t.setLogLevel&&n.onsite.setLogLevel(e),wn.getWebSDKSettings().then(t=>{null!=t&&t.configs.isCardsModuleEnabled&&null!=n&&n.cards&&n.cards.setLogLevel(e),null!=t&&t.configs.isWebPersonalizationModuleEnabled&&window.MoeWebP&&window.MoeWebP.setLogLevel&&window.MoeWebP.setLogLevel(e)}).catch(e=>{Si.error(1,i,"Error in getting Web SDK Settings. This might indicate that the App is blocked.")}))}catch(t){Si.error(0,i,"Error changing log level:",t)}}),Cn.vitals=()=>{var e=Li.get(yt.USER_DATA);return{userDetails:e,deviceUuid:null==e?void 0:e.deviceUuid,pushToken:Li.get(yt.PUSH_TOKEN),softAskStatus:Li.get(yt.SOFT_ASK_STATUS),hardAskStatus:Li.get(yt.HARD_ASK_STATUS)}},Cn.help=()=>{for(var e in xt)xt.hasOwnProperty(e)&&Si.log(0,"Moengage.help",e,"-",xt[e])},Cn.getBranch=()=>"master",Cn.handle_page_change=()=>{wn.getWebSDKSettings().then(e=>{Dn.pageChangeHandler(e.isDomainLevelStorage)})};let Ln={getData:(e,t)=>{window.addEventListener(Pt.MOE_LIFECYCLE.TOPIC_NAME,i=>{i.detail.name===Pt.MOE_LIFECYCLE.EVENT_NAMES.OSM_INIT&&null!=(i=s())&&i.onsite.getData(e,t)})},registerCallback:(e,t)=>{window.addEventListener(Pt.MOE_LIFECYCLE.TOPIC_NAME,i=>{i.detail.name===Pt.MOE_LIFECYCLE.EVENT_NAMES.OSM_INIT&&null!=(i=s())&&i.onsite.registerCallback(e,t)})},getSelfHandledOSM:e=>{window.addEventListener(Pt.MOE_LIFECYCLE.TOPIC_NAME,t=>{t.detail.name===Pt.MOE_LIFECYCLE.EVENT_NAMES.OSM_INIT&&null!=(t=s())&&t.onsite.getSelfHandledOSM(e)})}},Pn={track_event:S=()=>{},add_user_attribute:S,add_first_name:S,add_last_name:S,add_email:S,add_mobile:S,add_user_name:S,add_gender:S,add_birthday:S,destroy_session:S,add_unique_user_id:S,moe_events:S,location_type_attribute:S,call_web_push:S,setDebugLevel:S};var Be=function(e,t,i,n){return new(i=i||Promise)(function(a,r){function o(e){try{l(n.next(e))}catch(e){r(e)}}function s(e){try{l(n.throw(e))}catch(e){r(e)}}function l(e){var t;e.done?a(e.value):((t=e.value)instanceof i?t:new i(function(e){e(t)})).then(o,s)}l((n=n.apply(e,t||[])).next())})};class Rn{static initialize(){return Be(this,void 0,void 0,function*(){var e;return null==Rn.ready&&(Rn.serviceMetaStore=r.createInstance({driver:[r.INDEXEDDB,r.WEBSQL,r.LOCALSTORAGE],name:jt.DATABASE_NAME,storeName:jt.STORES.SERVICE_META.NAME}),Rn.campaingsMetaStore=r.createInstance({driver:[r.INDEXEDDB,r.WEBSQL,r.LOCALSTORAGE],name:jt.DATABASE_NAME,storeName:jt.STORES.CAMPAIGNS_META.NAME}),Rn.pendingSecondaryEvents=r.createInstance({driver:[r.INDEXEDDB,r.WEBSQL,r.LOCALSTORAGE],name:jt.DATABASE_NAME,storeName:jt.STORES.PENDING_SECONDARY_EVENTS.NAME}),Rn.pendingTimerCampaigns=r.createInstance({driver:[r.INDEXEDDB,r.WEBSQL,r.LOCALSTORAGE],name:jt.DATABASE_NAME,storeName:jt.STORES.PENDING_TIMER_CAMPAIGNS.NAME}),Rn.triggeringPrimaryEvents=r.createInstance({driver:[r.INDEXEDDB,r.WEBSQL,r.LOCALSTORAGE],name:jt.DATABASE_NAME,storeName:jt.STORES.TRIGGERING_PRIMARY_EVENTS.NAME}),Rn.campaingsTagsStore=r.createInstance({driver:[r.INDEXEDDB,r.WEBSQL,r.LOCALSTORAGE],name:jt.DATABASE_NAME,storeName:jt.STORES.CAMPAIGNS_TAGS.NAME}),Rn.campaingsStatsStore=r.createInstance({driver:[r.INDEXEDDB,r.WEBSQL,r.LOCALSTORAGE],name:jt.DATABASE_NAME,storeName:jt.STORES.CAMPAIGNS_STATS.NAME}),Rn.exitIntentCampaignStore=r.createInstance({driver:[r.INDEXEDDB,r.WEBSQL,r.LOCALSTORAGE],name:jt.DATABASE_NAME,storeName:jt.STORES.EXIT_INTENT_CAMPAIGN_STORE.NAME}),e=[Rn.serviceMetaStore.ready(),Rn.campaingsMetaStore.ready(),Rn.pendingSecondaryEvents.ready(),Rn.pendingTimerCampaigns.ready(),Rn.triggeringPrimaryEvents.ready(),Rn.campaingsTagsStore.ready(),Rn.campaingsStatsStore.ready(),Rn.exitIntentCampaignStore.ready()],Rn.ready=Promise.all(e)),Rn.ready})}static clear(e=!1){return Be(this,void 0,void 0,function*(){var t=Rn.baseLogTag+".clear";try{yield Rn.initialize(),yield Promise.all([Rn.campaingsMetaStore.clear(),Rn.campaingsTagsStore.clear(),Rn.exitIntentCampaignStore.clear(),Rn.triggeringPrimaryEvents.clear()]),e&&(yield Promise.all([Rn.serviceMetaStore.clear(),Rn.campaingsStatsStore.clear(),Rn.pendingSecondaryEvents.clear(),Rn.pendingTimerCampaigns.clear()]));var i=[Rn.campaingsMetaStore.ready(),Rn.campaingsTagsStore.ready(),Rn.exitIntentCampaignStore.ready(),Rn.triggeringPrimaryEvents.ready(),e?Rn.campaingsStatsStore.ready():Promise.resolve()];e&&i.push(Rn.serviceMetaStore.ready(),Rn.campaingsStatsStore.ready(),Rn.pendingSecondaryEvents.ready(),Rn.pendingTimerCampaigns.ready()),Rn.ready=Promise.all(i)}catch(i){Si.error(1,t,"Error clearing onsite stores:",i)}return Rn.ready})}static sdkOptOut(){return Be(this,void 0,void 0,function*(){yield Promise.all([Rn.pendingSecondaryEvents.clear(),Rn.pendingTimerCampaigns.clear(),Rn.triggeringPrimaryEvents.clear()])})}}Rn.baseLogTag="MOE_ONSITE_STORES";var Ue,Fe,We,He,Ve,Ge=function(e,t,i,n){return new(i=i||Promise)(function(a,r){function o(e){try{l(n.next(e))}catch(e){r(e)}}function s(e){try{l(n.throw(e))}catch(e){r(e)}}function l(e){var t;e.done?a(e.value):((t=e.value)instanceof i?t:new i(function(e){e(t)})).then(o,s)}l((n=n.apply(e,t||[])).next())})};let Mn=(e,t,i)=>null==e.campaignId?()=>{}:()=>(Rn.campaingsStatsStore.getItem(e.campaignId).then(t=>{t=null!=t?Object.assign(Object.assign({},t),{clicks:o(t,"clicks",0)+1}):{clicks:1},Rn.campaingsStatsStore.setItem(e.campaignId,t)}),null==i&&(i={}),Fn().track_event(jt.EVENT_NAMES[t].CLICK,Object.assign(Object.assign({campaign_id:e.campaignId,campaign_name:e.campaignName,type:jt.EVENT_NAMES[t].TYPE},i),e.campaignContext))),kn=(e,t,i=!1)=>{return null==e.campaignId?()=>{}:((n=e).templateType!==Ve.SELF_HANDLED&&(Yn(n,wt.MOE_PAGE_EXIT)||Yn(n,wt.MOE_PAGE_SCROLL))&&(ja.onScrollOrExitIntentCampaigns[n.campaignId]=!0),()=>{if(xn(e.campaignId),!i)return Fn().track_event(jt.EVENT_NAMES[t].IMPRESSION,Object.assign({campaign_id:e.campaignId,campaign_name:e.campaignName,type:jt.EVENT_NAMES[t].TYPE,templateType:e.templateType},e.campaignContext))});var n},xn=e=>{Rn.initialize().then(()=>{Rn.campaingsStatsStore.getItem(e).then(t=>{t=null!=t?Object.assign(Object.assign({},t),{impressions:o(t,"impressions",0)+1,lastImpression:new Date}):{impressions:1,lastImpression:new Date},Rn.campaingsStatsStore.setItem(e,t)})})},Bn=(e,t,i)=>{i=i?jt.EVENT_NAMES[t].AUTO_DISMISS:jt.EVENT_NAMES[t].DISMISS,Fn().track_event(i,Object.assign({campaign_id:e.campaignId,campaign_name:e.campaignName,type:jt.EVENT_NAMES[t].TYPE},e.campaignContext))},Un=(e,t)=>{Fn().track_event(jt.EVENT_NAMES[t].DELIVERED,Object.assign({campaign_id:e.campaignId,campaign_name:e.campaignName,type:jt.EVENT_NAMES[t].TYPE},e.campaignContext))},Fn=()=>window[window.moengage_object||"Moengage"];class Wn{static isValid(e,t){return!Wn.isCampaignExpired(e)&&Wn.isCampaignActive(e)&&Wn.isUserInCampaignSegment(e)&&Wn.isCampaignWithinFC(e,t)}static isCampaignExpired(e){return(new Date).getTime()>new Date(e.expiryTime).getTime()}static isValidMessagingCampaign(e,t,i,n,a){return Wn.canCampaignBeRenderedOverExisting(e,a.length)&&Wn.hasCampaignClearedSelfDelay(e,t)&&Wn.hasCampaignClearedGlobalDelay(e,i,n)}static isCampaignActive(e){var t=Wn.baseLogTag+".isValid";return e.status===We.ACTIVE||(Si.warn(1,t,`Campaign ${e.campaignId} : Status is `+e.status),!1)}static isUserInCampaignSegment(e){var t=Wn.baseLogTag+".isValid";return!!e.userInSegment||(Si.warn(1,t,`Campaign ${e.campaignId} : User is not in segment`),!1)}static isCampaignWithinFC(e,t){var i=Wn.baseLogTag+".isValid";if([Ve.SELF_HANDLED].indexOf(e.templateType)<0){var n=o(e,"delivery.fc_meta.count",0);if(0<n){var a=o(t,"impressions",0);if(null!=t)return!(n<=a&&(Si.warn(1,i,`Campaign ${e.campaignId} : FC reached. ${t.impressions} times shown`),1))}}return!0}static hasCampaignClearedGlobalDelay(e,t,i){var n=Wn.baseLogTag+".isValid",a=o(e,"delivery.fc_meta.ignore_global_delay",!1);try{if(!a){var r=new Date;if(i){var s=(r.getTime()-new Date(i).getTime())/1e3;if(t&&s<=t)return Si.remoteLogTracking(1,"info",n,`Can't render ${e.campaignId} as last global campaign was rendered ${s} seconds ago.`),!1}}}catch(e){return Si.error(1,n,"Error checking global delay:",e),!1}return!0}static hasCampaignClearedSelfDelay(e,t){var i=Wn.baseLogTag+".hasCampaignClearedSelfDelay",n=o(e,"delivery.fc_meta.delay",0);try{if(0<n&&null!=t&&t.lastImpression){var a=t.lastImpression,r=((new Date).getTime()-new Date(a).getTime())/1e3;if(r<=o(e,"delivery.fc_meta.delay",0))return Si.warn(1,i,`Can't render ${e.campaignId} as it was rendered ${r} seconds ago.`),!1}}catch(t){return Si.error(1,i,"Can't check self delay for "+e.campaignId,t),!1}return!0}static doCampaignPayloadHasMandatoryParams(e){var{payload:e,payloadType:t,htmlJsonPayload:i}=e;return!(!e&&!i||!t)}static canCampaignBeRenderedOverExisting(e,t){var i=Wn.baseLogTag+".canCampaignBeRenderedOverExisting";return!(0<t&&!e.display.config.showOverOtherCampaigns&&(Si.warn(1,i,`Can not show ${e.campaignId} over other existing campaigns`),1))}static comparator(e,t){return t.delivery.priority>e.delivery.priority||!(t.delivery.priority<e.delivery.priority)&&e.updatedTime<t.updatedTime?1:-1}}Wn.baseLogTag="CampaignUtils";let Hn=e=>Ge(void 0,void 0,void 0,function*(){var t=e.map(e=>Rn.campaingsStatsStore.getItem(e.campaignId));let i;try{return i=yield Promise.all(t),e.filter((e,t)=>Wn.isValid(e,i[t])).sort(Wn.comparator)}catch(t){return Si.error(1,"filterAndSortCampaigns","Error filtering and sorting campaigns: ",t),[]}});class Vn{}Vn.REMOVE_TRAIL_CHARS=/[^\w\s]+$/gi;let Gn=e=>{var t;null!=(t=null==(t=e.primaryEventsHash)?void 0:t.MOE_PAGE_SCROLL)&&t.length&&window.removeEventListener("scroll",e.getScrollListenerCallback())},Kn=e=>{e&&Object.keys(e.campaignRenderMap).forEach(t=>{var i;document.getElementById("moe-onsite-campaign-"+t)&&document.getElementById("moe-onsite-campaign-"+t).remove(),e.campaignRenderMap[t].isActive()&&e.dismissInapp(t,!1),clearTimeout(null==(i=e.campaignRenderMap[t])?void 0:i.delayTimer),delete e.campaignRenderMap[t],e.campaignRenderOrder=e.campaignRenderOrder.filter(e=>e!==t)})},jn=e=>{setTimeout(()=>{e&&(se()?e.windowEventManager.isPopStateEventBound&&(e.windowEventManager.setHistoryState(),e.windowEventManager.isExitIntentShown=!1,e.windowEventManager.scrollExitIntentInterval=null):document.removeEventListener("mouseout",e.windowEventManager.exitIntentListener))},0)},Yn=(e,t)=>(null==(e=o(e,"triggerData.primary_condition.included_filters",null))?void 0:e.filter_operator)===He.OR&&-1<(null==e?void 0:e.filters.findIndex(e=>e.action_name===t)),qn=e=>Ge(void 0,void 0,void 0,function*(){var t=yield Rn.exitIntentCampaignStore.getItem(e.campaignId);if(t)return t.error?t:(e.onsitePayload=t,Si.log(1,"getPrefetchedCampaign","Prefetched exit intent campaign found: "+e.campaignId),e)}),zn=e=>Ge(void 0,void 0,void 0,function*(){try{return yield Rn.campaingsMetaStore.getItem(e)}catch(e){return Si.error(2,"getCampaignById","Error getting campaign from store: ",e),null}}),$n=()=>new Promise(e=>{setTimeout(()=>Ge(void 0,void 0,void 0,function*(){let t=[];yield Rn.campaingsMetaStore.iterate(e=>{t.push(e)}),e(t)}),0)}),Jn=e=>null==(e=o(e,"triggerData.secondary_condition.included_filters.filters"))?void 0:e.length,Xn=e=>"moe-onsite-campaign-"+e;function Ke(e){var t,i,n,a;e.detail.name===Pt.SPA_LIFECYCLE.EVENT_NAMES.PAGE_CHANGED&&(window.Moengage.pageChangeHandlerCallingTime=(new Date).getTime(),window.MoeFocusHandler&&window.MoeFocusHandler(),null!=(e=Fn())&&e.onsite&&(e=Fn().onsite,({triggerManager:t,displayManager:i,sendDelayCampaignStats:n,funnelManager:a}=e),i&&(n(i,a),Kn(i)),t&&(Gn(t),jn(t)),ja.onScrollOrExitIntentCampaigns={},qi.resetListeners(),e.initializationPomise=null,e.selfHandledWebpTriggerListeners={},e.initialize)&&e.initialize(),window.Moengage.shouldClearPrevEvents=(new Date).getTime(),0<(null==(i=null==(a=(null==(n=Fn())?void 0:n.onsite).triggerManager)?void 0:a.exitIntentCampaigns)?void 0:i.length))&&se()&&null!=(t=null==a?void 0:a.windowEventManager)&&t.onMobileScrollAndExit(a.onExit)}function je(e){if(null!=e&&e.campaignRenderMap){var t=Object.keys(null==e?void 0:e.campaignRenderMap);let i=[];return t.forEach(t=>{e.campaignRenderMap[t].isActive()&&(i=i.concat(t))}),i.length?i:[]}return[]}class Qn{constructor(e,t,i,n){this.dataType=e,this.availableOperations=t,this.event=i,this.filter=n}validate(){return!(this.availableOperations.indexOf(this.filter.operator)<0)}checkEq(){let e=!1;return this.event.attributes.forEach(t=>{let i=t.value,n=this.filter.value;this.dataType===Ue.STRING&&typeof i===Ue.STRING&&(i=this.removeSpecialChars(i),n=this.removeSpecialChars(n)),t.key===this.filter.name&&(this.dataType!==Ue.STRING||this.filter.case_sensitive?i===n&&(e=!0):i.toLowerCase()===n.toLowerCase()&&(e=!0))}),e}checkExists(){let e=!1;return this.event.attributes.forEach(t=>{t.key===this.filter.name&&(e=!0)}),e}removeSpecialChars(e){return e.replace(Vn.REMOVE_TRAIL_CHARS,"")}}(a=Ue=Ue||{}).BOOL="bool",a.STRING="string",a.DATE="datetime",a.NUMBER="double",a.LONG="long",a.ARRAY_BOOL="array_bool",a.ARRAY_NUMBER="array_double",a.ARRAY_STRING="array_string",a.ARRAY_DATETIME="array_datetime",a.OBJECT="object",(S=Fe=Fe||{}).ALLOF="all_of",S.ANYOFF="any_of";let Zn=["is","exists","contains","startsWith","endsWith","in","containsInTheFollowing","startsWithInTheFollowing","endsWithInTheFollowing"];class ea extends Qn{constructor(e,t){super(Ue.STRING,Zn,e,t)}evaluate(){ea.baseLogTag;let e=!1;var t=this.event.attributes.filter(e=>e.key===this.filter.name),i=0<t.length?t[0]:null;if(null!=i&&Ji.isString(i.value))switch(this.filter.operator){case"is":e=this.checkEq();break;case"exists":e=this.checkExists();break;case"contains":case"containsInTheFollowing":e=this.checkContains(i);break;case"startsWith":case"startsWithInTheFollowing":e=this.checkStartsWith(i);break;case"endsWith":case"endsWithInTheFollowing":e=this.checkEndsWith(i);break;case"in":e=this.checkIn(i)}return this.filter.negate?!e:e}checkContains(e){var t=t=>this.filter.case_sensitive?0<=e.value.indexOf(t):0<=e.value.toLowerCase().indexOf(t.toLowerCase());return Array.isArray(this.filter.value)?this.filter.array_filter_type===Fe.ALLOF?this.checkInTheFollowing(t).every(e=>!0===e):this.checkInTheFollowing(t).includes(!0):t(this.filter.value)}checkStartsWith(e){var t=t=>{var i=(e,t)=>e.substr(0,t.length)===t;return this.filter.case_sensitive?i(e.value,t):i(e.value.toLowerCase(),t.toLowerCase())};return Array.isArray(this.filter.value)?this.filter.array_filter_type===Fe.ALLOF?this.checkInTheFollowing(t).every(e=>!0===e):this.checkInTheFollowing(t).includes(!0):t(this.filter.value)}checkEndsWith(e){var t=t=>{var i,n=(e,t,i)=>((void 0===i||i>e.length)&&(i=e.length),e.substring(i-t.length,i)===t);return this.filter.case_sensitive?n(e.value,t):(i=this.removeSpecialChars(e.value),t=this.removeSpecialChars(t),n(i.toLowerCase(),t.toLowerCase()))};return Array.isArray(this.filter.value)?this.filter.array_filter_type===Fe.ALLOF?this.checkInTheFollowing(t).every(e=>!0===e):this.checkInTheFollowing(t).includes(!0):t(this.filter.value)}checkIn(e){let t=!1;if(Array.isArray(this.filter.value))for(let i=this.filter.value.length-1;0<=i;i--)if(this.filter.case_sensitive){if(this.filter.value[i]===e.value){t=!0;break}}else if(this.filter.value[i].toLowerCase()===e.value.toLowerCase()){t=!0;break}return t}checkInTheFollowing(e){return this.filter.value.map(t=>e(t))}}ea.baseLogTag="StringDataType";let ta=["is","exists"];class ia extends Qn{constructor(e,t){super(Ue.BOOL,ta,e,t)}evaluate(){let e=!1;switch(this.filter.operator){case"is":e=this.checkEq();break;case"exists":e=this.checkExists()}return this.filter.negate?!e:e}}ia.baseLogTag="BooleanDataType";let na=["is","exists","greaterThan","lessThan","between","in"];class aa extends Qn{constructor(e,t){super(Ue.NUMBER,na,e,t)}evaluate(){aa.baseLogTag;let e=!1;var t=this.event.attributes.filter(e=>e.key===this.filter.name),i=0<t.length?t[0]:null;if(null!=i&&"number"==typeof i.value)switch(this.filter.operator){case"is":e=this.checkEq();break;case"exists":e=this.checkExists();break;case"greaterThan":e=this.checkGreaterThan(i);break;case"lessThan":e=this.checkLessThan(i);break;case"between":e=this.checkBetween(i);break;case"in":e=this.checkIn(i)}return this.filter.negate?!e:e}checkGreaterThan(e){return e.value>this.filter.value}checkLessThan(e){return e.value<this.filter.value}checkBetween(e){return this.filter.value2?this.filter.value&&this.filter.value2&&this.filter.value<=e.value&&e.value<this.filter.value2:this.filter.value&&this.filter.value1&&this.filter.value<=e.value&&e.value<this.filter.value1}checkIn(e){return Array.isArray(this.filter.value)&&0<=this.filter.value.indexOf(e.value)}}aa.baseLogTag="NumberDataType";let ra=["exists","on","between","before","after","inTheLast","inTheNext","today"];class oa extends Qn{constructor(e,t){!Ji.isDate(t.value)&&Ji.isString(t.value)&&(t.value=new Date(t.value.split("Z").join(""))),!Ji.isDate(t.value2)&&Ji.isString(t.value2)&&null!=t.value2&&(t.value2=new Date(t.value2.split("Z").join(""))),!Ji.isDate(t.value1)&&Ji.isString(t.value1)&&null!=t.value1&&(t.value1=new Date(t.value1.split("Z").join(""))),super(Ue.DATE,ra,e,t)}evaluate(){oa.baseLogTag;let e=!1;var t=this.event.attributes.filter(e=>e.key===this.filter.name),i=0<t.length?t[0]:null;if(null!=i)switch(i.value.setHours(0,0,0,0),this.filter.operator){case"is":e=this.checkEq();break;case"exists":e=this.checkExists();break;case"on":e=this.checkOn(i);break;case"between":e=this.checkBetween(i);break;case"before":e=this.checkBefore(i);break;case"after":e=this.checkAfter(i);break;case"inTheLast":e=this.checkLastX(i);break;case"inTheNext":e=this.checkNextX(i);break;case"today":e=this.checkToday(i)}return this.filter.negate?!e:e}checkOn(e){return e.value.setHours(0,0,0,0)===this.filter.value.setHours(0,0,0,0)}checkBetween(e){return this.filter.value2?this.filter.value.getTime()<=e.value.getTime()&&e.value.getTime()<this.filter.value2.getTime():this.filter.value.getTime()<=e.value.getTime()&&e.value.getTime()<this.filter.value1.getTime()}checkBefore(e){var{value:t}=this.filter;return typeof t===$t.NUMBER?((new Date).setHours(0,0,0,0)-e.value.setHours(0,0,0,0))/864e5>t:e.value.setHours(0,0,0,0)<t.setHours(0,0,0,0)}checkAfter(e){var{value:t}=this.filter;return typeof t===$t.NUMBER?(e.value.setHours(0,0,0,0)-(new Date).setHours(0,0,0,0))/864e5>t:e.value.setHours(0,0,0,0)>t.setHours(0,0,0,0)}checkLastX(e){var t=(new Date).setHours(0,0,0,0);return 0<t-(e=e.value.setHours(0,0,0,0))&&(t-e)/864e5<=this.filter.value}checkNextX(e){var t=(new Date).setHours(0,0,0,0);return 0<(e=e.value.setHours(0,0,0,0))-t&&(e-t)/864e5<=this.filter.value}checkToday(e){return e.value.setHours(0,0,0,0)===(new Date).setHours(0,0,0,0)}}oa.baseLogTag="DateTimeDataType";let sa=["is","exists","contains","startsWith","endsWith","in","lessThan","greaterThan","between","inTheLast","inTheNext","after","before","on","today"];class la extends Qn{constructor(e,t){super(t.data_type,sa,e,t)}evaluate(){var e=this.event.attributes.filter(e=>e.key===this.filter.name);return!(null==(e=0<e.length?e[0]:null)||!Ji.isArray(e.value))&&(this.filter.array_filter_type&&this.filter.array_filter_type===Fe.ANYOFF?this.checkAnyOf(e):this.checkAllOf(e))}checkAllOf(e){return e.value.every(t=>this.getFilterResult(t,e))}checkAnyOf(e){return e.value.some(t=>this.getFilterResult(t,e))}getFilterResult(e,t){return t=this.createCustomEvent(t.key,e),!!(e=this.getDataType(t)).validate()&&e.evaluate()}createCustomEvent(e,t){return e=new Gi(e,t),new cn(this.event.name,[e])}getDataType(e){let t;switch(this.filter.data_type){case Ue.ARRAY_BOOL:t=new ia(e,this.filter);break;case Ue.ARRAY_DATETIME:t=new oa(e,this.filter);break;case Ue.ARRAY_NUMBER:t=new aa(e,this.filter);break;case Ue.ARRAY_STRING:t=new ea(e,this.filter)}return t}}class da{constructor(e,t){this.event=e,this.filter=t}evaluate(){let e;var t=this.event.attributes.filter(e=>e.key===this.filter.name);let i=0<t.length?t[0]:null;if(!i)return!1;var n=this.filter.filters.map(e=>{var t;return"exists"===e.operator?(t=(null==e?void 0:e.name)in(null==i?void 0:i.value),e.negate?!t:t):(null==e?void 0:e.name)in(null==i?void 0:i.value)&&(t=new Gi(e.name,i.value[e.name]),t=new cn(e.name,[t]),ca.doesEventMatchFilters(t,e))}),a=this.filter.filter_operator;e=(null==n?void 0:n[0])||!1;for(let t=1;t<n.length;t++)if(a===He.AND){if(!1===(e=e&&n[t]))break}else if(a===He.OR&&!0===(e=e||n[t]))break;return e}}class ca{static doesEventMatchFilters(e,t){ca.baseLogTag;let i=!1,n=null;switch(t.data_type){case Ue.BOOL:(n=new ia(e,t)).validate()&&(i=n.evaluate());break;case Ue.STRING:(n=new ea(e,t)).validate()&&(i=n.evaluate());break;case Ue.NUMBER:case Ue.LONG:(n=new aa(e,t)).validate()&&(i=n.evaluate());break;case Ue.DATE:(n=new oa(e,t)).validate()&&(i=n.evaluate());break;case Ue.OBJECT:n=new da(e,t),i=n.evaluate();break;case Ue.ARRAY_STRING:case Ue.ARRAY_DATETIME:case Ue.ARRAY_BOOL:case Ue.ARRAY_NUMBER:(n=new la(e,t)).validate()&&(i=n.evaluate())}return i}static doesValueMatchFilter(e,t){return e=new Gi(t.name,e),e=new cn("Sample event",[e]),ca.doesEventMatchFilters(e,t)}}ca.baseLogTag="TriggerEvaluator";class ua{constructor(e){var t=ua.baseLogTag+".constructor",i=(this.campaignId=o(e,"campaign_id",null),this.campaignName=o(e,"campaign_name",null),this.templateType=o(e,"template_type",null),this.campaignContext=o(e,"campaign_context",null),o(e,"status",null)),n=((n=[We.ACTIVE,We.EXPIRED,We.PAUSED]).indexOf(i)<0?this.status=We.ACTIVE:this.status=n[n.indexOf(i)],this.tag=o(e,"tag",null),this.triggerData=null,ga.validate(o(e,"trigger"))?this.triggerData=new ga(o(e,"trigger")):Si.log(2,t,"Rejecting trigger data for :",e),this.expiryTime=Te(o(e,"expiry_time")+"Z"),this.updatedTime=Te(o(e,"updated_time")+"Z"),this.delivery=new fa(o(e,"delivery")),this.userInSegment=o(e,"user_in_segment",!0),o(e,"display",this.display=null));i=o(e,"display_filter",null),this.templateType!==Ve.SELF_HANDLED&&(null!=i?this.display=new Ia({rules:{uri_filters:i}},this.templateType):null!=n&&(this.display=new Ia(n,this.templateType))),this.stats={},this.onsitePayload=null,this.editorVersion=o(e,"editor_version",null)}static isValidMetaJSON(e){let t=!0;var i=["campaign_id","campaign_name","template_type","status","expiry_time","updated_time","delivery","user_in_segment"];for(let n=0;n<i.length;n++)if(null==e[i[n]]){t=!1;break}return t}static getTriggerEvent(e,t,i){return null==(t=o(t,`triggerData.${i}_condition.included_filters`,null))?void 0:t.filters.filter(t=>t.action_name===e||t.action_name===wt.MOE_PAGE_EXIT&&"MOE_EXIT"===e)}static areFiltersAbsent(e){return!(null==e||!e.action_name||null!=(e=null==e?void 0:e.attributes)&&e.filters)}static getFilters(e){return(null==e?void 0:e.action_name)&&(null==(e=null==e?void 0:e.attributes)?void 0:e.filters)||null}static getFilterOperator(e){return(null==e?void 0:e.action_name)&&(null==(e=null==e?void 0:e.attributes)?void 0:e.filterOperator)||He.AND}static isTriggered(e,t,i,n){let a=!0;if(0<(null==t?void 0:t.length)){let o;o=n||ua.getFilterOperator(i);var r=t.map(t=>ca.doesEventMatchFilters(e,t));a=r[0]||!1;for(let e=1;e<r.length;e++)if(o===He.AND){if(!1===(a=a&&r[e]))break}else if(o===He.OR&&!0===(a=a||r[e]))break}return a}static getFilterResult(e,t){return this.didPrimaryEventFilterTrigger(e,t)&&this.getURLFilterResult(t)}static didPrimaryEventFilterTrigger(e,t){var i=this.getTriggerEvent(e.name,t,"primary")||[];for(let t=0;t<i.length;t++){var n=i[t],a=ua.getFilters(n);if(ua.areFiltersAbsent(n)||ua.isTriggered(e,a,n))return!0}return!1}static getURLFilterResult(e){var t,i=new cn(wt.MOE_PAGE_URL_EVENT,[]);return!(e=ua.getTriggerEvent(i.name,e,"url"))||(e=e.find(e=>e.action_name===wt.MOE_PAGE_URL_EVENT),t=ua.getFilters(e),ua.isTriggered(i,t,e))}}ua.baseLogTag="OnsiteCampaignMeta";class ga{constructor(e){this.cs_id=e.cs_id,this._id=e._id,this.references=e.references,this.trigger_wait_time=e.trigger_wait_time||null,ma.validate(e.primary_condition)?this.primary_condition=new ma(e.primary_condition):this.primary_condition=null,ma.validate(e.secondary_condition)?this.secondary_condition=new ma(e.secondary_condition):this.secondary_condition=null,ma.validate(e.url_condition)?this.url_condition=new ma(e.url_condition):this.url_condition=null,this.description=e.description,this.trigger_delay=null!=e.trigger_delay?new pa(e.trigger_delay):null}static validate(e){let t=!1;return["primary_condition"].forEach(i=>{null!=o(e,i,null)&&(t=!0)}),t}}class pa{constructor(e){if(this.delay=o(e,"delay",0),this.unit=o(e,"unit","seconds"),this.delay_type=o(e,"delay_type",""),this.attribute=o(e,"attribute",""),o(e,"delay",null)&&o(e,"unit",null)){let e=this.delay;"minutes"!==this.unit&&"hours"!==this.unit&&"days"!==this.unit||(e*=60),"hours"!==this.unit&&"days"!==this.unit||(e*=60),"days"===this.unit&&(e*=24),this.delayInSeconds=e}else this.delayInSeconds=0}}class ma{constructor(e){this.included_filters=new ha(o(e,"included_filters",null)),this.excluded_filters=new ha(o(e,"excluded_filters",null))}static validate(e){return!!(e&&(e=e.included_filters)&&Array.isArray(e.filters)&&e.filters.length&&null!=e.filter_operator)}}class ha{constructor(e){this.filter_operator=o(e,"filter_operator",He.AND),this.filters=null==(e=o(e,"filters",[]))?void 0:e.map(e=>new Ea(e))}}class Ea{constructor(e){var t=("boolean"==("string"==typeof(t=o(e,"action_name",null))&&(t.includes("")?this.action_name=Ie(t):this.action_name=t),typeof(t=o(e,"executed",null)))&&(this.executed=t),this.filter_type=o(e,"filter_type",null),o(e,"attributes",null));va.validateJson(t)&&(this.attributes=new va(t)),"nested_filters"===this.filter_type&&(this.filters=new ha(e))}}class va{constructor(e){this.filters=[],this.filterOperator=o(e,"filter_operator",He.AND),this.filters=o(e,"filters",[]),this.filters.length&&this.filters.forEach(e=>{var t;null!=(t=null==e?void 0:e.name)&&t.includes("")&&(e.name=Ie(e.name))})}static validateJson(e){if(null==e)return!1;var t=["filters"];for(let i=0;i<t.length;i++)if(null==e[t[i]])return!1;return!0}}(a=We=We||{}).ACTIVE="ACTIVE",a.PAUSED="PAUSED",a.EXPIRED="EXPIRED",(S=He=He||{}).AND="and",S.OR="or";class fa{constructor(e){this.priority=o(e,"priority",0),this.dismiss_interval=o(e,"dismiss_interval",0),this.fc_meta=new Sa(o(e,"fc_meta",null))}}class Sa{constructor(e){this.count=0,this.delay=0,this.ignore_global_delay=!1,null!=e&&(this.count=o(e,"count",0),this.delay=o(e,"delay",0),this.ignore_global_delay=o(e,"ignore_global_delay",!1))}}class _a{constructor(e){this.aggregations=[],this.filters=[],this.aggregations=o(e,"aggregations",[]),this.filter_operator=o(e,"filter_operator",He.AND),this.filters=o(e,"filters",[])}}class Ia{constructor(e,t){this.config={blocking:o(e,"config.blocking",Ia.getDefaultValue("blocking",t)),pushPage:o(e,"config.push_page",Ia.getDefaultValue("push_page",t)),sticky:o(e,"config.sticky",Ia.getDefaultValue("sticky",t)),scrollable:o(e,"config.scrollable",Ia.getDefaultValue("scrollable",t)),showOverOtherCampaigns:o(e,"config.show_over_campaigns",Ia.getDefaultValue("show_over_campaigns",t))},this.rules={uriFilters:new _a(o(e,"rules.uri_filters",{}))}}static getDefaultValue(e,t){return{blocking:{POP_UP:!0,BANNER:!1},push_page:{POP_UP:!1,BANNER:!0},sticky:{POP_UP:!1,BANNER:!0},scrollable:{POP_UP:!1,BANNER:!0},show_over_campaigns:{POP_UP:!1,BANNER:!1}}[e][t]}}(a=Ve=Ve||{}).SELF_HANDLED="SELF_HANDLED",a.SELF_HANDLED_OSM="SELF_HANDLED_OSM",a.POP_UP="POP_UP",a.BANNER="BANNER";class Ta{constructor(e){this.templateType=o(e,"template_type",null),this.payloadType=o(e,"payload_type",null),this.payload=o(e,"payload",null),this.position=o(e,"position",null),this.campaignContext=o(e,"campaign_context",null),this.editorVersion=o(e,"editor_version",null),this.htmlJsonPayload=JSON.parse(ye(o(e,"html_json_payload",null))),this.updatedTime=Te(o(e,"updated_time")+"Z")}}var Ye=function(e,t,i,n){return new(i=i||Promise)(function(a,r){function o(e){try{l(n.next(e))}catch(e){r(e)}}function s(e){try{l(n.throw(e))}catch(e){r(e)}}function l(e){var t;e.done?a(e.value):((t=e.value)instanceof i?t:new i(function(e){e(t)})).then(o,s)}l((n=n.apply(e,t||[])).next())})};class ya{constructor(e){this.appId=e.appId,this.store=r.createInstance({driver:[r.INDEXEDDB,r.WEBSQL,r.LOCALSTORAGE],name:jt.DATABASE_NAME,storeName:jt.STORES.SERVICE_META.NAME}),this.host=e.baseDomainName}getUserSessionAttributes(){var e={day:["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"][(e=new Date).getDay()],hours:String(e.getHours()).padStart(2,"0")},t=new Xi,i=Ri(window.location.href);return Object.assign(Object.assign({},i),{USER_TYPE:1<t.getNumberOfSessions()?"Returning":"New",DAY_OF_THE_WEEK:e.day,TIME_OF_THE_DAY:e.hours})}getCampaignsMeta(){return Ye(this,void 0,void 0,function*(){var e=ya.baseLogTag+".getCampaignsMeta";try{var t=yield this.getRequestOptions(),i=yield this.store.getItem(jt.STORES.SERVICE_META.KEYS.LAST_META_CALL_TIME),n=yield ki.post(this.host+jt.API.META,Object.assign(Object.assign({},t),{postData:Object.assign(Object.assign({},t.postData),{campaign_ids:[],user_session_attributes:this.getUserSessionAttributes()}),last_fetch_time:i&&"object"==typeof i?i.toISOString():i})),a=(this.store.setItem(jt.STORES.SERVICE_META.KEYS.LAST_META_CALL_TIME,new Date),this.store.setItem(jt.STORES.SERVICE_META.KEYS.UNIQUE_ID,t.queryParams.unique_id),JSON.parse(n.responseText));let e=[];return a.campaigns.forEach(t=>{ua.isValidMetaJSON(t)&&e.push(new ua(t))}),{campaignsMeta:e,globalDelayBetweenInapps:o(a,"min_delay_btw_inapps",0)}}catch(t){throw Si.error(1,e,"Error getting meta for inapp: ",t),new Error("Could not get meta payload")}})}getCampaignPayload(e,t){return Ye(this,void 0,void 0,function*(){var i=ya.baseLogTag+".getCampaignPayload";let n;try{var a={contexts:["string"],campaign_context:e.campaignContext,user_session_attributes:this.getUserSessionAttributes()};if(t){var r={};for(let e=0;e<t.attributes.length;e++)r[t.attributes[e].key]=t.attributes[e].value;a.event={name:t.name,attributes:r,time:(new Date).toISOString()}}return n=yield ki.post(this.host+jt.API.CAMPAIGN_PAYLOAD+e.campaignId,yield this.getRequestOptions(a)),(n=JSON.parse(n.responseText)).code===jt.GCG_ERROR_CODE&&(n={payload:n}),new Ta(n)}catch(n){if(Si.error(1,i,"Error geting payload",n),n.code&&(409===n.code||400===n.code)&&n.reason)return{error:!0,reason:JSON.parse(n.reason).description||""};throw new Error("Could not get payload for "+e.campaignId)}})}getCampaignsPayload(e,t){return Ye(this,void 0,void 0,function*(){var i=ya.baseLogTag+".getCampaignsPayload";let n;try{if(t){var a={};for(let e=0;e<t.attributes.length;e++)a[t.attributes[e].key]=t.attributes[e].value;var r={event:{name:t.name,attributes:a,time:(new Date).toISOString()},contexts:["string"],campaign_ids:e};n=yield ki.post(this.host+jt.API.CAMPAIGNS_PAYLOAD,this.getRequestOptions(r))}else n=yield ki.post(this.host+jt.API.CAMPAIGNS_PAYLOAD,this.getRequestOptions());let i=[];return JSON.parse(n.responseText).forEach(e=>{i.push(new Ta(e))}),i}catch(n){throw Si.error(1,i,"Error geting payload",n),new Error("Could not get payload for "+e)}})}getDraftCampaign(e){return Ye(this,void 0,void 0,function*(){var t=ya.baseLogTag+".getDraftCampaign";try{var i=yield this.getRequestOptions(),n=(i.queryParams=Object.assign({},i.queryParams,{locale:e.locale,variation:e.variation}),yield ki.post(this.host+jt.API.DRAFT_CAMPAIGN_PAYLOAD+e.draftId,i)),a=JSON.parse(n.responseText);return"JSON"===a.payload_type&&(a.payload=JSON.parse(a.payload)),new Ta(a)}catch(i){return Si.error(1,t,"Error geting test campaign payload",i),null}})}getRequestOptions(e={}){let t=s();return Wi().then(i=>Ye(this,void 0,void 0,function*(){Li.get(yt.USER_DATA);var i,n,a=yield function(){return fe(this,void 0,void 0,function*(){var e={},t=Bi.getIdentityMap(),i=yield function(){return fe(this,void 0,void 0,function*(){var e=yield ji.get(),t=e.getAttribute(Nt.ID)||"";return{uniqueId:e.deviceUuid,uid:t}})}();return t&&(t.userIdentities&&(e.user_identities=t.userIdentities),t.previousIdentities)&&(e.previous_identities=t.previousIdentities),i.uid&&(e.uid=i.uid),{identifiers:e,uniqueId:i.uniqueId}})}();if(a.uniqueId)return i=se()?"mweb":"web",n=de(),{headers:{"Content-Type":"application/json","MOE-APPKEY":this.appId},queryParams:Object.assign({sdk_ver:t.getSdkVersion(),unique_id:null==a?void 0:a.uniqueId,os:i},n),postData:Object.assign(Object.assign({},e),{identifiers:a.identifiers})};throw new Error("uniqueId not found in localStorage.")})).catch(e=>{throw new Error("Error in getting Web SDK Settings. This might indicate that the App is blocked.")})}callStatsAPI(e,t){let i=ya.baseLogTag+".callStatsAPI";this.getRequestOptions().then(t=>{var n=this.host+jt.API.STATS;t.queryParams.app_id=t.headers["MOE-APPKEY"],delete t.queryParams.uid,n=Mi(n,t.queryParams),Si.log(1,i,"[sendBeacon] payload: "+JSON.stringify(e)),t=new Blob([JSON.stringify(e)],{type:"text/plain;charset=UTF-8"}),navigator.sendBeacon(n,t)})}}ya.baseLogTag="OnsiteApi";class ba{constructor(){this.isExitIntentShown=!1,this.isPopStateEventBound=!1}onScroll(e){let t=ba.baseLogTag+".onScroll";null==e&&(e=()=>{});var i=ba.throttle(()=>{Si.remoteLogTracking(1,"info",t,"Scrolled percent:",ba.getScrollPercent()),e(ba.getScrollPercent())},jt.SCROLL_CAMPAIGN_THROTTLING_TIME);return e(ba.getScrollPercent()),window.addEventListener("scroll",i),i}onMobileTabChange(e){let t=ba.baseLogTag+".onMobileTabChange";document.addEventListener("visibilitychange",()=>{this.isExitIntentShown||"hidden"!==document.visibilityState||(Si.log(1,t,"TRIGGERED: MOBILE EXIT INTENT"),e(),this.isExitIntentShown=!0)})}onMobileBackHit(e){let t=ba.baseLogTag+".onMobileBackHit";setTimeout(()=>{this.isPopStateEventBound=!0,window.addEventListener("popstate",i=>{!this.isExitIntentShown&&i.state&&"exit_intent"===i.state.moeIntent&&(Si.log(1,t,"TRIGGERED: MOBILE EXIT INTENT"),e("onBackClick"),this.isExitIntentShown=!0)})},1e3),this.setHistoryState()}setHistoryState(){window.history.state&&"no_intent"===window.history.state.moeIntent||(window.history.replaceState(Object.assign(Object.assign({},window.history.state),{moeIntent:"exit_intent"}),""),window.history.pushState(Object.assign(Object.assign({},window.history.state),{moeIntent:"no_intent"}),""))}onMobileScrollAndExit(e){let t,i=ba.baseLogTag+".onMobileScrollAndExit",n=document.documentElement.offsetHeight,a=ba.getScrollY();0<n&&(this.scrollExitIntentInterval=window.setInterval(()=>{let r=a-ba.getScrollY();r<0&&(r=0,a=ba.getScrollY()),t=ba.getScrollPercent()>jt.EXIT_INTENT.CONFIG.SCROLL_DOWN_THRESHOLD,t&&r/n>jt.EXIT_INTENT.CONFIG.SCROLL_UP_THRESHOLD/100&&(clearInterval(this.scrollExitIntentInterval),this.scrollExitIntentInterval=null,this.isExitIntentShown||(Si.log(1,i,"TRIGGERED: MOBILE EXIT INTENT"),e(),this.isExitIntentShown=!0))},jt.EXIT_INTENT.CONFIG.SCROLL_INTERVAL))}mobileExitIntent(e){this.onMobileScrollAndExit(e),this.onMobileBackHit(e),this.onMobileTabChange(e)}onExit(e){let t=ba.baseLogTag+".onExit";se()?this.mobileExitIntent(e):(this.exitIntentListener=i=>function(e,t,i,n){return new(i=i||Promise)(function(t,a){function r(e){try{s(n.next(e))}catch(e){a(e)}}function o(e){try{s(n.throw(e))}catch(e){a(e)}}function s(e){var n;e.done?t(e.value):((n=e.value)instanceof i?n:new i(function(e){e(n)})).then(r,o)}s((n=n.apply(e,[])).next())})}(this,0,void 0,function*(){var n=window.innerWidth;(i.clientY<0||i.clientX<0||i.clientY>=window.innerHeight||i.clientX>=n)&&(Si.log(1,t,"TRIGGERED: EXIT INTENT"),e())}),document.addEventListener("mouseout",this.exitIntentListener,!1))}static getScrollPercent(){var e=window,t=(i=document).documentElement,i=i.getElementsByTagName("body")[0];return e=e.innerHeight||t.clientHeight||i.clientHeight,t=document.body,i=document.documentElement,e<(t=Math.max(t.scrollHeight,t.offsetHeight,i.clientHeight,i.scrollHeight,i.offsetHeight))?100*ba.getScrollY()/(t-e):100}static getScrollY(){let e=0;return"number"==typeof window.pageYOffset?e=window.pageYOffset:document.body&&document.body.scrollTop&&(e=document.body.scrollTop),e}static throttle(e,t){let i;return(...n)=>{i=i||window.setTimeout(()=>{i=null,e.apply(null,n)},t)}}static setOnlineEventListner(e){window.addEventListener("online",e,{once:!0})}}ba.baseLogTag="WindowEventManager";var qe=function(e,t,i,n){return new(i=i||Promise)(function(a,r){function o(e){try{l(n.next(e))}catch(e){r(e)}}function s(e){try{l(n.throw(e))}catch(e){r(e)}}function l(e){var t;e.done?a(e.value):((t=e.value)instanceof i?t:new i(function(e){e(t)})).then(o,s)}l((n=n.apply(e,t||[])).next())})};class Aa{static getPendingSecondaryEventCampaign(e){return qe(this,void 0,void 0,function*(){return yield Rn.pendingSecondaryEvents.getItem(e)})}static setPendingSecondaryEventCampaign(e,t){return qe(this,void 0,void 0,function*(){yield Rn.pendingSecondaryEvents.setItem(e,t)})}static removePendingSecondaryEventCampaign(e){return qe(this,void 0,void 0,function*(){yield Rn.pendingSecondaryEvents.removeItem(e)})}static getPendingSecondaryEventKeys(){return qe(this,void 0,void 0,function*(){return yield Rn.pendingSecondaryEvents.keys()})}static getPendingTimerCampaign(e){return qe(this,void 0,void 0,function*(){return yield Rn.pendingTimerCampaigns.getItem(e)})}static setPendingTimerCampaign(e,t){return qe(this,void 0,void 0,function*(){yield Rn.pendingTimerCampaigns.setItem(e,t)})}static removePendingTimerCampaign(e){return qe(this,void 0,void 0,function*(){yield Rn.pendingTimerCampaigns.removeItem(e)})}static getPendingTimerKeys(){return qe(this,void 0,void 0,function*(){return yield Rn.pendingTimerCampaigns.keys()})}static getTriggeringPrimaryEvent(e){return qe(this,void 0,void 0,function*(){return yield Rn.triggeringPrimaryEvents.getItem(e)})}static setTriggeringPrimaryEvent(e,t){return qe(this,void 0,void 0,function*(){yield Rn.triggeringPrimaryEvents.setItem(e,t)})}static removeTriggeringPrimaryEvent(e){return qe(this,void 0,void 0,function*(){yield Rn.triggeringPrimaryEvents.removeItem(e)})}static getTriggeringPrimaryEventKeys(){return qe(this,void 0,void 0,function*(){return yield Rn.triggeringPrimaryEvents.keys()})}static removeCampaignFromStores(e){return qe(this,void 0,void 0,function*(){yield Aa.removePendingSecondaryEventCampaign(e),yield Aa.removePendingTimerCampaign(e)})}}var ze=function(e,t,i,n){return new(i=i||Promise)(function(a,r){function o(e){try{l(n.next(e))}catch(e){r(e)}}function s(e){try{l(n.throw(e))}catch(e){r(e)}}function l(e){var t;e.done?a(e.value):((t=e.value)instanceof i?t:new i(function(e){e(t)})).then(o,s)}l((n=n.apply(e,t||[])).next())})};class Oa{static setListener(e){this.listener=e}static destroy(){this.listener=null,this.deliveryStats=null}static setDeliveryStats(e){this.deliveryStats=e}static createNewTimers(){return ze(this,void 0,void 0,function*(){var e=this.baseLogTag+".createNewTimers",t=yield Aa.getPendingTimerKeys();for(let a=0;a<t.length;a++){var i=t[a],n=(n=yield Aa.getPendingTimerCampaign(i)).timer-(Date.now()-n.startTime);Si.log(1,e,`Creating new setTimeout with time: ${n} ms for the campaign: `+i),yield this.createPendingTimerCampaign(i,n)}})}static deletePendingTimer(e){return ze(this,void 0,void 0,function*(){var t=this.baseLogTag+".deletePendingTimer",i=yield Aa.getPendingTimerCampaign(e);null!=i&&i.timerId&&(Si.log(1,t,`There was an existing setTimeout associated to the campaign: ${e}. Clearing it`),clearTimeout(i.timerId))})}static deleteAllPendingTimers(){return ze(this,void 0,void 0,function*(){var e=this.baseLogTag+".deleteAllPendingTimers",t=(Si.log(1,e,"Clearing all setTimeout's associated to different campaign(s)"),yield Aa.getPendingTimerKeys());for(let e=0;e<t.length;e++){var i=t[e];i=yield Aa.getPendingTimerCampaign(i),clearTimeout(i.timerId)}})}static createPendingTimerCampaign(e,t){return ze(this,void 0,void 0,function*(){yield this.deletePendingTimer(e);var i=setTimeout(()=>ze(this,void 0,void 0,function*(){yield this.checkAndInvokeListener(e),yield Aa.removeCampaignFromStores(e)}),t);i={startTime:Date.now(),timerId:i,timer:t},yield Aa.setPendingTimerCampaign(e,i)})}static checkAndInvokeListener(e){return ze(this,void 0,void 0,function*(){var t=this.baseLogTag+".checkAndInvokeListener",i=yield zn(e);null!=i&&i.campaignId&&((yield this.isSatisfyingEventsArray(e))?ua.getURLFilterResult(i)&&(Si.log(1,t,`Campaign ${e} satisfies the secondary_condition and the url_condition after timer has elapsed`),this.closeProximityTimerCampaigns.push(i),this.closeProximityCampaignsTimeout||(this.closeProximityCampaignsTimeout=setTimeout(()=>{this.listener(this.closeProximityTimerCampaigns),this.closeProximityTimerCampaigns=[],this.closeProximityCampaignsTimeout=null},500))):(Si.warn(1,t,`Campaign: ${e} does not satisfy secondary_condition after its timer has elapsed. Removing its entry from secondary stores`),this.deliveryStats.setStats(i,jt.DELIVERY_FUNNEL.ATTEMPTED.CAMPAIGN_ATTEMPTED),this.deliveryStats.setStats(i,jt.DELIVERY_FUNNEL.EVALUATION.CAMPAIGN_EVALUATION_PATH_TIME_EXPIRED),this.deliveryStats.sendDeliveryStats([i])))})}static checkIfPendingAction(e,t){return t===He.AND&&!e.events.some(e=>1===e.filters.length&&!e.filters[0].executed)}static isSatisfyingEventsArray(e){return ze(this,void 0,void 0,function*(){var t=yield Aa.getPendingSecondaryEventCampaign(e);if(null!=t&&t.events){if(t.events.length){var i=t.operator;for(let e=0;e<t.events.length;e++){var n=t.events[e],a=n.operator;let r=!1,o=!1;for(let e=0;e<n.filters.length;e++)if(n.filters[e].executed){if(this.checkIfPendingAction(t,a))return!1;r=!0}else o=!0;if(i===He.AND&&a===He.OR&&r&&!o)return!1}}return!0}return!1})}static logDeliveryFunnelForExpiredTimerCampaigns(){return ze(this,void 0,void 0,function*(){var e=this.baseLogTag+".logDeliveryFunnelForExpiredTimerCampaigns",t=yield Aa.getPendingTimerKeys(),i=Date.now(),n=[];for(let o=0;o<t.length;o++){var a=t[o],r=yield Aa.getPendingTimerCampaign(a);i-r.startTime>=r.timer&&(yield this.isSatisfyingEventsArray(a))&&null!=(r=yield zn(a))&&r.campaignId&&(Si.warn(1,e,`Campaign: ${a} contained 'has not executed' event(s) and had satisfied secondary_condition, but the website was closed when the timer elapsed`),n.push(r),yield this.deleteTimerAndRemoveFromStores(a))}this.sendUserNotOnAppStat(n)})}static sendUserNotOnAppStat(e){var t;for(let t=0;t<e.length;t++){var i=e[t];this.deliveryStats.setStats(i,jt.DELIVERY_FUNNEL.ATTEMPTED.CAMPAIGN_ATTEMPTED),this.deliveryStats.setStats(i,jt.DELIVERY_FUNNEL.EVALUATION.CAMPAIGN_EVALUATION_USER_NOT_ON_APP)}null!=(t=this.deliveryStats)&&t.sendDeliveryStats(e)}static deleteTimerAndRemoveFromStores(e){return ze(this,void 0,void 0,function*(){yield this.deletePendingTimer(e),yield Aa.removeCampaignFromStores(e)})}}Oa.baseLogTag="CampaignTimerManager",Oa.listener=null,Oa.deliveryStats=null,Oa.closeProximityTimerCampaigns=[],Oa.closeProximityCampaignsTimeout=null;var $e=function(e,t,i,n){return new(i=i||Promise)(function(a,r){function o(e){try{l(n.next(e))}catch(e){r(e)}}function s(e){try{l(n.throw(e))}catch(e){r(e)}}function l(e){var t;e.done?a(e.value):((t=e.value)instanceof i?t:new i(function(e){e(t)})).then(o,s)}l((n=n.apply(e,t||[])).next())})};class wa{static setDeliveryStats(e){this.deliveryStats=e}static destroy(){this.deliveryStats=null}static createPendingSecondaryEvents(e,t){return $e(this,void 0,void 0,function*(){var i=this.baseLogTag+".createPendingSecondaryEvents";for(let o=0;o<e.length;o++){var n,a,r=e[o];Jn(r)&&(({campaignEntry:n,isCampaignTimerSet:a}=this.constructCampaignEntry(r)),yield Aa.setTriggeringPrimaryEvent(r.campaignId,t),yield Aa.setPendingSecondaryEventCampaign(r.campaignId,n),a)&&(Si.log(1,i,`The campaign: ${r.campaignId} has at least one 'has not executed' secondary event. Starting timer for this campaign. Time remaining: ${n.time_left} ms`),yield Oa.createPendingTimerCampaign(r.campaignId,n.time_left))}})}static constructCampaignEntry(e){var t=e.triggerData.secondary_condition.included_filters;let i={operator:t.filter_operator,events:[]},n=!1;return t.filters.forEach(e=>{if("nested_filters"===e.filter_type){let t={operator:e.filters.filter_operator,filters:[]};e.filters.filters.forEach(e=>{t.filters.push(e),!1===e.executed&&(n=!0)}),i.events.push(t)}else{var t={operator:i.operator===He.AND?He.OR:He.AND,filters:[e]};i.events.push(t),!1===e.executed&&(n=!0)}}),i.updated_time=Date.now(),i.time_left=1e3*e.triggerData.trigger_wait_time.wait_period,{campaignEntry:i,isCampaignTimerSet:n}}static pruneRemovedCampaigns(){return $e(this,void 0,void 0,function*(){var e=this.baseLogTag+".pruneRemovedCampaigns",t=(yield $n()).map(e=>e.campaignId),i=yield Aa.getPendingSecondaryEventKeys();for(let a=0;a<i.length;a++){var n=i[a];t.includes(n)||(Si.warn(1,e,`The campaign: $${n} is not present in the latest meta call. Removing its entry from secondary stores and removing any pending timer`),yield Oa.deleteTimerAndRemoveFromStores(n))}})}static updateCampaignTimeInSecondaryEventsStore(){return $e(this,void 0,void 0,function*(){var e=this.baseLogTag+".updateCampaignTimeInSecondaryEventsStore",t=yield Aa.getPendingSecondaryEventKeys(),i=[];for(let o=0;o<t.length;o++){var n=t[o],a=yield Aa.getPendingSecondaryEventCampaign(n),r=Date.now();a.time_left-=r-a.updated_time,a.updated_time=r,a.time_left<=0?(null!=(r=yield zn(n))&&r.campaignId&&(Si.warn(1,e,`Campaign: ${n} does not have time left to render. Removing its entry from secondary stores and clearing any setTimeout associated to it`),i.push(r)),yield Oa.deleteTimerAndRemoveFromStores(n)):yield Aa.setPendingSecondaryEventCampaign(n,a)}this.sendPathTimeExpiredStat(i)})}static updatePendingSecondaryEventsHistory(e,t){return $e(this,void 0,void 0,function*(){var i=this.baseLogTag+".updatePendingSecondaryEventsHistory",n=[],a=[],r=[],o=Date.now();for(let E=0;E<t.length;E++){var s=t[E],l=yield Aa.getPendingSecondaryEventCampaign(s);if(l)if(l.time_left-=o-l.updated_time,l.updated_time=o,l.time_left<=0){var d=yield zn(s);null!=d&&d.campaignId&&(Si.warn(1,i,`Campaign ${s} which is associated to the event: ${e.name} does not have time left to render. Removing its entry from secondary stores and clearing any setTimeout associated to it`),r.push(d)),a.push(s)}else{var c=l.operator;for(let t=0;t<l.events.length;t++){var u=l.events[t],g=u.operator;for(let t=0;t<u.filters.length;t++){var p=u.filters[t],m=p.attributes,h=p.executed;e.name===p.action_name&&(m&&ua.isTriggered(e,m.filters,null,m.filterOperator)||!e.attributes||!e.attributes.length)&&(h?g===He.OR?(u.toBeRemoved=!0,c!==He.OR&&(c!==He.AND||l.events.length&&!l.events.every(e=>e.toBeRemoved))||(Si.log(1,i,`Campaign: ${s}, triggered by event: ${e.name}, is eligible for further processing`),n.push(s))):g===He.AND&&(p.toBeRemoved=!0,u.filters.every(e=>e.toBeRemoved))&&(u.toBeRemoved=!0,c===He.OR||c===He.AND&&l.events.every(e=>e.toBeRemoved))&&(Si.log(1,i,`Campaign: ${s}, triggered by event: ${e.name}, is eligible for further processing`),n.push(s)):g===He.OR?(p.toBeRemoved=!0,u.filters.every(e=>e.toBeRemoved)&&(c===He.AND||c===He.OR&&1===l.events.length?(Si.warn(1,i,`The event: ${e.name} breaks secondary conditons of the campaign: ${s}. Removing the campaign from secondary stores and clearing any setTimeout associated to it`),a.push(s)):u.toBeRemoved=!0)):g===He.AND&&(u.toBeRemoved=!0,1===l.events.length)&&l.events[0].toBeRemoved&&c===He.OR&&(Si.warn(1,i,`The event: ${e.name} breaks secondary conditons of the campaign: ${s}. Removing the campaign from secondary stores and clearing any setTimeout associated to it`),a.push(s)))}}a.includes(s)||n.includes(s)||(yield this.updatePendingSecondaryEvents(s,l))}}return this.sendPathTimeExpiredStat(r),yield this.clearCampaignsData(a),yield this.clearCampaignsData(n),n})}static sendPathTimeExpiredStat(e){for(let i=0;i<e.length;i++){var t=e[i];this.deliveryStats.setStats(t,jt.DELIVERY_FUNNEL.ATTEMPTED.CAMPAIGN_ATTEMPTED),this.deliveryStats.setStats(t,jt.DELIVERY_FUNNEL.EVALUATION.CAMPAIGN_EVALUATION_PATH_TIME_EXPIRED)}this.deliveryStats.sendDeliveryStats(e)}static updatePendingSecondaryEvents(e,t){return $e(this,void 0,void 0,function*(){t.events=t.events.filter(e=>!e.toBeRemoved);for(let e=0;e<t.events.length;e++){var i=t.events[e];i.filters=i.filters.filter(e=>!e.toBeRemoved)}yield Aa.setPendingSecondaryEventCampaign(e,t)})}static clearCampaignsData(e){return $e(this,void 0,void 0,function*(){for(let t=0;t<e.length;t++)yield Oa.deleteTimerAndRemoveFromStores(e[t])})}static removeStaleTriggeringPrimaryEventCampaigns(){return $e(this,void 0,void 0,function*(){let e=this.baseLogTag+".removeStaleTriggeringPrimaryEventCampaigns";var t=yield Aa.getTriggeringPrimaryEventKeys();let i=yield Aa.getPendingSecondaryEventKeys();t.forEach(t=>$e(this,void 0,void 0,function*(){i.includes(t)||(Si.warn(1,e,`Campaign: ${t} does not exist in pendingSecondaryEvents store but exists in triggeringPrimaryEvents store. Removing it from triggeringPrimaryEvents store`),yield Aa.removeTriggeringPrimaryEvent(t))}))})}}wa.baseLogTag="SecondaryEventsManager",wa.deliveryStats=null;var Je=function(e,t,i,n){return new(i=i||Promise)(function(a,r){function o(e){try{l(n.next(e))}catch(e){r(e)}}function s(e){try{l(n.throw(e))}catch(e){r(e)}}function l(e){var t;e.done?a(e.value):((t=e.value)instanceof i?t:new i(function(e){e(t)})).then(o,s)}l((n=n.apply(e,t||[])).next())})};class Da{constructor(e){this.primaryEventsHash={},this.secondaryEventsHash={},this.messagingCampaigns=[],this.scrollCampaigns=[],this.scrollCampaignTriggered=!1,this.exitIntentCampaigns=[],this.exitCampaignTriggered=!1,this.listener=null,this.historyManager=window[Kt.PageEventHistoryManager],this.onEvent=e=>Je(this,void 0,void 0,function*(){var t=Da.baseLogTag+".onEvent";try{null!=this.primaryEventsHash[e.name]&&(yield this.handlePrimaryEvent(e)),null!=this.secondaryEventsHash[e.name]&&(yield this.handleSecondaryEvent(e))}catch(e){Si.error(1,t,"Error occurred during check event trigger campaigns: ",e)}}),this.onScroll=e=>Je(this,void 0,void 0,function*(){let t=Da.baseLogTag+".onScroll";try{var i,n;this.scrollCampaigns&&0<this.scrollCampaigns.length&&!this.scrollCampaignTriggered&&(i=yield this.getCampaignsFromHash(wt.MOE_PAGE_SCROLL),null!=(n=yield Hn(i)))&&n.map(i=>Je(this,void 0,void 0,function*(){var n,a=null==(a=null==(a=null==(a=null==(a=null==(a=null==i?void 0:i.triggerData)?void 0:a.primary_condition)?void 0:a.included_filters)?void 0:a.filters[0])?void 0:a.attributes)?void 0:a.filters[0];a&&(n=new Gi(a.name,a.value),n=yield cn.createEvent(wt.MOE_PAGE_SCROLL,[n]),ua.getFilterResult(n,i))&&e>a.value&&!this.scrollCampaignTriggered&&(this.scrollCampaignTriggered=!0,window.removeEventListener("scroll",this.scrollListenerCallback),Si.log(1,t,"Triggered Scroll campaign"),this.trigger([i],n))}))}catch(i){Si.error(1,t,"Error occurred in triggering scroll campaigns ",i)}}),this.onExit=e=>Je(this,void 0,void 0,function*(){var t=Da.baseLogTag+".onExit";try{if(0<this.exitIntentCampaigns.length&&!this.exitCampaignTriggered){let n=yield cn.createEvent("MOE_EXIT",[]);var i=(yield this.getCampaignsFromHash(wt.MOE_PAGE_EXIT)).filter(e=>ua.getFilterResult(n,e));i.length?(Si.log(1,t,"Triggered Exit Intent campaign: ",i),this.trigger(i,n)):("onBackClick"===e&&window.history.back(),Si.log(1,t,"No Exit Intent campaign is eligible."))}}catch(i){Si.error(1,t,"Error occurred in triggering exit intent campaigns ",i)}}),this.messagingCampaigns=e,this.windowEventManager=new ba}onTrigger(e){this.listener=e}handlePrimaryEvent(e){return Je(this,void 0,void 0,function*(){var t=Da.baseLogTag+".handlePrimaryEvent",i=this.primaryEventsHash[e.name],n=[],a=[];for(let e=0;e<i.length;e++){var r=i[e];r=yield zn(r),Jn(r)?n.push(r):o(r,"triggerData.primary_condition.included_filters.filter_operator")===He.OR&&a.push(r)}var s=n.filter(t=>ua.didPrimaryEventFilterTrigger(e,t));s.length&&(yield wa.createPendingSecondaryEvents(s,e)),s=a.filter(t=>ua.getFilterResult(e,t)),s.length&&(Si.log(1,t,`Campaigns triggered for event ${e.name}: `+s.length),this.trigger(s,e))})}handleSecondaryEvent(e){return Je(this,void 0,void 0,function*(){var t=Da.baseLogTag+".handleSecondaryEvent",i=yield wa.updatePendingSecondaryEventsHistory(e,this.secondaryEventsHash[e.name]);let n=[];for(let e=0;e<i.length;e++)n.push(yield zn(i[e]));(n=n.filter(e=>ua.getURLFilterResult(e))).length&&(Si.log(1,t,`Campaigns triggered by secondary event "${e.name}": `+n.length),this.trigger(n))})}getCampaignsFromHash(e){return Je(this,void 0,void 0,function*(){var t=[],i=this.primaryEventsHash[e];if(null!=i&&i.length)for(let e=0;e<i.length;e++)t.push(yield zn(i[e]));return t})}addEntryInEventsHash(e,t,i){null==e[t]&&(e[t]=[]),e[t].push(i)}createPrimaryEventsHash(e){var t=o(e,"triggerData.primary_condition.included_filters.filters",[]);t&&t.forEach(t=>{this.addEntryInEventsHash(this.primaryEventsHash,t.action_name,e.campaignId)})}createSecondaryEventsHash(e){var t=o(e,"triggerData.secondary_condition.included_filters.filters",[]);null!=t&&t.forEach(t=>{"nested_filters"===t.filter_type?t.filters.filters.forEach(t=>{this.addEntryInEventsHash(this.secondaryEventsHash,t.action_name,e.campaignId)}):this.addEntryInEventsHash(this.secondaryEventsHash,t.action_name,e.campaignId)})}startWatching(){return Je(this,void 0,void 0,function*(){Da.baseLogTag,this.messagingCampaigns.forEach(e=>{this.createPrimaryEventsHash(e),this.createSecondaryEventsHash(e)}),this.historyManager&&(this.historyManager.getHistory().forEach(this.onEvent),this.historyManager.addEventListener(this.onEvent)),this.scrollCampaignTriggered=!1,this.scrollCampaigns=this.messagingCampaigns.filter(e=>Yn(e,wt.MOE_PAGE_SCROLL)),0<this.scrollCampaigns.length&&(this.scrollListenerCallback=this.windowEventManager.onScroll(this.onScroll)),this.exitCampaignTriggered=!1,this.exitIntentCampaigns=this.messagingCampaigns.filter(e=>Yn(e,wt.MOE_PAGE_EXIT)),0<this.exitIntentCampaigns.length&&this.windowEventManager.onExit(this.onExit)})}setScrollListenerCallback(e){this.scrollListenerCallback=e}getScrollListenerCallback(){return this.scrollListenerCallback}getWindowEventManager(){return this.windowEventManager}trigger(e,t){null!=this.listener&&this.listener(e,t)}destory(){this.listener=null}}Da.baseLogTag="OnsiteTriggerManager";class Na{constructor(e,t){this.waitForDelay=null,this.delayTimer=null,this.iframe=null,this.onFrameLoad=new xi,this.active=!1,this.dismissInterval=null,this.isJSONPayloadApproach=!1,this.osmDivRendering=null,this.osmDivSelector=null,this.campaignRendered=!1,this.isActive=()=>this.active,this.campaignMeta=e,this.data=t,this.active=!1,this.campaignRendered=!1;let i=o(e,"triggerData.trigger_delay.delayInSeconds",0)||0;this.waitForDelay=new Promise(e=>{this.delayTimer=setTimeout(()=>{this.campaignRendered=!0,e()},1e3*i)})}setIsActive(e){this.active=e}}let Ca={CENTER:{position:"absolute",top:"50%",left:"50%",bottom:"auto",right:"auto",transform:"translate(-50%, -50%)"},CENTER_LEFT:{position:"absolute",top:"50%",left:"10px",bottom:"auto",right:"auto",transform:"translate(0,-50%)"},CENTER_RIGHT:{position:"absolute",top:"50%",right:"10px",bottom:"auto",left:"auto",transform:"translate(0,-50%)"},TOP_LEFT:{position:"absolute",top:"10px",left:"10px",bottom:"auto",right:"auto"},TOP_CENTER:{position:"absolute",top:"0",left:"50%",bottom:"auto",right:"auto",transform:"translate(-50%, 0)"},TOP_RIGHT:{position:"absolute",top:"10px",right:"10px",bottom:"auto",left:"auto"},BOTTOM_LEFT:{position:"absolute",bottom:"10px",left:"10px",top:"auto",right:"auto"},BOTTOM_CENTER:{position:"absolute",left:"50%",bottom:"10px",top:"auto",right:"auto",transform:"translate(-50%, 0)"},BOTTOM_RIGHT:{position:"absolute",bottom:"10px",right:"10px",top:"auto",left:"auto"},TOP:{position:"absolute",top:"0",left:"50%",bottom:"auto",right:"auto",transform:"translate(-50%, 0)"},BOTTOM:{position:"absolute",bottom:"0",top:"auto",right:"auto",left:"50%",transform:"translate(-50%, 0)"},LEFT:{position:"absolute",left:"0",bottom:"auto",right:"auto",top:"auto"},RIGHT:{position:"absolute",right:"0",bottom:"auto",left:"auto",top:"auto"}},La="OsmFunctions",Pa=(e,t)=>{var i=document.createElement("script");return i.type="text/javascript",i.text=`\n    const moeSDK = window.parent.Moengage;\n    let moeOsmCampaignMeta = ${JSON.stringify(e)};\n    const moengage = {\n        trackEvent: function (eventName, eventAttr, isNonInteractive) {\n          if(moeOsmCampaignMeta) {\n            return moeSDK.track_event(eventName, eventAttr);\n          }\n          return Promise.resolve();\n        },\n        trackClick: function (id) {\n          if(moeOsmCampaignMeta) {\n            return moeSDK.onsite.displayManager.clickTracker(OsmCampaignMeta, 'OSM', {\n                widget_id: id,\n              })();\n          }\n          return Promise.resolve();\n        },\n        trackDismiss: function (isAuto = false) {\n          if(moeOsmCampaignMeta) {\n            return moeSDK.onsite.displayManager.dismissEvent(OsmCampaignMeta, 'OSM', isAuto);\n          }\n          return Promise.resolve();\n        },\n        setAlias: function (data) {\n          return moeSDK.update_unique_user_id(data);\n        },\n        setUniqueId: function (data) {\n          return moeSDK.add_unique_user_id(data);\n        },\n        identifyUser: function(data) {\n          return moeSDK.identifyUser(data);\n        },\n        destroySession: function () {\n          return moeSDK.destroy_session();\n        },\n        setUserName: function (data) {\n          return moeSDK.add_user_name(data);\n        },\n        setFirstName: function (data) {\n          return moeSDK.add_first_name(data);\n        },\n        setLastName: function (data) {\n          return moeSDK.add_last_name(data);\n        },\n        setEmailId: function (data) {\n          return moeSDK.add_email(data);\n        },\n        setMobileNumber: function (data) {\n          return moeSDK.add_mobile(data);\n        },\n        setGender: function (data) {\n          return moeSDK.add_gender(data);\n        },\n        setBirthDate: function (data) {\n            //iso date format only\n            return moeSDK.add_birthday(data);\n        },\n        setUserAttribute: function (name, value, userAttributeLevel) {\n            if (userAttributeLevel && typeof userAttributeLevel === 'string') {\n              return moeSDK.add_user_attribute(name, value, userAttributeLevel);\n            }\n            return moeSDK.add_user_attribute(name, value);\n        },\n        dismissMessage: function () {\n          setTimeout(() => {\n            moeSDK.onsite.displayManager?.dismissInapp('${t}');\n          }, 100)\n        },\n        showPushOptIn: function (config) {\n          return moeSDK.call_web_push(config);\n        },\n        copyText: function (selector) {\n          return new Promise((res, rej) => {\n            if(!selector) rej();\n            var text = document.querySelector(selector);\n            if(text.textContent) {\n              navigator.clipboard.writeText(text.textContent);\n              res(null);\n            }\n            else {\n              text.select();\n              text.setSelectionRange(0, 99999);\n              navigator.clipboard.writeText(text.value);\n              res(null);\n            }\n          })\n        }\n    }\n    const MoeOsm = moengage;\n    `,i.setAttribute("data-moe-script","1"),i},Ra=e=>{var t=La+".getCampaignMeta";try{return!Ma()&&window.Moengage.onsite.displayManager.campaignRenderMap[e].campaignMeta}catch(i){Si.error(1,t,"Campaign meta not found: "+e)}},Ma=()=>{var e=La+".isTestCampaign";return!!window.Moengage.onsite.displayManager.testCampaign&&(Si.log(1,e,"Test campaign element. No data will be sent to BE right now. We'll start tracking events once the campaign is live"),!0)},ka=()=>(Si.log(1,La,"Osm Functions for tracking user behaviour"),{trackEvent:(e,t,i,n)=>(e=Ra(e),{}.constructor===i.constructor&&e?(e=Object.assign(Object.assign({campaign_id:e.campaignId,campaign_name:e.campaignName},e.campaignContext),i),window.Moengage.track_event(t,e)):Promise.resolve()),trackClick:(e,t)=>(e=Ra(e))?window.Moengage.onsite.displayManager.clickTracker(e,"OSM",{widget_id:t})():Promise.resolve(),trackDismiss:(e,t=!1)=>(e=Ra(e))?window.Moengage.onsite.displayManager.dismissEvent(e,"OSM",t):Promise.resolve(),setAlias:e=>window.Moengage.update_unique_user_id(e),setUniqueId:e=>window.Moengage.add_unique_user_id(e),identifyUser:e=>window.Moengage.identifyUser(e),destroySession:()=>window.Moengage.destroy_session(),setUserName:e=>window.Moengage.add_user_name(e),setFirstName:e=>window.Moengage.add_first_name(e),setLastName:e=>window.Moengage.add_last_name(e),setEmailId:e=>window.Moengage.add_email(e),setMobileNumber:e=>window.Moengage.add_mobile(e),setGender:e=>window.Moengage.add_gender(e),setBirthDate:e=>window.Moengage.add_birthday(e),setUserAttribute:(e,t,i="PROJECT")=>window.Moengage.add_user_attribute(e,t,i),dismissMessage(e){setTimeout(()=>{var t;null!=(t=window.Moengage.onsite.displayManager)&&t.dismissInapp(""+e)},100)},showPushOptIn:e=>window.Moengage.call_web_push(e),copyText:e=>new Promise((t,i)=>{e||i(),(i=document.querySelector(e)).textContent?navigator.clipboard.writeText(i.textContent):(i.select(),i.setSelectionRange(0,99999),navigator.clipboard.writeText(i.value)),t(null)})});function Xe(e){return"moe-onsite-campaign-"+e}function Qe(){var e=s();if(e)return e.accessibilityFocusTrap||(e.accessibilityFocusTrap={lastActiveElement:[],dismissOsmEventHandlers:{},keyboardTrapHandler:null,focusTrapStack:[],focusedElements:[]}),e.accessibilityFocusTrap}function Ze(e){var t=Qe();t&&(t.keyboardTrapHandler=e)}function et(e){var t,i=Qe();i&&(i.dismissOsmEventHandlers[e]&&tt(e),t=function(e,t){"Escape"===t.key&&(window.MoeOsm.trackDismiss(e),window.MoeOsm.dismissMessage(e))}.bind(null,e),i.dismissOsmEventHandlers[e]=t,window.addEventListener("keyup",t),i=document.getElementById(Xe(e)))&&"IFRAME"===i.tagName&&i.contentWindow&&i.contentWindow.addEventListener("keyup",t)}function tt(e){var t,i,n=Qe();n&&(t=n.dismissOsmEventHandlers[e])&&(window.removeEventListener("keyup",t),(i=document.getElementById(Xe(e)))&&"IFRAME"===i.tagName&&i.contentWindow&&i.contentWindow.removeEventListener("keyup",t),delete n.dismissOsmEventHandlers[e])}function it(){var e,t=Qe();t&&((null==(t=t.lastActiveElement.pop())?void 0:t.id)===hi.FLOATING_ICON_IFRAME?null!=(e=null==(e=t.contentDocument)?void 0:e.getElementById(hi.FLOATING_ICON_ID))&&e.focus({preventScroll:!0}):(t&&"function"==typeof t.focus?t:document.body).focus({preventScroll:!0}))}function nt(e,t,i=!1){var n=document.getElementById(Xe(e));if(n){if(et(e),e=n){var a=e.querySelector(".brz-popup2__preview");let t=mi,i="dialog";a&&(a.hasAttribute("aria-label")&&(t=a.getAttribute("aria-label"),a.removeAttribute("aria-label")),a.hasAttribute("role"))&&(i=a.getAttribute("role")),e.setAttribute("tabindex","0"),e.setAttribute("aria-label",t),e.setAttribute("role",i),e.setAttribute("aria-modal","true")}if("POP_UP"===t){var[r,o=document,a=!1]=[n,document,i];if((e=Qe())&&(t=rt(r)||r)){(e=>{var t,i=Qe();i&&e&&e.parentElement&&(-1!==(t=i.focusTrapStack.indexOf(e))&&i.focusTrapStack.splice(t,1),i.focusTrapStack.push(e),st())})(r);var s=t.querySelectorAll('a[href], button:not([disabled]), input:not([disabled]), select:not([disabled]), textarea:not([disabled]), [tabindex]:not([tabindex="-1"])');if(0===(null==s?void 0:s.length))t.hasAttribute("tabindex")&&"-1"!==t.getAttribute("tabindex")&&t.focus({preventScroll:!0});else{let i=s[0],n=s[s.length-1],l=(at(t,!0,a),null);s=e=>{if("Tab"===e.key){let a=!1,s=o.activeElement;var t;"IFRAME"===r.tagName?(t=r.contentDocument)&&t.activeElement&&(s=t.activeElement,a=s===t.body||t.body.contains(s)):a=s===r||r.contains(s),a?(s&&"moe-focus-trap-end"!==s.id&&(l=s),s&&"moe-focus-trap-end"===s.id?(e.preventDefault(),(e.shiftKey?l||n:i).focus({preventScroll:!0})):e.shiftKey&&s===i?(e.preventDefault(),n.focus({preventScroll:!0})):e.shiftKey||s!==n||(e.preventDefault(),i.focus({preventScroll:!0}))):(e.preventDefault(),r.focus({preventScroll:!0}))}},e.keyboardTrapHandler&&o.removeEventListener("keydown",e.keyboardTrapHandler),Ze(e.keyboardTrapHandler=s),o.addEventListener("keydown",e.keyboardTrapHandler)}}}else at(n,!1,i)}}function at(e,t=!1,i=!0){if(e){var n,a=Qe();if(a){if(i){i=e;var r=Qe();let t=parseInt(window.getComputedStyle(i).zIndex,10)||0;r.focusedElements=r.focusedElements.filter(e=>document.body.contains(e)),r.focusedElements.forEach(e=>{var i=parseInt(window.getComputedStyle(e).zIndex,10)||0;i>=t&&(e.style.zIndex=(i-1).toString())}),r.focusedElements.push(i)}0<a.focusTrapStack.length&&!t?a.lastActiveElement.push(e):(r=e.id===hi.FLOATING_ICON_IFRAME,i=rt(e)||e,!(n=a.focusTrapStack)||0===n.length||t?(document.activeElement&&document.activeElement instanceof HTMLElement&&a.lastActiveElement.push(document.activeElement),r?(t=null==(n=e.contentDocument)?void 0:n.getElementById(hi.FLOATING_ICON_ID))&&t.focus({preventScroll:!0}):i&&(i.setAttribute("tabindex","0"),i.focus({preventScroll:!0}))):i&&a.lastActiveElement.push(e))}}}function rt(e){if(e){let i=e;var t;return"IFRAME"===e.tagName&&(i=null!=(t=e.contentDocument)&&t.body?t.body:null!=t&&t.activeElement?t.activeElement:e),i}}function ot(e,t=document){var i,n=Qe();if(n&&((i=Qe())&&(e?-1!==(e=i.focusTrapStack.indexOf(e))&&i.focusTrapStack.splice(e,1):i.focusTrapStack.length=0,st()),n.keyboardTrapHandler&&(t.removeEventListener("keydown",n.keyboardTrapHandler),Ze(n.keyboardTrapHandler=null)),0<n.focusTrapStack.length)){let e=n.focusTrapStack[n.focusTrapStack.length-1];e&&"function"==typeof e.focus&&setTimeout(()=>{e.focus({preventScroll:!0})})}}function st(){var e=Qe();if(e){document.querySelectorAll("[data-moe-prev-aria-hidden]").forEach(e=>{var t;e instanceof HTMLElement&&("false"===(t=e.getAttribute("data-moe-prev-aria-hidden"))?e.removeAttribute("aria-hidden"):"true"===t?e.setAttribute("aria-hidden","true"):"null"===t&&e.removeAttribute("aria-hidden"),e.removeAttribute("data-moe-prev-aria-hidden"))}),document.querySelectorAll("[data-moe-prev-tabindex]").forEach(e=>{var t;e instanceof HTMLElement&&(""===(t=e.getAttribute("data-moe-prev-tabindex"))?e.removeAttribute("tabindex"):e.setAttribute("tabindex",t),e.removeAttribute("data-moe-prev-tabindex"))});let r=e.focusTrapStack[e.focusTrapStack.length-1];if((t=document.querySelectorAll('[role="dialog"][aria-modal="true"]')).forEach(e=>{e instanceof HTMLElement&&e!==r&&(e.removeAttribute("role"),e.removeAttribute("aria-modal"))}),0!==e.focusTrapStack.length){var t,i=[],n=["a[href]","button","input","select","textarea","[tabindex]",'[contenteditable="true"]'].join(",");if(t=r.parentElement){for(var a of Array.from(t.children))a!==r&&a instanceof HTMLElement&&(a.hasAttribute("data-moe-prev-aria-hidden")||(a.hasAttribute("aria-hidden")?a.setAttribute("data-moe-prev-aria-hidden",a.getAttribute("aria-hidden")):a.setAttribute("data-moe-prev-aria-hidden","null")),a.setAttribute("aria-hidden","true"),i.push(a),a.querySelectorAll(n).forEach(e=>{e.hasAttribute("data-moe-prev-tabindex")||(e.hasAttribute("tabindex")?e.setAttribute("data-moe-prev-tabindex",e.getAttribute("tabindex")):e.setAttribute("data-moe-prev-tabindex","")),e.setAttribute("tabindex","-1")}));r._ariaHiddenSiblings=i}}}}var lt=function(e,t,i,n){return new(i=i||Promise)(function(a,r){function o(e){try{l(n.next(e))}catch(e){r(e)}}function s(e){try{l(n.throw(e))}catch(e){r(e)}}function l(e){var t;e.done?a(e.value):((t=e.value)instanceof i?t:new i(function(e){e(t)})).then(o,s)}l((n=n.apply(e,t||[])).next())})};function dt(e,t,i,n,a){return lt(this,void 0,void 0,function*(){let r=Xn(t),o=/moe-campaign-id/g;yield lt(this,void 0,void 0,function*(){try{let h=e.root;var{styles:s,scripts:l}=e,d=document.createElement("div"),c=(d.id=r,i.parentNode.insertBefore(d,i),document.querySelector("#"+r));let E=new DOMParser;h=h.replace(o,t);var u=E.parseFromString(h,"text/html"),g=(yield function(e){return lt(this,void 0,void 0,function*(){try{var t=e.getElementsByTagName("a");for(let e=t.length-1;0<=e;e--)""===t[e].getAttribute("href")&&t[e].removeAttribute("href")}catch(e){Si.error(2,"InsertCustomHtmlJs.removeEmptyHrefTags","Error while removing Empty href attributes",e)}})}(u),function(e){try{["trackEvent","trackClick","trackDismiss","dismissMessage","leadGenFormSubmit","fetchRatingValue"].forEach(i=>{var n=i;e.querySelectorAll("[onclick]").forEach(e=>{var i=e.getAttribute("onclick").replace(new RegExp(n+"\\((.*?)\\)","g"),(e,i)=>i?n+`('${t}',${i})`:n+`('${t}')`);e.setAttribute("onclick",i)})})}catch(e){Si.error(2,"InsertCustomHtmlJs.addCampaignId","Error while adding Campaign Id",e)}}(u),s.map(e=>E.parseFromString(e,"text/html").head.childNodes[0])),p=l.map(e=>(e=e.replace(o,t),E.parseFromString(e,"text/html").head.childNodes[0])),m=g.map(e=>new Promise((t,i)=>{{let{node:n,onLoad:a,onError:o}=t={node:e,onLoad:t,onError:i};n instanceof HTMLMetaElement||"dns-prefetch"===n.getAttribute("rel")?a():(n.onload=()=>a(),n.onerror=()=>o()),document.querySelector("#"+r).appendChild(n)}}));yield Promise.all(m).catch(e=>{Si.warn(1,"InsertCustomHtmlJs","Error loading Styles",(null==e?void 0:e.message)||"")});let v=u.body.childNodes[0];c.appendChild(v),[...v.querySelectorAll(".brz-embed-code script")].map(e=>{var t=e,i=document.createElement("script");i.innerHTML=t.innerHTML;for(let e=0;e<t.attributes.length;e++){var{name:n,value:a}=t.attributes[e];i.setAttribute(n,a)}t.replaceWith(i)}),function(e){return lt(this,void 0,void 0,function*(){for(var i of e)yield(e=>new Promise((i,n)=>{var a=document.createElement("script");for(let i=0;i<e.attributes.length;i++){var o=e.attributes[i].name;let n=e.attributes[i].value;"src"===o&&(n.includes("typeform")||n.includes("tv-button"))&&(n=n+"?campaignId="+t),a.setAttribute(o,n)}a.src?(a.onload=i,a.onerror=n):(a.innerHTML=e.innerHTML,i()),document.querySelector("#"+r).appendChild(a)}))(i)})}(p).then(()=>{var e,i;window.Brz.emit("init.dom",window.jQuery(v)),Si.log(1,"InsertCustomHtmlJs","Custom HTML/JS DOM Level OSM Insertion: "+r),e=t,i=n.templateType,e&&(et(e),window.Brz.on("elements.popup.open",nt.bind(null,e,i))),a&&a(n,"OSM")()}).catch(e=>{Si.warn(1,"InsertCustomHtmlJs","Error loading script",(null==e?void 0:e.message)||"")})}catch(e){Si.error(2,"InsertCustomHtmlJs","Failed to Insert OSM into DOM: "+r)}})})}var ct=function(e,t,i,n){return new(i=i||Promise)(function(a,r){function o(e){try{l(n.next(e))}catch(e){r(e)}}function s(e){try{l(n.throw(e))}catch(e){r(e)}}function l(e){var t;e.done?a(e.value):((t=e.value)instanceof i?t:new i(function(e){e(t)})).then(o,s)}l((n=n.apply(e,t||[])).next())})};class xa{constructor(){this.renderListener=null,this.initializationPromiseObject=null,this.campaignRenderOrder=[],this.campaignRenderMap={},this.dismissTestInapp=e=>{ot(),tt(e),it(),this.initialInlineBodyStyle?document.body.setAttribute("style",this.initialInlineBodyStyle):document.body.removeAttribute("style"),this.removeOSMPusher(),this.pushCardsTemplate(0),setTimeout(()=>{var t;return null==(t=document.getElementById("moe-onsite-campaign-"+e))?void 0:t.remove()},0)},this.dismissInapp=(e,t=!0)=>{if(ot(document.getElementById(Xn(e))),it(),tt(e),0===this.getActiveCampaigns().length)this.dismissTestInapp(e);else{let i=this.getActiveCampaigns();setTimeout(()=>{i.forEach(t=>{var i;t.campaignMeta.campaignId===e&&(t.iframe?null!=(i=t.iframe)&&i.remove():null!=(i=t.osmDivSelector)&&i.remove())})},0),this.campaignRenderMap[e].setIsActive(!1),this.campaignRenderOrder=this.campaignRenderOrder.filter(t=>t!==e),clearInterval(this.campaignRenderMap[e].dismissInterval),this.campaignRenderMap[e].delayTimer=null,t&&qi.broadcastToWindow({topic:"OSM_INTERNAL_EVENT",name:"DISMISS",data:e}),this.renderAllActiveCampaigns()}},this.clickTracker=Mn,this.dismissEvent=Bn,this.startInitialization()}startInitialization(){return ct(this,void 0,void 0,function*(){var e=xa.baseLogTag+".startInitialization";try{null==this.initializationPromiseObject&&(this.initializationPromiseObject=new xi),this.initializationPromiseObject.res()}catch(t){Si.error(1,e,"Error initializing display managaer:",t)}})}getOSMPusher(e){var t=document.createElement("div");return t.id=jt.PUSH_BANNER,t.style.setProperty("display","block","important"),t.style.height=e+"px","FRAMESET"===document.body.nodeName?(e=document.head).parentNode.insertBefore(t,e):(e=document.body.firstChild).parentNode.insertBefore(t,e),t}removeOSMPusher(){var e;null!=(e=document.getElementById(jt.PUSH_BANNER))&&e.remove()}queueDraftCampaign(e,t){return ct(this,void 0,void 0,function*(){var i=xa.baseLogTag+".queueDraftCampaign";try{yield this.initializationPromiseObject.p,e.position=t.position,this.testCampaign=e;var n=!("1"!==t.editorVersion||!t.htmlJsonPayload);let a,r=!n&&xa.createDefaultIframe(this.testCampaign.draftId,t.payload);Si.warn(1,i,"Going to render test campaign "+e.draftId),a="FRAMESET"===document.body.nodeName?this.getOSMPusher(0):document.body.firstChild,n?(yield dt(t.htmlJsonPayload,this.testCampaign.draftId,a,{templateType:e.templateType}),this.renderTestCampaign(e,r,t)):(a.parentNode.insertBefore(r,a),r.onload=()=>{r.contentWindow.postMessage({campaignId:e.draftId},"*"),"1"===t.editorVersion?this.handleBridgeInsertion(r.contentDocument,e.draftId):this.handleClassBasedTrackingForTestCampaign(r,t,e),this.renderTestCampaign(e,r),nt(e.draftId,e.templateType)})}catch(e){Si.error(1,i,"Error queueing draft campaign",e)}})}renderTestCampaign(e,t,i){return ct(this,void 0,void 0,function*(){var n;t?(t.style.visibility="hidden",t.style.display="block",t.style.zIndex="2147483647",e.displaySettings.config.blocking?(t.style.height=window.innerHeight+"px",t.style.width="100%"):(t.style.height=getComputedStyle(t.contentDocument.body).height,t.style.width=getComputedStyle(t.contentDocument.body).width,e.templateType===Ve.POP_UP&&(t.style.margin="0px auto"),-1<t.srcdoc.indexOf(jt.POSITIONED_TEMPLATE)&&(n=-1<t.srcdoc.indexOf(jt.SIDE_BANNER),this.adjustPositionOfCampaign(t.style,e.position,n))),t.style.visibility="visible",this.testCampaignPositionStyling(e,t),e.displaySettings.config.scrollable||(document.body.style.overflow="hidden")):((n=document.getElementById(Xn(e.draftId))).style.zIndex="2147483647",this.testCampaignPositionStyling(e,n)),e.templateType===Ve.BANNER&&this.bannerTestCampaignStyling(e,t,i)})}queueLiveCampaign(e,t){return ct(this,void 0,void 0,function*(){var i,n=xa.baseLogTag+".queueLiveCampaign";e.campaignContext=t.campaignContext,e.editorVersion=t.editorVersion;try{yield this.initializationPromiseObject.p,null==this.campaignRenderMap[e.campaignId]||!this.campaignRenderMap[e.campaignId].isActive()&&null===this.campaignRenderMap[e.campaignId].delayTimer?(this.campaignRenderOrder.push(e.campaignId),this.campaignRenderMap[e.campaignId]=new Na(e,t),this.campaignRenderMap[e.campaignId].isJSONPayloadApproach=!("1"!==t.editorVersion||!t.htmlJsonPayload),this.campaignRenderMap[e.campaignId].isJSONPayloadApproach?this.campaignRenderMap[e.campaignId].osmDivRendering=i=>dt(t.htmlJsonPayload,e.campaignId,i,e,kn):(i=xa.createDefaultIframe(e.campaignId,this.campaignRenderMap[e.campaignId].data.payload),this.campaignRenderMap[e.campaignId].iframe=i),yield this.campaignRenderMap[e.campaignId].waitForDelay,(yield this.canCampaignBeRendered(e))?(Si.warn(1,n,"Going to render "+e.campaignId),this.campaignRenderMap[e.campaignId].setIsActive(!0),null!=this.renderListener&&this.renderListener(e),this.renderAllActiveCampaigns()):Si.warn(1,n,"Can not render "+e.campaignId)):Si.warn(1,n,`Can not render ${e.campaignId}, as campaign is already Active.`)}catch(i){Si.error(1,n,"Error queuing campaign "+e.campaignId,i)}})}renderAllActiveCampaigns(){return ct(this,void 0,void 0,function*(){var e,t=xa.baseLogTag+".renderAllActiveCampaigns";let i=this.getActiveCampaigns();if(this.restoreBodyStyle(),0<i.length){for(let n=0;n<i.length;n++)if(i[n].isJSONPayloadApproach||"visible"!==i[n].iframe.style.visibility){if(null==document.getElementById(Xn(i[n].campaignMeta.campaignId))){let e;e="FRAMESET"===document.body.nodeName?this.getOSMPusher(0):document.body.firstChild,i[n].isJSONPayloadApproach?(yield i[n].osmDivRendering(e),i[n].onFrameLoad.res(),i[n].osmDivSelector=document.getElementById(Xn(i[n].campaignMeta.campaignId))):(e.parentNode.insertBefore(i[n].iframe,e),i[n].iframe.onload=()=>{this.initialInlineBodyStyle=document.body.getAttribute("style"),Ba.setScrollState(i),i[n].iframe.contentWindow.postMessage({campaignId:i[n].campaignMeta.campaignId},"*"),"1"===i[n].campaignMeta.editorVersion?(this.handleBridgeInsertion(i[n].iframe.contentDocument,i[n].campaignMeta.campaignId,i[n].campaignMeta),this.changeAnchorTagReDirectionMethod(i[n].iframe)):this.handleClassBasedTracking(i[n]),i[n].onFrameLoad.res()})}yield i[n].onFrameLoad.p,i[n].isJSONPayloadApproach?(Si.log(1,t,"zindex for "+i[n].campaignMeta.campaignId,2147483647..toString()),i[n].osmDivSelector.style.zIndex=(2147483647-(i.length-n-1)).toString(),this.liveCampaignPositionStyling(i[n].campaignMeta,i[n].osmDivSelector)):(i[n].iframe.style.visibility="hidden",i[n].iframe.style.display="block",Si.log(1,t,"zindex for "+i[n].campaignMeta.campaignId,2147483647..toString()),i[n].iframe.style.zIndex=(2147483647-(i.length-n-1)).toString(),i[n].iframe.style.margin="0",i[n].campaignMeta.display.config.blocking?(i[n].iframe.style.height=window.innerHeight+"px",i[n].iframe.style.width="100%"):(i[n].iframe.style.height=getComputedStyle(i[n].iframe.contentDocument.body).height,i[n].iframe.style.padding.includes("10px")?i[n].iframe.style.width=parseInt(getComputedStyle(i[n].iframe.contentDocument.body).width)+20+"px":i[n].iframe.style.width=getComputedStyle(i[n].iframe.contentDocument.body).width,i[n].campaignMeta.templateType===Ve.POP_UP&&(i[n].iframe.style.margin="0px auto"),i[n].data.payload&&-1<i[n].data.payload.indexOf(jt.POSITIONED_TEMPLATE)&&(e=-1<i[n].data.payload.indexOf(jt.SIDE_BANNER),this.adjustPositionOfCampaign(i[n].iframe.style,i[n].data.position,e))),i[n].iframe.style.visibility="visible",this.liveCampaignPositionStyling(i[n].campaignMeta,i[n].iframe),kn(i[n].campaignMeta,"OSM")(),nt(i[n].campaignMeta.campaignId,i[n].campaignMeta.templateType)),null==i[n].dismissInterval&&0<(e=1e3*o(i[n].campaignMeta,"delivery.dismiss_interval",0))&&(i[n].dismissInterval=setTimeout(()=>{var e=this.campaignRenderMap[i[n].campaignMeta.campaignId];e&&e.isActive()&&(this.dismissInapp(i[n].campaignMeta.campaignId),window.MoeFocusHandler&&window.MoeFocusHandler(),Bn(i[n].campaignMeta,"OSM",!0))},e))}else i[n].iframe.style.zIndex=(2147483647-(i.length-n-1)).toString();this.bannerLiveCampaignsStyling(i)}})}restoreBodyStyle(){this.removeOSMPusher(),this.pushCardsTemplate(0);let e=0;Object.keys(this.campaignRenderMap).forEach(t=>{this.campaignRenderMap[t].campaignMeta.templateType===Ve.POP_UP&&this.campaignRenderMap[t].isActive()&&e++}),1<=e||(this.initialInlineBodyStyle?document.body.setAttribute("style",this.initialInlineBodyStyle):document.body.removeAttribute("style"))}canCampaignBeRendered(e){return ct(this,void 0,void 0,function*(){var t=xa.baseLogTag+".canCampaignBeRendered";try{var i=yield Rn.campaingsStatsStore.getItem(e.campaignId),n=yield Rn.serviceMetaStore.getItem(jt.STORES.SERVICE_META.KEYS.GLOBAL_DELAY),a=yield Rn.serviceMetaStore.getItem(jt.STORES.SERVICE_META.KEYS.LAST_INAPP_SHOWN_TIME);return Wn.isValid(e,i)&&Wn.isValidMessagingCampaign(e,i,n,a,this.getActiveCampaigns())&&ua.getURLFilterResult(e)}catch(i){Si.error(1,t,`Error checking if campaign ${e.campaignId} can be rendered:`,i)}return!1})}static createDefaultIframe(e,t){e=Xn(e);var i=document.createElement("iframe");return i.setAttribute("id",e),i.style.left="0px",i.style.top="0px",i.style.bottom="0px",i.style.right="0px",i.style.border="0px none",i.style.height="100%",i.style.width=window.innerWidth.toString()+"px",i.style.padding="0",i.style.overflow="hidden",i.style.overflowY="hidden",i.style.zIndex="999999",i.style.display="none",i.style.position="fixed",i.setAttribute("srcdoc",t),i}onRender(e){this.renderListener=e}getActiveCampaigns(){return this.campaignRenderOrder.map(e=>this.campaignRenderMap[e]).filter(e=>e.isActive())}destroy(){this.getActiveCampaigns().forEach(e=>{e.setIsActive(!1)}),this.renderAllActiveCampaigns(),this.campaignRenderOrder=[],this.campaignRenderMap={}}adjustPositionOfCampaign(e,t,i){t&&(Object.assign(e,Ca[t]),se())&&i&&this.addMarginInMweb(e,t)}addMarginInMweb(e,t){var i={paddingLeft:"10px",paddingRight:"10px",marginTop:"0",marginBottom:"0"};"TOP"===t&&(i.marginTop="10px"),"BOTTOM"===t&&(i.marginBottom="10px"),Object.assign(e,i)}handleBridgeInsertion(e,t,i){var n=xa.baseLogTag+".handleBridgeInsertion";try{e.head.append(Pa(i,t)),Si.log(2,n,"JS-bridge script inserted successfully",t)}catch(e){Si.warn(2,n,"Failed to insert OSM JS Bridge: ",t)}}handleClassBasedTrackingForTestCampaign(e,t,i){let n=xa.baseLogTag+".handleClassBasedTrackingForTestCampaign";var a,r=e=>Array.prototype.slice.call(e),o=r(e.contentDocument.getElementsByClassName(jt.CSS_SELECTORS.DISMISS_INAPP)),s=r(e.contentDocument.getElementsByClassName(jt.CSS_SELECTORS.CLICK_INAPP));if(r=r(e.contentDocument.getElementsByTagName("a")),0===o.length&&Si.warn(1,n,"No dismiss class items present in this template"),0===s.length&&Si.warn(1,n,"No click class items present in this template"),-1<t.payload.indexOf("TEXT_INPUT")||-1<t.payload.indexOf('dynamic-listeners="true"'))e.contentDocument.body.addEventListener("click",e=>{e.target&&e.target.classList.contains(jt.CSS_SELECTORS.CLICK_INAPP)&&Si.log(1,n,"Clicked on test campaign element. No data will be sent to BE right now. We'll start sending the click events once the campaign is live"),e.target&&e.target.classList.contains(jt.CSS_SELECTORS.DISMISS_INAPP)&&this.dismissTestInapp(i.draftId)});else{for(var l of s)l.addEventListener("click",e=>{Si.log(1,n,"Clicked on test campaign element. No data will be sent to BE right now. We'll start sending the click events once the campaign is live")});for(var d of o)d.addEventListener("click",()=>{this.dismissTestInapp(i.draftId)})}for(a of r)"_blank"!==a.getAttribute("target")&&a.setAttribute("target","_parent")}handleClassBasedTracking(e){var t,i=xa.baseLogTag+".handleClassBasedTracking",n=e=>Array.prototype.slice.call(e),a=e.iframe,r=n(a.contentDocument.getElementsByClassName(jt.CSS_SELECTORS.DISMISS_INAPP)),o=n(a.contentDocument.getElementsByClassName(jt.CSS_SELECTORS.CLICK_INAPP));if(n=n(a.contentDocument.getElementsByTagName("a")),0===r.length&&Si.warn(1,i,"No dismiss class items present in this template"),0===o.length&&Si.warn(1,i,"No click class items present in this template"),e.data.payload&&(-1<e.data.payload.indexOf("TEXT_INPUT")||-1<e.data.payload.indexOf('dynamic-listeners="true"')))a.contentDocument.body.addEventListener("click",t=>{var i;t.target&&t.target.classList.contains(jt.CSS_SELECTORS.CLICK_INAPP)&&(i=t.target.dataset.id,Mn(e.campaignMeta,"OSM",{widget_id:i})()),t.target&&t.target.classList.contains(jt.CSS_SELECTORS.DISMISS_INAPP)&&(this.dismissInapp(e.campaignMeta.campaignId),t.target.classList.contains(jt.CSS_SELECTORS.CLICK_INAPP)||Bn(e.campaignMeta,"OSM"))});else{for(var s of o)s.addEventListener("click",t=>{t=t.target.dataset.id,Mn(e.campaignMeta,"OSM",{widget_id:t})()});for(let t of r)t.addEventListener("click",()=>{this.dismissInapp(e.campaignMeta.campaignId),t.classList.contains(jt.CSS_SELECTORS.CLICK_INAPP)||Bn(e.campaignMeta,"OSM")})}for(t of n)"_blank"!==t.getAttribute("target")&&t.setAttribute("target","_parent")}changeAnchorTagReDirectionMethod(e){var t,i=xa.baseLogTag+".changeAnchorTagReDirectionMethod";try{var n;for(n of(t=e.contentDocument.getElementsByTagName("a"),Array.prototype.slice.call(t))){var a=n.getAttribute("target"),r=n.getAttribute("href");r&&"_parent"===a&&(n.setAttribute("onclick",`setTimeout(()=>{window.open('${r}','_parent')})`),n.removeAttribute("href"))}Si.log(1,i,"Anchor Tag Href Rendering Changed to onClick for Campaign Frame: "+e.id)}catch(t){Si.error(1,i,"Failed to Change Anchor Tag Href Rendering for Campaign Frame: "+e.id)}}liveCampaignPositionStyling(e,t){var i=xa.baseLogTag+".liveCampaignPositionStyling";try{e.templateType===Ve.BANNER?e.display.config.sticky?t.style.position="fixed":t.style.position="absolute":e.templateType===Ve.POP_UP&&(t.style.position="fixed","DIV"===t.tagName?t.style.inset="0":t.style.backgroundColor="rgba(99, 99, 99, 0.21)"),Si.log(1,i,"Added Position Styles for CampaignId: "+e.campaignId)}catch(t){Si.error(1,i,"Failed adding Styles for CampaignId: "+e.campaignId)}}testCampaignPositionStyling(e,t){var i=xa.baseLogTag+".testCampaignPositionStyling";try{e.templateType===Ve.BANNER?e.displaySettings.config.sticky?t.style.position="fixed":t.style.position="absolute":e.templateType===Ve.POP_UP&&(t.style.position="fixed","DIV"===t.tagName?t.style.inset="0":t.style.backgroundColor="rgba(99, 99, 99, 0.21)"),Si.log(1,i,"Added Position Styles for CampaignId: "+e.draftId)}catch(t){Si.error(1,i,"Failed adding Styles for CampaignId: "+e.draftId)}}bannerTestCampaignStyling(e,t,i){var n,a=xa.baseLogTag+".bannerTestCampaignStyling";try{let i,r,o=!0;t?(i=parseInt(getComputedStyle(t.contentDocument.body).height),o=-1<t.srcdoc.indexOf(jt.POSITIONED_TEMPLATE)):(n=document.querySelector("#"+Xn(e.draftId)+" .brz-container"),i=parseInt(getComputedStyle(n).height)),r=e.displaySettings.config.pushPage&&(o&&"TOP"===e.position||!o)?this.getOSMPusher(i):this.getOSMPusher(0),this.pushCardsTemplate(i,r),Si.log(1,a,"Added Banner Styles for Test CampaignId: "+e.draftId)}catch(i){Si.error(1,a,"Failed Added Banner Styles for Test CampaignId: "+e.draftId)}}bannerLiveCampaignsStyling(e){var t=xa.baseLogTag+".bannerLiveCampaignsStyling";let i=0,n=0;for(let r=e.filter(e=>e.campaignMeta.templateType===Ve.BANNER).length-1;0<=r;r--)try{if(e[r].isJSONPayloadApproach||e[r].iframe.contentDocument){let a,o=!0;e[r].isJSONPayloadApproach?a=parseInt(getComputedStyle(e[r].osmDivSelector.querySelector(".brz-container")).height):(a=parseInt(getComputedStyle(e[r].iframe.contentDocument.body).height),o=e[r].data.payload&&-1<e[r].data.payload.indexOf(jt.POSITIONED_TEMPLATE)),i+=a,e[r].campaignMeta.display.config.pushPage&&(o&&"TOP"===e[r].data.position||!o)&&(n+=a),Si.log(1,t,"Added Banner Styles for Live CampaignId: "+e[r].campaignMeta.campaignId)}}catch(a){Si.error(1,t,"Failed Adding Banner Styles for Live CampaignId: "+e[r].campaignMeta.campaignId)}var a=this.getOSMPusher(n);this.pushCardsTemplate(n,a)}pushCardsTemplate(e,t){var i;null!=(i=null==(i=null==window?void 0:window.Moengage)?void 0:i.cards)&&i.updatePushBannerHeight(e,t)}}xa.baseLogTag="MessagingDisplayManager";class Ba{static setScrollState(e){let t=!0;for(let i=0;i<e.length;i++)t=t&&e[i].campaignMeta.display.config.scrollable;t||(document.body.style.overflow="hidden")}}class Ua{constructor(e){this.campaignId=e.campaignId,this.campaignName=e.campaignName,this.expiryTime=e.expiryTime?new Date(e.expiryTime):null,this.updatedTime=e.updatedTime?new Date(e.updatedTime):null,this.status=e.status,this.jsonPayload=e.htmlJsonPayload,this.context=e.campaignContext,this.dismissInterval=e.delivery.dismiss_interval||0,this.urlFilters=e.triggerData.url_condition}}var ut=function(e,t,i,n){return new(i=i||Promise)(function(a,r){function o(e){try{l(n.next(e))}catch(e){r(e)}}function s(e){try{l(n.throw(e))}catch(e){r(e)}}function l(e){var t;e.done?a(e.value):((t=e.value)instanceof i?t:new i(function(e){e(t)})).then(o,s)}l((n=n.apply(e,t||[])).next())})};class Fa{constructor(e,t,i){this.baseLogTag="DeliveryFunnelManager",this.displayManager=t,this.OnsiteApiClient=new ya(e),this.deliveryStats=i}attemptCampaigns(e){e.forEach(e=>{this.deliveryStats.setStats(e,jt.DELIVERY_FUNNEL.ATTEMPTED.CAMPAIGN_ATTEMPTED)})}getImpressionStats(e){return ut(this,void 0,void 0,function*(){var t=this.baseLogTag+".getImpressionStats";try{return yield Rn.campaingsStatsStore.getItem(e.campaignId)}catch(i){Si.error(1,t,"Error getting impression stats for "+e.campaignId,i)}})}getLastGlobalInappShown(){return ut(this,void 0,void 0,function*(){return yield Rn.serviceMetaStore.getItem(jt.STORES.SERVICE_META.KEYS.LAST_INAPP_SHOWN_TIME)})}getGlobalDelay(){return ut(this,void 0,void 0,function*(){return yield Rn.serviceMetaStore.getItem(jt.STORES.SERVICE_META.KEYS.GLOBAL_DELAY)})}filterValidCampaigns(e){return ut(this,void 0,void 0,function*(){var t=this.baseLogTag+".filterValidCampaigns";try{var i=e.map(e=>this.getImpressionStats(e));let n=yield this.getLastGlobalInappShown(),a=yield this.getGlobalDelay();try{let t=yield Promise.all(i);return e.filter((e,i)=>{if(e.templateType!==Ve.SELF_HANDLED){if(!Wn.isCampaignWithinFC(e,t[i]))return this.deliveryStats.setStats(e,jt.DELIVERY_FUNNEL.PRIORITIZED.CAMPAIGN_PRIORITY_MAX_TIMES_SHOWN),!1;if(!Wn.hasCampaignClearedSelfDelay(e,t[i]))return this.deliveryStats.setStats(e,jt.DELIVERY_FUNNEL.PRIORITIZED.CAMPAIGN_PRIORITY_MIN_DELAY),!1;if(!Wn.hasCampaignClearedGlobalDelay(e,a,n))return this.deliveryStats.setStats(e,jt.DELIVERY_FUNNEL.PRIORITIZED.CAMPAIGN_PRIORITY_GLOBAL_DELAY),!1}return!Wn.isCampaignExpired(e)||(this.deliveryStats.setStats(e,jt.DELIVERY_FUNNEL.PRIORITIZED.CAMPAIGN_PRIORITY_EXPIRED),!1)})}catch(i){Si.error(1,t,"Error filtering and sorting campaigns",i)}}catch(i){Si.error(1,t,"Error in filterValidCampaigns",i)}})}prioritizeMessagingCampaigns(e,t=1){return ut(this,void 0,void 0,function*(){if(e&&0!==e.length&&(n=yield this.filterValidCampaigns(e))&&0!==n.length){var i=(n=n.sort(Wn.comparator)).slice(0,t),n=n.slice(t);let e=(new Date).toISOString(),a=i.map(e=>null==(e=null==e?void 0:e.campaignContext)?void 0:e.cid);return n.forEach(t=>{this.deliveryStats.setStats(t,jt.DELIVERY_FUNNEL.PRIORITIZED.CAMPAIGN_PRIORITY_HIGH_PRIORITY_CAMPAIGN_AVAILABLE,[{cids:a,t:e}])}),i}})}getCampaignTagMap(e){let t={},i=[],n={cids:[],t:(new Date).toISOString()};var a,r=new Set;for(a of e)a.tag&&(r.add(a.tag),t[a.tag]=t[a.tag]||[],t[a.tag].push(a));return r.forEach(e=>{var a;0<(e=t[e].sort(Wn.comparator)).length&&(a=e[0],i.push(a),n.cids.push(a.campaignContext.cid),1<e.length)&&e.slice(1).forEach(e=>{this.deliveryStats.setStats(e,jt.DELIVERY_FUNNEL.PRIORITIZED.CAMPAIGN_PRIORITY_HIGH_PRIORITY_CAMPAIGN_AVAILABLE,[n])})}),i}prioritizePersonalizationCampaigns(e){return ut(this,void 0,void 0,function*(){var t=yield this.filterValidCampaigns(e);return 0<t.length?this.getCampaignTagMap(t):[]})}getOnsitePayload(e,t){return ut(this,void 0,void 0,function*(){var i=this.baseLogTag+".getOnsitePayload";try{var n,a=yield this.OnsiteApiClient.getCampaignPayload(e,t);if(a&&!a.error)return a;a&&a.error?(n=a.reason,this.setDeliveryFailureStats(e,n)):this.deliveryStats.setStats(e,jt.DELIVERY_FUNNEL.DELIVERED.CAMPAIGN_DELIVERED_API_FAILURE)}catch(n){Si.error(1,i,"Error getting onsite payload",n),this.deliveryStats.setStats(e,jt.DELIVERY_FUNNEL.DELIVERED.CAMPAIGN_DELIVERED_API_FAILURE)}})}setDeliveryFailureStats(e,t){t&&["PAUSED","EXPIRED","personalize"].includes(t)||this.deliveryStats.setStats(e,jt.DELIVERY_FUNNEL.DELIVERED.CAMPAIGN_DELIVERED_API_FAILURE)}getEventForPersonalisation(e){return ut(this,void 0,void 0,function*(){var t=yield Aa.getTriggeringPrimaryEvent(e.campaignId);return t?new cn(t.name,t.attributes):null})}deliverMessagingCampaign(e,t){var i;return ut(this,void 0,void 0,function*(){var n=this.baseLogTag+".deliverMessagingCampaign";if(e){var a=(yield this.getEventForPersonalisation(e))||t;try{var r=yield this.getOnsitePayload(e,a);if(r&&(e.onsitePayload=r,!this.isGCGCampaign(e)))if((null==(i=r.payload)?void 0:i.code)===jt.GCG_ERROR_CODE)Si.warn(1,n,`Can not render ${e.campaignId} as it falls under Control Group.`),kn(e,"OSM",!0)();else{if(Wn.doCampaignPayloadHasMandatoryParams(e.onsitePayload))return e;Si.warn(1,n,"Can not render "+e.campaignId),this.deliveryStats.setStats(e,jt.DELIVERY_FUNNEL.DELIVERED.CAMPAIGN_DELIVERED_MANDATORY_PARAMS_MISSING)}}catch(a){Si.error(1,n,"Error delivering messaging campaign",a)}}})}deliverPersonalizationCampaigns(e,t,i){return ut(this,void 0,void 0,function*(){var n=this.baseLogTag+".deliverPersonalizationCampaigns";if(0<e.length){var a=e.map(e=>this.getOnsitePayload(e,i));try{let i=yield Promise.all(a);return e.filter((e,n)=>{if(i[n]&&i[n].payload&&(e.onsitePayload=i[n],null!=e.tag)&&null!=t[e.tag]){if("JSON"!==e.onsitePayload.payloadType)return!0;if((e=>{try{JSON.parse(e)}catch(e){return!1}return!0})(e.onsitePayload.payload))return!0}return!1})}catch(a){Si.error(1,n,"Error delivering personalization campaigns",a)}}})}messagingCampaignImpression(e,t){return ut(this,void 0,void 0,function*(){var i=this.baseLogTag+".messagingCampaignImpression";if(e)try{var n=yield this.getLastGlobalInappShown(),a=yield this.getGlobalDelay(),r=this.displayManager.getActiveCampaigns();if(Wn.hasCampaignClearedGlobalDelay(e,a,n))if(Wn.canCampaignBeRenderedOverExisting(e,r.length))if(ua.getURLFilterResult(e)){var o=this.displayManager.campaignRenderMap[e.campaignId];if(ja.onScrollOrExitIntentCampaigns[e.campaignId]||null!=o&&(t===wt.MOE_EXIT||t===wt.MOE_PAGE_SCROLL))this.deliveryStats.setStats(e,jt.DELIVERY_FUNNEL.IMPRESSION.CAMPAIGN_IMPRESSION_MAX_TIMES_SHOWN),Si.warn(1,i,"Can not render "+e.campaignId);else{if(null==o||!o.isActive())return e;this.deliveryStats.setStats(e,jt.DELIVERY_FUNNEL.IMPRESSION.CAMPAIGN_IMPRESSION_ANOTHER_CAMPAIGN_VISIBLE),Si.warn(1,i,`Can not render ${e.campaignId}, as campaign is already Active.`)}}else Si.warn(1,i,"Can not render "+e.campaignId),this.deliveryStats.setStats(e,jt.DELIVERY_FUNNEL.IMPRESSION.CAMPAIGN_IMPRESSION_URL_CHANGED);else this.deliveryStats.setStats(e,jt.DELIVERY_FUNNEL.IMPRESSION.CAMPAIGN_IMPRESSION_ANOTHER_CAMPAIGN_VISIBLE);else Si.warn(1,i,"Can not render "+e.campaignId),this.deliveryStats.setStats(e,jt.DELIVERY_FUNNEL.IMPRESSION.CAMPAIGN_IMPRESSION_GLOBAL_DELAY)}catch(n){Si.error(1,i,"Error delivering messaging campaign",n)}})}mostEligibleMessagingCampaign(e,t){return ut(this,void 0,void 0,function*(){if(0<e.length){this.attemptCampaigns(e);var i=null==(i=yield this.prioritizeMessagingCampaigns(e))?void 0:i[0];let a;Yn(i,wt.MOE_PAGE_EXIT)?(n=yield qn(i)).error?this.setDeliveryFailureStats(i,n.reason):this.isGCGCampaign(n)||(a=n):a=yield this.deliverMessagingCampaign(i,t);var n=yield this.messagingCampaignImpression(a,null==t?void 0:t.name);return this.deliveryStats.sendDeliveryStats(e),n}})}mostEligiblePersonalizationCampaigns(e,t,i){return ut(this,void 0,void 0,function*(){var n;return 0<e.length&&(this.attemptCampaigns(e),n=yield this.prioritizePersonalizationCampaigns(e),n=yield this.deliverPersonalizationCampaigns(n,t,i),this.deliveryStats.sendDeliveryStats(e),n)||[]})}mostEligibleSelfHandledPersonalizationCampaigns(e,t){return ut(this,void 0,void 0,function*(){var i=this.baseLogTag+".mostEligibleSelfHandledPersonalizationCampaigns",n=(this.attemptCampaigns(e),yield this.filterValidCampaigns(e));return Si.log(1,i,"Eligible campaigns with tag ",t,"are",n),(n=n.sort(Wn.comparator)[0])&&(Si.log(1,i,"Campaign with highest priority for tag",t,"is",n.campaignId),i=yield this.getOnsitePayload(n))&&i.payload&&(n.onsitePayload=i),this.deliveryStats.sendDeliveryStats(e),n})}mostEligibleSelfHandledCampaigns(e,t){return ut(this,void 0,void 0,function*(){var i=this.baseLogTag+".mostEligibleSelfHandledCampaigns",n=(this.attemptCampaigns(e),yield this.filterValidCampaigns(e));if(0===n.length)return this.deliveryStats.sendDeliveryStats(e),[];Si.log(1,i,"Eligible self-handled campaigns are ",n);let a=yield this.prioritizeMessagingCampaigns(e,jt.MAX_SELF_HANDLE_OSM_CAMPAIGNS);return a&&0<a.length?(Si.log(1,i,"Campaign in prioritised order: ",a.map(e=>e.campaignId)),n=Promise.all(a.map(e=>this.getOnsitePayload(e,t))).then(e=>e.filter(e=>(null==e?void 0:e.templateType)===Ve.SELF_HANDLED_OSM).map((e,t)=>new Ua(Object.assign(Object.assign({},e),a[t])))),this.deliveryStats.sendDeliveryStats(e),n):void 0})}delayDeliveryCampaignStats(e){this.deliveryStats.setStats(e,jt.DELIVERY_FUNNEL.IMPRESSION.CAMPAIGN_IMPRESSION_CANCEL_BEFORE_DELAY),this.deliveryStats.sendDeliveryStats([e])}isGCGCampaign(e){var t,i=this.baseLogTag+".isGCGCampaign";return(null==(t=e.onsitePayload.payload)?void 0:t.code)===jt.GCG_ERROR_CODE&&(Si.warn(1,i,`Can not render ${e.campaignId} as it falls under Control Group.`),kn(e,"OSM",!0)(),!0)}}class Wa{constructor(e){this.draftId=o(e,"draft_id",null),this.draftType=o(e,"draft_type",null),this.templateType=o(e,"template_type",null),this.action=o(e,"action",null);var t=o(e,"campaign_meta",{});this.locale=o(e,"locale",null),this.variation=o(e,"variation",null),this.displaySettings=new Ia({config:t.config},this.templateType)}static isValidRawJson(e){var{draft_id:e,draft_tag:t,draft_type:i}=e;return i===jt.DRAFT_CAMPAIGN_TPYES.WEB_PERSONALIZATON?null!=e&&null!=t:null!=e}}let Ha=(e,t)=>(Si.log(1,"selfHandledHelper.track",`Self handled OSM ${t} tracking called for campaign:`,e.campaignName),e.campaignId?(t===jt.EVENT_NAMES.OSM.IMPRESSION&&xn(e.campaignId),s().track_event(t,Object.assign({campaign_id:e.campaignId,campaign_name:e.campaignName,type:jt.EVENT_NAMES.OSM.TYPE},e.context))):new Promise((e,t)=>{t("Moengage error: Campaign ID not found")}));class Va{handler(e,t,i,n,a,r){var o;return function(e,t,i,n){return new(i=i||Promise)(function(t,a){function r(e){try{s(n.next(e))}catch(e){a(e)}}function o(e){try{s(n.throw(e))}catch(e){a(e)}}function s(e){var n;e.done?t(e.value):((n=e.value)instanceof i?n:new i(function(e){e(n)})).then(r,o)}s((n=n.apply(e,[])).next())})}(this,0,void 0,function*(){var s=Va.baseLogTag+".handler",l=(Si.log(1,s,(null==r?void 0:r.name)&&`Triggered for ${r.name}: `||"Campaign(s) triggered: ",a),a.filter(e=>e.templateType===Ve.SELF_HANDLED)),d=a.filter(e=>e.templateType!==Ve.SELF_HANDLED&&e.templateType!==Ve.SELF_HANDLED_OSM),c=a.filter(e=>e.templateType===Ve.SELF_HANDLED_OSM);if(0<l.length&&0<(l=yield e.mostEligiblePersonalizationCampaigns(l,t,r)).length&&i(l),0<d.length){if(l=yield e.mostEligibleMessagingCampaign(d,r),null!=r&&r.timestamp&&r.timestamp<(null==(o=window.Moengage)?void 0:o.pageChangeHandlerCallingTime))return void Si.log(1,s,"Stopped triggering the campaign because handle_page_change was called: ",a);l&&n(l)}0<c.length&&this.selfHandledOSMCallback&&0<(d=yield e.mostEligibleSelfHandledCampaigns(c,r)).length&&(d.forEach(e=>{Ha(e,jt.EVENT_NAMES.OSM.DELIVERED)}),this.selfHandledOSMCallback(d))})}}Va.baseLogTag="EventTriggerHandler";class Ga{constructor(e){this.baseLogTag="DeliveryStats",this.OnsiteApiClient=new ya(e),this.batchId=(0,oe.v4)()}sendDeliveryStats(e){return function(e,t,i,n){return new(i=i||Promise)(function(t,a){function r(e){try{s(n.next(e))}catch(e){a(e)}}function o(e){try{s(n.throw(e))}catch(e){a(e)}}function s(e){var n;e.done?t(e.value):((n=e.value)instanceof i?n:new i(function(e){e(n)})).then(r,o)}s((n=n.apply(e,[])).next())})}(this,0,void 0,function*(){var t=this.baseLogTag+".sendDeliveryStats";if(window.navigator.onLine){if(0<e.length)try{let t={};e.forEach(e=>{t[e.campaignContext.cid]||(t[e.campaignContext.cid]=e.stats,e.stats={})});var i={stats:t};this.OnsiteApiClient.callStatsAPI(i,this.batchId)}catch(i){Si.error(1,t,"Error in sending delivery funnel stats",i)}}else Si.error(1,t,"No internet connection. Delivery stats will not be sent"),ba.setOnlineEventListner(()=>{this.sendDeliveryStats(e)})})}setStats(e,t,i){let n=(new Date).toISOString();e&&(e.stats[t]=e.stats[t]||[],i?e.stats[t]=i:e.stats[t].some(e=>e.t===n)||e.stats[t].push({t:n}))}}var gt=function(e,t,i,n){return new(i=i||Promise)(function(a,r){function o(e){try{l(n.next(e))}catch(e){r(e)}}function s(e){try{l(n.throw(e))}catch(e){r(e)}}function l(e){var t;e.done?a(e.value):((t=e.value)instanceof i?t:new i(function(e){e(t)})).then(o,s)}l((n=n.apply(e,t||[])).next())})};let Ka=new xi;class ja{constructor(e){this.initializationPomise=null,this.testDraftInfo=null,this.triggerManager=null,this.displayManager=null,this.selfHandledWebpTriggerListeners={},this.funnelManager=null,this.eventTriggerHandler=null,this.deliveryStats=null,this.initData=e,Si.setLogLevel(e.debugLevel),this.OnsiteApiClient=new ya(this.initData),function(){ja.handleSDKEnableAndDisableLisetner||(window.addEventListener(Pt.MOE_LIFECYCLE.TOPIC_NAME,e=>Ge(this,void 0,void 0,function*(){var t=null==(t=null==e?void 0:e.detail)?void 0:t.name;t===Pt.MOE_LIFECYCLE.EVENT_NAMES.SDK_ENABLED?yield tr.enableOSM():t===Pt.MOE_LIFECYCLE.EVENT_NAMES.SDK_DISABLED&&(yield tr.disableOSM(!1,!0))})),ja.handleSDKEnableAndDisableLisetner=!0)}()}setLogLevel(e){Si.setLogLevel(e,!1)}isTestCampaignAvailable(){return gt(this,void 0,void 0,function*(){let e=ja.baseLogTag+".isTestCampaignAvailable";window.opener?(window.addEventListener("message",t=>gt(this,void 0,void 0,function*(){var i,n;t.data&&"inapp_test"===t.data.action&&(i=t.data,Wa.isValidRawJson(i)?(n=new Wa(i),Si.log(1,e,"Valid test campaign data found checking TestCampaign",i),yield this.checkForTestCampaign(n)):Si.error(1,e,"Data is not a valid test campaign",i),Ka.res())}),!1),window.opener.postMessage("moe_test_osm","*"),setTimeout(()=>gt(this,void 0,void 0,function*(){Ka.res()}),100)):Ka.res()})}initialize(){let e=ja.baseLogTag+".initialize";return Si.log(1,e,"Initialising onsite module"),null==this.initializationPomise&&Ae()&&(this.initializationPomise=new Promise(t=>gt(this,void 0,void 0,function*(){try{yield Rn.initialize(),yield this.isTestCampaignAvailable(),Ka.p.then(()=>gt(this,void 0,void 0,function*(){yield this.syncCampaigns();var i=yield $n(),n=((n=this.isExitIntentCampaignFound(i)).length&&(yield this.prefetchExitIntentCampaigns(n)),i.filter(e=>null!=e.triggerData));if(this.displayManager=new xa,this.displayManager.onRender(t=>{Si.log(1,e,"Campaign rendered: "+t.campaignId),Rn.serviceMetaStore.setItem(jt.STORES.SERVICE_META.KEYS.LAST_INAPP_SHOWN_TIME,new Date)}),null!=this.testDraftInfo&&this.testDraftInfo.draftType===jt.DRAFT_CAMPAIGN_TPYES.ONSITE_MESSAGING){Si.log(1,e,"Test campaigns present, will be showing only the test campaign."),Si.log(1,e,"No live campaign will be shown till draft campaign showing");try{Si.log(1,e,"Trying to render draft campaign with id "+this.testDraftInfo.draftId);var a=yield this.OnsiteApiClient.getDraftCampaign(this.testDraftInfo);Si.log(1,e,"Test campaign payload: ",a),a&&this.displayManager.queueDraftCampaign(this.testDraftInfo,a),this.testDraftInfo=null}catch(i){Si.error(1,e,`Error fetching data for test campaign ${this.testDraftInfo.draftId}: `,i)}}else null!=(i=this.initData)&&i.enableSPA&&this.handleSPA(),ja.attachIdentityUpdateHandler(),this.deliveryStats=new Ga(this.initData),this.triggerManager=new Da(n),this.funnelManager=new Fa(this.initData,this.displayManager,this.deliveryStats),this.eventTriggerHandler=new Va,a=this.eventTriggerHandler.handler.bind(this.eventTriggerHandler,this.funnelManager,this.selfHandledWebpTriggerListeners,this.handlePersonalizationCampaigns.bind(this),this.handleMessagingCampaigns.bind(this)),this.triggerManager.onTrigger(a),Oa.setListener(a),wa.setDeliveryStats(this.deliveryStats),Oa.setDeliveryStats(this.deliveryStats),yield Oa.logDeliveryFunnelForExpiredTimerCampaigns(),yield wa.updateCampaignTimeInSecondaryEventsStore(),yield Oa.createNewTimers(),this.triggerManager.startWatching();qi.broadcastToWindow({topic:Pt.MOE_LIFECYCLE.TOPIC_NAME,name:Pt.MOE_LIFECYCLE.EVENT_NAMES.OSM_INIT}),t(!0)}))}catch(t){Si.error(1,e,t)}}))),this.initializationPomise}handleMessagingCampaigns(e){return gt(this,void 0,void 0,function*(){var t=ja.baseLogTag+".handleMessagingCampaigns";e.onsitePayload&&this.displayManager&&(Si.log(1,t,"Campaign triggered: "+e.campaignId),Si.log(1,t,"Payload for campaign:",e.onsitePayload),this.displayManager.queueLiveCampaign(e,e.onsitePayload))})}handlePersonalizationCampaigns(e){return gt(this,void 0,void 0,function*(){let t=ja.baseLogTag+".handlePersonalizationCampaigns";0<e.length&&e.forEach(e=>{null!=e.tag&&(Si.log(1,t,"Personlization Campaign triggered: "+e.campaignId),this.selfHandledWebpTriggerListeners[e.tag].forEach(t=>{this.handleSelfHandledCallback(e,e.onsitePayload,t)}))})})}logout(e=!1,t=!1){var i;return gt(this,void 0,void 0,function*(){var n,a=ja.baseLogTag+".logout";Si.log(1,a,"Starting module logout"),null!=(i=this.initData)&&i.enableSPA&&this.removeHandlePageChange(),this.initializationPomise=null,this.displayManager&&(Kn(this.displayManager),n=Object.keys(null==(i=this.displayManager)?void 0:i.campaignRenderMap),null!=(i=this.displayManager.testCampaign)&&i.draftId&&n.push(null==(i=this.displayManager.testCampaign)?void 0:i.draftId),n.forEach(e=>{(e=document.getElementById("moe-onsite-campaign-"+e))&&e.remove()}),this.displayManager.destroy()),this.triggerManager&&(Gn(this.triggerManager),jn(this.triggerManager),this.triggerManager.destory()),un.clear(),wa.destroy(),Oa.destroy(),e&&(ja.onScrollOrExitIntentCampaigns={}),this.displayManager=null,this.funnelManager=null,this.eventTriggerHandler=null,yield Oa.deleteAllPendingTimers(),t?Rn.sdkOptOut():(yield Rn.serviceMetaStore.removeItem(jt.STORES.SERVICE_META.KEYS.LAST_META_CALL_TIME),yield Rn.clear(e)),Si.log(1,a,"Starting module logout complete")})}checkForTestCampaign(e){return gt(this,void 0,void 0,function*(){var t=ja.baseLogTag+".checkForTestCampaign";try{var i=e;null==i?(Si.log(1,t,"No draft campaign found"),this.testDraftInfo=null):(Si.log(1,t,"Found draft campaign: ",i),this.testDraftInfo=i,null==this.testDraftInfo.draftId&&(this.testDraftInfo.draftType=jt.DRAFT_CAMPAIGN_TPYES.WEB_PERSONALIZATON))}catch(i){Si.error(1,t,"Error getting test campaign",i)}})}getData(e,t){return gt(this,void 0,void 0,function*(){let i=ja.baseLogTag+".getData";null==t&&(Si.warn(1,i,"Moengage.onsite.getData called without a providing a callback."),t=()=>{});try{var n,a,r,o;yield this.initializationPomise,null!=this.testDraftInfo?(Si.log(1,i,"Fetching test campaign: ",this.testDraftInfo),this.testDraftInfo.draftType===jt.DRAFT_CAMPAIGN_TPYES.WEB_PERSONALIZATON&&(n=yield this.OnsiteApiClient.getDraftCampaign(this.testDraftInfo),this.testDraftInfo=null,t(null,{payload:n.payload,click:()=>{Si.log(1,i,"This is a test campaign")},imp:()=>{Si.log(1,i,"This is a test campaign")}}))):(a=yield Rn.campaingsTagsStore.getItem(e))?(r=(yield Promise.all(a.map(e=>zn(e)))).filter(e=>null==e.triggerData),(o=yield this.funnelManager.mostEligibleSelfHandledPersonalizationCampaigns(r,e))&&o.onsitePayload?this.handleSelfHandledCallback(o,o.onsitePayload,t):(Si.error(1,i,"Error fetching campaign payload"),t({message:"There was an error fetching data for this tag"},null))):(Si.warn(1,i,"Could not find any eligible campaign for tag",e),t({message:"Could not find any eligible campaign for tag "+e},null))}catch(n){Si.error(1,i,"Error getting campaign",n)}})}registerCallback(e,t){return gt(this,void 0,void 0,function*(){var i=ja.baseLogTag+".registerCallback";try{yield this.initializationPomise,null==this.selfHandledWebpTriggerListeners[e]?this.selfHandledWebpTriggerListeners[e]=[t]:this.selfHandledWebpTriggerListeners[e].push(t)}catch(t){Si.error(1,i,"Error setting callback for tag",e),Si.error(1,i,"Error stack:",t)}})}handleSelfHandledCallback(e,t,i){return gt(this,void 0,void 0,function*(){var n=ja.baseLogTag+".handleSelfHandledCallback";if(e.campaignContext=t.campaignContext,"JSON"===t.payloadType)try{t.payload=JSON.parse(t.payload);var a=o(e,"triggerData.trigger_delay.delayInSeconds",0)||0;setTimeout(()=>{Un(e,"WP"),i(null,{payload:t.payload,click:t=>{Mn(e,"WP",t)()},imp:kn(e,"WP")})},1e3*a)}catch(r){a=`Payload for campaign_id ${e.campaignId} is not a valid JSON`,Si.error(1,n,a),Si.error(1,n,"Payload provided:",t.payload),i({message:a},null)}else Un(e,"WP"),i(null,{payload:t.payload,click:t=>{Mn(e,"WP",t)()},imp:kn(e,"WP")})})}syncCampaigns(){return gt(this,void 0,void 0,function*(){var e=ja.baseLogTag+".syncCampaigns";try{(yield this.shouldClearMetaStorage())&&(yield Rn.campaingsMetaStore.clear(),yield this.rebuildTagStore()),(yield this.shouldSaveRemoteCampaigns())&&(yield this.saveRemoteCampaigns())}catch(t){Si.error(1,e,"Error getting remote campaigns: ",t)}})}shouldClearMetaStorage(){return gt(this,void 0,void 0,function*(){return(yield Rn.serviceMetaStore.getItem(jt.STORES.SERVICE_META.KEYS.LAST_FETCH_SDK_VERSION))!==s().getSdkVersion()})}shouldSaveRemoteCampaigns(){var e;return gt(this,void 0,void 0,function*(){var t=ja.baseLogTag+".shouldSaveRemoteCampaigns",i=yield Rn.serviceMetaStore.getItem(jt.STORES.SERVICE_META.KEYS.LAST_FETCH_SDK_VERSION),n=yield Rn.serviceMetaStore.getItem(jt.STORES.SERVICE_META.KEYS.LAST_META_CALL_TIME),a=(n=new Date(n),(new Date).getTime());return null==n||a-n>jt.META_REFRESH_TIME||(Si.remoteLogTracking(1,"info",t,"Last fetch was less than 15 mins ago at ",n),i!==s().getSdkVersion()?(Si.remoteLogTracking(1,"info",t,"Version change detected. Will proceed to fetch latest campaigns"),!0):!(!(a=yield Rn.serviceMetaStore.getItem(jt.STORES.SERVICE_META.KEYS.UNIQUE_ID))||a===(null==(e=Li.get(yt.USER_DATA))?void 0:e.deviceUuid)||(Si.remoteLogTracking(1,"info",t,"Unique device id change detected. Will proceed to fetch latest campaigns"),0)))})}saveRemoteCampaigns(){return gt(this,void 0,void 0,function*(){var e=ja.baseLogTag+".saveRemoteCampaigns",t=(yield Rn.campaingsMetaStore.clear(),yield Rn.exitIntentCampaignStore.clear(),yield this.OnsiteApiClient.getCampaignsMeta());null!=t&&(yield this.addCampaignsToDB(t.campaignsMeta),Si.log(1,e,"Inapp campaigns meta saved!")),yield wa.pruneRemovedCampaigns(),yield wa.removeStaleTriggeringPrimaryEventCampaigns(),yield Rn.serviceMetaStore.setItem(jt.STORES.SERVICE_META.KEYS.GLOBAL_DELAY,t.globalDelayBetweenInapps),yield Rn.serviceMetaStore.setItem(jt.STORES.SERVICE_META.KEYS.LAST_FETCH_SDK_VERSION,s().getSdkVersion())})}addCampaignsToDB(e){return gt(this,void 0,void 0,function*(){var t=ja.baseLogTag+".addCampaignsToDB";Si.log(1,t,`Adding/Updating ${e.length} campaigns in DB`,e.map(e=>e.campaignId));try{yield Promise.all(e.map(e=>Rn.campaingsMetaStore.setItem(e.campaignId,e))),yield this.rebuildTagStore()}catch(e){Si.error(1,t,"Error saving remote campaigns:",e)}})}rebuildTagStore(){return gt(this,void 0,void 0,function*(){var e=ja.baseLogTag+".rebuildTagStore";try{yield Rn.campaingsTagsStore.clear();var t,i=yield $n(),n={};for(t of i)null!=t.tag&&(null==n[t.tag]&&(n[t.tag]=[]),n[t.tag].push(t.campaignId));var a,r=[];for(a in yield Rn.campaingsTagsStore.clear(),n)n.hasOwnProperty(a)&&r.push(Rn.campaingsTagsStore.setItem(a,n[a]));yield Promise.all(r)}catch(t){Si.error(1,e,"Error updating tags store:",t)}})}isExitIntentCampaignFound(e){return e.filter(e=>e.templateType!==Ve.SELF_HANDLED&&Yn(e,wt.MOE_PAGE_EXIT))}prefetchExitIntentCampaigns(e){return gt(this,void 0,void 0,function*(){var t=ja.baseLogTag+".prefetchExitIntentCampaigns";let i=yield cn.createEvent("MOE_EXIT",[]);var n=(yield Hn(e)).filter(e=>ua.getFilterResult(i,e));if(!n||!n.length)return Si.log(1,t,"Exit intent campaign not eligible to prefetch"),!1;var a,r=yield qn(n[0]);r&&r.onsitePayload&&r.onsitePayload.updatedTime.getTime()===n[0].updatedTime.getTime()||(r=n[0].campaignId,(a=yield this.OnsiteApiClient.getCampaignPayload(n[0])).payload||a.htmlJsonPayload?(a.updatedTime=n[0].updatedTime,yield Rn.exitIntentCampaignStore.setItem(r,a),Si.log(1,t,"Exit intent campaign prefetched: "+r)):a.error&&a.reason&&(yield Rn.exitIntentCampaignStore.setItem(r,a)))})}static handleDisableModule(e){qi.broadcastToWindow({topic:"MODULE_ACTIONS",name:"DISABLE_OSM",data:{isUserLogout:e}})}sendDelayCampaignStats(e,t){return gt(this,void 0,void 0,function*(){var i,n=ja.baseLogTag+".sendDelayCampaignStats";e&&0<(i=Object.keys(e.campaignRenderMap).filter(t=>!e.campaignRenderMap[t].campaignRendered)).length&&(Si.log(1,n,"Campaigns found:",i),t.delayDeliveryCampaignStats(e.campaignRenderMap[i[0]].campaignMeta))})}handleSPA(){var e=ja.baseLogTag+".handleSPA";Si.log(2,e,"Adding SPA event listener for OSM"),window.addEventListener(Pt.SPA_LIFECYCLE.TOPIC_NAME,Ke,{once:!0})}removeHandlePageChange(){var e=ja.baseLogTag+".removeHandlePageChange";Si.log(2,e,"Removing SPA event listener for OSM"),window.removeEventListener(Pt.SPA_LIFECYCLE.TOPIC_NAME,Ke)}static identityUpdateHandler(e){var t;return gt(this,void 0,void 0,function*(){var i=ja.baseLogTag+".identityUpdateHandler";Si.log(2,i,"Received event: "+e.detail.name),e.detail.name===Pt.USER_LIFECYCLE.EVENT_NAMES.USER_IDENTITY_UPDATE?(i=je(null==(t=null==window?void 0:window.Moengage)?void 0:t.onsite.displayManager))&&0<i.length?(yield Rn.serviceMetaStore.removeItem(jt.STORES.SERVICE_META.KEYS.LAST_META_CALL_TIME),function(e){window.addEventListener("OSM_INTERNAL_EVENT",function t(i){let{name:n,data:a}=i.detail;if("DISMISS"===n&&a&&e.includes(a)){let e=je(null==(i=null==window?void 0:window.Moengage)?void 0:i.onsite.displayManager);e&&0!==e.length||(qi.broadcastToWindow({topic:"MODULE_ACTIONS",name:"DISABLE_ENABLE_OSM"}),window.removeEventListener("OSM_INTERNAL_EVENT",t))}},{once:1===e.length})}(i),window.addEventListener(Pt.USER_LIFECYCLE.TOPIC_NAME,ja.identityUpdateHandler)):qi.broadcastToWindow({topic:"MODULE_ACTIONS",name:"DISABLE_ENABLE_OSM"}):e.detail.name===Pt.USER_LIFECYCLE.EVENT_NAMES.LOGOUT&&(removeEventListener(Pt.USER_LIFECYCLE.TOPIC_NAME,ja.identityUpdateHandler),ja.identityListenerAdded=!1,ja.handleDisableModule(!0))})}static attachIdentityUpdateHandler(){ja.identityListenerAdded||(window.addEventListener(Pt.USER_LIFECYCLE.TOPIC_NAME,ja.identityUpdateHandler),ja.identityListenerAdded=!0)}getSelfHandledOSM(e){let t=ja.baseLogTag+".getSelfHandledOSM";e&&"function"==typeof e?(Si.log(1,t,"Self handled OSM callback requested"),this.initializationPomise.then(()=>{this.eventTriggerHandler?this.eventTriggerHandler.selfHandledOSMCallback=e:Si.warn(1,t,"OSM module not initialised properly for self handled OSM to work; or it is in test campaign mode.")}).catch(i=>{Si.error(1,t,"Error during initialization:",i),e(i,null)})):Si.error(1,t,"Self handled OSM callback is not a function.")}selfHandledShown(e){return Ha(e,jt.EVENT_NAMES.OSM.IMPRESSION)}selfHandledClicked(e){return Ha(e,jt.EVENT_NAMES.OSM.CLICK)}selfHandledDismissed(e){return Ha(e,jt.EVENT_NAMES.OSM.DISMISS)}}ja.baseLogTag="MoeOnsite",ja.identityListenerAdded=!1,ja.onScrollOrExitIntentCampaigns={},ja.handleSDKEnableAndDisableLisetner=!1,window[jt.OSM_MODULE]=ja,window.MoeOsm=ka();class Ya{static addCallback(e,t){null!=e&&null!=t&&(null==Ya.callbacks[e]&&(Ya.callbacks[e]=[]),Ya.callbacks[e].push(t))}static getCallbacks(e){return Ya.callbacks[e]||[]}static runCallbacks(e){Ya.getCallbacks(e).forEach(e=>{e()})}}function pt(){var e=document.getElementById("moe-push-div");null!=e&&(e.style.visibility="none",e.style.opacity="0",e.parentNode.removeChild(e))}var mt;Ya.callbacks={};class qa{constructor(e){this.swRegisterPromise=null,this.swActiveRetries=1;let t=qa.baseLogTag+".constructor";this.sdkSettings=e,this.registerServiceWorker().then(e=>{this.sendDataToServiceWorker()}).catch(e=>{Si.error(1,t,"Error registering serviceworker:",e)})}showHardAsk(){let e=qa.baseLogTag+".showHardAsk";return new Promise((t,i)=>{qa.isWebPushSupported().then(n=>{n?this.getCurrentPermissionState().then(n=>{Ae()&&this.registerServiceWorker().then(a=>{var r;n!==Me.DENIED?(Si.remoteLogTracking(1,"info",e,"Attempting to open hard ask"),null!=(r=s())&&r.track_event(wt.OPT_IN_ATTEMPT),qi.broadcastToWindow({topic:Pt.MOE_LIFECYCLE.TOPIC_NAME,name:Pt.OPT_IN_LIFECYCLE.EVENT_NAMES.HARD_ASK_ATTEMPTED}),this.showOverlay(),Ae()&&this.askPermission().then(i=>{Ae()&&(this.hideOverlay(),Si.remoteLogTracking(2,"info",e,"Permission state after hard ask:",i),i===Me.GRANTED?this.getPushTokenDetails().then(e=>{this.sendDataToServiceWorker(e.token),t({state:i,subscriptionDetails:e})}):(this.sendDataToServiceWorker(),t({state:i,subscriptionDetails:null})))}).catch(t=>{Si.error(1,e,t),i(Rt.SERVICE_WORKER_REGISTRATION_FAILED)})):(Si.remoteLogTracking(1,"info",e,"Hard ask not shown as permission state is",n),t({state:n,subscriptionDetails:null}))}).catch(t=>{Si.error(1,e,"Error registering serviceworker:",t),i(t)})}).catch(t=>{Si.error(1,e,"Registering service worker failed:",t),i(Rt.SERVICE_WORKER_REGISTRATION_FAILED)}):(Si.warn(1,e,"Web push not supported in current browser environment"),i(Rt.WEB_PUSH_NOT_SUPPORTED))})})}sendDataToServiceWorker(e){return new Promise(t=>{pn.collectGetParams().then(t=>{var i,n=_i.get();e&&(t.push_id=e||ge()||void 0),t.isWebPushEnabled=this.sdkSettings.isWebPushEnabled&&!n.disableWebPush,t.isBatchingEnabled=Li.get(yt.WEB_SETTINGS).configs.isBatchingEnabled,null!=(i=n.proxyDomains)&&i.api&&(t.proxyDomains=n.proxyDomains),c()||n.swScope?r.createInstance({driver:[r.INDEXEDDB],name:"moe_database",storeName:"moe_data"}).setItem("reportParams",{data:t}):navigator.serviceWorker.ready.then(()=>{this.sendDataToServiceWorkerOnControllerReady(t)})})})}sendDataToServiceWorkerOnControllerReady(e){if(navigator.serviceWorker.controller){if("chrome-extension:"===window.location.protocol)return chrome.runtime.sendMessage({data:e});navigator.serviceWorker.controller.postMessage({data:e})}else this.swActiveRetries<3&&setTimeout(()=>{this.swActiveRetries++,this.sendDataToServiceWorkerOnControllerReady(e)},500)}getCurrentPermissionState(){return Fi.getInstance().then(e=>navigator.permissions&&!e.isSafari()?navigator.permissions.query({name:"notifications"}).then(e=>qa.parsePermissionState(e.state)).catch(e=>{}):new Promise(t=>{let i,n=null==(i=window.Notification)?void 0:i.permission;e.isSafari()&&n===Zt.DEFAULT&&(n=Zt.PROMPT,Li.get(ei))&&(n=Zt.DENIED),t(qa.parsePermissionState(n))}))}getPushTokenDetails(){let e=qa.baseLogTag+".getPushTokenDetails";return new Promise((t,i)=>{this.getCurrentPermissionState().then(i=>{Fi.getInstance().then(n=>{i!==Me.GRANTED?t({token:null,raw:null}):this.registerServiceWorker().then(i=>{let a=null,r={userVisibleOnly:!0},o=(d(this.sdkSettings.webPushPlatformData,n)&&(a=g(this.sdkSettings.webPushPlatformData,n),r.applicationServerKey=Se(a)),()=>{i.pushManager.subscribe(r).then(e=>{(e=>{var i=e.toJSON(),a=(e=e.endpoint.substring(0,i.endpoint.lastIndexOf("/")+1),i.expirationTime);let r=i.endpoint.split("/")[i.endpoint.split("/").length-1];n.isEdge()&&(r=r.replace("?token=",""));var o={};if(i.keys)for(var s in i.keys)i.keys.hasOwnProperty(s)&&(o[s]=i.keys[s]);t({token:r,endpoint:e,keys:o,expirationTime:a,raw:i})})(e)}).catch(i=>{Si.error(1,e,"Error in subscribtion: ",i),t({token:null,raw:null})})});i.pushManager.getSubscription().then(e=>{var t;e&&"vapid"===this.sdkSettings.webPushPlatformData.chrome.subscriptionMode&&e.options&&e.options.applicationServerKey&&(t=_e(e.options.applicationServerKey),[a,a+"=",a+"==",_e(Se(a))].indexOf(t)<0)?e.unsubscribe().then(()=>{o()}):o()})}).catch(i=>{Si.error(1,e,"Error in getting push token: ",i),t({token:null,raw:null})})})})})}removeToken(){return Li.remove(yt.PUSH_TOKEN),Li.remove(yt.OPTED_STATUS_TRACK_TIME),Li.remove(yt.SUBSCRIPTION_DETAILS),Promise.resolve()}trackHardAskShownEvents(){var e;Li.set(yt.OPT_IN_SHOWN_TIME,Date.now()),null!=(e=s())&&e.track_event(wt.OPT_IN_SHOWN),qi.broadcastToWindow({topic:Pt.MOE_LIFECYCLE.TOPIC_NAME,name:Pt.OPT_IN_LIFECYCLE.EVENT_NAMES.HARD_ASK_SHOWN}),Ya.runCallbacks(Pt.OPT_IN_LIFECYCLE.EVENT_NAMES.HARD_ASK_SHOWN),qi.deprecatedSdkCallback("opt_in_shown")}askPermission(){return new Promise((e,t)=>{var i;this.trackHardAskShownEvents(),null!=(i=window.Notification)&&i.requestPermission().then(t=>{e(qa.parsePermissionState(t))}).catch(e=>{t(Rt.PERMISSION_DISMISSED_TOO_MANY_TIMES)})})}registerServiceWorker(){let e=qa.baseLogTag+".registerServiceWorker";return"chrome-extension:"===window.location.protocol?navigator.serviceWorker.ready:(null!=this.swRegisterPromise||(this.swRegisterPromise=new Promise((t,i)=>{if(qa.registeredServiceWorker)t(qa.registeredServiceWorker);else if("serviceWorker"in navigator){let n="serviceworker.js",a=!1;if(_i.get()&&null!=_i.get().swPath&&(n=_i.get().swPath,a=!0),"/"===n[0]||n.startsWith("http")||(n="/"+n),c())Si.log(1,e,"Removing scope in case of shopify."),this.registerScopedSW(n,/moengage/,t,i);else{let r="/";_i.get()&&null!=_i.get().swScope?(r=_i.get().swScope,this.registerScopedSW(n,r,t,i)):(a&&(Si.log(1,e,"Using user defined path to serviceworker:",n),r=n.substr(0,n.lastIndexOf("/")+1),qa.canSwBeRegisteredWithScope(r)||(Si.error(1,e,"Service worker can only be registered from same directory or child directory."),i(Rt.SERVICE_WORKER_NOT_IN_CORRECT_SCOPE))),navigator.serviceWorker.register(n,{scope:r}).then(n=>{Si.log(2,e,"Serviceworker registered"),navigator.serviceWorker.ready.then(i=>{Si.log(2,e,"Serviceworker ready"),qa.registeredServiceWorker=i,_i.get()&&_i.get().forceSwUpdate&&i.update(),t(i)}).catch(t=>{Si.error(1,e,"Service worker register failed:",t),i(Rt.SERVICE_WORKER_REGISTRATION_FAILED)})}).catch(t=>{Si.error(1,e,"Service worker register failed:",t),i(Rt.SERVICE_WORKER_REGISTRATION_FAILED)})),Si.log(1,e,"Scope for serviceworker:",r)}}else Si.error(1,e,"Service worker not supported"),i("Service worker not supported")})),this.swRegisterPromise)}registerScopedSW(e,t,i,n){let a=qa.baseLogTag+".registerScopedSW";navigator.serviceWorker.register(e).then(e=>{Si.log(2,a,"Serviceworker registered"),navigator.serviceWorker.getRegistrations().then(e=>{e.forEach(e=>{setTimeout(()=>{e.active&&e.active.scriptURL.match(t)&&(Si.log(2,a,"Serviceworker ready"),qa.registeredServiceWorker=e,_i.get()&&_i.get().forceSwUpdate&&e.update(),i(e))},100)})}).catch(e=>{Si.error(1,a,"Service worker register failed:",e),n(Rt.SERVICE_WORKER_REGISTRATION_FAILED)})}).catch(e=>{Si.error(1,a,"Service worker register failed:",e),n(Rt.SERVICE_WORKER_REGISTRATION_FAILED)})}static canSwBeRegisteredWithScope(e){var t=window.location.pathname;return!(t.indexOf(e)<0)&&0<=t.substring(t.indexOf(e)).length}static isWebPushSupported(){return new Promise(e=>{Fi.getInstance().then(t=>{!t.isIncognito&&"serviceWorker"in navigator&&"PushManager"in window&&"Notification"in window&&t.isWebPushCompatible()?e(!0):e(!1)})})}static parsePermissionState(e){return"prompt"===e?Me.PROMPT:"granted"===e?Me.GRANTED:"denied"===e?Me.DENIED:"default"===e?Me.DISMISSED:null}showNotification(e){let t=qa.baseLogTag+".showNotification";this.registerServiceWorker().then(i=>{e?e.title?e.body?(null==e.requireInteraction&&(e.requireInteraction=!0),i.showNotification(e.title,e)):Si.error(1,t,"Notification body can not be blank"):Si.error(1,t,"Notification title can not be blank"):Si.error(1,t,"Notification object can not be blank")}).catch(e=>{Si.error(1,t,"Error registering serviceworker:",e)})}showOverlay(){if(this.sdkSettings.toShowOverlay&&this.sdkSettings.optInType===ke.ONE_STEP){let e=document.createElement("div");e.id="moe-push-div",e.style.display="none",e.className="moe-push-class",Fi.getInstance().then(t=>function(e,t,i,n){return new(i=i||Promise)(function(t,a){function r(e){try{s(n.next(e))}catch(e){a(e)}}function o(e){try{s(n.throw(e))}catch(e){a(e)}}function s(e){var n;e.done?t(e.value):((n=e.value)instanceof i?n:new i(function(e){e(n)})).then(r,o)}s((n=n.apply(e,[])).next())})}(this,0,void 0,function*(){var i;let n;if(t.isMobile?e.innerHTML=(yield me(this.sdkSettings.overlay,this.sdkSettings.isBrandingHidden)).mobileUI:e.innerHTML=(yield me(this.sdkSettings.overlay,this.sdkSettings.isBrandingHidden)).webUI,(i=document.body.firstChild).parentNode.insertBefore(e,i),(i=t.name)===Fi.BROWSER_NAMES.CHROME||i===Fi.BROWSER_NAMES.OPERA_NEON?n=document.getElementsByClassName("moe_chrome"):i===Fi.BROWSER_NAMES.FIREFOX?n=document.getElementsByClassName("moe_firefox"):i!==Fi.BROWSER_NAMES.OPERA&&i!==Fi.BROWSER_NAMES.SAFARI||(n=document.getElementsByClassName("moe_opera")),0===n.length)document.getElementById("moe-push-div").style.display="none";else for(let e=n.length-1;0<=e;e--)n[e].style.display="block";this.overlayTimer=window.setTimeout(()=>{""===e.style.opacity&&(e.style.display="block")},1500),e.onclick=()=>{this.hideOverlay()}}))}}hideOverlay(){clearTimeout(this.overlayTimer),pt()}}qa.baseLogTag="HTTPS-NotificationManager";let za="Web push settings not configured on MoEngage dashboard: "+Bt;class $a{constructor(e,t){this.currentManager=null;var i=$a.baseLogTag+".constructor";this.config=e,this.browser=t,this.browser.isWebPushCompatible()?e.webPushPlatformData.chrome&&(e.isWebPushEnabled?"https"===(()=>{if(window)return"localhost"===window.location.hostname?"https":"http:"===window.location.protocol?"http":"https:"===window.location.protocol||"chrome-extension:"===window.location.protocol?"https":void 0})()?this.currentManager=new qa(e):Si.error(1,i,"Web Push does not work in http mode"):(c()&&new qa(e),Si.warn(1,i,"Web push settings not configured. Please configure at ",Bt))):this.browser.name===Fi.BROWSER_NAMES.SAFARI&&"safari"in window&&"pushNotification"in window.safari&&(this.currentManager=null,Si.warn(1,i,"Web push is only supported on Safari 16 and above."))}showHardAsk(){let e=$a.baseLogTag+".showHardAsk";return new Promise((t,i)=>{this.getCurrentPermissionState().then(n=>{null!=this.currentManager?n===Me.PROMPT?this.currentManager.showHardAsk().then(i=>{var n;i.state===Me.DISMISSED?(null!=(n=s())&&n.track_event(wt.OPT_IN_DISMISSED),qi.broadcastToWindow({topic:Pt.MOE_LIFECYCLE.TOPIC_NAME,name:Pt.OPT_IN_LIFECYCLE.EVENT_NAMES.HARD_ASK_DISMISSED}),qi.deprecatedSdkCallback("opt_in_dismissed"),Ya.runCallbacks(Pt.OPT_IN_LIFECYCLE.EVENT_NAMES.HARD_ASK_DISMISSED),Si.log(1,e,"Hard ask was dismissed")):i.state===Me.GRANTED?(null!=(n=s())&&n.track_event(wt.OPT_IN_ALLOWED),qi.broadcastToWindow({topic:Pt.MOE_LIFECYCLE.TOPIC_NAME,name:Pt.OPT_IN_LIFECYCLE.EVENT_NAMES.HARD_ASK_ALLOWED,data:i.subscriptionDetails}),qi.deprecatedSdkCallback("opt_in_allowed"),Ya.runCallbacks(Pt.OPT_IN_LIFECYCLE.EVENT_NAMES.HARD_ASK_ALLOWED),Si.log(1,e,"Push permission was granted"),Si.customLabel(1,e,"token",i.subscriptionDetails.token)):i.state===Me.DENIED&&(null!=(n=s())&&n.track_event(wt.OPT_IN_BLOCKED),null!=(n=s())&&n.track_event("Web Push Opt-in Denied"),qi.broadcastToWindow({topic:Pt.MOE_LIFECYCLE.TOPIC_NAME,name:Pt.OPT_IN_LIFECYCLE.EVENT_NAMES.HARD_ASK_DENIED}),qi.deprecatedSdkCallback("opt_in_blocked"),Ya.runCallbacks(Pt.OPT_IN_LIFECYCLE.EVENT_NAMES.HARD_ASK_DENIED),Si.log(1,e,"Notification permission was denied")),t(i)}).catch(i=>{Si.error(1,e,"Error showing hard ask:",i),t({state:n,subscriptionDetails:null})}):(Si.log(1,e,"Not showing Hard Ask as current permission state is",n),this.getPushTokenDetails().then(i=>{Si.customLabel(1,e,"token",i.token),t({state:n,subscriptionDetails:i})}).catch(i=>{Si.warn(1,e,"Could not get push token details"),t({state:n,subscriptionDetails:null})})):(Si.log(1,e,"MoEngage web push settings not configured. Please configure at",Bt),i(Rt.WEB_PUSH_NOT_CONFIGURED))}).catch(e=>{i(e)})})}getCurrentPermissionState(){return null!=this.currentManager?this.currentManager.getCurrentPermissionState():Promise.reject(za)}getPushTokenDetails(){return null!=this.currentManager?this.currentManager.getPushTokenDetails():Promise.reject(za)}removeToken(){return null!=this.currentManager?this.currentManager.removeToken():Promise.reject(za)}showNotification(e){var t=$a.baseLogTag+".showNotification";if(null!=this.currentManager)return this.currentManager.showNotification(e);Si.warn(1,t,za)}}$a.baseLogTag="NotificationManager";class Ja{constructor(e){this.mainDivs=[],this.config=e}showSoftAsk(){let e=Ja.baseLogTag+".showSoftAsk";return new Promise((t,i)=>{let n=this.config.loadTime;Fi.getInstance().then(i=>{(n=this.config.optInType===ke.SELF_HANDLED||i.isSafari()&&this.config.optInType===ke.ONE_STEP?0:n)&&Si.log(1,e,"Delay of",n," second(s) requested before opt-in flow"),setTimeout(()=>{!i.isWebPushCompatible()||this.config.optInType!==ke.TWO_STEP&&this.config.optInType!==ke.SELF_HANDLED?(Li.set(yt.SOFT_ASK_STATUS,mt.NOT_SHOWN),t({showHardAsk:!0,softAskState:mt.NOT_SHOWN})):this.showOptIn(()=>{var t;Si.log(1,e,"Soft ask was shown"),null!=(t=s())&&t.track_event(wt.WEB_OPTIN_BANNER_LOAD),Li.set(yt.OPT_IN_SHOWN_TIME,Date.now()),Li.set(yt.SOFT_ASK_STATUS,mt.SHOWN),qi.broadcastToWindow({topic:Pt.MOE_LIFECYCLE.TOPIC_NAME,name:Pt.OPT_IN_LIFECYCLE.EVENT_NAMES.SOFT_ASK_SHOWN}),qi.deprecatedSdkCallback("soft_ask_shown"),Ya.runCallbacks(Pt.OPT_IN_LIFECYCLE.EVENT_NAMES.SOFT_ASK_SHOWN)},()=>{var i;null!=(i=s())&&i.track_event(wt.WEB_OPTIN_ACCEPTED),this.hideOptIn(),it(),Si.log(1,e,"Soft ask was allowed"),Li.set(yt.SOFT_ASK_STATUS,mt.ALLOWED),t({showHardAsk:!0,softAskState:mt.ALLOWED}),qi.broadcastToWindow({topic:Pt.MOE_LIFECYCLE.TOPIC_NAME,name:Pt.OPT_IN_LIFECYCLE.EVENT_NAMES.SOFT_ASK_ALLOWED}),qi.deprecatedSdkCallback("soft_ask_allowed"),Ya.runCallbacks(Pt.OPT_IN_LIFECYCLE.EVENT_NAMES.SOFT_ASK_ALLOWED)},()=>{var i;this.hideOptIn(),it(),null!=(i=s())&&i.track_event(wt.WEB_OPTIN_CLOSED),Si.log(1,e,"Soft ask was dismissed"),Li.set(yt.SOFT_ASK_STATUS,mt.DISMISSED),t({showHardAsk:!1,softAskState:mt.DISMISSED}),qi.broadcastToWindow({topic:Pt.MOE_LIFECYCLE.TOPIC_NAME,name:Pt.OPT_IN_LIFECYCLE.EVENT_NAMES.SOFT_ASK_DISMISSED}),qi.deprecatedSdkCallback("soft_ask_closed"),Ya.runCallbacks(Pt.OPT_IN_LIFECYCLE.EVENT_NAMES.SOFT_ASK_DISMISSED)},e=>{e=!!e,this.hideOptIn(),t({showHardAsk:e,softAskState:mt.NOT_SHOWN})})},1e3*n)})})}showOptIn(e,t,i,n){let a=Ja.baseLogTag+".showOptIn";if(this.config.optInType===ke.TWO_STEP){let r=document.getElementById("moe-push-div");null==r&&((r=document.createElement("div")).id="moe-push-div",r.className="moe-push-class"),Fi.getInstance().then(o=>{let s=null;var l;null!=(s=o.isMobile?pe(this.config.optInPreview,this.config.isBrandingHidden).mobileUI:pe(this.config.optInPreview,this.config.isBrandingHidden).webUI)?(r.innerHTML=s,null!=(o=document.body.firstChild)&&o.parentNode.insertBefore(r,o),(o=(this.moeDiv=r).firstElementChild)&&(o.tabIndex=0,o.setAttribute("role","alert"),o.setAttribute("aria-live","polite"),at(r.firstElementChild)),o=document.getElementById("optInText")||document.getElementById("optInTextConventional"),l=document.getElementById("moe-dontallow_button"),null==o?(Si.error(1,a,"Error showing soft ask. Allow button id is missing"),n()):(e(),o.onclick=()=>{t()},l?l.onclick=()=>{i()}:window.moeRemoveBanner=()=>{i()})):(Si.error(1,a,"Error displaying soft ask"),n())})}else if(this.config.optInType===ke.SELF_HANDLED){var r=_i.get();if(r.customSoftAsk){var o=document.getElementsByClassName(r.customSoftAsk.mainClass),s=document.getElementsByClassName(r.customSoftAsk.allowClass),l=document.getElementsByClassName(r.customSoftAsk.dismissClass);if(o.length<1)Si.error(1,a,"Could not find main class for the soft ask. Class name given:",r.customSoftAsk.mainClass),Fi.getInstance().then(e=>{e.isWebPushCompatible()&&(Si.warn(1,a,"Proceeding to hard ask directly"),n(!0))});else{e(),s.length<1&&(Si.warn(1,a,"Could not find any element for allow button. Class name given:",r.customSoftAsk.allowClass),Si.warn(1,a,"Docs for self-handled opt in available here - ",xt.SELF_HANDLED_DOCS)),l.length<1&&Si.warn(1,a,"Could not find any element for dismiss button. Class name given:",r.customSoftAsk.dismissClass);for(let e=o.length-1;0<=e;e--){var d=o[e];this.mainDivs.push(d),d.style.display="block",at(d)}for(let e=s.length-1;0<=e;e--)s[e].onclick=()=>{t()};for(let e=l.length-1;0<=e;e--)l[e].onclick=()=>{i()}}}else Fi.getInstance().then(e=>{e.isWebPushCompatible()?(Si.warn(1,a,"No soft ask configured. Proceeding to hard ask directly. \n\nYou can ignore this message if you do not want any soft ask."),n(!0)):(Si.error(1,a,"Soft ask needs to be present in case of http implementation. Can not show hard ask otherwise."),n())})}}hideOptIn(){null!=this.moeDiv&&(this.moeDiv.style.display="none"),0<this.mainDivs.length&&this.mainDivs.map(e=>{e.style.display="none"})}}Ja.baseLogTag="SoftAskManager",(S=mt=mt||{}).SHOWN="shown",S.NOT_SHOWN="not shown",S.ALLOWED="allowed",S.DISMISSED="dismissed";class Xa{constructor(e,t){this.notificationManager=null,this.softAskManager=null,this.sdkSettings=e,this.browser=t,this.softAskManager=new Ja(this.sdkSettings),this.notificationManager=new $a(this.sdkSettings,t),function(){Xa.handleSdkDisableListener||(window.addEventListener(Pt.MOE_LIFECYCLE.TOPIC_NAME,e=>function(e,t,i,n){return new(i=i||Promise)(function(t,a){function r(e){try{s(n.next(e))}catch(e){a(e)}}function o(e){try{s(n.throw(e))}catch(e){a(e)}}function s(e){var n;e.done?t(e.value):((n=e.value)instanceof i?n:new i(function(e){e(n)})).then(r,o)}s((n=n.apply(e,[])).next())})}(this,0,void 0,function*(){var t;(null==(t=null==e?void 0:e.detail)?void 0:t.name)===Pt.MOE_LIFECYCLE.EVENT_NAMES.SDK_DISABLED&&pt()})),Xa.handleSdkDisableListener=!0)}()}callWebPush(){let e=Xa.baseLogTag+".callWebPush";var t,i,n;t=this.sdkSettings,i=this.browser,(null==(n=_i.get())||!n.disableWebPush)&&t.isWebPushEnabled&&0<=ci.indexOf(i.name)&&navigator.serviceWorker&&"PushManager"in window&&"Notification"in window&&this.notificationManager.getCurrentPermissionState().then(t=>function(e,t,i,n){return new(i=i||Promise)(function(t,a){function r(e){try{s(n.next(e))}catch(e){a(e)}}function o(e){try{s(n.throw(e))}catch(e){a(e)}}function s(e){var n;e.done?t(e.value):((n=e.value)instanceof i?n:new i(function(e){e(n)})).then(r,o)}s((n=n.apply(e,[])).next())})}(this,0,void 0,function*(){var i=(i=t)=>{ji.get().then(t=>{var n,a,r,o,l;t.deviceAdded=(n=this.sdkSettings,a=t,r=Bi.getUserIdentities(),o=a.getAttribute("email"),l=a.getAttribute("mobile"),!!(null!==o||null!==l||null!=r&&r.u_em||null!=r&&r.u_mb||null!=(l=null==(o=null==n?void 0:n.configs)?void 0:o.subscriberBasedBillingAttributes)&&l.some(e=>null!==a.getAttribute(e))||r&&0<Object.keys(r).length&&Object.keys(r).some(e=>{var t;return null==(t=null==(t=null==n?void 0:n.configs)?void 0:t.subscriberBasedBillingAttributes)?void 0:t.includes((null==(t=di.find(t=>t.moeName===e))?void 0:t.attributeName)||e)})||be())),t.save().then(()=>{this.notificationManager.removeToken().then(()=>{var t;null!=(t=s())&&t.track_event(wt.DEVICE_ATTRIBUTE,{[ti.MOE_PUSH_OPTED]:!1}),null!=(t=s())&&t.track_event(wt.PERMISSION_BLOCKED),i===Me.DENIED?(Li.set(yt.HARD_ASK_STATUS,i),Si.log(1,e,"Not asking for permission as current state is denied.")):(Li.remove(yt.OPT_IN_SHOWN_TIME),this.startPushSubscription())})})})},n=yield Fi.getInstance(),a=ge(),r=t===Me.DENIED&&!this.sdkSettings.isDomainLevelStorage;null==a&&t!==Me.DENIED?this.startPushSubscription():null!=a&&(r||n.isSafari()&&t===Me.PROMPT)?(Si.log(1,e,"User has removed the permission"),Si.image(1,Mt.SAD),n.isSafari()&&t===Me.PROMPT&&(Li.set(ei,!0),t=Me.DENIED),i(t)):r?Si.warn(1,e,"Not proceeding with push subscription as current state is denied"):null!=a&&t===Me.GRANTED?this.browser.name===Fi.BROWSER_NAMES.CHROME?d(this.sdkSettings.webPushPlatformData,this.browser)?this.startPushSubscription():Si.warn(1,e,"Subscription mode is not VAPID type. Cannot subscribe to web push."):(this.startPushSubscription(),this.notificationManager.getPushTokenDetails().then(t=>{Si.customLabel(1,e,"token",t.token)})):this.sdkSettings.isDomainLevelStorage?Ni.get(yt.HARD_ASK_STATUS)===Me.GRANTED?(r=null==(n=Ni.get(yt.SUBSCRIPTION_DETAILS))?void 0:n.domain)&&r===window.location.origin?(Si.log(1,e,"It seems that the user has unsubscribed manually. Starting push subscription.."),i(t)):Si.log(1,e,"Not showing opt-in as user subscribed to sub-domain"):this.startPushSubscription():i()})).catch(t=>{Si.error(1,e,"Error in getting current state:",t)})}startPushSubscription(){let e=Xa.baseLogTag+".startPushSubscription",t=()=>{Li.set(yt.HARD_ASK_STATUS,Me.PROMPT);let t=ge();this.notificationManager.showHardAsk().then(i=>{Li.set(yt.HARD_ASK_STATUS,i.state),i.state===Me.GRANTED?null!=i.subscriptionDetails.token?(Li.set(yt.PUSH_TOKEN,i.subscriptionDetails.token),i.subscriptionDetails.domain=window.location.origin,Li.set(yt.SUBSCRIPTION_DETAILS,i.subscriptionDetails),i.subscriptionDetails.token&&t!==i.subscriptionDetails.token&&pn.deviceAdd().then(()=>{var n;Si.image(1,Mt.AMAZED),ji.getSync().subscribedToOldSdk?Si.remoteLogTracking(1,"info",e,"User subscribed from older sdk, hence not sending subscription event"):(null!=t?null!=(n=s())&&n.add_user_attribute("Web Migrated User","true"):null!=(n=s())&&n.add_user_attribute("Web Subscription URL",location.href),null!=(n=s())&&n.track_event(wt.PERMISSION_ALLOWED,{MOE_WEB_PUSH_TOKEN:i.subscriptionDetails.token,migrated_user:!!window.location.search.includes("moe_migration=true")||void 0}))}),this.sdkSettings.isDomainLevelStorage&&Ni.set(yt.SUBSCRIPTION_DETAILS,{domain:i.subscriptionDetails.domain,token:i.subscriptionDetails.token,endpoint:i.subscriptionDetails.endpoint,keys:i.subscriptionDetails.keys})):(Si.error(1,e,"Push token was received as null."),Si.error(1,e,"Please contact MoEngage support if this troubleshooting does not solve the issue.")):i.state===Me.DENIED&&Si.image(1,Mt.SAD)}).catch(t=>{Si.warn(1,e,t)})},i=()=>{this.softAskManager?this.softAskManager.showSoftAsk().then(e=>{e.showHardAsk&&t()}):Si.log(1,e,"SoftAskManager not set.")};this.notificationManager.getCurrentPermissionState().then(n=>{if(n===Me.GRANTED)this.sdkSettings.optInType!==ke.ONE_STEP&&Si.remoteLogTracking(1,"info",e,"Skipping soft ask as browser permission is set to allow all notifications"),t();else if(n!==Me.DENIED){var a=parseInt(Li.get(yt.OPT_IN_SHOWN_TIME)),r=(Date.now()-a)/36e5;if(!a||this.sdkSettings.optInType===ke.SELF_HANDLED||r>this.sdkSettings.promptAgain)if(this.browser.name===Fi.BROWSER_NAMES.SAFARI&&this.sdkSettings.optInType===ke.ONE_STEP){Si.log(1,e,"1 step optin configured. In Safari 16+ and macOS 13+, the web push optin will be shown after a user click. Any delay will be ignored.");let t=()=>{window.removeEventListener("click",t),i()};window.addEventListener("click",t)}else i();else{let t,i;i=r<1?(t=Math.floor(60*r),"minute(s)"):(t=Math.floor(100*r)/100,"hour(s)"),Si.remoteLogTracking(1,"info",e,"Not showing opt in as last it was shown",t,i,"back on",new Date(a),". Reappear time is set to",this.sdkSettings.promptAgain,"hours."),Si.log(1,e,"You can clear localstorage to get opt-in again.")}}else Si.log(2,e,"Not showing opt-in as permission is denied."),Li.set(yt.HARD_ASK_STATUS,n)})}getPermissionState(){return this.notificationManager.getCurrentPermissionState()}showNotification(e){this.notificationManager&&this.notificationManager.showNotification(e)}trackPushOptedDeviceAttribute(){return new Promise(e=>{var t,i=Li.get(yt.OPTED_STATUS_TRACK_TIME);i&&864e5<Date.now()-i&&(i=ge(),null!=(t=s())&&t.track_event(wt.DEVICE_ATTRIBUTE,{[ti.MOE_PUSH_OPTED]:!!i}),Li.set(yt.OPTED_STATUS_TRACK_TIME,Date.now())),e(null)})}}Xa.baseLogTag="WebPushManager",Xa.handleSdkDisableListener=!1;class Qa{constructor(){this.customSoftAsk=null}static get(){return Ei.get(Tt.INIT_DATA)}static save(e){Ei.set(Tt.INIT_DATA,e),Li.set(yt.INIT_DATA,e)}static setSoftAskConfig(e){var t=Qa.get();e={mainClass:o(e,"main_class",o(e,"mainClass",null)),allowClass:o(e,"allow_class",o(e,"allowClass",null)),dismissClass:o(e,"block_class",o(e,"dismissClass",null))},Qa.save(Object.assign(Object.assign({},t),{customSoftAsk:e}))}}class Za{initialize(e){let t=Za.baseLogTag+".initialize";Za.handlePublicFunctions(),Fi.getInstance().then(i=>{let n=new Xa(e,i);n&&l(e,i)?(0<=[ke.ONE_STEP,ke.TWO_STEP].indexOf(e.optInType)?n.callWebPush():(Si.log(1,t,"Self handled setting. Will show opt-in on manual invocation, if required."),n.getPermissionState().then(e=>{var i=ge();(e===Me.GRANTED||null!=i&&e===Me.DENIED)&&(e===Me.GRANTED&&Si.log(1,t,"Notification permission already granted. Proceeding to subscribe the user"),n.callWebPush())}).catch(e=>{Si.warn(1,t,"Cannot get permission state: ",e)})),n.trackPushOptedDeviceAttribute()):ci.indexOf(i.name)<0&&Si.warn(1,t,"Web push not supported on this browser. Supported browsers are:\n\t\t1. Google Chrome\n\t\t2. Mozilla Firefox\n\t\t3. Opera\n\t\t4. Edge\n\t\t5. Safari 16 and above + macOS 13 and above")})}static getPermissionState(e){return new Promise((t,i)=>{Wi().then(n=>{Fi.getInstance().then(a=>{new Xa(n,a).getPermissionState().then(i=>{t(i),e&&e(null,i)}).catch(t=>{i(t),e&&e(t,null)})})}).catch(t=>{i(t),e&&e(t,null)})})}static handlePublicFunctions(){var e=s();e.callWebPush=Za.callWebPush,e.call_web_push=Za.callWebPush,e.showNotification=Za.showNotification,e.getPermissionState=Za.getPermissionState}static callWebPush(e){let t=Za.baseLogTag+".callWebPush";Ae()?Wi().then(i=>{i.isWebPushEnabled?i.optInType===ke.SELF_HANDLED?(Si.log(1,t,"Starting web push functions"),null!=e&&Qa.setSoftAskConfig(e),Fi.getInstance().then(e=>{new Xa(i,e).callWebPush()})):Si.warn(1,t,"This feature can only be used when you have chosed self-handled approach in the dashboard. You can check dashboard here:",Bt):Si.log(1,t,"Web push settings not configured on dashboard yet. To start web push subscriptions, please configure the settings on dashboard.")}).catch(e=>{Si.error(1,t,"Error in getting Web SDK Settings. This might indicate that the App is blocked.")}):Si.warn(2,t,"Cannot initiate web push as Web SDK has been disabled.")}static showNotification(e){Wi().then(t=>{Fi.getInstance().then(i=>{new Xa(t,i).showNotification(e)})}).catch(e=>{})}}function ht(e){return!(!e||"object"!=typeof e)&&["moe_offering_id","moe_offering_name","moe_offering_type","moe_decision_policy_id","moe_decision_policy_name"].every(t=>t in e&&"string"==typeof e[t]&&""!==e[t].trim())}function Et(e){return!(!e||"object"!=typeof e)&&["cid","moe_locale_id","moe_variation_id"].every(t=>t in e&&"string"==typeof e[t]&&""!==e[t].trim())}function vt(e,t){if(e&&"object"==typeof e&&!Array.isArray(e))return e;if("string"==typeof e)try{var i=JSON.parse(e);return i&&"object"==typeof i&&!Array.isArray(i)?i:(Si.error(2,t,"Parsed JSON is not a valid object"),null)}catch(e){Si.error(2,t,"Error parsing JSON string:",e)}return null}Za.baseLogTag="PushModule";class er{constructor(){this.initialize=()=>{s().personalize={trackClick:this.trackClick,trackImpression:this.trackImpression,onUpdateDeviceId:this.onUpdateDeviceId,offeringClicked:this.offeringClicked,offeringShown:this.offeringShown},er.setupFetchExperiencesFunction()},this.getDeviceUniqueId=e=>{window.addEventListener(Pt.MOE_LIFECYCLE.TOPIC_NAME,t=>{t.detail.name===Pt.MOE_LIFECYCLE.EVENT_NAMES.DEVICE_UUID&&(t=t.detail.data,e(t))})},this.onUpdateDeviceId=e=>{this.getDeviceUniqueId(e)},this.offeringClicked=(e,t)=>er.track(e,ni.OFFERING_CLICKED,ht,"Invalid offering context, missing required fields",t),this.offeringShown=(e,t)=>er.track(e,ni.OFFERING_SHOWN,ht,"Invalid offering context, missing required fields",t),this.trackClick=(e,t)=>er.track(e,ni.CLICK,Et,"Invalid experience context, missing required fields",t),this.trackImpression=(e,t)=>er.track(e,ni.IMPRESSION,Et,"Invalid experience context, missing required fields",t)}}er.baseLogTag="Web Personalization Tracking",er.setupFetchExperiencesFunction=()=>{let e=()=>{var e=s();e&&e.personalize&&(e.personalize.fetchExperiences=window.MoeWebP.fetchExperiences)};window.MoeWebP&&window.MoeWebP.fetchExperiences?e():window.addEventListener(Pt.MOE_LIFECYCLE.TOPIC_NAME,t=>{t.detail.name===Pt.MOE_LIFECYCLE.EVENT_NAMES.WEBP_INIT&&e()})},er.track=(e,t,i,n,a)=>{var r=er.baseLogTag+".track";if(!(e=vt(e,r)))return Si.error(2,r,"Invalid context"),Promise.reject(new Error("Invalid context"));if(!i(e))return Si.error(2,r,n),Promise.reject(new Error(n));i=a&&vt(a,r)||{},n=Object.assign(Object.assign({},e),i);try{var o=s();return o?(Si.log(2,r,t+": Event Tracked"),o.track_event(t,n)):(window.moengage_q=window.moengage_q||[]).push({f:"track_event",a:[t,n]}),Promise.resolve()}catch(e){return Si.error(2,r,"Failed tracking expression",e),Promise.reject(e)}};var ft=function(e,t,i,n){return new(i=i||Promise)(function(a,r){function o(e){try{l(n.next(e))}catch(e){r(e)}}function s(e){try{l(n.throw(e))}catch(e){r(e)}}function l(e){var t;e.done?a(e.value):((t=e.value)instanceof i?t:new i(function(e){e(t)})).then(o,s)}l((n=n.apply(e,t||[])).next())})};class tr{constructor(){tr.handleEventListeners()}static loadModule(e){var t=tr.baseLogTag+".loadModule";return null==tr.loadPromises[e.name]&&(Si.log(1,t,"Starting to fetch module: ",e.name),tr.loadPromises[e.name]=new Promise((t,i)=>{var n,a,r;n=e.src,a=()=>{var i=new window[Yt[e.name].windowLocation](_i.get());t(i)},document&&((r=document.createElement("script")).setAttribute("src",ye(n)),r.onload=a,r.async=!0,document.body.appendChild(r))})),tr.loadPromises[e.name]}static enableOSM(){return ft(this,void 0,void 0,function*(){var e=_i.get();void 0===s().onsite.OnsiteApiClient&&(s().onsite=new ja(e),yield s().onsite.initialize())})}static disableOSM(e=!1,t=!1){return ft(this,void 0,void 0,function*(){var i=s();i.onsite.OnsiteApiClient&&(Si.log(2,tr.baseLogTag,`Logging out from OSM module - userLogoutHappen: ${e}, OsmOptOut: `+t),yield s().onsite.logout(e,t),i.onsite=null,i.onsite=Ln)})}static enableCards(e){return ft(this,void 0,void 0,function*(){let t=s();tr.loadModule(Yt.CARDS).then(i=>{i.initialize(e),t.cards=i}).catch(e=>{Si.error(1,"enableCards","Error in loading Cards Module:",e)})})}static disableCards(){return ft(this,void 0,void 0,function*(){var e=s();e.cards&&(yield e.cards.disableCardsModule())})}static enablePush(e){return ft(this,void 0,void 0,function*(){(new Za).initialize(e)})}static handleEventListeners(){window.addEventListener("MODULE_ACTIONS",e=>ft(this,void 0,void 0,function*(){var t;"DISABLE_OSM"===e.detail.name&&tr.disableOSM(null==(t=e.detail.data)?void 0:t.isUserLogout),"DISABLE_ENABLE_OSM"===e.detail.name&&null!=(t=null==(t=s())?void 0:t.onsite.initData)&&t.appId&&(yield tr.disableOSM(),tr.enableOSM())}))}static enableWebPersonalizationTracking(){return ft(this,void 0,void 0,function*(){(new er).initialize()})}}tr.baseLogTag="ModuleManager",tr.loadPromises={};class ir{constructor(e){this.deviceToLogout=o(e,"deviceToLogout",null)}static get(){return new ir(Li.get(yt.GRACEFUL_DATA))}save(){Li.set(yt.GRACEFUL_DATA,this)}}class nr{onWindowVisibilityChange(e){Ei.set("isWindowActive",!0),document.addEventListener("focus",()=>{t(!0)},!1),document.addEventListener("blur",()=>{t(!1)},!1),window.addEventListener("focus",()=>{t(!0)},!1),window.addEventListener("blur",()=>{"IFRAME"!==document.activeElement.tagName&&t(!1)},!1);let t=e=>"boolean"==typeof e?i(e?"visible":"hidden"):document.hidden?i("hidden"):i("visible"),i=t=>{Ei.set("isWindowActive","visible"===t),e(t)};window.addEventListener("visibilitychange",t,!1)}static executeCleanup(){var e,t;if(!((t=Date.now())-nr.lastCleanupAttempt<nr.CLEANUP_THROTTLE_MS||(nr.lastCleanupAttempt=t,nr.isCleanupInProgress))){var i,n,a,{reportsCount:t,remoteLogsCount:r}=nr.getBatchCounts();if(0!==t||0!==r){nr.isCleanupInProgress=!0;try{nr.isBatchingEnabled&&(tn.windowClosed=!0,0<t)&&(on.sendBeacon(),on.reactToTriggerEvents()),null!=(e=window.Moengage.onsite)&&e.displayManager&&(({sendDelayCampaignStats:i,displayManager:n,funnelManager:a}=window.Moengage.onsite),i(n,a))}catch(e){Si.error(0,"WindowEventManager.executeCleanup","Error during cleanup execution:",e)}finally{nr.isCleanupInProgress=!1}}}}static beforeUnload(){nr.shouldExecuteCleanup()&&nr.executeCleanup()}static pageHide(e){e&&"boolean"==typeof e.persisted&&e.persisted||!nr.shouldExecuteCleanup()||nr.executeCleanup()}static shouldExecuteCleanup(){var e,t;return!nr.isCleanupInProgress&&(({reportsCount:e,remoteLogsCount:t}=nr.getBatchCounts()),0<e||0<t)}static getBatchCounts(){var e;return{reportsCount:(null==(e=on.reports)?void 0:e.length)||0,remoteLogsCount:(null==(e=on.remoteLogs)?void 0:e.length)||0}}static manageMobileEventListeners(e){var t;se()&&(e=e?"addEventListener":"removeEventListener",t=nr.mobileAppStateChange,window[e]("focus",t,!1),window[e]("blur",t,!1),document[e]("touchstart",t,!1))}static visibilityChangeForCleanup(){document.hidden&&nr.shouldExecuteCleanup()&&(Si.log(2,"WindowEventManager.visibilityChangeForCleanup","Visibility change detected, executing cleanup"),nr.executeCleanup())}static mouseOut(e){(null===e.relatedTarget||e.clientY<=nr.MOUSE_OUT_THRESHOLD_PX)&&(Si.log(2,"WindowEventManager.mouseOut","Mouse left window or browser header detected"),nr.shouldExecuteCleanup())&&nr.executeCleanup()}static mobileAppStateChange(){nr.shouldExecuteCleanup()&&(Si.log(2,"WindowEventManager.mobileAppStateChange","Mobile app state change detected, executing cleanup"),nr.executeCleanup())}static removeAllCleanupListeners(){nr.listenersAdded&&(Si.log(2,"WindowEventManager.removeAllCleanupListeners","Removing all enhanced event listeners"),nr.isCleanupInProgress=!1,nr.listenersAdded=!1,nr.lastCleanupAttempt=0,window.removeEventListener("beforeunload",nr.beforeUnload,!1),"onpagehide"in window&&window.removeEventListener("pagehide",nr.pageHide,!1),document.removeEventListener("visibilitychange",nr.visibilityChangeForCleanup,!1),document.removeEventListener("mouseout",nr.mouseOut,!1),nr.manageMobileEventListeners(!1))}static addAllCleanupListeners(e){nr.listenersAdded||(Si.log(2,"WindowEventManager.addAllCleanupListeners","Adding enhanced event listeners for incognito mode, batching enabled:",e),e&&(nr.isBatchingEnabled=!0),nr.isCleanupInProgress=!1,nr.listenersAdded=!0,nr.lastCleanupAttempt=0,document.addEventListener("visibilitychange",nr.visibilityChangeForCleanup,!1),"onpagehide"in window&&window.addEventListener("pagehide",nr.pageHide,!1),window.addEventListener("beforeunload",nr.beforeUnload,!1),document.addEventListener("mouseout",nr.mouseOut,!1),nr.manageMobileEventListeners(!0))}}nr.CLEANUP_THROTTLE_MS=500,nr.MOUSE_OUT_THRESHOLD_PX=5,nr.isCleanupInProgress=!1,nr.isBatchingEnabled=!1,nr.listenersAdded=!1,nr.lastCleanupAttempt=0;var St=function(e,t,i,n){return new(i=i||Promise)(function(a,r){function o(e){try{l(n.next(e))}catch(e){r(e)}}function s(e){try{l(n.throw(e))}catch(e){r(e)}}function l(e){var t;e.done?a(e.value):((t=e.value)instanceof i?t:new i(function(e){e(t)})).then(o,s)}l((n=n.apply(e,t||[])).next())})};let ar="MoEngage.user";class rr{static addAttribute(e,t,i=Gi.USER_ATTRIBUTE_LEVEL.PROJECT){let n=ar+".addUserAttribute";return new Promise((a,r)=>{if(Ae()){let r=_i.get();Wi().then(o=>{if("string"!=typeof e||null==e)Si.error(1,n,"Attribute name needs to be a string"),a({error:5e3,message:"Attribute name needs to be a string. Type provided was "+typeof e});else if(""===e)Si.error(1,n,"Attribute name can not be an empty string"),a({error:5001,message:"Attribute name can not be an empty string"});else if(null==t)Si.error(1,n,"Attribute value null"),a({error:5003,message:"Attribute value was empty"});else if("string"==typeof t&&""===t)Si.error(1,n,"Attribute value needs to be non-empty string or non-empty object"),a({error:5004,message:"Attribute value needs to be non-empty string or non-empty object"});else if(Pe(t)&&Ct.includes(e))Si.error(1,n,`Value of '${e}' attribute cannot be an object`),a({error:5002,message:"Attribute value cannot be an object"});else if("object"==typeof t&&Array.isArray(t)&&!t.length)Si.error(1,n,"Attribute value needs to be non-empty string or non-empty object"),a({error:5006,message:"Attribute value needs to be non-empty string or non-empty object"});else if(Pe(t)&&!Object.keys(t).length)Si.error(1,n,"Attribute value cannot be empty object"),a({error:5005,message:"Attribute value cannot be empty object"});else if(i!==Gi.USER_ATTRIBUTE_LEVEL.PORTFOLIO||null!=r&&r.projectId)if(i!==Gi.USER_ATTRIBUTE_LEVEL.PORTFOLIO||"id"!==e&&e!==Nt.ID)if(i===Gi.USER_ATTRIBUTE_LEVEL.PORTFOLIO&&o.configs.blacklistedPortfolioUserAttributes.includes(e))Si.error(1,n,"Cannot track this portfolio attribute as it is blacklisted"),a({error:5007,message:"Cannot track this portfolio attribute as it is blacklisted"});else{let s=new Gi(e,t,i),l=()=>{ji.get().then(e=>{e.addAttribute(s).then(e=>St(this,void 0,void 0,function*(){null!=r&&r.projectId||(yield this.checkAndAddAttributeInIdentityMap(s,t,o)),e?(s.key===Nt.ID&&(yield Bi.updateIdentifiersIDB({moe_user_id:s.value}),Si.log(1,n,"Logging in the user with id: ",s.value)),cn.createUserAttributeEvent(s).then(e=>{Si.log(2,n,"Event to be converted to report:",e),un.addEvent(e),pn.collectGetParams().then(t=>{t=new dn(dn.REPORT_ADD_TYPE.USER_ATTRIBUTE,t,e,i),pn.reportAdd(t).then(()=>{a(!0)})})})):(Si.error(1,n,"Attribute already present/queued. Not adding again."),a({error:5005,message:"Attribute already present/queued. Not adding again."}))}))})};"id"===e?ji.get().then(e=>St(this,void 0,void 0,function*(){var i=e.indexOfAttribute("id");if(-1<i)if(t===e.attributes[i].value)Si.log(1,n,"User already logged in with id:",t),a(!0);else{Si.log(1,n,"Logging out previous user with id:",e.attributes[i].value),qi.broadcastToWindow({topic:"USER_ACTIONS",name:"FORCED_LOGOUT",data:{id:t}});let a=null==(i=Bi.getUserIdentities())?void 0:i.uid;rr.logout(!0,t).then(()=>St(this,void 0,void 0,function*(){yield this.forcedLogoutUpdateInIdentityMap(t,a,o),l()}))}else yield this.uidLoginUpdateIdentityMap(t,o),l()})):(qi.broadcastToWindow({topic:"USER_ACTIONS",name:"LOGIN",data:{id:t}}),l())}else Si.error(1,n,"uid cannot be tracked as portfolio attribute"),a({error:5007,message:"uid cannot be tracked as portfolio attribute"});else Si.error(1,n,"Cannot track this attribute at portfolio level as project id is missing in integration"),a({error:5007,message:"Cannot track this attribute at portfolio level as project id is missing in integration"})}).catch(i=>{var r;null!=(r=window.moengage_q)&&r.push({f:"add_user_attribute",a:[e,t]}),Si.error(1,n,"Error in getting Web SDK Settings. ",i),a({error:5007,message:"Error in getting Web SDK Settings.",err:i})})}else Si.warn(2,n,`Not tracking the attribute "${e}" as Web SDK has been disabled.`),a(!1)})}static login(e){return rr.addAttribute("id",e)}static identifyUser(e){return St(this,void 0,void 0,function*(){var t=ar+".identifyUser";if(Ae())if("string"==typeof e&&e.length||(e=>{if("object"==typeof e&&null!==e){let i=!0;for(var t in e)if(i=!1,"string"!=typeof(t=e[t])||!t.length)return;return!i}})(e)){let s,l={};if("string"==typeof e?l.uid=e:l=Object.assign({},e),_i.get().projectId){if(!l.uid)return void Si.error(1,t,"Only 'uid' can be set as identity in project level.");l={uid:l.uid},Si.log(1,t,"Project level integration. Only uid is accepted as identity.")}try{s=yield Wi()}catch(e){Si.warn(1,t,"Could not fetch sdk config.")}var i=yield ji.get(),n=Bi.getUserIdentities()||{};let d=!1,c=!1;var a,r={};for(a in l){if("string"!=typeof l[a])return void Si.error(1,t,`Identity '${a}' has a non-string value. Rejecting the IdentityMap.`);n[a]&&n[a]===l[a]||(d=!0),n[a]&&n[a]!==l[a]&&(r[a]=n[a]),!c&&this.shouldTriggerPushSubBilling(a,i,s)&&(c=!0)}if(d){var o=Object.keys(Bi.getUserIdentities()||{}).length||i.getAttribute("id");o&&(yield on.flushReports());let e=!1;if(c)try{yield pn.deviceAdd(),e=!0}catch(e){Si.error(1,t,"Error occurred while adding device: ",e)}l.uid&&l.uid!==n.uid&&(yield i.addAttribute(new Gi("id",l.uid)),yield Bi.updateIdentifiersIDB({moe_user_id:l.uid})),yield Bi.updateCurrentUserIdentities(l),Object.keys(r).length&&(yield Bi.updatePreviousUserIdentities(r));try{!o&&on.reports.length||!s||s.isPushSubBilling&&(s.isPushSubBilling,!i.deviceAdded)&&!e||(yield pn.sendBatchOfReports([]))}catch(e){Si.error(1,t,"Error occurred while sending identities request: ",e)}Bi.broadcastUserIdentityUpdate()}else Si.warn(1,t,"Identities not updated as same values were passed again.")}else Si.error(1,t,"type of the argument 'identities' is not supported OR empty identity received.");else Si.warn(2,t,"Not tracking user identities as Web SDK has been disabled.")})}static logout(e,t){let i=ar+".logout";if(!Ae())return Si.warn(2,i,"Not tracking user logout as Web SDK has been disabled."),Promise.resolve(!1);let n=e?{type:"forced",new_uid:t}:null;return e=ir.get(),null!=ji.getSync()&&(e.deviceToLogout=ji.getSync().deviceUuid,e.save()),new Promise(e=>{gn.track(wt.LOGOUT,n).then(()=>St(this,void 0,void 0,function*(){Si.log(1,i,"Logging out now!"),yield on.flushReports(!0),nr.removeAllCleanupListeners(),Wi().then(t=>St(this,void 0,void 0,function*(){t.isDomainLevelStorage&&(Ni.remove(yt.USER_DATA),Ni.remove(yt.IDENTITY_MAP)),un.clear(),Bi.broadcastLogout(),yield ji.logout(),Li.logout(),yield Bi.updateIdentifiersIDB({}),Li.remove(yt.GRACEFUL_DATA),pn.onDeviceAdd=new xi,setTimeout(()=>{qi.broadcastToWindow({topic:"USER_ACTIONS",name:"LOGOUT_COMPLETED"})},100),vi.setRemoteLogging(null,!1),Ei.set(Tt.HAS_USER_LOGGED_OUT,!0),e(!0)})).catch(t=>{Si.error(1,i,"Error in getting Web SDK Settings. This might indicate that the App is blocked."),e(!1)})}))})}static updateUniqueId(e){let t=ar+".updateUniqueId";return Ae()?new Promise(i=>{ji.get().then(n=>St(this,void 0,void 0,function*(){var a=n.indexOfAttribute(Nt.ID),r=n.indexOfAttribute("oldUniqueIds");if(!(-1<a))return Si.log(2,t,"Logging in as no id found"),rr.login(e);var o=n.attributes[a].value;e!==o?(Si.log(2,t,"Different ids found"),-1<r?(n.attributes[r].value.push(o),n.attributes.splice(a,1)):(n.attributes.splice(a,1),n.addAttribute(new Gi("oldUniqueIds",[o]))),n.save().then(()=>{rr.login(e).then(()=>{i(!0)})})):(Si.warn(1,t,"New id and old id are the same. Not updating the id."),i(!0))}))}):(Si.warn(2,t,"Not updating user ID as Web SDK has been disabled."),Promise.resolve(!1))}static getAttributes(e=Gi.USER_ATTRIBUTE_LEVEL.PROJECT){var t=ji.getSync().attributes;let i={};return t.forEach(t=>{(t.level||e!==Gi.USER_ATTRIBUTE_LEVEL.PROJECT)&&t.level!==e||(i[t.key]=t.value)}),i}static setAttributes(e){ji.getSync().attributes=e,Si.log(2,"MoEngage.user.setAttributes","User attributes have been updated")}static checkAndAddAttributeInIdentityMap(e,t,i){var n;return St(this,void 0,void 0,function*(){var a;e.key!==Nt.ID&&"string"==typeof t&&(a=(null==(n=di.find(t=>t.attributeName===e.key))?void 0:n.moeName)||e.key,i.configs.identityAttributes.includes(a))&&(Si.log(1,"MoEngage.user.checkAndAddAttributeInIdentityMap",`Attribute to be tracked: '${e.key}' is an identity.`),yield this.identifyUser({[a]:t}))})}static forcedLogoutUpdateInIdentityMap(e,t,i){return St(this,void 0,void 0,function*(){i.configs.identityAttributes.includes("uid")&&t&&t!==e&&(yield Bi.updateCurrentUserIdentities({uid:e}))})}static uidLoginUpdateIdentityMap(e,t){var i;return St(this,void 0,void 0,function*(){var n;null!=(i=null==(i=t.configs)?void 0:i.identityAttributes)&&i.includes("uid")&&(null!=(n=Bi.getUserIdentities())&&n.uid&&n.uid!==e&&(yield on.flushReports(),yield Bi.updatePreviousUserIdentities({uid:n.uid})),yield Bi.updateCurrentUserIdentities({uid:e})),Bi.broadcastUserIdentityUpdate()})}static shouldTriggerPushSubBilling(e,t,i){return(null==i?void 0:i.isPushSubBilling)&&!t.deviceAdded&&u((null==(t=di.find(t=>t.moeName===e))?void 0:t.attributeName)||e,i.configs.subscriberBasedBillingAttributes)}}let or=()=>new Promise(e=>{"complete"!==window.document.readyState?window.addEventListener("load",()=>{e(!0)}):e(!0)});class sr{static enableSdk(){let e=this.baseLogTag+".enableSdk";return new Promise(t=>{Ae()?(Si.warn(2,e,"SDK is already enabled."),t(!0)):(this.setDisabledFlag(!1),cr(),gr().then(()=>{this.broadcastSdkEnabled(),nn.initialize().then(()=>{this.setDisabledFlagIDB(!1)}),Ne(),t(!0)}))})}static disableSdk(){let e=this.baseLogTag+".disableSdk";return new Promise(t=>{Ae()?(this.broadcastSdkDisabled(),this.setDisabledFlag(!0),this.setDisabledFlagIDB(!0).then(e=>{this.disableSdkActivities(),(new Xi).clearSessionAndSource(),this.filterAndClearUserAttributesCache(),t(e)})):(Si.warn(2,e,"SDK is already disabled."),t(!0))})}static setDisabledFlag(e){Li.set(yt.SDK_DISABLED,e),Ni.set(yt.SDK_DISABLED,e)}static filterAndClearUserAttributesCache(){let e,t,i,n=Li.get(yt.WEB_SETTINGS),a=null==(e=null==n?void 0:n.configs)?void 0:e.identityAttributes,r=null==(t=null==n?void 0:n.configs)?void 0:t.subscriberBasedBillingAttributes;var o=Li.get(yt.USER_DATA);null!=(i=null==o?void 0:o.attributes)&&i.length&&(o.attributes=o.attributes.filter(e=>{if(null!=a&&a.length){var t=(null==(t=di.find(t=>t.attributeName===e.key))?void 0:t.moeName)||e.key;if(a.includes(t))return!0}return t=[Nt.EMAIL,Nt.MOBILE,"Web Migrated User","Web Subscription URL"],!(null==n||!n.isPushSubBilling||!(t.includes(e.key)||null!=r&&r.length&&r.includes(e.key)))}),rr.setAttributes(o.attributes),Li.set(yt.USER_DATA,o))}static broadcastSdkEnabled(){qi.broadcastToWindow({topic:Pt.MOE_LIFECYCLE.TOPIC_NAME,name:Pt.MOE_LIFECYCLE.EVENT_NAMES.SDK_ENABLED})}static broadcastSdkDisabled(){qi.broadcastToWindow({topic:Pt.MOE_LIFECYCLE.TOPIC_NAME,name:Pt.MOE_LIFECYCLE.EVENT_NAMES.SDK_DISABLED})}static setDisabledFlagIDB(e=!1){return function(e,t,i,n){return new(i=i||Promise)(function(t,a){function r(e){try{s(n.next(e))}catch(e){a(e)}}function o(e){try{s(n.throw(e))}catch(e){a(e)}}function s(e){var n;e.done?t(e.value):((n=e.value)instanceof i?n:new i(function(e){e(n)})).then(r,o)}s((n=n.apply(e,[])).next())})}(this,0,void 0,function*(){return new Promise(t=>{var i;null!=(i=this.moeDataStore)&&i.getItem||(this.moeDataStore=r.createInstance({driver:[r.INDEXEDDB],name:Ht.DATABASE_NAME,storeName:Ht.STORE_NAME})),this.moeDataStore?this.moeDataStore.setItem(yt.SDK_DISABLED,e).then(()=>{t(!0)}).catch(()=>t(!1)):t(!1)})})}static disableSdkActivities(){var e,t;for(t in on.suspendBatching(),null!=(e=_i.get())&&e.enableSPA&&Dn.removeURLChangeObserver(),nr.removeAllCleanupListeners(),yt.Q)Pi.purge(t);"function"==typeof(null==(e=nn.offlineDataStore)?void 0:e.clear)&&nn.offlineDataStore.clear()}}sr.baseLogTag="SdkMethods";var _t=function(e,t,i,n){return new(i=i||Promise)(function(a,r){function o(e){try{l(n.next(e))}catch(e){r(e)}}function s(e){try{l(n.throw(e))}catch(e){r(e)}}function l(e){var t;e.done?a(e.value):((t=e.value)instanceof i?t:new i(function(e){e(t)})).then(o,s)}l((n=n.apply(e,t||[])).next())})};class lr{}lr.track_event=(e,t)=>gn.track(e,t),lr.add_unique_user_id=e=>_t(void 0,void 0,void 0,function*(){return yield rr.login(e)}),lr.update_unique_user_id=e=>_t(void 0,void 0,void 0,function*(){return yield rr.updateUniqueId(e)}),lr.add_user_attribute=(e,t,i=Gi.USER_ATTRIBUTE_LEVEL.PROJECT)=>rr.addAttribute(e,t,i),lr.add_first_name=e=>rr.addAttribute("first_name",e),lr.add_last_name=e=>rr.addAttribute("last_name",e),lr.add_email=e=>rr.addAttribute("email",e),lr.add_mobile=e=>rr.addAttribute("mobile",e),lr.add_user_name=e=>rr.addAttribute("name",e),lr.add_gender=e=>rr.addAttribute("gender",e),lr.add_birthday=e=>rr.addAttribute("birthday",e),lr.destroy_session=()=>rr.logout(),lr.track_page_view=()=>(gn.track(wt.WEB_SESSION_START,{timestamp:Number(Date.now())}),gn.track(wt.PAGE_VIEWED,{timestamp:Number(Date.now())})),lr.identifyUser=e=>_t(void 0,void 0,void 0,function*(){return yield rr.identifyUser(e)}),lr.getUserIdentities=()=>Bi.getUserIdentities(),lr.enableSdk=()=>_t(void 0,void 0,void 0,function*(){return yield sr.enableSdk()}),lr.disableSdk=()=>_t(void 0,void 0,void 0,function*(){return yield sr.disableSdk()}),lr.isSdkEnabled=()=>Ae(),lr.user={getAttributes:rr.getAttributes},lr.getUserId=()=>{var e;return(null==(e=rr.getAttributes())?void 0:e.USER_ATTRIBUTE_UNIQUE_ID)||""},lr.getUserAttribute=(e,t=Gi.USER_ATTRIBUTE_LEVEL.PROJECT)=>rr.getAttributes(t)[e]||"",lr.userAttributeLevel=Gi.USER_ATTRIBUTE_LEVEL;class dr{static getUuid(){return Li.get(yt.USER_DATA).deviceUuid}static getPushToken(){var e=Li.get(yt.SUBSCRIPTION_DETAILS);return(null==e?void 0:e.token)||null}static getDeviceData(){return Li.get(yt.DEVICE_DATA)}static setDeviceData(e,t){Li.set(yt.DEVICE_DATA,Object.assign(Object.assign({},this.getDeviceData()),{[e]:t}))}static createNewDeviceUniqueId(){this.setDeviceData("deviceUniqueId",(0,oe.v4)())}}function It(e){let t="Pre-Initialization";if(!(e=>(e=["bot","spider","crawler","crawling","Applebot","PetalBot","pingbot","proximic","AdsBot-Google","Googlebot","Cincraw","SnapchatBot","Snapchat-Proxy/1.0","SnapchatAds","Snapchat-Ads/1.0","YandexRenderResourcesBot","bingbot","slurp","MicrosoftPreview","Baiduspider","HeadlessChrome",...Array.isArray(e)?e:[]],new RegExp(e.join("|"),"i").test(navigator.userAgent)))(null==e?void 0:e.bots_list)){if((i=s())&&0<i.initialised)return Si.error(1,t,"MoEngage Web SDK initialised multiple times. Please integrate the Web SDK only once!"),i;if("undefined"==typeof Promise)Si.error(1,t,"Promises not supported");else{if(e.app_id||e.appId){i=class{static isIntegrated(){try{var e=localStorage.getItem(Gt.CLUSTER),t=localStorage.getItem(Gt.SW_PATH),i=localStorage.getItem(Gt.SW_SCOPE),n=localStorage.getItem(Gt.ENABLE_SPA),a=localStorage.getItem(Gt.DISABLE_ONSITE),r=localStorage.getItem(Gt.DISABLE_COOKIES),o=localStorage.getItem(Gt.CARDS),s={},l=(e&&(s.cluster=e),t&&(s.swPath=t),i&&(s.swScope=i),n&&(s.enableSPA="true"===n),r&&(s.disableCookies="true"===r),a&&(s.disable_onsite="true"===r),o&&(s.cards=JSON.parse(o)),e||t||i||n||r||a||o);return l&&Si.log(1,".isSegmentDataFound","Data found for segment initialisation",s),!!l&&s}catch(e){return!1}}}.isIntegrated(),i&&(e=Object.assign({},e,i)),_i.save(e);let a=_i.get();or().then(()=>{var i;ur(),new tr,(e=>{const t="handleLogger";Si.setLogLevel(e.debugLevel),Si.log(1,t,"Init data: ",e),Si.log(1,t,"Script loaded!"),Si.customLabel(1,t,"SDK Version","2.61.01"),e.debugLevel>0&&(Si.warn(1,t,"You are currently using MoEngage in debug environment. You'll find all the data captured in this environment in the TEST mode on the dashoard."),Si.warn(1,t,"Please initialize with debugLevel as",0,"when using on your production environment."))})(a),i=e.disableSdk,((e,t)=>new Promise(i=>{let n=indexedDB.open(e);n.onsuccess=()=>{n.result.objectStoreNames.contains(t)?i(!0):i(!1)},n.onerror=()=>{i(!1)}}))(Ht.DATABASE_NAME,Ht.STORE_NAME).then(e=>{var t;e&&(e=r.createInstance({driver:[r.INDEXEDDB],name:Ht.DATABASE_NAME,storeName:Ht.STORE_NAME}))&&(e.setItem("isSdkDisabledAtInit",!!i),Oe()||Ni.get(At))&&("boolean"==typeof(t=Ni.get(yt.SDK_DISABLED))?e.setItem(yt.SDK_DISABLED,t):e.removeItem(yt.SDK_DISABLED))}),Ae()||(Oe()||Ni.get(At))&&!1===Ni.get(yt.SDK_DISABLED)&&(Li.set(yt.SDK_DISABLED,!1),1)?(cr(),window.addEventListener(Pt.MOE_LIFECYCLE.TOPIC_NAME,e=>{if(e.detail.name===Pt.MOE_LIFECYCLE.EVENT_NAMES.LANDING_PAGE_DEVICE_ADD){let e="handleLandingPageDeviceAdd";wn.getWebSDKSettings().then(t=>{if(null!=(t=null==t?void 0:t.configs)&&t.landingPageTracking)return ji.get().then(t=>{t.deviceAdded||(Si.log(2,e,"Landing page tracking enabled and device not added, triggering device add"),pn.deviceAdd(!1))})}).catch(t=>{Si.error(2,e,"Error getting SDK settings or checking device status for landing page device add:",t),pn.deviceAdd(!1)})}}),gr().then(()=>{Ne()})):Si.warn(2,t,"Not initialising the SDK as it has been disabled."),qi.broadcastToWindow({topic:Pt.MOE_LIFECYCLE.TOPIC_NAME,name:Pt.MOE_LIFECYCLE.EVENT_NAMES.MOE_INIT,data:e},!0)});var i=window.moengage_object||"Moengage",n=Object.assign(Object.assign(Object.assign({},Cn),lr),{onsite:Ln});return window[i]=n}Si.error(1,t,"App Id not specified. Please check docs page to complete the integration - ",xt.WEBSDK_DOCS)}return Pn}Si.error(1,t,"Bot detected, Can't initialise the MoEngage Web SDK")}let cr=()=>{window.addEventListener("USER_ACTIONS",e=>{"LOGOUT_COMPLETED"===e.detail.name&&gr(!0)})},ur=()=>{le()===oi.WEB&&r.createInstance({driver:[r.INDEXEDDB,r.WEBSQL,r.LOCALSTORAGE],name:Ft.DATABASE_NAME,storeName:Ft.STORE_NAME}).clear()},gr=(window&&(window.moe=It,window.moeBannerText="banner",window[Kt.PageEventHistoryManager]=un),(e=!1)=>{let t="Initialization";return new Promise(i=>wn.getWebSDKSettings().then(n=>{let{isDomainLevelStorage:a,isPushSubBilling:r,isWebPushEnabled:o,configs:{isBatchingEnabled:s,remoteLogTracking:l,logLevel:d,isCardsModuleEnabled:c}}=n;vi.setRemoteLogging(d,l),mr(a),hr(s,l,n);var g=dr.getDeviceData();return null!=g&&g.deviceUniqueId||dr.createNewDeviceUniqueId(),ji.get().then(s=>function(e,t,i,n){return new(i=i||Promise)(function(e,t){function a(e){try{o(n.next(e))}catch(e){t(e)}}function r(e){try{o(n.throw(e))}catch(e){t(e)}}function o(t){var n;t.done?e(t.value):((n=t.value)instanceof i?n:new i(function(e){e(n)})).then(a,r)}o((n=n.apply(undefined,[])).next())})}(0,0,void 0,function*(){if(null==(l=null==(l=n.configs)?void 0:l.identityAttributes)||!l.includes("uid")||null!=(l=Bi.getUserIdentities())&&l.uid||Bi.copyUidIntoIdentityMap(s),ir.get().deviceToLogout===s.deviceUuid)return Si.remoteLogTracking(1,"info",t,"User was not able to logout last time. Completing the logout now and starting new session."),rr.logout();s.deviceAdded&&pn.onDeviceAdd.res(),r&&Si.warn(1,t,"You are under push subscriber based billing plan. We are only tracking users with an email, phone number or have subscribed to web push. All user attributes and events will be stored in a queue till we receive either of the properties.");var l=new Xi;(new nr).onWindowVisibilityChange(l.handleBrowserInactivity),Si.customLabel(1,t,"Device UUID",s.deviceUuid),Si.customLabel(1,t,"Device Added",s.deviceAdded),qi.broadcastToWindow({topic:Pt.MOE_LIFECYCLE.TOPIC_NAME,name:Pt.MOE_LIFECYCLE.EVENT_NAMES.SETTINGS_FETCHED,data:n}),qi.broadcastToWindow({topic:Pt.MOE_LIFECYCLE.TOPIC_NAME,name:Pt.MOE_LIFECYCLE.EVENT_NAMES.DEVICE_UUID,data:s.deviceUuid}),(!n.isPushSubBilling&&(!s.deviceAdded||e)||n.isPushSubBilling&&(((e,t)=>{let i,n,a=(null==(i=null==e?void 0:e.configs)?void 0:i.subscriberBasedBillingAttributes)||[];return(null==(n=t.attributes)?void 0:n.some(e=>u(e.key,a)))||!!ge()})(n,s)&&e||be()))&&pn.deviceAdd(),lr.track_page_view(),En.clear(yt.Q.DEVICE),En.clear(yt.Q.REPORT),_i.get().enableSPA&&!Dn.isObserverRunning&&(new Dn).addURLChangeObserver(a),Fi.getInstance().then(e=>{var i,a=!(null!=(a=null==(i=window.MoeWebP)?void 0:i.isEditorModeEnabled)&&a.call(i));o&&!_i.get().disableWebPush&&a?tr.enablePush(n):Si.warn(1,t,"Web push feature not enabled for current environment"),!_i.get().disableOnsite&&a?pn.onDeviceAdd.p.then(()=>{tr.enableOSM()}):Si.warn(1,t,"Onsite is disabled in this page since `disableOnsite: true` is passed during initialization."),c&&null!=(i=_i.get().cards)&&i.enable&&a?tr.enableCards(n):tr.disableCards(),null!=(i=n.configs)&&i.isWebPersonalizationModuleEnabled&&tr.enableWebPersonalizationTracking(),pr()}),i(!0)}))}).catch(e=>{Si.error(1,t,"Error in getting Web SDK Settings. This might indicate that the App is blocked."),i(!1)}))}),pr=()=>{var e="Moengage.clearWindowQ";try{var t=s();let n=window.moengage_q;if(t&&n){if(window.moengage_q=[],n&&0<n.length&&t)for(let a=0;a<n.length;a++){Si.remoteLogTracking(1,"info",e,"Method called before SDK downloaded:",[n[a].f],n[a].a);var i=n[a].f;"onsite.getData"===i?t.onsite.getData(...n[a].a):"onsite.registerCallback"===i?t.onsite.registerCallback(...n[a].a):"onsite.getSelfHandledOSM"===i?t.onsite.getSelfHandledOSM(...n[a].a):"landingPages.trackImpression"===i?t.landingPages.trackImpression.apply(null,n[a].a):null!=t[n[a].f]&&t[n[a].f].apply(null,n[a].a)}n=[]}}catch(t){Si.error(1,e,t)}},mr=e=>{e&&(Li.isSharedWithCookie=!0,Li.copyKeysFromCookie())},hr=(e,t,i)=>{nr.addAllCleanupListeners(e),(e||t)&&(on.init(i),Si.log(1,"handleBatching","Enabled Batching for "+(e?"Event Tracking":"")+(t?", Remote Logs Tracking":"")))},Er={clearWindowQ:pr,clearEventsFromIDB:ur,initialize:It,isWindowLoaded:or}}})();